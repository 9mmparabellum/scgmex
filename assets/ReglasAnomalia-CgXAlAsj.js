import{u as re,A as te,j as e}from"./index-CPaKNtDw.js";import{b as s}from"./vendor-DEA9Ikep.js";import{c as oe}from"./useAnomalias-CwEF5gOm.js";import{useCreate as se,useUpdate as ie,useRemove as ne}from"./useCrud-BktvsPeN.js";import{Y as j,Z as y}from"./constants-CX_We7cr.js";import{D as le}from"./DataTable-HS7RLNYY.js";import{M as ce}from"./Modal-BiK_8Ur7.js";import{B as i}from"./Button-BnoK6vsi.js";import{I as M}from"./Input-DL7Lvbg0.js";import{S as D}from"./Select-C_7OhVDc.js";import{B as L}from"./Badge-CGz_j3CN.js";import{C as de}from"./ConfirmDialog-DLbWcXIK.js";import{e as me}from"./exportHelpers-CvXmrB4L.js";import"./supabase-DANKYb0E.js";import"./export-t5FFX7R_.js";const z=[{nombre:"Monto mayor a 3 desviaciones estandar",descripcion:"Detecta movimientos cuyo monto supera 3 desviaciones estandar respecto a la media del periodo.",tipo:"monto_inusual",nivel_riesgo:"alto",umbral:3,activa:!0,parametros:{campo:"monto",metodo:"desviacion_estandar"}},{nombre:"Poliza duplicada en 7 dias",descripcion:"Identifica movimientos con la misma cuenta y monto registrados dentro de un periodo de 7 dias.",tipo:"patron_duplicado",nivel_riesgo:"medio",umbral:7,activa:!0,parametros:{dias:7,comparar:"cuenta_monto"}},{nombre:"Transaccion fin de semana",descripcion:"Marca polizas registradas en sabado, domingo o fuera de horario laboral.",tipo:"horario_sospechoso",nivel_riesgo:"medio",umbral:0,activa:!0,parametros:{dias_habiles:"lun-vie",horario:"07:00-20:00"}},{nombre:"Monto redondo > $100,000",descripcion:"Detecta montos que son multiplos exactos de $10,000 y superan $100,000.",tipo:"monto_inusual",nivel_riesgo:"bajo",umbral:1e5,activa:!0,parametros:{multiplo:1e4,minimo:1e5}},{nombre:"Desviacion presupuestal > 20%",descripcion:"Alerta cuando el monto ejercido supera en mas de 20% al monto aprobado.",tipo:"desviacion_presupuestal",nivel_riesgo:"alto",umbral:20,activa:!0,parametros:{porcentaje:20,comparar:"ejercido_vs_aprobado"}},{nombre:"Concentracion proveedor > 40%",descripcion:"Detecta cuando un solo proveedor concentra mas del 40% del total de compras.",tipo:"proveedor_concentrado",nivel_riesgo:"critico",umbral:40,activa:!0,parametros:{porcentaje:40,metodo:"concentracion"}}],P={nombre:"",descripcion:"",tipo:"",nivel_riesgo:"",umbral:"",activa:!0,parametros:[]};function ue(){return e.jsx("div",{className:"flex items-center justify-center py-16",children:e.jsxs("svg",{className:"animate-spin h-8 w-8 text-guinda",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]})})}function Ae(){const{entePublico:T,rol:B}=re(),m=T?.id,n=te(B,"anomalias"),{data:b=[],isLoading:O}=oe(m),g=se("regla_anomalia"),h=ie("regla_anomalia"),k=ne("regla_anomalia"),N=b.length>0?b:z,V=b.length===0,[I,u]=s.useState(!1),[p,C]=s.useState(null),[t,l]=s.useState({...P}),[_,v]=s.useState(!1),[x,f]=s.useState(null),[H,w]=s.useState(!1),W=s.useMemo(()=>Object.entries(j).map(([a,r])=>({value:a,label:r})),[]),U=s.useMemo(()=>Object.entries(y).map(([a,{label:r}])=>({value:a,label:r})),[]),c=(a,r)=>l(o=>({...o,[a]:r})),F=a=>!a||typeof a!="object"?[]:Object.entries(a).map(([r,o])=>({key:r,value:String(o)})),$=a=>{const r={};return(a||[]).forEach(({key:o,value:d})=>{o.trim()&&(r[o.trim()]=d)}),r},G=s.useCallback(()=>{C(null),l({...P,parametros:[]}),u(!0)},[]),R=s.useCallback(a=>{C(a),l({nombre:a.nombre||"",descripcion:a.descripcion||"",tipo:a.tipo||"",nivel_riesgo:a.nivel_riesgo||"",umbral:a.umbral??"",activa:a.activa!==!1,parametros:F(a.parametros)}),u(!0)},[]),Y=s.useCallback(async()=>{if(!(!t.nombre.trim()||!t.tipo||!t.nivel_riesgo)){v(!0);try{const a={nombre:t.nombre.trim(),descripcion:t.descripcion.trim(),tipo:t.tipo,nivel_riesgo:t.nivel_riesgo,umbral:Number(t.umbral)||0,activa:t.activa,parametros:$(t.parametros),ente_id:m};p?.id?await h.mutateAsync({id:p.id,...a}):await g.mutateAsync(a),u(!1)}finally{v(!1)}}},[t,p,m,g,h]),A=s.useCallback(async a=>{a.id&&await h.mutateAsync({id:a.id,activa:!a.activa})},[h]),q=s.useCallback(async()=>{if(x?.id){w(!0);try{await k.mutateAsync(x.id),f(null)}finally{w(!1)}}},[x,k]),Z=s.useCallback(async()=>{v(!0);try{for(const a of z)await g.mutateAsync({...a,ente_id:m})}finally{v(!1)}},[g,m]),J=()=>{l(a=>({...a,parametros:[...a.parametros||[],{key:"",value:""}]}))},S=(a,r,o)=>{l(d=>({...d,parametros:d.parametros.map((E,ae)=>ae===a?{...E,[r]:o}:E)}))},K=a=>{l(r=>({...r,parametros:r.parametros.filter((o,d)=>d!==a)}))},Q=s.useMemo(()=>[{key:"nombre",label:"Nombre",render:a=>e.jsx("span",{className:"font-medium text-text-heading",children:a||"—"})},{key:"tipo",label:"Tipo",width:"160px",render:a=>e.jsx(L,{variant:"primary",children:j[a]||a||"—"})},{key:"nivel_riesgo",label:"Riesgo",width:"110px",render:a=>{const r=y[a];return e.jsx(L,{variant:r?.variant||"default",children:r?.label||a||"—"})}},{key:"umbral",label:"Umbral",width:"100px",render:a=>e.jsx("span",{className:"font-mono text-sm",children:a??"—"})},{key:"activa",label:"Activa",width:"90px",sortable:!1,render:(a,r)=>e.jsx("button",{type:"button",className:["relative inline-flex h-6 w-11 flex-shrink-0 rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none",a!==!1?"bg-guinda":"bg-gray-200",r.id&&n?"cursor-pointer":"cursor-default opacity-60"].join(" "),onClick:o=>{o.stopPropagation(),r.id&&n&&A(r)},disabled:!r.id||!n,children:e.jsx("span",{className:["pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out",a!==!1?"translate-x-5":"translate-x-0"].join(" ")})})},{key:"id",label:"Acciones",width:"120px",sortable:!1,render:(a,r)=>e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(i,{size:"sm",variant:"ghost",onClick:o=>{o.stopPropagation(),R(r)},children:e.jsxs("svg",{className:"w-4 h-4",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"}),e.jsx("path",{d:"M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"})]})}),r.id&&n&&e.jsx(i,{size:"sm",variant:"ghost",onClick:o=>{o.stopPropagation(),f(r)},children:e.jsxs("svg",{className:"w-4 h-4 text-danger",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("polyline",{points:"3 6 5 6 21 6"}),e.jsx("path",{d:"M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"}),e.jsx("line",{x1:"10",y1:"11",x2:"10",y2:"17"}),e.jsx("line",{x1:"14",y1:"11",x2:"14",y2:"17"})]})})]})}],[n,A,R]),X=[{key:"nombre",label:"Nombre"},{key:"tipo",label:"Tipo",getValue:a=>j[a.tipo]||a.tipo},{key:"nivel_riesgo",label:"Nivel Riesgo",getValue:a=>y[a.nivel_riesgo]?.label||a.nivel_riesgo},{key:"umbral",label:"Umbral"},{key:"activa",label:"Activa",getValue:a=>a.activa!==!1?"Si":"No"},{key:"descripcion",label:"Descripcion"}],ee=()=>{me(N,X,"reglas_anomalia")};return O?e.jsx(ue,{}):e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-bold text-text-primary",children:"Reglas de Deteccion"}),e.jsx("p",{className:"text-sm text-text-muted mt-1",children:"Configuracion de reglas para el motor de deteccion de anomalias"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(i,{variant:"outline-secondary",size:"sm",onClick:ee,children:[e.jsxs("svg",{className:"w-4 h-4 mr-1.5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"}),e.jsx("polyline",{points:"7 10 12 15 17 10"}),e.jsx("line",{x1:"12",y1:"15",x2:"12",y2:"3"})]}),"Excel"]}),n&&e.jsxs(i,{onClick:G,children:[e.jsx("svg",{className:"w-4 h-4 mr-1.5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z",clipRule:"evenodd"})}),"Nueva Regla"]})]})]}),V&&e.jsxs("div",{className:"bg-[#03c3ec]/10 border border-[#03c3ec]/30 rounded-lg p-4 mb-4 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("svg",{className:"w-5 h-5 text-[#03a9ce] flex-shrink-0",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("line",{x1:"12",y1:"16",x2:"12",y2:"12"}),e.jsx("line",{x1:"12",y1:"8",x2:"12.01",y2:"8"})]}),e.jsxs("p",{className:"text-sm text-text-heading",children:["Se muestran las reglas predeterminadas. Para personalizarlas, haga clic en",e.jsx("strong",{children:" “Crear Reglas Predeterminadas”"})," para guardarlas en la base de datos."]})]}),n&&e.jsx(i,{size:"sm",variant:"outline-primary",onClick:Z,loading:_,children:"Crear Reglas Predeterminadas"})]}),e.jsx("div",{className:"bg-white rounded-lg card-shadow p-5",children:e.jsx(le,{columns:Q,data:N})}),e.jsx(ce,{open:I,onClose:()=>u(!1),title:p?"Editar Regla":"Nueva Regla",size:"lg",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx(M,{label:"Nombre",value:t.nombre,onChange:a=>c("nombre",a.target.value),placeholder:"Nombre de la regla"}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-text-heading mb-1.5",children:"Descripcion"}),e.jsx("textarea",{className:"block w-full rounded-md border border-border bg-white text-text-heading text-[0.9375rem] px-3.5 py-2.5 placeholder:text-text-muted transition-all duration-150 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda min-h-[80px]",rows:3,value:t.descripcion,onChange:a=>c("descripcion",a.target.value),placeholder:"Descripcion de la regla de deteccion..."})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(D,{label:"Tipo de Anomalia",options:W,value:t.tipo,onChange:a=>c("tipo",a.target.value),placeholder:"Seleccionar tipo"}),e.jsx(D,{label:"Nivel de Riesgo",options:U,value:t.nivel_riesgo,onChange:a=>c("nivel_riesgo",a.target.value),placeholder:"Seleccionar nivel"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 items-end",children:[e.jsx(M,{label:"Umbral",type:"number",value:t.umbral,onChange:a=>c("umbral",a.target.value),placeholder:"Valor numerico del umbral"}),e.jsx("div",{className:"flex items-center gap-3 h-[40px]",children:e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:t.activa,onChange:a=>c("activa",a.target.checked),className:"h-4 w-4 rounded border-border text-guinda focus:ring-guinda/25 cursor-pointer"}),e.jsx("span",{className:"text-[0.9375rem] text-text-heading font-medium",children:"Regla activa"})]})})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("label",{className:"block text-sm font-medium text-text-heading",children:"Parametros"}),e.jsxs(i,{size:"sm",variant:"ghost",onClick:J,children:[e.jsx("svg",{className:"w-3.5 h-3.5 mr-1",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z",clipRule:"evenodd"})}),"Agregar"]})]}),(t.parametros||[]).length===0?e.jsx("p",{className:"text-sm text-text-muted bg-[#f9fafb] rounded-md p-3 text-center",children:"Sin parametros configurados"}):e.jsx("div",{className:"space-y-2",children:t.parametros.map((a,r)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"text",className:"flex-1 h-[36px] rounded-md border border-border bg-white text-text-heading text-[0.875rem] px-3 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda",placeholder:"Clave",value:a.key,onChange:o=>S(r,"key",o.target.value)}),e.jsx("input",{type:"text",className:"flex-1 h-[36px] rounded-md border border-border bg-white text-text-heading text-[0.875rem] px-3 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda",placeholder:"Valor",value:a.value,onChange:o=>S(r,"value",o.target.value)}),e.jsx("button",{type:"button",className:"p-1.5 rounded-md text-text-muted hover:text-danger hover:bg-danger/10 transition-colors cursor-pointer",onClick:()=>K(r),children:e.jsxs("svg",{className:"w-4 h-4",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]},r))})]}),e.jsxs("div",{className:"flex justify-end gap-3 border-t border-border pt-4",children:[e.jsx(i,{variant:"ghost",onClick:()=>u(!1),children:"Cancelar"}),e.jsx(i,{onClick:Y,loading:_,disabled:!t.nombre.trim()||!t.tipo||!t.nivel_riesgo,children:p?"Actualizar Regla":"Crear Regla"})]})]})}),e.jsx(de,{open:!!x,onClose:()=>f(null),onConfirm:q,title:"Eliminar Regla",message:`¿Esta seguro de eliminar la regla "${x?.nombre}"? Esta accion no se puede deshacer.`,confirmText:"Eliminar",loading:H})]})}export{Ae as default};
