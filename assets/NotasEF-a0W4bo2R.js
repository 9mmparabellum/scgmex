import{s as C,u as S,o as I,p as G,q as V,j as e}from"./index-xuYioy8Y.js";import{b as x}from"./vendor-DEA9Ikep.js";import{u as z,b as H}from"./useCrud-BZqSYSww.js";import{o as E,p as A,q as w}from"./constants-B0qHiDNt.js";import{M as W}from"./Modal-BawsBw69.js";import{B as b}from"./Button-CQM7GO5t.js";import{S as k}from"./Select-CHQpqBAE.js";import{I as $}from"./Input-C6_ozmNh.js";import{B as Q}from"./Badge-DX5pclE5.js";import"./supabase-DANKYb0E.js";import"./export-t5FFX7R_.js";const R=[{tipo_nota:"desglose",estado_financiero:"situacion_financiera",numero:1,titulo:"Notas al Estado de Situacion Financiera",contenido:""},{tipo_nota:"desglose",estado_financiero:"actividades",numero:2,titulo:"Notas al Estado de Actividades",contenido:""},{tipo_nota:"desglose",estado_financiero:"variacion_hacienda",numero:3,titulo:"Notas al Estado de Variacion en la Hacienda Publica",contenido:""},{tipo_nota:"desglose",estado_financiero:"flujo_efectivo",numero:4,titulo:"Notas al Estado de Flujos de Efectivo",contenido:""},{tipo_nota:"memoria",estado_financiero:"general",numero:1,titulo:"Notas de Memoria (Cuentas de Orden)",contenido:""},{tipo_nota:"gestion",estado_financiero:"general",numero:1,titulo:"Notas de Gestion Administrativa",contenido:""},{tipo_nota:"gestion",estado_financiero:"general",numero:2,titulo:"Politicas de Contabilidad Significativas",contenido:""},{tipo_nota:"gestion",estado_financiero:"general",numero:3,titulo:"Partes Relacionadas",contenido:""}];async function D(s,a,o,n){let i=C.from("nota_estado_financiero").select("*, elaborador:usuarios!elaborado_por(nombre)").eq("ente_id",s).eq("ejercicio_id",a).eq("periodo_id",o).order("tipo_nota").order("numero");const{data:h,error:l}=await i;if(l)throw l;return h}async function K(s,a,o,n){const i=R.map(r=>({ente_id:s,ejercicio_id:a,periodo_id:o,tipo_nota:r.tipo_nota,estado_financiero:r.estado_financiero,numero:r.numero,titulo:r.titulo,contenido:r.contenido,estado:"borrador",elaborado_por:n})),{data:h,error:l}=await C.from("nota_estado_financiero").insert(i).select();if(l)throw l;return h}function Z(s,a){const{entePublico:o,ejercicioFiscal:n}=S();return I({queryKey:["notas_ef",o?.id,n?.id,s,a],queryFn:()=>D(o.id,n.id,s),enabled:!!o?.id&&!!n?.id&&!!s})}function U(){const s=G();return V({mutationFn:({enteId:a,ejercicioId:o,periodoId:n,elaboradoPor:i})=>K(a,o,n,i),onSuccess:()=>{s.invalidateQueries({queryKey:["notas_ef"]})}})}const J=Object.entries(E).map(([s,a])=>({key:s,label:a})),X=Object.entries(A).map(([s,a])=>({value:s,label:a.label}));function ce(){const{entePublico:s,ejercicioFiscal:a}=S(),[o,n]=x.useState(""),[i,h]=x.useState("desglose"),[l,r]=x.useState(!1),[c,p]=x.useState(null),[u,N]=x.useState({titulo:"",contenido:"",estado:"borrador"}),{data:v=[]}=z("periodo_contable",{filter:{ejercicio_id:a?.id},order:{column:"numero",ascending:!0}}),P=x.useMemo(()=>v.map(t=>({value:t.id,label:t.nombre||`Periodo ${t.numero}`})),[v]),{data:f=[],isLoading:T,isError:F}=Z(o),y=U(),j=H("nota_estado_financiero"),_=x.useMemo(()=>f.filter(t=>t.tipo_nota===i),[f,i]),M=async()=>{if(o)try{await y.mutateAsync({enteId:s?.id,ejercicioId:a?.id,periodoId:o})}catch{}},O=t=>{p(t),N({titulo:t.titulo||"",contenido:t.contenido||"",estado:t.estado||"borrador"}),r(!0)},L=async()=>{if(c)try{await j.mutateAsync({id:c.id,titulo:u.titulo,contenido:u.contenido,estado:u.estado}),r(!1),p(null)}catch{}},g=(t,d)=>N(m=>({...m,[t]:d})),q=(t,d=120)=>t?t.length>d?t.substring(0,d)+"...":t:"";return e.jsxs("div",{children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h1",{className:"text-xl font-bold text-text-primary",children:"Notas a los Estados Financieros"}),e.jsx("p",{className:"text-sm text-text-muted mt-1",children:"Notas de desglose, memoria y gestion administrativa (NIF, CONAC)"})]}),e.jsx("div",{className:"bg-white rounded-lg card-shadow p-4 mb-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 items-end",children:[e.jsx(k,{label:"Periodo",placeholder:"Seleccionar periodo...",options:P,value:o,onChange:t=>n(t.target.value)}),e.jsx("div",{}),e.jsx("div",{className:"flex justify-end",children:e.jsxs(b,{onClick:M,loading:y.isPending,disabled:!o,children:[e.jsx("svg",{className:"w-4 h-4 mr-1.5 inline-block",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),"Generar Plantillas"]})})]})}),e.jsx("div",{className:"bg-white rounded-lg card-shadow mb-6",children:e.jsx("div",{className:"border-b border-border px-5",children:e.jsx("nav",{className:"flex gap-6 -mb-px","aria-label":"Tipo de nota",children:J.map(t=>{const d=i===t.key,m=f.filter(B=>B.tipo_nota===t.key).length;return e.jsxs("button",{onClick:()=>h(t.key),className:`py-3 text-[0.9375rem] font-medium border-b-2 transition-colors cursor-pointer ${d?"border-guinda text-guinda":"border-transparent text-text-muted hover:text-text-primary hover:border-border"}`,children:[t.label,m>0&&e.jsx("span",{className:`ml-2 text-xs px-1.5 py-0.5 rounded-full ${d?"bg-guinda/10 text-guinda":"bg-[#f5f5f9] text-text-muted"}`,children:m})]},t.key)})})})}),T?e.jsx("div",{className:"bg-white rounded-lg card-shadow p-5",children:e.jsx("div",{className:"flex items-center justify-center py-16",children:e.jsxs("svg",{className:"animate-spin h-8 w-8 text-guinda",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]})})}):F?e.jsx("div",{className:"bg-white rounded-lg card-shadow p-5",children:e.jsxs("div",{className:"text-center py-16",children:[e.jsx("div",{className:"flex justify-center mb-4",children:e.jsx("div",{className:"w-16 h-16 rounded-full bg-[#ff3e1d]/10 flex items-center justify-center text-[#ff3e1d]",children:e.jsxs("svg",{className:"w-7 h-7",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("line",{x1:"12",y1:"8",x2:"12",y2:"12"}),e.jsx("line",{x1:"12",y1:"16",x2:"12.01",y2:"16"})]})})}),e.jsx("h3",{className:"text-[0.9375rem] font-semibold text-text-heading mb-1",children:"Error al cargar notas"}),e.jsx("p",{className:"text-sm text-text-muted max-w-sm mx-auto",children:"Ocurrio un error al obtener las notas. Intente nuevamente."})]})}):o?_.length===0?e.jsx("div",{className:"bg-white rounded-lg card-shadow p-5",children:e.jsxs("div",{className:"text-center py-16",children:[e.jsx("div",{className:"flex justify-center mb-4",children:e.jsx("div",{className:"w-16 h-16 rounded-full bg-[#f5f5f9] flex items-center justify-center text-text-muted",children:e.jsxs("svg",{className:"w-7 h-7",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8Z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"})]})})}),e.jsxs("h3",{className:"text-[0.9375rem] font-semibold text-text-heading mb-1",children:["Sin notas de ",E[i]||i]}),e.jsx("p",{className:"text-sm text-text-muted max-w-sm mx-auto",children:'No hay notas registradas para este tipo y periodo. Presione "Generar Plantillas" para crear las notas base.'})]})}):e.jsx("div",{className:"space-y-3",children:_.map(t=>{const d=A[t.estado]||{label:t.estado,variant:"default"},m=w[t.estado_financiero]||t.estado_financiero;return e.jsx("div",{onClick:()=>O(t),className:"bg-white rounded-lg card-shadow p-5 hover:ring-2 hover:ring-guinda/15 transition-all cursor-pointer",children:e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-1",children:[t.numero&&e.jsxs("span",{className:"text-xs font-mono font-semibold text-guinda bg-guinda/10 px-2 py-0.5 rounded",children:["#",t.numero]}),e.jsx("h3",{className:"text-[0.9375rem] font-semibold text-text-heading truncate",children:t.titulo||"Sin titulo"})]}),m&&e.jsx("p",{className:"text-xs text-text-muted mb-2",children:m}),e.jsx("p",{className:"text-sm text-text-secondary leading-relaxed",children:q(t.contenido)||"Sin contenido"})]}),e.jsx("div",{className:"flex-shrink-0",children:e.jsx(Q,{variant:d.variant,children:d.label})})]})},t.id)})}):e.jsx("div",{className:"bg-white rounded-lg card-shadow p-5",children:e.jsxs("div",{className:"text-center py-16",children:[e.jsx("div",{className:"flex justify-center mb-4",children:e.jsx("div",{className:"w-16 h-16 rounded-full bg-[#f5f5f9] flex items-center justify-center text-text-muted",children:e.jsxs("svg",{className:"w-7 h-7",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8Z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"}),e.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),e.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"}),e.jsx("polyline",{points:"10 9 9 9 8 9"})]})})}),e.jsx("h3",{className:"text-[0.9375rem] font-semibold text-text-heading mb-1",children:"Seleccione un periodo"}),e.jsx("p",{className:"text-sm text-text-muted max-w-sm mx-auto",children:"Seleccione un periodo contable para ver las notas a los estados financieros"})]})}),e.jsx(W,{open:l,onClose:()=>{r(!1),p(null)},title:c?`Editar Nota #${c.numero||""}`:"Editar Nota",size:"lg",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx($,{label:"Titulo",value:u.titulo,onChange:t=>g("titulo",t.target.value),placeholder:"Titulo de la nota"}),e.jsxs("div",{className:"w-full",children:[e.jsx("label",{className:"block text-sm font-medium text-text-heading mb-1.5",children:"Contenido"}),e.jsx("textarea",{value:u.contenido,onChange:t=>g("contenido",t.target.value),placeholder:"Contenido de la nota...",rows:10,className:"w-full rounded-md border border-border px-3 py-2 text-[0.9375rem] focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda resize-y min-h-[200px]"})]}),e.jsx(k,{label:"Estado",value:u.estado,onChange:t=>g("estado",t.target.value),options:X,placeholder:"Seleccionar estado..."}),c?.estado_financiero&&e.jsxs("div",{className:"bg-[#f9fafb] rounded-md p-3",children:[e.jsx("p",{className:"text-xs text-text-muted uppercase tracking-wide mb-0.5",children:"Estado Financiero Asociado"}),e.jsx("p",{className:"text-sm text-text-primary font-medium",children:w[c.estado_financiero]||c.estado_financiero})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-2 border-t border-border",children:[e.jsx(b,{variant:"ghost",onClick:()=>{r(!1),p(null)},disabled:j.isPending,children:"Cancelar"}),e.jsx(b,{onClick:L,loading:j.isPending,disabled:!u.titulo.trim(),children:"Guardar cambios"})]})]})})]})}export{ce as default};
