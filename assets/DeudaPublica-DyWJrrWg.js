import{u as fe,j as t}from"./index-CPaKNtDw.js";import{b as n}from"./vendor-DEA9Ikep.js";import{useCreate as R,useUpdate as je,useRemove as _e}from"./useCrud-BktvsPeN.js";import{a as ye,u as Ne,b as Ce}from"./useDeuda-8zxGOmTK.js";import{D as G}from"./DataTable-HS7RLNYY.js";import{M as X}from"./Modal-BiK_8Ur7.js";import{B as c}from"./Button-BnoK6vsi.js";import{I as i}from"./Input-DL7Lvbg0.js";import{S as v}from"./Select-C_7OhVDc.js";import{B as k}from"./Badge-CGz_j3CN.js";import{C as ke}from"./ConfirmDialog-DLbWcXIK.js";import{e as Me}from"./exportHelpers-CvXmrB4L.js";import{g as U,h as $,i as H}from"./constants-CX_We7cr.js";import"./supabase-DANKYb0E.js";import"./export-t5FFX7R_.js";const d=b=>new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(b||0),J={clave:"",descripcion:"",tipo:"credito",acreedor:"",monto_original:"",saldo_vigente:"",tasa_interes:"",tipo_tasa:"fija",plazo_meses:"",fecha_contratacion:"",fecha_vencimiento:"",moneda:"MXN",destino_recursos:"",garantia:"",estado:"vigente"},M={tipo:"disposicion",monto:"",fecha:new Date().toISOString().split("T")[0],descripcion:""};function Re(){const{entePublico:b,ejercicioFiscal:K}=fe(),[Q,m]=n.useState(!1),[p,S]=n.useState(null),[s,f]=n.useState({...J}),[W,j]=n.useState(!1),[u,_]=n.useState(null),[Y,D]=n.useState(!1),[w,E]=n.useState(null),[Z,T]=n.useState(null),[y,x]=n.useState(!1),[l,N]=n.useState({...M}),{data:C=[],isLoading:ee}=ye(),{data:g={}}=Ne(),{data:I=[],isLoading:te}=Ce(w),O=R("instrumento_deuda"),z=je("instrumento_deuda"),A=_e("instrumento_deuda"),F=R("movimiento_deuda"),ae=n.useMemo(()=>Object.entries(U).map(([e,a])=>({value:e,label:a})),[]),se=n.useMemo(()=>Object.entries($).map(([e,a])=>({value:e,label:a.label})),[]),oe=n.useMemo(()=>H.map(e=>({value:e.key??e,label:e.label??e})),[]),ne=[{value:"fija",label:"Fija"},{value:"variable",label:"Variable"},{value:"mixta",label:"Mixta"}],o=(e,a)=>f(r=>({...r,[e]:a})),h=(e,a)=>N(r=>({...r,[e]:a})),ie=e=>({credito:"primary",emision:"info"})[e]||"default",re=e=>({vigente:"success",pagado:"info",reestructurado:"warning",vencido:"danger"})[e]||"default",le=e=>({disposicion:"info",amortizacion:"success",pago_interes:"warning",reestructura:"danger"})[e]||"default",P=e=>U[e]||e,V=e=>{const a=$[e];return a?a.label??a:e},ce=e=>{const a=H.find(r=>(r.key??r)===e);return a?a.label??a:e},de=()=>{S(null),f({...J}),m(!0)},q=e=>{S(e),f({clave:e.clave??"",descripcion:e.descripcion??"",tipo:e.tipo??"credito",acreedor:e.acreedor??"",monto_original:e.monto_original??"",saldo_vigente:e.saldo_vigente??"",tasa_interes:e.tasa_interes??"",tipo_tasa:e.tipo_tasa??"fija",plazo_meses:e.plazo_meses??"",fecha_contratacion:e.fecha_contratacion??"",fecha_vencimiento:e.fecha_vencimiento??"",moneda:e.moneda??"MXN",destino_recursos:e.destino_recursos??"",garantia:e.garantia??"",estado:e.estado??"vigente"}),m(!0)},me=async()=>{const e={...s,ente_id:b?.id,ejercicio_id:K?.id,monto_original:Number(s.monto_original)||0,saldo_vigente:Number(s.saldo_vigente)||0,tasa_interes:Number(s.tasa_interes)||0,plazo_meses:Number(s.plazo_meses)||0};p?await z.mutateAsync({id:p.id,...e}):await O.mutateAsync(e),m(!1)},ue=e=>{_(e),j(!0)},pe=async()=>{u&&await A.mutateAsync(u.id),j(!1),_(null)},xe=e=>{E(e.id),T(e),x(!1),N({...M,fecha:new Date().toISOString().split("T")[0]}),D(!0)},ge=async()=>{await F.mutateAsync({instrumento_id:w,...l,monto:Number(l.monto)||0}),x(!1),N({...M,fecha:new Date().toISOString().split("T")[0]})},he=()=>{Me(C,[{key:"clave",label:"Clave"},{key:"descripcion",label:"Descripcion"},{key:"tipo",label:"Tipo",getValue:a=>P(a.tipo)},{key:"acreedor",label:"Acreedor"},{key:"monto_original",label:"Monto Original",getValue:a=>Number(a.monto_original||0)},{key:"saldo_vigente",label:"Saldo Vigente",getValue:a=>Number(a.saldo_vigente||0)},{key:"tasa_interes",label:"Tasa %",getValue:a=>Number(a.tasa_interes||0)},{key:"fecha_vencimiento",label:"Vencimiento"},{key:"estado",label:"Estado",getValue:a=>V(a.estado)}],"deuda_publica")},ve=[{key:"fecha",label:"Fecha",width:"100px"},{key:"tipo",label:"Tipo",width:"130px",render:e=>t.jsx(k,{variant:le(e),children:ce(e)})},{key:"monto",label:"Monto",width:"130px",render:e=>t.jsx("span",{className:"text-right block tabular-nums",children:d(e)})},{key:"descripcion",label:"Descripcion"}],be=[{key:"clave",label:"Clave",width:"100px"},{key:"descripcion",label:"Descripcion"},{key:"tipo",label:"Tipo",width:"120px",render:e=>t.jsx(k,{variant:ie(e),children:P(e)})},{key:"acreedor",label:"Acreedor",width:"150px"},{key:"monto_original",label:"Monto Original",width:"130px",render:e=>t.jsx("span",{className:"text-right block tabular-nums",children:d(e)})},{key:"saldo_vigente",label:"Saldo Vigente",width:"130px",render:e=>t.jsx("span",{className:"text-right block tabular-nums",children:d(e)})},{key:"tasa_interes",label:"Tasa %",width:"80px",render:e=>`${Number(e||0).toFixed(2)}%`},{key:"fecha_vencimiento",label:"Vencimiento",width:"110px"},{key:"estado",label:"Estado",width:"120px",render:e=>t.jsx(k,{variant:re(e),children:V(e)})},{key:"id",label:"Acciones",width:"180px",sortable:!1,render:(e,a)=>t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{onClick:r=>{r.stopPropagation(),xe(a)},className:"text-xs text-info hover:text-info/80 transition-colors cursor-pointer",children:"Movimientos"}),t.jsx("button",{onClick:r=>{r.stopPropagation(),q(a)},className:"text-xs text-primary hover:text-primary-light transition-colors cursor-pointer",children:"Editar"}),t.jsx("button",{onClick:r=>{r.stopPropagation(),ue(a)},className:"text-xs text-danger hover:text-danger/80 transition-colors cursor-pointer",children:"Eliminar"})]})}],B=O.isPending||z.isPending,L=F.isPending;return t.jsxs("div",{children:[t.jsxs("div",{className:"mb-6",children:[t.jsx("h1",{className:"text-xl font-bold text-text-primary",children:"Deuda Publica"}),t.jsx("p",{className:"text-sm text-text-muted mt-1",children:"Art. 47 LGCG — Control de instrumentos de deuda publica"})]}),t.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-6",children:[t.jsxs("div",{className:"bg-white rounded-lg card-shadow p-4",children:[t.jsx("p",{className:"text-xs text-text-muted uppercase tracking-wide mb-1",children:"Saldo Total"}),t.jsx("p",{className:"text-lg font-bold text-text-primary",children:d(g.saldo_total)})]}),t.jsxs("div",{className:"bg-white rounded-lg card-shadow p-4",children:[t.jsx("p",{className:"text-xs text-text-muted uppercase tracking-wide mb-1",children:"Intereses Pagados"}),t.jsx("p",{className:"text-lg font-bold text-text-primary",children:d(g.intereses_pagados)})]}),t.jsxs("div",{className:"bg-white rounded-lg card-shadow p-4",children:[t.jsx("p",{className:"text-xs text-text-muted uppercase tracking-wide mb-1",children:"Amortizaciones"}),t.jsx("p",{className:"text-lg font-bold text-text-primary",children:d(g.amortizaciones)})]}),t.jsxs("div",{className:"bg-white rounded-lg card-shadow p-4",children:[t.jsx("p",{className:"text-xs text-text-muted uppercase tracking-wide mb-1",children:"Total Instrumentos"}),t.jsx("p",{className:"text-lg font-bold text-text-primary",children:g.total_instrumentos??0})]})]}),t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsxs("h2",{className:"text-sm font-semibold text-text-secondary",children:["Instrumentos",t.jsxs("span",{className:"ml-2 text-text-muted font-normal",children:["(",C.length," registros)"]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(c,{onClick:he,variant:"outline-primary",size:"sm",children:"Exportar Excel"}),t.jsx(c,{onClick:de,size:"sm",children:"+ Nuevo Instrumento"})]})]}),ee?t.jsx("div",{className:"flex items-center justify-center py-16 text-text-muted text-sm",children:"Cargando instrumentos de deuda..."}):t.jsx(G,{columns:be,data:C,onRowClick:q}),t.jsx(X,{open:Q,onClose:()=>m(!1),title:p?"Editar Instrumento":"Nuevo Instrumento",size:"lg",children:t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsx(i,{label:"Clave",value:s.clave,onChange:e=>o("clave",e.target.value),placeholder:"Ej. DP-001",required:!0}),t.jsx(v,{label:"Tipo",value:s.tipo,onChange:e=>o("tipo",e.target.value),options:ae,placeholder:"— Seleccione tipo —",required:!0})]}),t.jsxs("div",{className:"w-full",children:[t.jsxs("label",{className:"block text-sm font-medium text-text-heading mb-1.5",children:["Descripcion ",t.jsx("span",{className:"text-danger",children:"*"})]}),t.jsx("textarea",{value:s.descripcion,onChange:e=>o("descripcion",e.target.value),placeholder:"Descripcion del instrumento de deuda",rows:3,className:"w-full h-[40px] min-h-[80px] rounded-md border border-border px-3 py-2 text-[0.9375rem] focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda"})]}),t.jsx(i,{label:"Acreedor",value:s.acreedor,onChange:e=>o("acreedor",e.target.value),placeholder:"Nombre del acreedor o institucion",required:!0}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[t.jsx(i,{label:"Monto Original",type:"number",value:s.monto_original,onChange:e=>o("monto_original",e.target.value),placeholder:"0.00",required:!0}),t.jsx(i,{label:"Saldo Vigente",type:"number",value:s.saldo_vigente,onChange:e=>o("saldo_vigente",e.target.value),placeholder:"0.00",required:!0}),t.jsx(i,{label:"Tasa Interes (%)",type:"number",value:s.tasa_interes,onChange:e=>o("tasa_interes",e.target.value),placeholder:"0.00"})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[t.jsx(v,{label:"Tipo Tasa",value:s.tipo_tasa,onChange:e=>o("tipo_tasa",e.target.value),options:ne,placeholder:"— Seleccione —"}),t.jsx(i,{label:"Plazo (meses)",type:"number",value:s.plazo_meses,onChange:e=>o("plazo_meses",e.target.value),placeholder:"Ej. 60"}),t.jsx(i,{label:"Moneda",value:s.moneda,onChange:e=>o("moneda",e.target.value),placeholder:"MXN"})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsx(i,{label:"Fecha Contratacion",type:"date",value:s.fecha_contratacion,onChange:e=>o("fecha_contratacion",e.target.value),required:!0}),t.jsx(i,{label:"Fecha Vencimiento",type:"date",value:s.fecha_vencimiento,onChange:e=>o("fecha_vencimiento",e.target.value),required:!0})]}),t.jsxs("div",{className:"w-full",children:[t.jsx("label",{className:"block text-sm font-medium text-text-heading mb-1.5",children:"Destino de Recursos"}),t.jsx("textarea",{value:s.destino_recursos,onChange:e=>o("destino_recursos",e.target.value),placeholder:"Destino de los recursos del financiamiento",rows:2,className:"w-full h-[40px] min-h-[80px] rounded-md border border-border px-3 py-2 text-[0.9375rem] focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda"})]}),t.jsx(i,{label:"Garantia",value:s.garantia,onChange:e=>o("garantia",e.target.value),placeholder:"Tipo de garantia ofrecida"}),t.jsx(v,{label:"Estado",value:s.estado,onChange:e=>o("estado",e.target.value),options:se,placeholder:"— Seleccione estado —",required:!0}),t.jsxs("div",{className:"flex justify-end gap-3 pt-2 border-t border-border",children:[t.jsx(c,{variant:"ghost",onClick:()=>m(!1),disabled:B,children:"Cancelar"}),t.jsx(c,{onClick:me,loading:B,disabled:!s.clave.trim()||!s.descripcion.trim(),children:p?"Guardar cambios":"Crear instrumento"})]})]})}),t.jsx(X,{open:Y,onClose:()=>{D(!1),E(null),T(null)},title:`Movimientos — ${Z?.clave??""}`,size:"lg",children:t.jsxs("div",{className:"space-y-4",children:[te?t.jsx("div",{className:"flex items-center justify-center py-8 text-text-muted text-sm",children:"Cargando movimientos..."}):I.length===0&&!y?t.jsx("div",{className:"flex flex-col items-center justify-center py-8 text-text-muted",children:t.jsx("p",{className:"text-[0.9375rem]",children:"No hay movimientos registrados para este instrumento"})}):t.jsx(G,{columns:ve,data:I}),y&&t.jsxs("div",{className:"border border-border rounded-lg p-4 space-y-4 bg-[#f9fafb]",children:[t.jsx("h3",{className:"text-sm font-semibold text-text-secondary",children:"Nuevo Movimiento"}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsx(v,{label:"Tipo",value:l.tipo,onChange:e=>h("tipo",e.target.value),options:oe,placeholder:"— Seleccione tipo —",required:!0}),t.jsx(i,{label:"Monto",type:"number",value:l.monto,onChange:e=>h("monto",e.target.value),placeholder:"0.00",required:!0})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsx(i,{label:"Fecha",type:"date",value:l.fecha,onChange:e=>h("fecha",e.target.value),required:!0}),t.jsx(i,{label:"Descripcion",value:l.descripcion,onChange:e=>h("descripcion",e.target.value),placeholder:"Descripcion del movimiento"})]}),t.jsxs("div",{className:"flex justify-end gap-3",children:[t.jsx(c,{variant:"ghost",onClick:()=>x(!1),disabled:L,children:"Cancelar"}),t.jsx(c,{onClick:ge,loading:L,disabled:!l.tipo||!l.monto||!l.fecha,children:"Guardar movimiento"})]})]}),!y&&t.jsx("div",{className:"flex justify-end pt-2 border-t border-border",children:t.jsx(c,{onClick:()=>x(!0),size:"sm",children:"+ Registrar Movimiento"})})]})}),t.jsx(ke,{open:W,onClose:()=>{j(!1),_(null)},onConfirm:pe,title:"Eliminar instrumento",message:u?`¿Esta seguro de eliminar el instrumento "${u.clave} — ${u.descripcion}"? Esta accion no se puede deshacer.`:"",confirmText:"Eliminar",loading:A.isPending})]})}export{Re as default};
