import{s as u,u as E,o as P,q as S,p as B,j as e}from"./index-xuYioy8Y.js";import{b as f}from"./vendor-DEA9Ikep.js";import{u as O}from"./useCrud-BZqSYSww.js";import{r as W}from"./constants-B0qHiDNt.js";import{D as z}from"./DataTable-CoGr0iSJ.js";import{M as V}from"./Modal-BawsBw69.js";import{B as k}from"./Button-CQM7GO5t.js";import{S as C}from"./Select-CHQpqBAE.js";import{B as T}from"./Badge-DX5pclE5.js";import{C as R}from"./ConfirmDialog-BrOOKlKS.js";import"./supabase-DANKYb0E.js";import"./export-t5FFX7R_.js";async function F(t){const{data:c,error:a}=await u.from("apertura_ejercicio").select("*, ejercicio_origen:ejercicio_fiscal!ejercicio_origen_id(anio, estado), ejercicio_destino:ejercicio_fiscal!ejercicio_destino_id(anio, estado), ejecutador:usuarios!ejecutado_por(nombre)").eq("ente_id",t).order("created_at",{ascending:!1});if(a)throw a;return c}async function Q(t,c,a){const n={origenExiste:!1,origenCerrado:!1,destinoExiste:!1,destinoAbierto:!1,noExisteApertura:!0},{data:i}=await u.from("ejercicio_fiscal").select("id, anio, estado").eq("id",c).eq("ente_id",t).single();i&&(n.origenExiste=!0,n.origenCerrado=i.estado==="cerrado");const{data:m}=await u.from("ejercicio_fiscal").select("id, anio, estado").eq("id",a).eq("ente_id",t).single();m&&(n.destinoExiste=!0,n.destinoAbierto=m.estado==="abierto");const{data:s}=await u.from("apertura_ejercicio").select("id").eq("ente_id",t).eq("ejercicio_origen_id",c).eq("ejercicio_destino_id",a).maybeSingle();return s&&(n.noExisteApertura=!1),n}async function $(t,c,a,n){const{data:i,error:m}=await u.from("apertura_ejercicio").insert({ente_id:t,ejercicio_origen_id:c,ejercicio_destino_id:a,fecha_apertura:new Date().toISOString().slice(0,10),estado:"procesando",ejecutado_por:n}).select().single();if(m)throw m;try{const{data:s}=await u.from("periodo_contable").select("id").eq("ejercicio_id",c).order("numero",{ascending:!1}).limit(1);if(!s?.length)throw new Error("No se encontraron periodos en el ejercicio origen");const b=s[0].id,{data:o,error:x}=await u.from("saldo_cuenta").select("cuenta_id, saldo_final").eq("ente_id",t).eq("ejercicio_id",c).eq("periodo_id",b);if(x)throw x;const{data:v}=await u.from("periodo_contable").select("id").eq("ejercicio_id",a).order("numero",{ascending:!0}).limit(1);if(!v?.length)throw new Error("No se encontraron periodos en el ejercicio destino");const h=v[0].id,g=o.filter(d=>Number(d.saldo_final)!==0).map(d=>({ente_id:t,ejercicio_id:a,periodo_id:h,cuenta_id:d.cuenta_id,saldo_inicial:Number(d.saldo_final),total_debe:0,total_haber:0,saldo_final:Number(d.saldo_final)}));if(g.length){const{error:d}=await u.from("saldo_cuenta").insert(g);if(d)throw d}let y=0,p=0;for(const d of o){const j=Number(d.saldo_final);j>0?y+=j:p+=Math.abs(j)}const{data:N,error:_}=await u.from("apertura_ejercicio").update({estado:"completado",total_cuentas_transferidas:g.length,total_saldo_deudor:y,total_saldo_acreedor:p}).eq("id",i.id).select().single();if(_)throw _;return N}catch(s){throw await u.from("apertura_ejercicio").update({estado:"error",observaciones:s.message}).eq("id",i.id),s}}function I(){const{entePublico:t}=E();return P({queryKey:["aperturas",t?.id],queryFn:()=>F(t.id),enabled:!!t?.id})}function K(){const{entePublico:t}=E();return S({mutationFn:({ejercicioOrigenId:c,ejercicioDestinoId:a})=>Q(t.id,c,a)})}function X(){const t=B();return S({mutationFn:({enteId:c,ejercicioOrigenId:a,ejercicioDestinoId:n,ejecutadoPor:i})=>$(c,a,n,i),onSuccess:()=>{t.invalidateQueries({queryKey:["aperturas"]}),t.invalidateQueries({queryKey:["saldos_cuenta"]})}})}const A=t=>new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(t||0);function ae(){const{entePublico:t,user:c}=E(),[a,n]=f.useState(!1),[i,m]=f.useState(""),[s,b]=f.useState(""),[o,x]=f.useState(null),[v,h]=f.useState(!1),{data:g=[],isLoading:y}=I(),{data:p=[]}=O("ejercicio_fiscal",{filter:{ente_id:t?.id},order:{column:"anio",ascending:!0}}),N=f.useMemo(()=>p.map(r=>({value:r.id,label:`${r.anio}`})),[p]),_=K(),d=X(),j=f.useMemo(()=>o?o.origenExiste&&o.origenCerrado&&o.destinoExiste&&o.destinoAbierto&&o.noExisteApertura:!1,[o]),q=f.useMemo(()=>[{key:"ejercicio_origen",label:"Ejercicio Origen",width:"140px",render:(r,l)=>l.ejercicio_origen?.anio||"—"},{key:"ejercicio_destino",label:"Ejercicio Destino",width:"140px",render:(r,l)=>l.ejercicio_destino?.anio||"—"},{key:"fecha_apertura",label:"Fecha Apertura",width:"150px",render:r=>r?new Date(r).toLocaleDateString("es-MX"):"—"},{key:"estado",label:"Estado",width:"130px",render:r=>{const l=W[r];return e.jsx(T,{variant:l?.variant||"default",children:l?.label||r||"—"})}},{key:"total_cuentas_transferidas",label:"Cuentas Transferidas",width:"160px",render:r=>e.jsx("span",{className:"font-mono text-sm",children:r??0})},{key:"total_saldo_deudor",label:"Saldo Deudor",width:"150px",render:r=>e.jsx("span",{className:"font-mono text-sm text-right block tabular-nums",children:A(r)})},{key:"total_saldo_acreedor",label:"Saldo Acreedor",width:"150px",render:r=>e.jsx("span",{className:"font-mono text-sm text-right block tabular-nums",children:A(r)})},{key:"ejecutado_por",label:"Ejecutado Por",width:"150px",render:(r,l)=>l.ejecutador?.nombre||l.ejecutado_por_nombre||"—"}],[]),M=()=>{m(""),b(""),x(null),n(!0)},L=async()=>{if(!(!i||!s))try{const r=await _.mutateAsync({ejercicioOrigenId:i,ejercicioDestinoId:s});x(r)}catch{x(null)}},D=async()=>{try{await d.mutateAsync({enteId:t?.id,ejercicioOrigenId:i,ejercicioDestinoId:s,ejecutadoPor:c?.id}),h(!1),n(!1),m(""),b(""),x(null)}catch{h(!1)}},w=(r,l)=>e.jsxs("div",{className:"flex items-center gap-2.5 py-1.5",children:[l?e.jsx("div",{className:"w-5 h-5 rounded-full bg-[#71dd37]/15 flex items-center justify-center flex-shrink-0",children:e.jsx("svg",{className:"w-3.5 h-3.5 text-[#71dd37]",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"20 6 9 17 4 12"})})}):e.jsx("div",{className:"w-5 h-5 rounded-full bg-[#ff3e1d]/15 flex items-center justify-center flex-shrink-0",children:e.jsxs("svg",{className:"w-3.5 h-3.5 text-[#ff3e1d]",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})}),e.jsx("span",{className:`text-sm ${l?"text-text-primary":"text-[#ff3e1d] font-medium"}`,children:r})]});return e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-bold text-text-primary",children:"Apertura del Ejercicio"}),e.jsx("p",{className:"text-sm text-text-muted mt-1",children:"Transferencia de saldos del ejercicio anterior al nuevo ejercicio (Art. 49 LGCG)"})]}),e.jsxs(k,{onClick:M,children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 mr-1.5 inline-block",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z",clipRule:"evenodd"})}),"Nueva Apertura"]})]}),e.jsx("div",{className:"bg-white rounded-lg card-shadow p-5",children:y?e.jsx("div",{className:"flex items-center justify-center py-16",children:e.jsxs("svg",{className:"animate-spin h-8 w-8 text-guinda",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]})}):g.length===0?e.jsxs("div",{className:"text-center py-16",children:[e.jsx("div",{className:"flex justify-center mb-4",children:e.jsx("div",{className:"w-16 h-16 rounded-full bg-[#f5f5f9] flex items-center justify-center text-text-muted",children:e.jsxs("svg",{className:"w-7 h-7",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M3 3v18h18"}),e.jsx("path",{d:"M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"})]})})}),e.jsx("h3",{className:"text-[0.9375rem] font-semibold text-text-heading mb-1",children:"Sin aperturas registradas"}),e.jsx("p",{className:"text-sm text-text-muted max-w-sm mx-auto",children:'No se han realizado aperturas de ejercicio. Presione "Nueva Apertura" para iniciar el proceso.'})]}):e.jsx(z,{columns:q,data:g})}),e.jsx(V,{open:a,onClose:()=>n(!1),title:"Nueva Apertura de Ejercicio",size:"md",children:e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"text-sm font-semibold text-text-secondary mb-3 flex items-center gap-2",children:[e.jsx("span",{className:"w-5 h-5 rounded-full bg-guinda text-white text-xs flex items-center justify-center font-bold",children:"1"}),"Seleccionar ejercicios"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(C,{label:"Ejercicio Origen",placeholder:"Seleccionar...",options:N,value:i,onChange:r=>{m(r.target.value),x(null)}}),e.jsx(C,{label:"Ejercicio Destino",placeholder:"Seleccionar...",options:N,value:s,onChange:r=>{b(r.target.value),x(null)}})]})]}),e.jsxs("div",{children:[e.jsxs("h3",{className:"text-sm font-semibold text-text-secondary mb-3 flex items-center gap-2",children:[e.jsx("span",{className:"w-5 h-5 rounded-full bg-guinda text-white text-xs flex items-center justify-center font-bold",children:"2"}),"Verificar condiciones"]}),e.jsxs(k,{variant:"outline-primary",onClick:L,loading:_.isPending,disabled:!i||!s||i===s,size:"sm",children:[e.jsx("svg",{className:"w-4 h-4 mr-1.5 inline-block",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})}),"Verificar"]}),i&&s&&i===s&&e.jsx("p",{className:"text-xs text-[#ff3e1d] mt-2",children:"El ejercicio origen y destino deben ser diferentes."}),o&&e.jsxs("div",{className:"mt-4 bg-[#f9fafb] rounded-lg p-4 border border-border",children:[e.jsx("p",{className:"text-xs text-text-muted uppercase tracking-wide font-semibold mb-2",children:"Resultado de verificacion"}),w("Ejercicio origen existe",o.origenExiste),w("Ejercicio origen esta cerrado",o.origenCerrado),w("Ejercicio destino existe",o.destinoExiste),w("Ejercicio destino esta abierto",o.destinoAbierto),w("No existe apertura previa entre estos ejercicios",o.noExisteApertura),j&&e.jsx("div",{className:"mt-3 pt-3 border-t border-border",children:e.jsx("p",{className:"text-xs text-[#71dd37] font-medium",children:"Todas las verificaciones pasaron correctamente. Puede proceder con la apertura."})}),!j&&e.jsx("div",{className:"mt-3 pt-3 border-t border-border",children:e.jsx("p",{className:"text-xs text-[#ff3e1d] font-medium",children:"Algunas verificaciones no pasaron. Corrija las condiciones antes de continuar."})})]})]}),e.jsxs("div",{children:[e.jsxs("h3",{className:"text-sm font-semibold text-text-secondary mb-3 flex items-center gap-2",children:[e.jsx("span",{className:"w-5 h-5 rounded-full bg-guinda text-white text-xs flex items-center justify-center font-bold",children:"3"}),"Ejecutar apertura"]}),e.jsx("p",{className:"text-xs text-text-muted mb-3",children:"Esta operacion transferira los saldos finales del ejercicio origen como saldos iniciales del ejercicio destino. Esta accion no se puede deshacer."}),e.jsxs("div",{className:"flex justify-end gap-3 pt-2 border-t border-border",children:[e.jsx(k,{variant:"ghost",onClick:()=>n(!1),children:"Cancelar"}),e.jsxs(k,{variant:"success",onClick:()=>h(!0),disabled:!j,children:[e.jsx("svg",{className:"w-4 h-4 mr-1.5 inline-block",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 10V3L4 14h7v7l9-11h-7z"})}),"Ejecutar Apertura"]})]})]})]})}),e.jsx(R,{open:v,onClose:()=>h(!1),onConfirm:D,title:"Confirmar apertura del ejercicio",message:`Se transferiran los saldos del ejercicio ${p.find(r=>r.id===i)?.anio||""} al ejercicio ${p.find(r=>r.id===s)?.anio||""}. Esta operacion no se puede deshacer. ¿Desea continuar?`,confirmText:"Ejecutar Apertura",loading:d.isPending})]})}export{ae as default};
