import{u as Q,j as a}from"./index-CSPrBd4B.js";import{b as t}from"./vendor-DEA9Ikep.js";import{u as O,a as ee,b as ae,c as se,B as b}from"./Button-D3Vrtg19.js";import{c as re}from"./supabase-DANKYb0E.js";import{D as te}from"./DataTable-BQLGCCk4.js";import{M as oe}from"./Modal-B4ofYqvK.js";import{I as _}from"./Input-CNYH32IR.js";import{S as P}from"./Select-Ch7OX2yO.js";import{B as U}from"./Badge-BoxAYuIW.js";import{C as ne}from"./ConfirmDialog-K7f1P5fT.js";import"./export-t5FFX7R_.js";const ie="https://pfmiwusneqjplwwwlvyh.supabase.co",le="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBmbWl3dXNuZXFqcGx3d3dsdnloIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc3MDM1MjY5NCwiZXhwIjoyMDg1OTI4Njk0fQ.oNMXceNEyFmlJMJ_UfpUvbRakLhYmmxWre3dWlcqMXE",L=re(ie,le,{auth:{autoRefreshToken:!1,persistSession:!1}}),h="usuarios",B=[{value:"super_admin",label:"Super Administrador"},{value:"admin_ente",label:"Administrador de Ente"},{value:"contador_general",label:"Contador General"},{value:"contador",label:"Contador"},{value:"presupuesto",label:"Presupuesto"},{value:"tesorero",label:"Tesorero"},{value:"patrimonio",label:"Patrimonio"},{value:"auditor",label:"Auditor"},{value:"transparencia",label:"Transparencia"},{value:"consulta",label:"Solo Consulta"}],T=Object.fromEntries(B.map(g=>[g.value,g.label])),ce={super_admin:"danger",admin_ente:"warning",contador_general:"primary",contador:"info",presupuesto:"info",tesorero:"warning",patrimonio:"primary",auditor:"danger",transparencia:"success",consulta:"default"},M={nombre:"",email:"",rol:"",ente_id:"",activo:!0,password:""};function ye(){const{rol:g}=Q(),{data:u=[]}=O("ente_publico",{order:{column:"nombre",ascending:!0}}),D=t.useMemo(()=>u.map(e=>({value:e.id,label:`${e.clave} — ${e.nombre}`})),[u]),S=t.useMemo(()=>Object.fromEntries(u.map(e=>[e.id,e.nombre_corto||e.clave])),[u]),z=t.useMemo(()=>[{key:"nombre",label:"Nombre"},{key:"email",label:"Email",render:e=>a.jsx("span",{className:"font-mono text-xs text-text-secondary",children:e||"--"})},{key:"ente_id",label:"Entidad",width:"160px",render:e=>a.jsx("span",{className:"text-xs text-text-secondary",children:S[e]||(e?"...":"Global")})},{key:"rol",label:"Rol",width:"200px",render:e=>a.jsx(U,{variant:ce[e]||"default",children:T[e]||e||"--"})},{key:"activo",label:"Estado",width:"120px",render:e=>a.jsx(U,{variant:e?"success":"danger",children:e?"Activo":"Inactivo"})}],[S]),{data:G=[],isLoading:J}=O(h,{order:{column:"nombre",ascending:!0}}),v=ee(h),f=ae(h),k=se(h),[X,j]=t.useState(!1),[o,y]=t.useState(null),[s,p]=t.useState(M),[i,l]=t.useState({}),[Z,w]=t.useState(!1),[d,N]=t.useState(null),[A,I]=t.useState(!1),[C,x]=t.useState(null),$=()=>{y(null),p({...M}),l({}),j(!0)},q=e=>{y(e),p({nombre:e.nombre??"",email:e.email??"",rol:e.rol??"",ente_id:e.ente_id??"",activo:e.activo??!0}),l({}),x(null),j(!0)},E=()=>{j(!1),y(null),p(M),l({})},c=(e,r)=>{p(n=>({...n,[e]:r})),i[e]&&l(n=>{const m={...n};return delete m[e],m})},F=()=>{const e={};return s.nombre.trim()||(e.nombre="El nombre es requerido"),s.email.trim()?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s.email.trim())||(e.email="Ingrese un email valido"):e.email="El email es requerido",s.rol||(e.rol="Seleccione un rol"),s.rol&&s.rol!=="super_admin"&&!s.ente_id&&(e.ente_id="Seleccione la entidad a la que pertenece el usuario"),o||(!s.password||s.password.length<8)&&(e.password="La contrasena debe tener al menos 8 caracteres"),l(e),Object.keys(e).length===0},Y=async e=>{if(e.preventDefault(),!F())return;const r={nombre:s.nombre.trim(),email:s.email.trim().toLowerCase(),rol:s.rol,ente_id:s.ente_id||null,activo:s.activo};try{if(o)await f.mutateAsync({id:o.id,...r});else{const{data:n,error:m}=await L.auth.admin.createUser({email:r.email,password:s.password,email_confirm:!0});if(m)throw m;await v.mutateAsync({...r,auth_id:n.user.id})}E()}catch(n){n?.message?.includes("already been registered")&&l({email:"Este email ya esta registrado en el sistema"})}},V=async e=>{I(!0),x(null);try{const{error:r}=await L.auth.admin.generateLink({type:"recovery",email:e});if(r)throw r;x({ok:!0,text:"Enlace de recuperacion generado. El usuario recibira un email."})}catch(r){x({ok:!1,text:r.message||"Error al enviar enlace"})}finally{I(!1)}},W=e=>{N(e),w(!0)},H=async()=>{if(d)try{await k.mutateAsync(d.id),w(!1),N(null)}catch{}},K=()=>{w(!1),N(null)},R=v.isPending||f.isPending;return a.jsxs("div",{children:[a.jsxs("div",{className:"flex items-center justify-between mb-6",children:[a.jsxs("div",{children:[a.jsx("h1",{className:"text-xl font-bold text-text-primary",children:"Gestion de Usuarios"}),a.jsx("p",{className:"text-sm text-text-muted mt-1",children:"Art. 84 — Control de acceso basado en roles (RBAC)"})]}),a.jsxs(b,{onClick:$,children:[a.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor",children:a.jsx("path",{fillRule:"evenodd",d:"M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z",clipRule:"evenodd"})}),"Nuevo Usuario"]})]}),a.jsx("div",{className:"bg-white rounded-lg card-shadow p-5",children:J?a.jsxs("div",{className:"flex items-center justify-center py-16",children:[a.jsxs("svg",{className:"animate-spin h-6 w-6 text-primary",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[a.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),a.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),a.jsx("span",{className:"ml-3 text-sm text-text-muted",children:"Cargando usuarios..."})]}):a.jsx(te,{columns:z,data:G,onRowClick:q})}),a.jsx(oe,{open:X,onClose:E,title:o?"Editar Usuario":"Nuevo Usuario",size:"md",children:a.jsxs("form",{onSubmit:Y,className:"space-y-4",children:[a.jsx(_,{label:"Nombre *",placeholder:"Nombre completo del usuario",value:s.nombre,onChange:e=>c("nombre",e.target.value),error:i.nombre}),a.jsx(_,{label:"Email *",type:"email",placeholder:"correo@ejemplo.gob.mx",value:s.email,onChange:e=>c("email",e.target.value),error:i.email}),a.jsx(P,{label:"Rol *",placeholder:"Seleccionar rol...",options:B,value:s.rol,onChange:e=>c("rol",e.target.value),error:i.rol}),s.rol!=="super_admin"&&a.jsx(P,{label:`Ente Publico ${s.rol&&s.rol!=="super_admin"?"*":""}`,placeholder:"Seleccionar entidad...",options:D,value:s.ente_id,onChange:e=>c("ente_id",e.target.value),error:i.ente_id}),s.rol==="super_admin"&&a.jsx("div",{className:"bg-bg-hover rounded-md p-3",children:a.jsxs("p",{className:"text-xs text-text-muted",children:[a.jsx("span",{className:"font-semibold text-text-secondary",children:"Super Administrador"})," tiene acceso global a todas las entidades del sistema."]})}),!o&&a.jsx(_,{label:"Contrasena *",type:"password",placeholder:"Minimo 8 caracteres",value:s.password,onChange:e=>c("password",e.target.value),error:i.password}),a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("input",{id:"usuario-activo",type:"checkbox",checked:s.activo,onChange:e=>c("activo",e.target.checked),className:"h-4 w-4 rounded border-border text-primary focus:ring-primary/30 cursor-pointer"}),a.jsx("label",{htmlFor:"usuario-activo",className:"text-sm font-medium text-text-secondary cursor-pointer select-none",children:"Usuario activo"})]}),o&&a.jsxs("div",{className:"border border-border rounded-md p-3",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{children:[a.jsx("p",{className:"text-sm font-medium text-text-heading",children:"Contrasena"}),a.jsx("p",{className:"text-xs text-text-muted mt-0.5",children:"Enviar enlace para restablecer contrasena"})]}),a.jsx("button",{type:"button",onClick:()=>V(o.email),disabled:A,className:"h-[34px] px-3 text-xs font-medium rounded-md border border-guinda text-guinda hover:bg-guinda/5 transition-colors cursor-pointer disabled:opacity-50",children:A?"Enviando...":"Enviar Enlace"})]}),C&&a.jsx("p",{className:`text-xs mt-2 ${C.ok?"text-verde":"text-danger"}`,children:C.text})]}),s.rol&&a.jsxs("div",{className:"bg-bg-hover rounded-md p-3",children:[a.jsxs("p",{className:"text-xs text-text-muted",children:[a.jsx("span",{className:"font-semibold text-text-secondary",children:"Rol seleccionado: "}),T[s.rol]]}),a.jsxs("p",{className:"text-xs text-text-muted mt-1",children:[s.rol==="super_admin"&&"Acceso total al sistema. Puede gestionar todos los entes, usuarios y configuraciones.",s.rol==="admin_ente"&&"Administrador de un ente publico especifico. Puede gestionar usuarios y configuraciones del ente.",s.rol==="contador_general"&&"Acceso a todos los modulos contables. Puede registrar y aprobar polizas.",s.rol==="contador"&&"Acceso a modulos contables asignados. Puede registrar polizas.",s.rol==="presupuesto"&&"Gestion del presupuesto de ingresos y egresos.",s.rol==="tesorero"&&"Gestion de fondos, bancos y conciliaciones bancarias.",s.rol==="patrimonio"&&"Gestion de bienes muebles e inmuebles del ente.",s.rol==="auditor"&&"Acceso de solo lectura a todos los modulos para auditoria.",s.rol==="transparencia"&&"Acceso a reportes y generacion de informes de transparencia.",s.rol==="consulta"&&"Acceso de solo lectura a modulos autorizados."]})]}),(v.isError||f.isError)&&a.jsx("div",{className:"p-3 rounded-lg border border-danger/30 bg-danger/5 text-sm text-danger",children:"Ocurrio un error al guardar. Por favor intente de nuevo."}),a.jsxs("div",{className:"flex items-center justify-between pt-4 border-t border-border",children:[a.jsx("div",{children:o&&a.jsx(b,{variant:"danger",type:"button",size:"sm",onClick:()=>W(o),children:"Eliminar"})}),a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx(b,{variant:"ghost",type:"button",onClick:E,disabled:R,children:"Cancelar"}),a.jsx(b,{type:"submit",loading:R,children:o?"Guardar Cambios":"Crear Usuario"})]})]})]})}),a.jsx(ne,{open:Z,onClose:K,onConfirm:H,title:"Eliminar Usuario",message:d?`Esta seguro de eliminar al usuario "${d.nombre}" (${d.email})? Esta accion no se puede deshacer.`:"",confirmText:"Eliminar",cancelText:"Cancelar",variant:"danger",loading:k.isPending})]})}export{ye as default};
