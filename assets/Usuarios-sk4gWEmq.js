import{u as Y,j as e}from"./index-C7O7P87m.js";import{b as n}from"./vendor-DEA9Ikep.js";import{u as V,a as W,b as $,c as H,B as b}from"./Button-DSFUuRiE.js";import{c as K}from"./supabase-DANKYb0E.js";import{D as Q}from"./DataTable-wHfPkz6g.js";import{M as ee}from"./Modal-DLp9MTwE.js";import{I as E}from"./Input-B5i4Vmf0.js";import{S as ae}from"./Select-Bs0hNJCZ.js";import{B as S}from"./Badge-DFM6rO93.js";import{C as se}from"./ConfirmDialog-CJrDnoxI.js";import"./export-t5FFX7R_.js";const re="https://pfmiwusneqjplwwwlvyh.supabase.co",te="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBmbWl3dXNuZXFqcGx3d3dsdnloIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc3MDM1MjY5NCwiZXhwIjoyMDg1OTI4Njk0fQ.oNMXceNEyFmlJMJ_UfpUvbRakLhYmmxWre3dWlcqMXE",_=K(re,te,{auth:{autoRefreshToken:!1,persistSession:!1}}),h="usuarios",O=[{value:"super_admin",label:"Super Administrador"},{value:"admin_ente",label:"Administrador de Ente"},{value:"contador_general",label:"Contador General"},{value:"contador",label:"Contador"},{value:"presupuesto",label:"Presupuesto"},{value:"tesorero",label:"Tesorero"},{value:"patrimonio",label:"Patrimonio"},{value:"auditor",label:"Auditor"},{value:"transparencia",label:"Transparencia"},{value:"consulta",label:"Solo Consulta"}],P=Object.fromEntries(O.map(r=>[r.value,r.label])),oe={super_admin:"danger",admin_ente:"warning",contador_general:"primary",contador:"info",presupuesto:"info",tesorero:"warning",patrimonio:"primary",auditor:"danger",transparencia:"success",consulta:"default"},M={nombre:"",email:"",rol:"",activo:!0,password:""},ne=[{key:"nombre",label:"Nombre"},{key:"email",label:"Email",render:r=>e.jsx("span",{className:"font-mono text-xs text-text-secondary",children:r||"--"})},{key:"rol",label:"Rol",width:"200px",render:r=>e.jsx(S,{variant:oe[r]||"default",children:P[r]||r||"--"})},{key:"activo",label:"Estado",width:"120px",render:r=>e.jsx(S,{variant:r?"success":"danger",children:r?"Activo":"Inactivo"})}];function fe(){const{rol:r}=Y(),{data:U=[],isLoading:L}=V(h,{order:{column:"nombre",ascending:!0}}),g=W(h),f=$(h),k=H(h),[T,v]=n.useState(!1),[o,j]=n.useState(null),[s,p]=n.useState(M),[c,l]=n.useState({}),[B,y]=n.useState(!1),[d,w]=n.useState(null),[A,I]=n.useState(!1),[N,x]=n.useState(null),D=()=>{j(null),p({...M}),l({}),v(!0)},z=a=>{j(a),p({nombre:a.nombre??"",email:a.email??"",rol:a.rol??"",activo:a.activo??!0}),l({}),x(null),v(!0)},C=()=>{v(!1),j(null),p(M),l({})},m=(a,t)=>{p(i=>({...i,[a]:t})),c[a]&&l(i=>{const u={...i};return delete u[a],u})},G=()=>{const a={};return s.nombre.trim()||(a.nombre="El nombre es requerido"),s.email.trim()?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s.email.trim())||(a.email="Ingrese un email valido"):a.email="El email es requerido",s.rol||(a.rol="Seleccione un rol"),o||(!s.password||s.password.length<8)&&(a.password="La contrasena debe tener al menos 8 caracteres"),l(a),Object.keys(a).length===0},J=async a=>{if(a.preventDefault(),!G())return;const t={nombre:s.nombre.trim(),email:s.email.trim().toLowerCase(),rol:s.rol,activo:s.activo};try{if(o)await f.mutateAsync({id:o.id,...t});else{const{data:i,error:u}=await _.auth.admin.createUser({email:t.email,password:s.password,email_confirm:!0});if(u)throw u;await g.mutateAsync({...t,auth_id:i.user.id})}C()}catch(i){i?.message?.includes("already been registered")&&l({email:"Este email ya esta registrado en el sistema"})}},X=async a=>{I(!0),x(null);try{const{error:t}=await _.auth.admin.generateLink({type:"recovery",email:a});if(t)throw t;x({ok:!0,text:"Enlace de recuperacion generado. El usuario recibira un email."})}catch(t){x({ok:!1,text:t.message||"Error al enviar enlace"})}finally{I(!1)}},Z=a=>{w(a),y(!0)},F=async()=>{if(d)try{await k.mutateAsync(d.id),y(!1),w(null)}catch{}},q=()=>{y(!1),w(null)},R=g.isPending||f.isPending;return e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-bold text-text-primary",children:"Gestion de Usuarios"}),e.jsx("p",{className:"text-sm text-text-muted mt-1",children:"Art. 84 â€” Control de acceso basado en roles (RBAC)"})]}),e.jsxs(b,{onClick:D,children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z",clipRule:"evenodd"})}),"Nuevo Usuario"]})]}),e.jsx("div",{className:"bg-white rounded-lg card-shadow p-5",children:L?e.jsxs("div",{className:"flex items-center justify-center py-16",children:[e.jsxs("svg",{className:"animate-spin h-6 w-6 text-primary",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),e.jsx("span",{className:"ml-3 text-sm text-text-muted",children:"Cargando usuarios..."})]}):e.jsx(Q,{columns:ne,data:U,onRowClick:z})}),e.jsx(ee,{open:T,onClose:C,title:o?"Editar Usuario":"Nuevo Usuario",size:"md",children:e.jsxs("form",{onSubmit:J,className:"space-y-4",children:[e.jsx(E,{label:"Nombre *",placeholder:"Nombre completo del usuario",value:s.nombre,onChange:a=>m("nombre",a.target.value),error:c.nombre}),e.jsx(E,{label:"Email *",type:"email",placeholder:"correo@ejemplo.gob.mx",value:s.email,onChange:a=>m("email",a.target.value),error:c.email}),e.jsx(ae,{label:"Rol *",placeholder:"Seleccionar rol...",options:O,value:s.rol,onChange:a=>m("rol",a.target.value),error:c.rol}),!o&&e.jsx(E,{label:"Contrasena *",type:"password",placeholder:"Minimo 8 caracteres",value:s.password,onChange:a=>m("password",a.target.value),error:c.password}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{id:"usuario-activo",type:"checkbox",checked:s.activo,onChange:a=>m("activo",a.target.checked),className:"h-4 w-4 rounded border-border text-primary focus:ring-primary/30 cursor-pointer"}),e.jsx("label",{htmlFor:"usuario-activo",className:"text-sm font-medium text-text-secondary cursor-pointer select-none",children:"Usuario activo"})]}),o&&e.jsxs("div",{className:"border border-border rounded-md p-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-text-heading",children:"Contrasena"}),e.jsx("p",{className:"text-xs text-text-muted mt-0.5",children:"Enviar enlace para restablecer contrasena"})]}),e.jsx("button",{type:"button",onClick:()=>X(o.email),disabled:A,className:"h-[34px] px-3 text-xs font-medium rounded-md border border-guinda text-guinda hover:bg-guinda/5 transition-colors cursor-pointer disabled:opacity-50",children:A?"Enviando...":"Enviar Enlace"})]}),N&&e.jsx("p",{className:`text-xs mt-2 ${N.ok?"text-verde":"text-danger"}`,children:N.text})]}),s.rol&&e.jsxs("div",{className:"bg-bg-hover rounded-md p-3",children:[e.jsxs("p",{className:"text-xs text-text-muted",children:[e.jsx("span",{className:"font-semibold text-text-secondary",children:"Rol seleccionado: "}),P[s.rol]]}),e.jsxs("p",{className:"text-xs text-text-muted mt-1",children:[s.rol==="super_admin"&&"Acceso total al sistema. Puede gestionar todos los entes, usuarios y configuraciones.",s.rol==="admin_ente"&&"Administrador de un ente publico especifico. Puede gestionar usuarios y configuraciones del ente.",s.rol==="contador_general"&&"Acceso a todos los modulos contables. Puede registrar y aprobar polizas.",s.rol==="contador"&&"Acceso a modulos contables asignados. Puede registrar polizas.",s.rol==="presupuesto"&&"Gestion del presupuesto de ingresos y egresos.",s.rol==="tesorero"&&"Gestion de fondos, bancos y conciliaciones bancarias.",s.rol==="patrimonio"&&"Gestion de bienes muebles e inmuebles del ente.",s.rol==="auditor"&&"Acceso de solo lectura a todos los modulos para auditoria.",s.rol==="transparencia"&&"Acceso a reportes y generacion de informes de transparencia.",s.rol==="consulta"&&"Acceso de solo lectura a modulos autorizados."]})]}),(g.isError||f.isError)&&e.jsx("div",{className:"p-3 rounded-lg border border-danger/30 bg-danger/5 text-sm text-danger",children:"Ocurrio un error al guardar. Por favor intente de nuevo."}),e.jsxs("div",{className:"flex items-center justify-between pt-4 border-t border-border",children:[e.jsx("div",{children:o&&e.jsx(b,{variant:"danger",type:"button",size:"sm",onClick:()=>Z(o),children:"Eliminar"})}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(b,{variant:"ghost",type:"button",onClick:C,disabled:R,children:"Cancelar"}),e.jsx(b,{type:"submit",loading:R,children:o?"Guardar Cambios":"Crear Usuario"})]})]})]})}),e.jsx(se,{open:B,onClose:q,onConfirm:F,title:"Eliminar Usuario",message:d?`Esta seguro de eliminar al usuario "${d.nombre}" (${d.email})? Esta accion no se puede deshacer.`:"",confirmText:"Eliminar",cancelText:"Cancelar",variant:"danger",loading:k.isPending})]})}export{fe as default};
