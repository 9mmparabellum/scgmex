import{u as Q,A as W,j as a}from"./index-CPaKNtDw.js";import{c as Z,b as i}from"./vendor-DEA9Ikep.js";import{a as ee}from"./useObraPublica-mhUE7uf2.js";import{useCreate as ae,useUpdate as oe,useRemove as te}from"./useCrud-BktvsPeN.js";import{w as y,x as S,y as j}from"./constants-CX_We7cr.js";import{D as re}from"./DataTable-HS7RLNYY.js";import{M as ie}from"./Modal-BiK_8Ur7.js";import{B as p}from"./Button-BnoK6vsi.js";import{I as s}from"./Input-DL7Lvbg0.js";import{S as C}from"./Select-C_7OhVDc.js";import{B as D}from"./Badge-CGz_j3CN.js";import{C as ne}from"./ConfirmDialog-DLbWcXIK.js";import{e as se}from"./exportHelpers-CvXmrB4L.js";import"./supabase-DANKYb0E.js";import"./export-t5FFX7R_.js";const ce=c=>new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(c||0),N=()=>new Date().toISOString().slice(0,10),A={nombre:"",clave:"",tipo:"obra_publica",modalidad_contratacion:"licitacion_publica",contratista:"",monto_contratado:"",monto_ejercido:"",avance_fisico:"",fecha_inicio:N(),fecha_fin_programada:"",estado:"planeacion",descripcion:""};function Ne(){const c=Z(),{entePublico:F,ejercicioFiscal:T,rol:I}=Q(),b=W(I,"obra_publica"),[R,l]=i.useState(!1),[d,k]=i.useState(null),[t,x]=i.useState({...A}),[q,g]=i.useState(!1),[m,f]=i.useState(null),[u,V]=i.useState(""),{data:h=[],isLoading:B}=ee(),E=ae("proyecto_obra"),O=oe("proyecto_obra"),M=te("proyecto_obra"),v=i.useMemo(()=>u?h.filter(e=>e.estado===u):h,[h,u]),z=i.useMemo(()=>Object.entries(y).map(([e,o])=>({value:e,label:o})),[]),$=i.useMemo(()=>Object.entries(S).map(([e,o])=>({value:e,label:o})),[]),_=i.useMemo(()=>Object.entries(j).map(([e,{label:o}])=>({value:e,label:o})),[]),w=i.useMemo(()=>[{value:"",label:"Todos los estados"},..._],[_]),r=(e,o)=>x(n=>({...n,[e]:o})),L=()=>{k(null),x({...A,fecha_inicio:N()}),l(!0)},X=e=>{k(e),x({nombre:e.nombre??"",clave:e.clave??"",tipo:e.tipo??"obra_publica",modalidad_contratacion:e.modalidad_contratacion??"licitacion_publica",contratista:e.contratista??"",monto_contratado:e.monto_contratado??"",monto_ejercido:e.monto_ejercido??"",avance_fisico:e.avance_fisico??"",fecha_inicio:e.fecha_inicio??N(),fecha_fin_programada:e.fecha_fin_programada??"",estado:e.estado??"planeacion",descripcion:e.descripcion??""}),l(!0)},Y=async()=>{const e={...t,ente_id:F?.id,ejercicio_id:T?.id,monto_contratado:Number(t.monto_contratado)||0,monto_ejercido:Number(t.monto_ejercido)||0,avance_fisico:Number(t.avance_fisico)||0,fecha_fin_programada:t.fecha_fin_programada||null};d?await O.mutateAsync({id:d.id,...e}):await E.mutateAsync(e),l(!1)},G=e=>{f(e),g(!0)},U=async()=>{m&&await M.mutateAsync(m.id),g(!1),f(null)},H=e=>{c(`/obra-publica/proyectos/${e.id}`)},J=()=>{se(v,[{key:"clave",label:"Clave"},{key:"nombre",label:"Nombre"},{key:"tipo",label:"Tipo",getValue:o=>y[o.tipo]||o.tipo},{key:"modalidad_contratacion",label:"Modalidad",getValue:o=>S[o.modalidad_contratacion]||o.modalidad_contratacion},{key:"contratista",label:"Contratista"},{key:"monto_contratado",label:"Monto Contratado",getValue:o=>Number(o.monto_contratado||0)},{key:"monto_ejercido",label:"Monto Ejercido",getValue:o=>Number(o.monto_ejercido||0)},{key:"avance_fisico",label:"Avance Fisico %",getValue:o=>Number(o.avance_fisico||0)},{key:"fecha_inicio",label:"Fecha Inicio"},{key:"fecha_fin_programada",label:"Fecha Fin Programada"},{key:"estado",label:"Estado",getValue:o=>j[o.estado]?.label||o.estado},{key:"descripcion",label:"Descripcion"}],"proyectos_obra")},K=i.useMemo(()=>[{key:"clave",label:"Clave",width:"110px"},{key:"nombre",label:"Nombre"},{key:"tipo",label:"Tipo",width:"160px",render:e=>y[e]||e||"—"},{key:"contratista",label:"Contratista",width:"180px",render:e=>e||"—"},{key:"monto_contratado",label:"Monto Contratado",width:"160px",render:e=>a.jsx("span",{className:"text-right block tabular-nums",children:ce(e)})},{key:"avance_fisico",label:"Avance",width:"100px",render:e=>{const o=Number(e||0),n=o>=80?"success":o>=40?"warning":"default";return a.jsxs(D,{variant:n,children:[o.toFixed(0),"%"]})}},{key:"estado",label:"Estado",width:"130px",render:e=>{const o=j[e]||{label:e,variant:"default"};return a.jsx(D,{variant:o.variant,children:o.label})}},{key:"id",label:"Acciones",width:"160px",sortable:!1,render:(e,o)=>a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("button",{onClick:n=>{n.stopPropagation(),c(`/obra-publica/proyectos/${o.id}`)},className:"text-xs text-info hover:text-info/80 transition-colors cursor-pointer",children:"Ver"}),b&&a.jsxs(a.Fragment,{children:[a.jsx("button",{onClick:n=>{n.stopPropagation(),X(o)},className:"text-xs text-primary hover:text-primary-light transition-colors cursor-pointer",children:"Editar"}),a.jsx("button",{onClick:n=>{n.stopPropagation(),G(o)},className:"text-xs text-danger hover:text-danger/80 transition-colors cursor-pointer",children:"Eliminar"})]})]})}],[b,c]),P=E.isPending||O.isPending;return a.jsxs("div",{children:[a.jsxs("div",{className:"mb-6",children:[a.jsx("h1",{className:"text-xl font-bold text-text-primary",children:"Proyectos de Obra Publica"}),a.jsx("p",{className:"text-sm text-text-muted mt-1",children:"Registro y seguimiento de proyectos de obra publica del ejercicio fiscal"})]}),a.jsxs("div",{className:"flex items-center justify-between mb-4",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsxs("h2",{className:"text-sm font-semibold text-text-secondary",children:["Proyectos",a.jsxs("span",{className:"ml-2 text-text-muted font-normal",children:["(",v.length," registros)"]})]}),a.jsx("select",{value:u,onChange:e=>V(e.target.value),className:"h-[38px] rounded-md border border-border text-[0.8125rem] px-3 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda",children:w.map(e=>a.jsx("option",{value:e.value,children:e.label},e.value))})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(p,{onClick:J,variant:"outline-primary",size:"sm",children:"Exportar Excel"}),b&&a.jsx(p,{onClick:L,size:"sm",children:"+ Nuevo Proyecto"})]})]}),B?a.jsx("div",{className:"flex items-center justify-center py-16 text-text-muted text-sm",children:"Cargando proyectos de obra publica..."}):a.jsx(re,{columns:K,data:v,onRowClick:H}),a.jsx(ie,{open:R,onClose:()=>l(!1),title:d?"Editar Proyecto":"Nuevo Proyecto",size:"lg",children:a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[a.jsx(s,{label:"Nombre del Proyecto",value:t.nombre,onChange:e=>r("nombre",e.target.value),placeholder:"Nombre del proyecto",required:!0}),a.jsx(s,{label:"Clave",value:t.clave,onChange:e=>r("clave",e.target.value),placeholder:"Ej. OP-2026-001",required:!0})]}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[a.jsx(C,{label:"Tipo de Proyecto",value:t.tipo,onChange:e=>r("tipo",e.target.value),options:z,placeholder:"-- Seleccione tipo --",required:!0}),a.jsx(C,{label:"Modalidad de Contratacion",value:t.modalidad_contratacion,onChange:e=>r("modalidad_contratacion",e.target.value),options:$,placeholder:"-- Seleccione modalidad --",required:!0})]}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[a.jsx(s,{label:"Contratista",value:t.contratista,onChange:e=>r("contratista",e.target.value),placeholder:"Nombre del contratista"}),a.jsx(C,{label:"Estado",value:t.estado,onChange:e=>r("estado",e.target.value),options:_,placeholder:"-- Seleccione estado --",required:!0})]}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[a.jsx(s,{label:"Monto Contratado",type:"number",value:t.monto_contratado,onChange:e=>r("monto_contratado",e.target.value),placeholder:"0.00",required:!0}),a.jsx(s,{label:"Monto Ejercido",type:"number",value:t.monto_ejercido,onChange:e=>r("monto_ejercido",e.target.value),placeholder:"0.00"}),a.jsx(s,{label:"Avance Fisico (%)",type:"number",value:t.avance_fisico,onChange:e=>r("avance_fisico",e.target.value),placeholder:"0"})]}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[a.jsx(s,{label:"Fecha de Inicio",type:"date",value:t.fecha_inicio,onChange:e=>r("fecha_inicio",e.target.value),required:!0}),a.jsx(s,{label:"Fecha Fin Programada",type:"date",value:t.fecha_fin_programada,onChange:e=>r("fecha_fin_programada",e.target.value)})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Descripcion"}),a.jsx("textarea",{value:t.descripcion,onChange:e=>r("descripcion",e.target.value),placeholder:"Describa el proyecto de obra publica",rows:3,className:"w-full h-auto rounded-md border border-border text-[0.9375rem] px-3 py-2 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda"})]}),a.jsxs("div",{className:"flex justify-end gap-3 pt-2 border-t border-border",children:[a.jsx(p,{variant:"ghost",onClick:()=>l(!1),disabled:P,children:"Cancelar"}),a.jsx(p,{onClick:Y,loading:P,disabled:!t.nombre.trim()||!t.clave.trim(),children:d?"Guardar cambios":"Crear proyecto"})]})]})}),a.jsx(ne,{open:q,onClose:()=>{g(!1),f(null)},onConfirm:U,title:"Eliminar proyecto",message:m?`¿Esta seguro de eliminar el proyecto "${m.nombre}"? Esta accion no se puede deshacer.`:"",confirmText:"Eliminar",loading:M.isPending})]})}export{Ne as default};
