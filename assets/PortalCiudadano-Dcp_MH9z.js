import{s as A,u as E,o as L,A as ae,j as t}from"./index-w8y8owqO.js";import{b as s}from"./vendor-DEA9Ikep.js";import{useCreate as ie,useUpdate as oe,useRemove as se}from"./useCrud-BtFPgtI3.js";import{K as g,L as v}from"./constants-CX_We7cr.js";import{D as le}from"./DataTable-BSU7FwdU.js";import{M as ne}from"./Modal-BIIwL78L.js";import{B as j}from"./Button-BNgFL-Nv.js";import{I as y}from"./Input-pbRyI1ph.js";import{S as R}from"./Select-BDMENQev.js";import{B as ce}from"./Badge-CBnEW2x0.js";import{C as re}from"./ConfirmDialog-CEB8zrmM.js";import{e as de}from"./exportHelpers-CvXmrB4L.js";import"./supabase-DANKYb0E.js";import"./export-t5FFX7R_.js";async function ue(i,o){const{data:d,error:l}=await A.from("publicacion_portal").select("*").eq("ente_id",i).eq("ejercicio_id",o).order("fecha_publicacion",{ascending:!1});if(l)throw l;return d}async function pe(i,o){const{data:d}=await A.from("publicacion_portal").select("id, tipo, estado").eq("ente_id",i).eq("ejercicio_id",o),l=d||[];return{total:l.length,publicados:l.filter(r=>r.estado==="publicado").length,enRevision:l.filter(r=>r.estado==="revision").length,borradores:l.filter(r=>r.estado==="borrador").length}}function me(){const{entePublico:i,ejercicioFiscal:o}=E();return L({queryKey:["publicaciones_portal",i?.id,o?.id],queryFn:()=>ue(i.id,o.id),enabled:!!i?.id&&!!o?.id})}function be(){const{entePublico:i,ejercicioFiscal:o}=E();return L({queryKey:["resumen_portal",i?.id,o?.id],queryFn:()=>pe(i.id,o.id),enabled:!!i?.id&&!!o?.id})}const k=()=>new Date().toISOString().slice(0,10),w={titulo:"",tipo:"estado_financiero",descripcion:"",contenido:"",fecha_publicacion:k(),fecha_vigencia:"",url_documento:"",estado:"borrador"};function Se(){const{entePublico:i,ejercicioFiscal:o,rol:d}=E(),l=ae(d,"portal"),[r,u]=s.useState(!1),[m,T]=s.useState(null),[n,_]=s.useState({...w}),[I,C]=s.useState(!1),[b,N]=s.useState(null),[x,B]=s.useState(""),[f,U]=s.useState(""),{data:S=[],isLoading:V}=me(),{data:h={},isLoading:z}=be(),O=ie("publicacion_portal"),D=oe("publicacion_portal"),F=se("publicacion_portal"),K=s.useMemo(()=>Object.entries(g).map(([e,a])=>({value:e,label:a})),[]),G=s.useMemo(()=>Object.entries(v).map(([e,{label:a}])=>({value:e,label:a})),[]),Q=s.useMemo(()=>[{value:"",label:"Todos los tipos"},...Object.entries(g).map(([e,a])=>({value:e,label:a}))],[]),$=s.useMemo(()=>[{value:"",label:"Todos los estados"},...Object.entries(v).map(([e,{label:a}])=>({value:e,label:a}))],[]),P=s.useMemo(()=>{let e=S;return x&&(e=e.filter(a=>a.tipo===x)),f&&(e=e.filter(a=>a.estado===f)),e},[S,x,f]),c=(e,a)=>_(p=>({...p,[e]:a})),H=(e,a=50)=>e?e.length>a?e.slice(0,a)+"...":e:"",J=[{label:"Total Publicaciones",value:h.total||0},{label:"Publicados",value:h.publicados||0},{label:"En Revision",value:h.enRevision||0},{label:"Borradores",value:h.borradores||0}],W=()=>{T(null),_({...w,fecha_publicacion:k()}),u(!0)},q=e=>{T(e),_({titulo:e.titulo??"",tipo:e.tipo??"estado_financiero",descripcion:e.descripcion??"",contenido:e.contenido??"",fecha_publicacion:e.fecha_publicacion??k(),fecha_vigencia:e.fecha_vigencia??"",url_documento:e.url_documento??"",estado:e.estado??"borrador"}),u(!0)},X=async()=>{const e={...n,ente_id:i?.id,ejercicio_id:o?.id,fecha_vigencia:n.fecha_vigencia||null};m?await D.mutateAsync({id:m.id,...e}):await O.mutateAsync(e),u(!1)},Y=e=>{N(e),C(!0)},Z=async()=>{b&&await F.mutateAsync(b.id),C(!1),N(null)},ee=()=>{de(P,[{key:"titulo",label:"Titulo"},{key:"tipo",label:"Tipo",getValue:a=>g[a.tipo]||a.tipo},{key:"descripcion",label:"Descripcion"},{key:"fecha_publicacion",label:"Fecha Publicacion"},{key:"fecha_vigencia",label:"Fecha Vigencia"},{key:"url_documento",label:"URL Documento"},{key:"estado",label:"Estado",getValue:a=>v[a.estado]?.label||a.estado}],"publicaciones_portal")},te=s.useMemo(()=>[{key:"titulo",label:"Titulo"},{key:"tipo",label:"Tipo",width:"160px",render:e=>g[e]||e},{key:"descripcion",label:"Descripcion",width:"220px",render:e=>t.jsx("span",{title:e||"",children:H(e)})},{key:"fecha_publicacion",label:"Fecha Publicacion",width:"140px"},{key:"fecha_vigencia",label:"Fecha Vigencia",width:"130px"},{key:"estado",label:"Estado",width:"130px",render:e=>{const a=v[e]||{label:e,variant:"default"};return t.jsx(ce,{variant:a.variant,children:a.label})}},{key:"id",label:"Acciones",width:"140px",sortable:!1,render:(e,a)=>t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{onClick:p=>{p.stopPropagation(),q(a)},className:"text-xs text-primary hover:text-primary-light transition-colors cursor-pointer",children:"Editar"}),l&&t.jsx("button",{onClick:p=>{p.stopPropagation(),Y(a)},className:"text-xs text-danger hover:text-danger/80 transition-colors cursor-pointer",children:"Eliminar"})]})}],[l]),M=O.isPending||D.isPending;return t.jsxs("div",{children:[t.jsxs("div",{className:"mb-6",children:[t.jsx("h1",{className:"text-xl font-bold text-text-primary",children:"Portal Ciudadano"}),t.jsx("p",{className:"text-sm text-text-muted mt-1",children:"Gestion de publicaciones de transparencia para el portal ciudadano"})]}),z?t.jsx("div",{className:"flex items-center justify-center py-10 text-text-muted text-sm",children:"Cargando resumen..."}):t.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-6",children:J.map(e=>t.jsxs("div",{className:"bg-white rounded-lg card-shadow p-4",children:[t.jsx("p",{className:"text-xs text-text-muted uppercase tracking-wide mb-1",children:e.label}),t.jsx("p",{className:"text-lg font-bold text-text-primary",children:e.value})]},e.label))}),t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsxs("div",{className:"flex items-center gap-4",children:[t.jsxs("h2",{className:"text-sm font-semibold text-text-secondary",children:["Publicaciones",t.jsxs("span",{className:"ml-2 text-text-muted font-normal",children:["(",P.length," registros)"]})]}),t.jsx("select",{value:x,onChange:e=>B(e.target.value),className:"h-[38px] rounded-md border border-border text-[0.9375rem] px-3 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda",children:Q.map(e=>t.jsx("option",{value:e.value,children:e.label},e.value))}),t.jsx("select",{value:f,onChange:e=>U(e.target.value),className:"h-[38px] rounded-md border border-border text-[0.9375rem] px-3 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda",children:$.map(e=>t.jsx("option",{value:e.value,children:e.label},e.value))})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(j,{onClick:ee,variant:"outline-primary",size:"sm",children:"Exportar Excel"}),l&&t.jsx(j,{onClick:W,size:"sm",children:"+ Nueva Publicacion"})]})]}),V?t.jsx("div",{className:"flex items-center justify-center py-16 text-text-muted text-sm",children:"Cargando publicaciones..."}):t.jsx(le,{columns:te,data:P,onRowClick:q}),t.jsx(ne,{open:r,onClose:()=>u(!1),title:m?"Editar Publicacion":"Nueva Publicacion",size:"lg",children:t.jsxs("div",{className:"space-y-4",children:[t.jsx(y,{label:"Titulo",value:n.titulo,onChange:e=>c("titulo",e.target.value),placeholder:"Titulo de la publicacion",required:!0}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsx(R,{label:"Tipo",value:n.tipo,onChange:e=>c("tipo",e.target.value),options:K,placeholder:"-- Seleccione tipo --",required:!0}),t.jsx(R,{label:"Estado",value:n.estado,onChange:e=>c("estado",e.target.value),options:G,placeholder:"-- Seleccione estado --",required:!0})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Descripcion"}),t.jsx("textarea",{value:n.descripcion,onChange:e=>c("descripcion",e.target.value),placeholder:"Descripcion breve de la publicacion",rows:3,className:"w-full h-auto rounded-md border border-border text-[0.9375rem] px-3 py-2 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Contenido"}),t.jsx("textarea",{value:n.contenido,onChange:e=>c("contenido",e.target.value),placeholder:"Contenido completo de la publicacion",rows:6,className:"w-full h-auto rounded-md border border-border text-[0.9375rem] px-3 py-2 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda"})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsx(y,{label:"Fecha de Publicacion",type:"date",value:n.fecha_publicacion,onChange:e=>c("fecha_publicacion",e.target.value),required:!0}),t.jsx(y,{label:"Fecha de Vigencia (opcional)",type:"date",value:n.fecha_vigencia,onChange:e=>c("fecha_vigencia",e.target.value)})]}),t.jsx(y,{label:"URL del Documento",value:n.url_documento,onChange:e=>c("url_documento",e.target.value),placeholder:"https://ejemplo.com/documento.pdf"}),t.jsxs("div",{className:"flex justify-end gap-3 pt-2 border-t border-border",children:[t.jsx(j,{variant:"ghost",onClick:()=>u(!1),disabled:M,children:"Cancelar"}),t.jsx(j,{onClick:X,loading:M,disabled:!n.titulo.trim(),children:m?"Guardar cambios":"Crear publicacion"})]})]})}),t.jsx(re,{open:I,onClose:()=>{C(!1),N(null)},onConfirm:Z,title:"Eliminar publicacion",message:b?`Â¿Esta seguro de eliminar la publicacion "${b.titulo}"? Esta accion no se puede deshacer.`:"",confirmText:"Eliminar",loading:F.isPending})]})}export{Se as default};
