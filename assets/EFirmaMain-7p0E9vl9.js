const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/useCrud-C19KmPO4.js","assets/index-KskWbqO9.js","assets/vendor-DEA9Ikep.js","assets/supabase-DANKYb0E.js","assets/export-t5FFX7R_.js","assets/index-DuiWBmwa.css"])))=>i.map(i=>d[i]);
import{_ as X}from"./export-t5FFX7R_.js";import{u as ve,A as be,j as e}from"./index-KskWbqO9.js";import{b as o}from"./vendor-DEA9Ikep.js";import{useUpdate as je,useRemove as Ce}from"./useCrud-C19KmPO4.js";import{u as _e,a as Ne,b as ye,p as ke,e as Ee,d as K}from"./useEFirma-BMoNUf6L.js";import{S,V as b}from"./constants-CX_We7cr.js";import{D as Se}from"./DataTable-DWljaDCm.js";import{M as Q}from"./Modal-DfjuYvxB.js";import{B as j}from"./Button-DGu3eAys.js";import{I as p}from"./Input-CHoXOb6x.js";import{S as U}from"./Select-k3R1vLiz.js";import{B as m}from"./Badge-B4UqNpVe.js";import{C as De}from"./ConfirmDialog-D5TWhe0q.js";import{e as Fe}from"./exportHelpers-CvXmrB4L.js";import"./supabase-DANKYb0E.js";const B=()=>new Date().toISOString().slice(0,10),J={numero_serie:"",titular:"",rfc:"",tipo:"fiel",fecha_vigencia_inicio:B(),fecha_vigencia_fin:"",estado:"vigente",emisor:"",notas:""};function He(){const{entePublico:C,rol:_}=ve(),h=be(_,"seguridad"),[D,g]=o.useState(!1),[c,q]=o.useState(null),[s,N]=o.useState({...J}),[Y,F]=o.useState(!1),[y,T]=o.useState(null),[w,z]=o.useState(null),[i,O]=o.useState(null),[R,v]=o.useState(""),[Z,V]=o.useState(!1),k=o.useRef(null),[ee,A]=o.useState(!1),[r,te]=o.useState(null),{data:I=[],isLoading:ae}=_e(),{data:f={},isLoading:ie}=Ne(),E=ye(),$=je("certificado_efirma"),G=Ce("certificado_efirma"),se=o.useMemo(()=>Object.entries(S).map(([t,a])=>({value:t,label:a})),[]),re=o.useMemo(()=>Object.entries(b).map(([t,{label:a}])=>({value:t,label:a})),[]),ne=o.useMemo(()=>{const t=f.totalCertificados||0,a=f.vigentes||0,n=f.porVencer||0,l=f.totalDocumentos||0,d=f.firmados||0,M=f.pendientes||0;return[{label:"Total Certificados",value:t,color:"text-text-primary"},{label:"Vigentes",value:a,color:"text-[#56ca00]"},{label:"Por Vencer",value:n,color:"text-[#e09600]"},{label:"Total Documentos",value:l,color:"text-text-primary"},{label:"Firmados",value:d,color:"text-[#56ca00]"},{label:"Pendientes",value:M,color:"text-[#e09600]"}]},[f]),x=(t,a)=>N(n=>({...n,[t]:a})),oe=t=>{if(t.estado!=="vigente"||!t.fecha_vigencia_fin)return!1;const a=new Date,n=new Date(t.fecha_vigencia_fin),l=720*60*60*1e3;return n.getTime()-a.getTime()<l},L=o.useCallback(async t=>{if(v(""),O(null),!t)return;if(t.name.split(".").pop().toLowerCase()!=="cer"){v("Solo se aceptan archivos con extension .cer");return}if(t.size>10240){v("El archivo es demasiado grande. Los certificados .cer no deben exceder 10 KB.");return}try{const n=await t.arrayBuffer(),l=ke(n);z(t),O(l),N(d=>({...d,numero_serie:l.numeroSerie||d.numero_serie,titular:l.titular||d.titular,rfc:l.rfc||d.rfc,emisor:l.emisor||d.emisor,fecha_vigencia_inicio:l.fechaInicio?l.fechaInicio.toISOString().slice(0,10):d.fecha_vigencia_inicio,fecha_vigencia_fin:l.fechaFin?l.fechaFin.toISOString().slice(0,10):d.fecha_vigencia_fin,estado:l.vigente?"vigente":"vencido"}))}catch(n){v(`Error al leer el certificado: ${n.message}`)}},[]),ce=o.useCallback(t=>{t.preventDefault(),V(!1);const a=t.dataTransfer?.files?.[0];a&&L(a)},[L]),le=o.useCallback(t=>{t.preventDefault(),V(!0)},[]),de=o.useCallback(()=>{V(!1)},[]),P=()=>{z(null),O(null),v(""),k.current&&(k.current.value="")},me=()=>{q(null),N({...J,fecha_vigencia_inicio:B()}),P(),g(!0)},xe=t=>{q(t),N({numero_serie:t.numero_serie??"",titular:t.titular??"",rfc:t.rfc??"",tipo:t.tipo??"fiel",fecha_vigencia_inicio:t.fecha_vigencia_inicio??B(),fecha_vigencia_fin:t.fecha_vigencia_fin??"",estado:t.estado??"vigente",emisor:t.emisor??"",notas:t.notas??""}),P(),g(!0)},H=t=>{te(t),A(!0)},ue=async()=>{if(!c&&w&&i)await E.mutateAsync({file:w,tipo:s.tipo});else if(c){const t={...s,ente_id:C?.id};await $.mutateAsync({id:c.id,...t})}else{const t={...s,ente_id:C?.id},{useCreate:a}=await X(async()=>{const{useCreate:d}=await import("./useCrud-C19KmPO4.js");return{useCreate:d}},__vite__mapDeps([0,1,2,3,4,5])),{supabase:n}=await X(async()=>{const{supabase:d}=await import("./index-KskWbqO9.js").then(M=>M.B);return{supabase:d}},__vite__mapDeps([1,2,3,4,5])),{error:l}=await n.from("certificado_efirma").insert(t);if(l)throw l}g(!1)},fe=t=>{T(t),F(!0)},pe=async()=>{y&&await G.mutateAsync(y.id),F(!1),T(null)},he=()=>{Fe(I,[{key:"numero_serie",label:"Numero de Serie"},{key:"titular",label:"Titular"},{key:"rfc",label:"RFC"},{key:"tipo",label:"Tipo",getValue:a=>S[a.tipo]||a.tipo},{key:"fecha_vigencia_inicio",label:"Fecha Inicio"},{key:"fecha_vigencia_fin",label:"Fecha Fin"},{key:"estado",label:"Estado",getValue:a=>b[a.estado]?.label||a.estado},{key:"emisor",label:"Emisor"},{key:"notas",label:"Notas"}],"certificados_efirma")},ge=o.useMemo(()=>[{key:"numero_serie",label:"Numero de Serie",width:"180px"},{key:"titular",label:"Titular"},{key:"rfc",label:"RFC",width:"140px"},{key:"tipo",label:"Tipo",width:"140px",render:t=>S[t]||t},{key:"fecha_vigencia_fin",label:"Vigencia",width:"120px"},{key:"estado",label:"Estado",width:"120px",render:(t,a)=>{const n=b[t]||{label:t,variant:"default"};return e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(m,{variant:n.variant,children:n.label}),a.certificado_pem&&e.jsx("span",{title:"Certificado cargado desde .cer",className:"text-[10px] text-[#56ca00]",children:"CER"})]})}},{key:"emisor",label:"Emisor",width:"160px",render:t=>{if(!t)return"-";const a=t.toLowerCase().includes("sat")||t.toLowerCase().includes("servicio de administracion");return e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"truncate",title:t,children:t}),a&&e.jsx(m,{variant:"success",children:"SAT"})]})}},{key:"id",label:"Acciones",width:"160px",sortable:!1,render:(t,a)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:n=>{n.stopPropagation(),H(a)},className:"text-xs text-[#03a9ce] hover:text-[#03a9ce]/80 transition-colors cursor-pointer",children:"Detalle"}),e.jsx("button",{onClick:n=>{n.stopPropagation(),xe(a)},className:"text-xs text-primary hover:text-primary-light transition-colors cursor-pointer",children:"Editar"}),h&&e.jsx("button",{onClick:n=>{n.stopPropagation(),fe(a)},className:"text-xs text-danger hover:text-danger/80 transition-colors cursor-pointer",children:"Eliminar"})]})}],[h]),W=E.isPending||$.isPending;return e.jsxs("div",{children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h1",{className:"text-xl font-bold text-text-primary",children:"e.firma / FIEL"}),e.jsx("p",{className:"text-sm text-text-muted mt-1",children:"Gestion de certificados de firma electronica y documentos firmados"})]}),ie?e.jsx("div",{className:"flex items-center justify-center py-16 text-text-muted text-sm",children:"Cargando resumen de e.firma..."}):e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6",children:ne.map(t=>e.jsxs("div",{className:"bg-white rounded-lg card-shadow p-4",children:[e.jsx("p",{className:"text-xs text-text-muted uppercase tracking-wide mb-1",children:t.label}),e.jsx("p",{className:`text-lg font-bold ${t.color}`,children:t.value})]},t.label))}),e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h2",{className:"text-sm font-semibold text-text-secondary",children:["Certificados",e.jsxs("span",{className:"ml-2 text-text-muted font-normal",children:["(",I.length," registros)"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(j,{onClick:he,variant:"outline-primary",size:"sm",children:"Exportar Excel"}),h&&e.jsx(j,{onClick:me,size:"sm",children:"+ Cargar Certificado (.cer)"})]})]}),ae?e.jsx("div",{className:"flex items-center justify-center py-16 text-text-muted text-sm",children:"Cargando certificados..."}):e.jsx(Se,{columns:ge,data:I,onRowClick:H,rowClassName:t=>oe(t)?"bg-amber-50":""}),e.jsx(Q,{open:D,onClose:()=>g(!1),title:c?"Editar Certificado":"Cargar Certificado (.cer)",size:"lg",children:e.jsxs("div",{className:"space-y-4",children:[!c&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Archivo de Certificado (.cer)"}),e.jsxs("div",{onDrop:ce,onDragOver:le,onDragLeave:de,onClick:()=>k.current?.click(),className:`
                  relative border-2 border-dashed rounded-lg p-6 text-center cursor-pointer
                  transition-colors duration-150
                  ${Z?"border-guinda bg-guinda/5":i?"border-[#56ca00] bg-[#56ca00]/5":R?"border-danger bg-danger/5":"border-border hover:border-guinda/50 hover:bg-bg-hover"}
                `,children:[e.jsx("input",{ref:k,type:"file",accept:".cer",className:"hidden",onChange:t=>{const a=t.target.files?.[0];a&&L(a)}}),i?e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 text-[#56ca00]",children:[e.jsx("svg",{className:"w-5 h-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})}),e.jsx("span",{className:"text-sm font-medium",children:"Certificado leido correctamente"})]}),e.jsx("p",{className:"text-xs text-text-muted",children:w?.name}),e.jsx("button",{type:"button",onClick:t=>{t.stopPropagation(),P()},className:"text-xs text-danger hover:text-danger/80 cursor-pointer",children:"Quitar archivo"})]}):e.jsxs("div",{className:"space-y-1",children:[e.jsx("svg",{className:"mx-auto w-8 h-8 text-text-muted",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:1.5,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M9 8.25H7.5a2.25 2.25 0 00-2.25 2.25v9a2.25 2.25 0 002.25 2.25h9a2.25 2.25 0 002.25-2.25v-9a2.25 2.25 0 00-2.25-2.25H15m0-3l-3-3m0 0l-3 3m3-3v11.25"})}),e.jsxs("p",{className:"text-sm text-text-secondary",children:["Arrastre su archivo ",e.jsx("strong",{children:".cer"})," aqui o haga clic para seleccionar"]}),e.jsx("p",{className:"text-xs text-text-muted",children:"Se leeran automaticamente: numero de serie, titular, RFC, emisor y vigencia"})]})]}),R&&e.jsx("p",{className:"mt-1 text-xs text-danger",children:R})]}),i&&!c&&e.jsxs("div",{className:"bg-[#f8f8f8] rounded-lg p-4 space-y-2",children:[e.jsx("h4",{className:"text-sm font-semibold text-text-primary mb-2",children:"Datos del certificado"}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-text-muted",children:"No. Serie:"}),e.jsx("span",{className:"ml-2 font-mono text-xs text-text-primary",children:i.numeroSerie})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-text-muted",children:"RFC:"}),e.jsx("span",{className:"ml-2 font-semibold text-text-primary",children:i.rfc||"No encontrado"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-text-muted",children:"Titular:"}),e.jsx("span",{className:"ml-2 text-text-primary",children:i.titular||"No encontrado"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-text-muted",children:"Emisor:"}),e.jsx("span",{className:"ml-2 text-text-primary",children:i.emisor||"Desconocido"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-text-muted",children:"Vigencia inicio:"}),e.jsx("span",{className:"ml-2 text-text-primary",children:i.fechaInicio?.toLocaleDateString("es-MX")||"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-text-muted",children:"Vigencia fin:"}),e.jsx("span",{className:"ml-2 text-text-primary",children:i.fechaFin?.toLocaleDateString("es-MX")||"-"})]})]}),e.jsxs("div",{className:"flex items-center gap-2 pt-2 border-t border-border/50",children:[Ee(i)&&e.jsx(m,{variant:"success",children:"SAT Verificado"}),i.vigente?e.jsx(m,{variant:"success",children:"Vigente"}):e.jsx(m,{variant:"danger",children:new Date>i.fechaFin?"Vencido":"No vigente aun"}),i.vigente&&K(i)<=30&&e.jsxs(m,{variant:"warning",children:["Vence en ",K(i)," dias"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(U,{label:"Tipo de Certificado",value:s.tipo,onChange:t=>x("tipo",t.target.value),options:se,placeholder:"-- Seleccione tipo --",required:!0}),c&&e.jsx(U,{label:"Estado",value:s.estado,onChange:t=>x("estado",t.target.value),options:re,placeholder:"-- Seleccione estado --",required:!0})]}),(c||!i)&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(p,{label:"Numero de Serie",value:s.numero_serie,onChange:t=>x("numero_serie",t.target.value),placeholder:"Ej. 30001000000400002434",required:!0,disabled:!!i&&!c}),e.jsx(p,{label:"RFC",value:s.rfc,onChange:t=>x("rfc",t.target.value),placeholder:"RFC del titular",required:!0,disabled:!!i&&!c})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(p,{label:"Titular",value:s.titular,onChange:t=>x("titular",t.target.value),placeholder:"Nombre del titular del certificado",required:!0,disabled:!!i&&!c}),e.jsx(p,{label:"Emisor",value:s.emisor,onChange:t=>x("emisor",t.target.value),placeholder:"Ej. SAT, Autoridad Certificadora",disabled:!!i&&!c})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(p,{label:"Fecha de Vigencia Inicio",type:"date",value:s.fecha_vigencia_inicio,onChange:t=>x("fecha_vigencia_inicio",t.target.value),required:!0,disabled:!!i&&!c}),e.jsx(p,{label:"Fecha de Vigencia Fin",type:"date",value:s.fecha_vigencia_fin,onChange:t=>x("fecha_vigencia_fin",t.target.value),required:!0,disabled:!!i&&!c})]})]}),c&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Notas"}),e.jsx("textarea",{value:s.notas,onChange:t=>x("notas",t.target.value),placeholder:"Observaciones o notas adicionales",rows:3,className:"w-full h-auto rounded-md border border-border text-[0.9375rem] px-3 py-2 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda"})]}),E.isError&&e.jsxs("p",{className:"text-xs text-danger",children:["Error: ",E.error?.message||"No se pudo registrar el certificado"]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-2 border-t border-border",children:[e.jsx(j,{variant:"ghost",onClick:()=>g(!1),disabled:W,children:"Cancelar"}),e.jsx(j,{onClick:ue,loading:W,disabled:(c||!i)&&(!s.numero_serie.trim()||!s.titular.trim()||!s.rfc.trim()||!s.fecha_vigencia_fin),children:c?"Guardar cambios":i?"Registrar Certificado":"Crear Certificado"})]})]})}),e.jsx(Q,{open:ee,onClose:()=>A(!1),title:"Detalle del Certificado",size:"lg",children:r&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(m,{variant:b[r.estado]?.variant||"default",children:b[r.estado]?.label||r.estado}),r.emisor&&(r.emisor.toLowerCase().includes("sat")||r.emisor.toLowerCase().includes("servicio de administracion")?e.jsx(m,{variant:"success",children:"SAT Verificado"}):e.jsx(m,{variant:"default",children:"Emisor externo"})),r.certificado_pem&&e.jsx(m,{variant:"info",children:"Archivo .cer cargado"})]}),e.jsxs("div",{className:"bg-[#f8f8f8] rounded-lg p-5 space-y-3",children:[e.jsx(u,{label:"Numero de Serie",value:r.numero_serie,mono:!0}),e.jsx(u,{label:"Titular",value:r.titular}),e.jsx(u,{label:"RFC",value:r.rfc,bold:!0}),e.jsx(u,{label:"Tipo",value:S[r.tipo]||r.tipo}),e.jsx(u,{label:"Emisor",value:r.emisor}),e.jsx(u,{label:"Vigencia Inicio",value:r.fecha_vigencia_inicio?.slice(0,10)}),e.jsx(u,{label:"Vigencia Fin",value:r.fecha_vigencia_fin?.slice(0,10)}),r.notas&&e.jsx(u,{label:"Notas",value:r.notas})]}),r.certificado_pem&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Certificado PEM"}),e.jsx("pre",{className:"bg-[#2b2c40] text-[#e0e0e0] rounded-lg p-3 text-[11px] font-mono overflow-x-auto max-h-40",children:r.certificado_pem})]}),e.jsx("div",{className:"flex justify-end pt-2 border-t border-border",children:e.jsx(j,{variant:"ghost",onClick:()=>A(!1),children:"Cerrar"})})]})}),e.jsx(De,{open:Y,onClose:()=>{F(!1),T(null)},onConfirm:pe,title:"Eliminar certificado",message:y?`Â¿Esta seguro de eliminar el certificado con numero de serie "${y.numero_serie||""}"? Esta accion no se puede deshacer.`:"",confirmText:"Eliminar",loading:G.isPending})]})}function u({label:C,value:_,mono:h=!1,bold:D=!1}){return _?e.jsxs("div",{className:"flex items-start gap-3 text-sm",children:[e.jsxs("span",{className:"text-text-muted min-w-[140px] shrink-0",children:[C,":"]}),e.jsx("span",{className:`text-text-primary ${h?"font-mono text-xs":""} ${D?"font-semibold":""}`,children:_})]}):null}export{He as default};
