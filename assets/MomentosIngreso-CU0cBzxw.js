import{u as Y,o as Z,j as o}from"./index-DlnbnB4f.js";import{b as n}from"./vendor-DEA9Ikep.js";import{u as D,a as ee,c as oe,B as h}from"./Button-DZlEhO8L.js";import{a as te}from"./presupuestoService-DQW52iiF.js";import{b,a as F}from"./constants-B9IYjURH.js";import{e as ie}from"./exportHelpers-CvXmrB4L.js";import{D as ne}from"./DataTable-ChCf_2S9.js";import{M as se}from"./Modal-BnlHmifr.js";import{I as y}from"./Input-By_Rxet1.js";import{S as c}from"./Select-hyTmOG3p.js";import{B as ae}from"./Badge-BmW5yDoH.js";import{C as re}from"./ConfirmDialog-DlyKGeom.js";import"./supabase-DANKYb0E.js";import"./export-t5FFX7R_.js";const P=r=>new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(r||0),R=()=>new Date().toISOString().slice(0,10),q={concepto_id:"",periodo_id:"",tipo_movimiento:"",monto:"",descripcion:"",fecha:R()};function _e(){const{entePublico:r,ejercicioFiscal:j}=Y(),[a,$]=n.useState(b[0].key),[d,A]=n.useState(""),[m,B]=n.useState(""),[L,p]=n.useState(!1),[i,_]=n.useState({...q}),[V,v]=n.useState(!1),[u,f]=n.useState(null),C=n.useMemo(()=>{const e={momento:a};return d&&(e.concepto_id=d),m&&(e.periodo_id=m),e},[a,d,m]),{data:g=[],isLoading:z}=Z({queryKey:["movimiento_presupuestal_ingreso",r?.id,C],queryFn:()=>te(r?.id,C),enabled:!!r?.id}),{data:x=[]}=D("concepto_ingreso",{filter:{ente_id:r?.id,ejercicio_id:j?.id}}),{data:M=[]}=D("periodo_contable",{filter:{ejercicio_id:j?.id}}),k=ee("movimiento_presupuestal_ingreso"),N=oe("movimiento_presupuestal_ingreso"),S=n.useMemo(()=>{const e={};return x.forEach(t=>{e[t.id]=t}),e},[x]),E=n.useMemo(()=>x.map(e=>({value:e.id,label:`${e.clave} — ${e.descripcion}`})),[x]),w=n.useMemo(()=>M.map(e=>({value:e.id,label:e.nombre||e.clave})),[M]),U=n.useMemo(()=>F.map(e=>({value:e.key,label:e.label})),[]),X=e=>({original:"info",adicion:"success",reduccion:"danger"})[e]||"default",O=e=>{const t=F.find(s=>s.key===e);return t?t.label:e},T=b.find(e=>e.key===a)?.label??a,G=()=>{_({...q,fecha:R()}),p(!0)},l=(e,t)=>{_(s=>({...s,[e]:t}))},K=async()=>{const e={concepto_id:i.concepto_id,periodo_id:i.periodo_id||null,momento:a,tipo_movimiento:i.tipo_movimiento,monto:Number(i.monto)||0,descripcion:i.descripcion,fecha:i.fecha};await k.mutateAsync(e),p(!1)},Q=e=>{f(e),v(!0)},H=async()=>{u&&await N.mutateAsync(u.id),v(!1),f(null)},J=()=>{ie(g,[{key:"fecha",label:"Fecha",getValue:t=>t.fecha},{key:"concepto",label:"Concepto",getValue:t=>{const s=S[t.concepto_id];return s?`${s.clave} — ${s.descripcion}`:t.concepto_id}},{key:"tipo_movimiento",label:"Tipo Movimiento",getValue:t=>O(t.tipo_movimiento)},{key:"monto",label:"Monto",getValue:t=>Number(t.monto||0)},{key:"descripcion",label:"Descripcion"}],`momentos_ingreso_${a}`)},W=[{key:"fecha",label:"Fecha",width:"120px"},{key:"concepto_id",label:"Concepto",render:e=>{const t=S[e];return t?t.clave:"—"}},{key:"tipo_movimiento",label:"Tipo Mov.",width:"120px",render:e=>o.jsx(ae,{variant:X(e),children:O(e)})},{key:"monto",label:"Monto",width:"130px",render:e=>o.jsx("span",{className:"text-right block tabular-nums",children:P(e)})},{key:"descripcion",label:"Descripcion"},{key:"id",label:"Acciones",width:"100px",sortable:!1,render:(e,t)=>o.jsx("button",{onClick:s=>{s.stopPropagation(),Q(t)},className:"text-xs text-danger hover:text-danger/80 transition-colors cursor-pointer",children:"Eliminar"})}],I=k.isPending;return o.jsxs("div",{children:[o.jsxs("div",{className:"mb-6",children:[o.jsx("h1",{className:"text-xl font-bold text-text-primary",children:"Momentos del Ingreso"}),o.jsx("p",{className:"text-sm text-text-muted mt-1",children:"Registro de movimientos presupuestarios de ingreso"})]}),o.jsx("div",{className:"flex flex-wrap items-center gap-2 mb-6",children:b.map(e=>o.jsx("button",{onClick:()=>$(e.key),className:["px-4 py-2 text-sm font-medium rounded-lg transition-colors cursor-pointer",a===e.key?"bg-primary text-white":"bg-white card-shadow text-text-secondary hover:bg-bg-hover"].join(" "),children:e.label},e.key))}),o.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 max-w-2xl",children:[o.jsx(c,{label:"Concepto",value:d,onChange:e=>A(e.target.value),options:E,placeholder:"— Todos los conceptos —"}),o.jsx(c,{label:"Periodo",value:m,onChange:e=>B(e.target.value),options:w,placeholder:"— Todos los periodos —"})]}),o.jsxs("div",{className:"flex items-center justify-between mb-4",children:[o.jsxs("h2",{className:"text-sm font-semibold text-text-secondary",children:[T,o.jsxs("span",{className:"ml-2 text-text-muted font-normal",children:["(",g.length," movimientos)"]})]}),o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx(h,{onClick:J,variant:"outline-primary",size:"sm",children:"Exportar Excel"}),o.jsx(h,{onClick:G,size:"sm",children:"+ Registrar Movimiento"})]})]}),z?o.jsx("div",{className:"flex items-center justify-center py-16 text-text-muted text-sm",children:"Cargando movimientos..."}):o.jsx(ne,{columns:W,data:g}),o.jsx(se,{open:L,onClose:()=>p(!1),title:"Registrar Movimiento",size:"md",children:o.jsxs("div",{className:"space-y-4",children:[o.jsxs("div",{className:"w-full",children:[o.jsx("label",{className:"block text-sm font-medium text-text-heading mb-1.5",children:"Momento contable"}),o.jsx("div",{className:"block w-full h-[40px] rounded-md border border-border bg-bg-hover text-text-muted text-[0.9375rem] px-3.5 py-2.5",children:T})]}),o.jsx(c,{label:"Concepto",value:i.concepto_id,onChange:e=>l("concepto_id",e.target.value),options:E,placeholder:"— Seleccione un concepto —",required:!0}),o.jsx(c,{label:"Periodo contable",value:i.periodo_id,onChange:e=>l("periodo_id",e.target.value),options:w,placeholder:"— Seleccione un periodo —",required:!0}),o.jsx(c,{label:"Tipo de movimiento",value:i.tipo_movimiento,onChange:e=>l("tipo_movimiento",e.target.value),options:U,placeholder:"— Seleccione tipo —",required:!0}),o.jsx(y,{label:"Monto",type:"number",value:i.monto,onChange:e=>l("monto",e.target.value),placeholder:"0.00",min:0,required:!0}),o.jsx(y,{label:"Descripcion (opcional)",value:i.descripcion,onChange:e=>l("descripcion",e.target.value),placeholder:"Descripcion del movimiento"}),o.jsx(y,{label:"Fecha",type:"date",value:i.fecha,onChange:e=>l("fecha",e.target.value),required:!0}),o.jsxs("div",{className:"flex justify-end gap-3 pt-2 border-t border-border",children:[o.jsx(h,{variant:"ghost",onClick:()=>p(!1),disabled:I,children:"Cancelar"}),o.jsx(h,{onClick:K,loading:I,disabled:!i.concepto_id||!i.tipo_movimiento||!i.monto||!i.fecha,children:"Registrar movimiento"})]})]})}),o.jsx(re,{open:V,onClose:()=>{v(!1),f(null)},onConfirm:H,title:"Eliminar movimiento",message:u?`¿Esta seguro de eliminar este movimiento por ${P(u.monto)}? Esta accion no se puede deshacer.`:"",confirmText:"Eliminar",loading:N.isPending})]})}export{_e as default};
