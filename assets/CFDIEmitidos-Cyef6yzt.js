import{u as se,y as le,j as t}from"./index-xuYioy8Y.js";import{b as s}from"./vendor-DEA9Ikep.js";import{a as ie,b as re,c as ne}from"./useCrud-BZqSYSww.js";import{a as de}from"./useCFDI-XVMNfgm4.js";import{O as b,P as g,U as T,Q as U}from"./constants-B0qHiDNt.js";import{D as ce}from"./DataTable-CoGr0iSJ.js";import{M as ue}from"./Modal-BawsBw69.js";import{B as x}from"./Button-CQM7GO5t.js";import{I as i}from"./Input-C6_ozmNh.js";import{S as f}from"./Select-CHQpqBAE.js";import{B as me}from"./Badge-DX5pclE5.js";import{C as pe}from"./ConfirmDialog-BrOOKlKS.js";import{e as be}from"./exportHelpers-CvXmrB4L.js";import"./supabase-DANKYb0E.js";import"./export-t5FFX7R_.js";const N=h=>new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(h||0),E=()=>new Date().toISOString().slice(0,10),P={serie:"",folio:"",uuid:"",fecha_emision:E(),receptor_rfc:"",receptor_nombre:"",uso_cfdi:"G03",tipo:"ingreso",metodo_pago:"PUE",subtotal:"",iva:"",total:"",estado:"vigente",notas:""};function Ie(){const{entePublico:h,ejercicioFiscal:R,rol:A}=se(),v=le(A,"cfdi"),[V,n]=s.useState(!1),[d,F]=s.useState(null),[a,j]=s.useState({...P}),[$,C]=s.useState(!1),[r,y]=s.useState(null),[u,q]=s.useState(""),[m,z]=s.useState(""),{data:k=[],isLoading:B}=de(),D=ie("cfdi_emitido"),S=re("cfdi_emitido"),I=ne("cfdi_emitido"),G=s.useMemo(()=>Object.entries(b).map(([e,o])=>({value:e,label:o})),[]),X=s.useMemo(()=>Object.entries(g).map(([e,{label:o}])=>({value:e,label:o})),[]),L=s.useMemo(()=>Object.entries(T).map(([e,o])=>({value:e,label:`${e} - ${o}`})),[]),Q=s.useMemo(()=>Object.entries(U).map(([e,o])=>({value:e,label:`${e} - ${o}`})),[]),H=s.useMemo(()=>[{value:"",label:"Todos los tipos"},...Object.entries(b).map(([e,o])=>({value:e,label:o}))],[]),J=s.useMemo(()=>[{value:"",label:"Todos los estados"},...Object.entries(g).map(([e,{label:o}])=>({value:e,label:o}))],[]),_=s.useMemo(()=>{let e=k;return u&&(e=e.filter(o=>o.tipo===u)),m&&(e=e.filter(o=>o.estado===m)),e},[k,u,m]),l=(e,o)=>j(c=>{const p={...c,[e]:o};if(e==="subtotal"||e==="iva"){const oe=Number(e==="subtotal"?o:p.subtotal)||0,ae=Number(e==="iva"?o:p.iva)||0;p.total=(oe+ae).toFixed(2)}return p}),K=e=>e?e.length>12?e.slice(0,8)+"...":e:"",W=()=>{F(null),j({...P,fecha_emision:E()}),n(!0)},O=e=>{F(e),j({serie:e.serie??"",folio:e.folio??"",uuid:e.uuid??"",fecha_emision:e.fecha_emision??E(),receptor_rfc:e.receptor_rfc??"",receptor_nombre:e.receptor_nombre??"",uso_cfdi:e.uso_cfdi??"G03",tipo:e.tipo??"ingreso",metodo_pago:e.metodo_pago??"PUE",subtotal:e.subtotal??"",iva:e.iva??"",total:e.total??"",estado:e.estado??"vigente",notas:e.notas??""}),n(!0)},Y=async()=>{const e={...a,ente_id:h?.id,ejercicio_id:R?.id,subtotal:Number(a.subtotal)||0,iva:Number(a.iva)||0,total:Number(a.total)||0};d?await S.mutateAsync({id:d.id,...e}):await D.mutateAsync(e),n(!1)},Z=e=>{y(e),C(!0)},w=async()=>{r&&await I.mutateAsync(r.id),C(!1),y(null)},ee=()=>{be(_,[{key:"serie",label:"Serie"},{key:"folio",label:"Folio"},{key:"uuid",label:"UUID"},{key:"fecha_emision",label:"Fecha Emision"},{key:"receptor_rfc",label:"Receptor RFC"},{key:"receptor_nombre",label:"Receptor Nombre"},{key:"uso_cfdi",label:"Uso CFDI",getValue:o=>T[o.uso_cfdi]||o.uso_cfdi},{key:"tipo",label:"Tipo",getValue:o=>b[o.tipo]||o.tipo},{key:"metodo_pago",label:"Metodo Pago",getValue:o=>U[o.metodo_pago]||o.metodo_pago},{key:"subtotal",label:"Subtotal",getValue:o=>Number(o.subtotal||0)},{key:"iva",label:"IVA",getValue:o=>Number(o.iva||0)},{key:"total",label:"Total",getValue:o=>Number(o.total||0)},{key:"estado",label:"Estado",getValue:o=>g[o.estado]?.label||o.estado},{key:"notas",label:"Notas"}],"cfdi_emitidos")},te=s.useMemo(()=>[{key:"serie",label:"Serie-Folio",width:"120px",render:(e,o)=>`${e||""}${e&&o.folio?"-":""}${o.folio||""}`},{key:"uuid",label:"UUID",width:"120px",render:e=>t.jsx("span",{title:e||"",children:K(e)})},{key:"fecha_emision",label:"Fecha",width:"110px"},{key:"receptor_rfc",label:"Receptor RFC",width:"140px"},{key:"receptor_nombre",label:"Receptor Nombre"},{key:"tipo",label:"Tipo",width:"100px",render:e=>b[e]||e},{key:"subtotal",label:"Subtotal",width:"130px",render:e=>t.jsx("span",{className:"text-right block tabular-nums",children:N(e)})},{key:"iva",label:"IVA",width:"110px",render:e=>t.jsx("span",{className:"text-right block tabular-nums",children:N(e)})},{key:"total",label:"Total",width:"140px",render:e=>t.jsx("span",{className:"text-right block tabular-nums font-bold",children:N(e)})},{key:"estado",label:"Estado",width:"120px",render:e=>{const o=g[e]||{label:e,variant:"default"};return t.jsx(me,{variant:o.variant,children:o.label})}},{key:"id",label:"Acciones",width:"140px",sortable:!1,render:(e,o)=>t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{onClick:c=>{c.stopPropagation(),O(o)},className:"text-xs text-primary hover:text-primary-light transition-colors cursor-pointer",children:"Editar"}),v&&t.jsx("button",{onClick:c=>{c.stopPropagation(),Z(o)},className:"text-xs text-danger hover:text-danger/80 transition-colors cursor-pointer",children:"Eliminar"})]})}],[v]),M=D.isPending||S.isPending;return t.jsxs("div",{children:[t.jsxs("div",{className:"mb-6",children:[t.jsx("h1",{className:"text-xl font-bold text-text-primary",children:"CFDI Emitidos"}),t.jsx("p",{className:"text-sm text-text-muted mt-1",children:"Comprobantes fiscales digitales emitidos por el ente publico"})]}),t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsxs("div",{className:"flex items-center gap-4",children:[t.jsxs("h2",{className:"text-sm font-semibold text-text-secondary",children:["Emitidos",t.jsxs("span",{className:"ml-2 text-text-muted font-normal",children:["(",_.length," registros)"]})]}),t.jsx("select",{value:u,onChange:e=>q(e.target.value),className:"h-[38px] rounded-md border border-border text-[0.9375rem] px-3 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda",children:H.map(e=>t.jsx("option",{value:e.value,children:e.label},e.value))}),t.jsx("select",{value:m,onChange:e=>z(e.target.value),className:"h-[38px] rounded-md border border-border text-[0.9375rem] px-3 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda",children:J.map(e=>t.jsx("option",{value:e.value,children:e.label},e.value))})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(x,{onClick:ee,variant:"outline-primary",size:"sm",children:"Exportar Excel"}),v&&t.jsx(x,{onClick:W,size:"sm",children:"+ Nuevo CFDI"})]})]}),B?t.jsx("div",{className:"flex items-center justify-center py-16 text-text-muted text-sm",children:"Cargando CFDI emitidos..."}):t.jsx(ce,{columns:te,data:_,onRowClick:O}),t.jsx(ue,{open:V,onClose:()=>n(!1),title:d?"Editar CFDI Emitido":"Nuevo CFDI Emitido",size:"lg",children:t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[t.jsx(i,{label:"Serie",value:a.serie,onChange:e=>l("serie",e.target.value),placeholder:"Ej. A"}),t.jsx(i,{label:"Folio",value:a.folio,onChange:e=>l("folio",e.target.value),placeholder:"Ej. 001",required:!0}),t.jsx(i,{label:"UUID",value:a.uuid,onChange:e=>l("uuid",e.target.value),placeholder:"UUID del timbrado",disabled:!!d})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsx(i,{label:"Fecha de Emision",type:"date",value:a.fecha_emision,onChange:e=>l("fecha_emision",e.target.value),required:!0}),t.jsx(f,{label:"Tipo",value:a.tipo,onChange:e=>l("tipo",e.target.value),options:G,placeholder:"-- Seleccione tipo --",required:!0})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsx(i,{label:"Receptor RFC",value:a.receptor_rfc,onChange:e=>l("receptor_rfc",e.target.value),placeholder:"RFC del receptor",required:!0}),t.jsx(i,{label:"Receptor Nombre",value:a.receptor_nombre,onChange:e=>l("receptor_nombre",e.target.value),placeholder:"Nombre o razon social del receptor",required:!0})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsx(f,{label:"Uso CFDI",value:a.uso_cfdi,onChange:e=>l("uso_cfdi",e.target.value),options:L,placeholder:"-- Seleccione uso CFDI --",required:!0}),t.jsx(f,{label:"Metodo de Pago",value:a.metodo_pago,onChange:e=>l("metodo_pago",e.target.value),options:Q,placeholder:"-- Seleccione metodo de pago --",required:!0})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[t.jsx(i,{label:"Subtotal",type:"number",value:a.subtotal,onChange:e=>l("subtotal",e.target.value),placeholder:"0.00",required:!0}),t.jsx(i,{label:"IVA",type:"number",value:a.iva,onChange:e=>l("iva",e.target.value),placeholder:"0.00"}),t.jsx(i,{label:"Total",type:"number",value:a.total,onChange:e=>l("total",e.target.value),placeholder:"0.00",disabled:!0})]}),t.jsx(f,{label:"Estado",value:a.estado,onChange:e=>l("estado",e.target.value),options:X,placeholder:"-- Seleccione estado --",required:!0}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Notas"}),t.jsx("textarea",{value:a.notas,onChange:e=>l("notas",e.target.value),placeholder:"Observaciones o notas adicionales",rows:3,className:"w-full h-auto rounded-md border border-border text-[0.9375rem] px-3 py-2 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda"})]}),t.jsxs("div",{className:"flex justify-end gap-3 pt-2 border-t border-border",children:[t.jsx(x,{variant:"ghost",onClick:()=>n(!1),disabled:M,children:"Cancelar"}),t.jsx(x,{onClick:Y,loading:M,disabled:!a.folio.toString().trim()||!a.receptor_rfc.trim()||!a.receptor_nombre.trim(),children:d?"Guardar cambios":"Crear CFDI"})]})]})}),t.jsx(pe,{open:$,onClose:()=>{C(!1),y(null)},onConfirm:w,title:"Eliminar CFDI emitido",message:r?`Â¿Esta seguro de eliminar el CFDI emitido "${r.serie||""}${r.serie&&r.folio?"-":""}${r.folio||""}"? Esta accion no se puede deshacer.`:"",confirmText:"Eliminar",loading:I.isPending})]})}export{Ie as default};
