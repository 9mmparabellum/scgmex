import{u as F,j as i,c as B}from"./index-C8w7C__S.js";import{b as c}from"./vendor-DEA9Ikep.js";import{u as T,a as L,b as $,c as z,B as E}from"./Button-DuXcW5xX.js";import{D as R}from"./DataTable-jgOn3qee.js";import{M as q}from"./Modal-DP5Epx02.js";import{I as v}from"./Input-BuLY86I-.js";import{S as G}from"./Select-D5ASwMqy.js";import{B as J}from"./Badge-R2GXFUbi.js";import{C as H}from"./ConfirmDialog-u86aQ__Z.js";import"./supabase-DANKYb0E.js";import"./export-t5FFX7R_.js";const U=[{value:"abierto",label:"Abierto"},{value:"en_cierre",label:"En Cierre"},{value:"cerrado",label:"Cerrado"}],V={abierto:"success",en_cierre:"warning",cerrado:"danger"},W={abierto:"Abierto",en_cierre:"En Cierre",cerrado:"Cerrado"},Y=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre","Ajustes"],y={anio:new Date().getFullYear(),fecha_inicio:"",fecha_fin:"",estado:"abierto"};function K(t,r){const l=[];for(let o=1;o<=13;o++)if(o<=12){const x=new Date(r,o-1,1),p=new Date(r,o,0);l.push({ejercicio_id:t,numero:o,nombre:Y[o-1],fecha_inicio:x.toISOString().slice(0,10),fecha_fin:p.toISOString().slice(0,10),estado:"cerrado"})}else l.push({ejercicio_id:t,numero:13,nombre:"Ajustes",fecha_inicio:`${r}-12-31`,fecha_fin:`${r}-12-31`,estado:"cerrado"});return l}function ce(){const{entePublico:t}=F(),{data:r=[],isLoading:l}=T("ejercicio_fiscal",{filter:{ente_id:t?.id},order:{column:"anio",ascending:!1}}),{setEjercicioFiscal:o}=F(),x=L("ejercicio_fiscal"),p=$("ejercicio_fiscal"),C=z("ejercicio_fiscal"),[w,j]=c.useState(!1),[d,b]=c.useState(null),[a,f]=c.useState(y),[N,m]=c.useState({}),[u,g]=c.useState(null),[A,S]=c.useState(!1),D=()=>{b(null),f(y),m({}),j(!0)},k=e=>{b(e),f({anio:e.anio,fecha_inicio:e.fecha_inicio??"",fecha_fin:e.fecha_fin??"",estado:e.estado??"abierto"}),m({}),j(!0)},_=()=>{j(!1),b(null),f(y),m({})},h=(e,n)=>{f(s=>({...s,[e]:n})),N[e]&&m(s=>({...s,[e]:void 0}))},M=()=>{const e={};return(!a.anio||isNaN(Number(a.anio)))&&(e.anio="El anio es requerido y debe ser un numero valido"),m(e),Object.keys(e).length===0},O=async()=>{if(M()){S(!0);try{if(d)await p.mutateAsync({id:d.id,anio:Number(a.anio),fecha_inicio:a.fecha_inicio||null,fecha_fin:a.fecha_fin||null,estado:a.estado});else{const e=await x.mutateAsync({ente_id:t?.id,anio:Number(a.anio),fecha_inicio:a.fecha_inicio||`${a.anio}-01-01`,fecha_fin:a.fecha_fin||`${a.anio}-12-31`,estado:a.estado}),n=K(e.id,Number(a.anio));await B("periodo_contable",n),o(e)}_()}catch(e){console.error("Error al guardar ejercicio fiscal:",e)}finally{S(!1)}}},I=async()=>{if(u)try{await C.mutateAsync(u.id),g(null)}catch(e){console.error("Error al eliminar ejercicio fiscal:",e)}},P=[{key:"anio",label:"Anio",width:"100px"},{key:"fecha_inicio",label:"Fecha Inicio"},{key:"fecha_fin",label:"Fecha Fin"},{key:"estado",label:"Estado",render:e=>i.jsx(J,{variant:V[e]||"default",children:W[e]||e})},{key:"acciones",label:"Acciones",sortable:!1,render:(e,n)=>i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx("button",{onClick:s=>{s.stopPropagation(),k(n)},className:"text-xs text-primary hover:text-primary-light font-medium transition-colors cursor-pointer",children:"Editar"}),i.jsx("button",{onClick:s=>{s.stopPropagation(),g(n)},className:"text-xs text-danger hover:text-danger/80 font-medium transition-colors cursor-pointer",children:"Eliminar"})]})}];return t?.id?i.jsxs("div",{children:[i.jsxs("div",{className:"flex items-center justify-between mb-6",children:[i.jsxs("div",{children:[i.jsx("h1",{className:"text-xl font-bold text-text-primary",children:"Ejercicios Fiscales"}),i.jsxs("p",{className:"text-sm text-text-muted mt-1",children:["Administracion de ejercicios fiscales para ",t?.nombre]})]}),i.jsx(E,{onClick:D,children:"Nuevo Ejercicio"})]}),i.jsx("div",{className:"bg-white rounded-lg card-shadow p-4",children:l?i.jsxs("div",{className:"flex items-center justify-center py-12",children:[i.jsxs("svg",{className:"animate-spin h-6 w-6 text-primary",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[i.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),i.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),i.jsx("span",{className:"ml-3 text-text-muted text-sm",children:"Cargando ejercicios..."})]}):i.jsx(R,{columns:P,data:r})}),i.jsx(q,{open:w,onClose:_,title:d?"Editar Ejercicio Fiscal":"Nuevo Ejercicio Fiscal",children:i.jsxs("div",{className:"space-y-4",children:[i.jsx(v,{label:"Anio",type:"number",value:a.anio,onChange:e=>h("anio",e.target.value),error:N.anio,min:2e3,max:2100,required:!0}),i.jsx(v,{label:"Fecha Inicio",type:"date",value:a.fecha_inicio,onChange:e=>h("fecha_inicio",e.target.value)}),i.jsx(v,{label:"Fecha Fin",type:"date",value:a.fecha_fin,onChange:e=>h("fecha_fin",e.target.value)}),i.jsx(G,{label:"Estado",value:a.estado,onChange:e=>h("estado",e.target.value),options:U}),!d&&i.jsx("p",{className:"text-xs text-text-muted border-l-2 border-info pl-3",children:"Al crear el ejercicio fiscal se generaran automaticamente 13 periodos contables (Enero a Diciembre mas periodo de Ajustes)."}),i.jsxs("div",{className:"flex justify-end gap-3 pt-2",children:[i.jsx(E,{variant:"ghost",onClick:_,disabled:A,children:"Cancelar"}),i.jsx(E,{onClick:O,loading:A,children:d?"Guardar Cambios":"Crear Ejercicio"})]})]})}),i.jsx(H,{open:!!u,onClose:()=>g(null),onConfirm:I,title:"Eliminar Ejercicio Fiscal",message:u?`Esta seguro de eliminar el ejercicio fiscal ${u.anio}? Esta accion no se puede deshacer y eliminara todos los periodos contables asociados.`:"",confirmText:"Eliminar",loading:C.isPending})]}):i.jsx("div",{className:"flex items-center justify-center h-64",children:i.jsx("p",{className:"text-text-muted text-sm",children:"Seleccione un ente publico para ver los ejercicios fiscales."})})}export{ce as default};
