import{u as B,j as i}from"./index-CHHoMz4Q.js";import{b as c}from"./vendor-DEA9Ikep.js";import{u as T,a as S,b as L,c as $,B as E}from"./Button-BlJJN9v_.js";import{D as z}from"./DataTable-Cz_W0WKV.js";import{M as R}from"./Modal-CrKTJ4AZ.js";import{I as v}from"./Input-BIwpmmZN.js";import{S as q}from"./Select-Dfn36s6t.js";import{B as G}from"./Badge-B5Ahs-LU.js";import{C as J}from"./ConfirmDialog-C6dy2a8k.js";import"./export-t5FFX7R_.js";import"./supabase-DANKYb0E.js";const H=[{value:"abierto",label:"Abierto"},{value:"en_cierre",label:"En Cierre"},{value:"cerrado",label:"Cerrado"}],U={abierto:"success",en_cierre:"warning",cerrado:"danger"},V={abierto:"Abierto",en_cierre:"En Cierre",cerrado:"Cerrado"},W=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre","Ajustes"],y={anio:new Date().getFullYear(),fecha_inicio:"",fecha_fin:"",estado:"abierto"};function Y(r,s){const l=[];for(let o=1;o<=13;o++)if(o<=12){const p=new Date(s,o-1,1),f=new Date(s,o,0);l.push({ejercicio_id:r,numero:o,nombre:W[o-1],fecha_inicio:p.toISOString().slice(0,10),fecha_fin:f.toISOString().slice(0,10),estado:"cerrado"})}else l.push({ejercicio_id:r,numero:13,nombre:"Ajustes",fecha_inicio:`${s}-12-31`,fecha_fin:`${s}-12-31`,estado:"cerrado"});return l}function ne(){const{entePublico:r}=B(),{data:s=[],isLoading:l}=T("ejercicio_fiscal",{filter:{ente_id:r?.id},order:{column:"anio",ascending:!1}}),o=S("ejercicio_fiscal"),p=L("ejercicio_fiscal"),f=$("ejercicio_fiscal"),w=S("periodo_contable"),[D,j]=c.useState(!1),[d,b]=c.useState(null),[a,h]=c.useState(y),[C,m]=c.useState({}),[u,g]=c.useState(null),[N,A]=c.useState(!1),F=()=>{b(null),h(y),m({}),j(!0)},k=e=>{b(e),h({anio:e.anio,fecha_inicio:e.fecha_inicio??"",fecha_fin:e.fecha_fin??"",estado:e.estado??"abierto"}),m({}),j(!0)},_=()=>{j(!1),b(null),h(y),m({})},x=(e,n)=>{h(t=>({...t,[e]:n})),C[e]&&m(t=>({...t,[e]:void 0}))},O=()=>{const e={};return(!a.anio||isNaN(Number(a.anio)))&&(e.anio="El anio es requerido y debe ser un numero valido"),m(e),Object.keys(e).length===0},M=async()=>{if(O()){A(!0);try{if(d)await p.mutateAsync({id:d.id,anio:Number(a.anio),fecha_inicio:a.fecha_inicio||null,fecha_fin:a.fecha_fin||null,estado:a.estado});else{const e=await o.mutateAsync({ente_id:r?.id,anio:Number(a.anio),fecha_inicio:a.fecha_inicio||`${a.anio}-01-01`,fecha_fin:a.fecha_fin||`${a.anio}-12-31`,estado:a.estado}),n=Y(e.id,Number(a.anio));for(const t of n)await w.mutateAsync(t)}_()}catch(e){console.error("Error al guardar ejercicio fiscal:",e)}finally{A(!1)}}},I=async()=>{if(u)try{await f.mutateAsync(u.id),g(null)}catch(e){console.error("Error al eliminar ejercicio fiscal:",e)}},P=[{key:"anio",label:"Anio",width:"100px"},{key:"fecha_inicio",label:"Fecha Inicio"},{key:"fecha_fin",label:"Fecha Fin"},{key:"estado",label:"Estado",render:e=>i.jsx(G,{variant:U[e]||"default",children:V[e]||e})},{key:"acciones",label:"Acciones",sortable:!1,render:(e,n)=>i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx("button",{onClick:t=>{t.stopPropagation(),k(n)},className:"text-xs text-primary hover:text-primary-light font-medium transition-colors cursor-pointer",children:"Editar"}),i.jsx("button",{onClick:t=>{t.stopPropagation(),g(n)},className:"text-xs text-danger hover:text-danger/80 font-medium transition-colors cursor-pointer",children:"Eliminar"})]})}];return r?.id?i.jsxs("div",{children:[i.jsxs("div",{className:"flex items-center justify-between mb-6",children:[i.jsxs("div",{children:[i.jsx("h1",{className:"text-xl font-bold text-text-primary",children:"Ejercicios Fiscales"}),i.jsxs("p",{className:"text-sm text-text-muted mt-1",children:["Administracion de ejercicios fiscales para ",r?.nombre]})]}),i.jsx(E,{onClick:F,children:"Nuevo Ejercicio"})]}),i.jsx("div",{className:"bg-white rounded-lg card-shadow p-4",children:l?i.jsxs("div",{className:"flex items-center justify-center py-12",children:[i.jsxs("svg",{className:"animate-spin h-6 w-6 text-primary",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[i.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),i.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),i.jsx("span",{className:"ml-3 text-text-muted text-sm",children:"Cargando ejercicios..."})]}):i.jsx(z,{columns:P,data:s})}),i.jsx(R,{open:D,onClose:_,title:d?"Editar Ejercicio Fiscal":"Nuevo Ejercicio Fiscal",children:i.jsxs("div",{className:"space-y-4",children:[i.jsx(v,{label:"Anio",type:"number",value:a.anio,onChange:e=>x("anio",e.target.value),error:C.anio,min:2e3,max:2100,required:!0}),i.jsx(v,{label:"Fecha Inicio",type:"date",value:a.fecha_inicio,onChange:e=>x("fecha_inicio",e.target.value)}),i.jsx(v,{label:"Fecha Fin",type:"date",value:a.fecha_fin,onChange:e=>x("fecha_fin",e.target.value)}),i.jsx(q,{label:"Estado",value:a.estado,onChange:e=>x("estado",e.target.value),options:H}),!d&&i.jsx("p",{className:"text-xs text-text-muted border-l-2 border-info pl-3",children:"Al crear el ejercicio fiscal se generaran automaticamente 13 periodos contables (Enero a Diciembre mas periodo de Ajustes)."}),i.jsxs("div",{className:"flex justify-end gap-3 pt-2",children:[i.jsx(E,{variant:"ghost",onClick:_,disabled:N,children:"Cancelar"}),i.jsx(E,{onClick:M,loading:N,children:d?"Guardar Cambios":"Crear Ejercicio"})]})]})}),i.jsx(J,{open:!!u,onClose:()=>g(null),onConfirm:I,title:"Eliminar Ejercicio Fiscal",message:u?`Esta seguro de eliminar el ejercicio fiscal ${u.anio}? Esta accion no se puede deshacer y eliminara todos los periodos contables asociados.`:"",confirmText:"Eliminar",loading:f.isPending})]}):i.jsx("div",{className:"flex items-center justify-center h-64",children:i.jsx("p",{className:"text-text-muted text-sm",children:"Seleccione un ente publico para ver los ejercicios fiscales."})})}export{ne as default};
