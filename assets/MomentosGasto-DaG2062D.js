import{u as Y,o as Z,j as t}from"./index-CyKkzz21.js";import{b as a}from"./vendor-DEA9Ikep.js";import{u as D,a as ee,c as te}from"./useCrud-bUfgzWCS.js";import{f as oe}from"./presupuestoService-CMYpBxRh.js";import{M as g,a as F}from"./constants-B48pdecp.js";import{e as ie}from"./exportHelpers-CvXmrB4L.js";import{D as ae}from"./DataTable-DfIEqyJf.js";import{M as se}from"./Modal-CR5BegYj.js";import{B as h}from"./Button-BA780zlq.js";import{I as y}from"./Input-CofDiIdZ.js";import{S as c}from"./Select-B7MIUx36.js";import{B as re}from"./Badge-BiItYtys.js";import{C as ne}from"./ConfirmDialog-DPG7zYiO.js";import"./supabase-DANKYb0E.js";import"./export-t5FFX7R_.js";const q=n=>new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(n||0),R=()=>new Date().toISOString().slice(0,10),I={partida_id:"",periodo_id:"",tipo_movimiento:"",monto:"",descripcion:"",fecha:R()};function Me(){const{entePublico:n,ejercicioFiscal:j}=Y(),[r,A]=a.useState(g[0].key),[d,$]=a.useState(""),[m,B]=a.useState(""),[L,p]=a.useState(!1),[i,_]=a.useState({...I}),[V,v]=a.useState(!1),[u,f]=a.useState(null),M=a.useMemo(()=>{const e={momento:r};return d&&(e.partida_id=d),m&&(e.periodo_id=m),e},[r,d,m]),{data:b=[],isLoading:z}=Z({queryKey:["movimiento_presupuestal_egreso",n?.id,M],queryFn:()=>oe(n?.id,M),enabled:!!n?.id}),{data:x=[]}=D("partida_egreso",{filter:{ente_id:n?.id,ejercicio_id:j?.id}}),{data:k=[]}=D("periodo_contable",{filter:{ejercicio_id:j?.id}}),C=ee("movimiento_presupuestal_egreso"),N=te("movimiento_presupuestal_egreso"),S=a.useMemo(()=>{const e={};return x.forEach(o=>{e[o.id]=o}),e},[x]),E=a.useMemo(()=>x.map(e=>({value:e.id,label:`${e.clave} — ${e.descripcion}`})),[x]),P=a.useMemo(()=>k.map(e=>({value:e.id,label:e.nombre||e.clave})),[k]),G=a.useMemo(()=>F.map(e=>({value:e.key,label:e.label})),[]),U=e=>({original:"info",adicion:"success",reduccion:"danger"})[e]||"default",w=e=>{const o=F.find(s=>s.key===e);return o?o.label:e},O=g.find(e=>e.key===r)?.label??r,X=()=>{_({...I,fecha:R()}),p(!0)},l=(e,o)=>{_(s=>({...s,[e]:o}))},K=async()=>{const e={partida_id:i.partida_id,periodo_id:i.periodo_id||null,momento:r,tipo_movimiento:i.tipo_movimiento,monto:Number(i.monto)||0,descripcion:i.descripcion,fecha:i.fecha};await C.mutateAsync(e),p(!1)},Q=e=>{f(e),v(!0)},H=async()=>{u&&await N.mutateAsync(u.id),v(!1),f(null)},J=()=>{ie(b,[{key:"fecha",label:"Fecha",getValue:o=>o.fecha},{key:"partida",label:"Partida",getValue:o=>{const s=S[o.partida_id];return s?`${s.clave} — ${s.descripcion}`:o.partida_id}},{key:"tipo_movimiento",label:"Tipo Movimiento",getValue:o=>w(o.tipo_movimiento)},{key:"monto",label:"Monto",getValue:o=>Number(o.monto||0)},{key:"descripcion",label:"Descripcion"}],`momentos_gasto_${r}`)},W=[{key:"fecha",label:"Fecha",width:"120px"},{key:"partida_id",label:"Partida",render:e=>{const o=S[e];return o?o.clave:"—"}},{key:"tipo_movimiento",label:"Tipo Mov.",width:"120px",render:e=>t.jsx(re,{variant:U(e),children:w(e)})},{key:"monto",label:"Monto",width:"130px",render:e=>t.jsx("span",{className:"text-right block tabular-nums",children:q(e)})},{key:"descripcion",label:"Descripcion"},{key:"id",label:"Acciones",width:"100px",sortable:!1,render:(e,o)=>t.jsx("button",{onClick:s=>{s.stopPropagation(),Q(o)},className:"text-xs text-danger hover:text-danger/80 transition-colors cursor-pointer",children:"Eliminar"})}],T=C.isPending;return t.jsxs("div",{children:[t.jsxs("div",{className:"mb-6",children:[t.jsx("h1",{className:"text-xl font-bold text-text-primary",children:"Momentos del Gasto"}),t.jsx("p",{className:"text-sm text-text-muted mt-1",children:"Registro de movimientos presupuestarios de egreso"})]}),t.jsx("div",{className:"flex flex-wrap items-center gap-2 mb-6",children:g.map(e=>t.jsx("button",{onClick:()=>A(e.key),className:["px-4 py-2 text-sm font-medium rounded-lg transition-colors cursor-pointer",r===e.key?"bg-primary text-white":"bg-white card-shadow text-text-secondary hover:bg-bg-hover"].join(" "),children:e.label},e.key))}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 max-w-2xl",children:[t.jsx(c,{label:"Partida",value:d,onChange:e=>$(e.target.value),options:E,placeholder:"— Todas las partidas —"}),t.jsx(c,{label:"Periodo",value:m,onChange:e=>B(e.target.value),options:P,placeholder:"— Todos los periodos —"})]}),t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsxs("h2",{className:"text-sm font-semibold text-text-secondary",children:[O,t.jsxs("span",{className:"ml-2 text-text-muted font-normal",children:["(",b.length," movimientos)"]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(h,{onClick:J,variant:"outline-primary",size:"sm",children:"Exportar Excel"}),t.jsx(h,{onClick:X,size:"sm",children:"+ Registrar Movimiento"})]})]}),z?t.jsx("div",{className:"flex items-center justify-center py-16 text-text-muted text-sm",children:"Cargando movimientos..."}):t.jsx(ae,{columns:W,data:b}),t.jsx(se,{open:L,onClose:()=>p(!1),title:"Registrar Movimiento",size:"md",children:t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"w-full",children:[t.jsx("label",{className:"block text-sm font-medium text-text-heading mb-1.5",children:"Momento contable"}),t.jsx("div",{className:"block w-full h-[40px] rounded-md border border-border bg-bg-hover text-text-muted text-[0.9375rem] px-3.5 py-2.5",children:O})]}),t.jsx(c,{label:"Partida",value:i.partida_id,onChange:e=>l("partida_id",e.target.value),options:E,placeholder:"— Seleccione una partida —",required:!0}),t.jsx(c,{label:"Periodo contable",value:i.periodo_id,onChange:e=>l("periodo_id",e.target.value),options:P,placeholder:"— Seleccione un periodo —",required:!0}),t.jsx(c,{label:"Tipo de movimiento",value:i.tipo_movimiento,onChange:e=>l("tipo_movimiento",e.target.value),options:G,placeholder:"— Seleccione tipo —",required:!0}),t.jsx(y,{label:"Monto",type:"number",value:i.monto,onChange:e=>l("monto",e.target.value),placeholder:"0.00",min:0,required:!0}),t.jsx(y,{label:"Descripcion (opcional)",value:i.descripcion,onChange:e=>l("descripcion",e.target.value),placeholder:"Descripcion del movimiento"}),t.jsx(y,{label:"Fecha",type:"date",value:i.fecha,onChange:e=>l("fecha",e.target.value),required:!0}),t.jsxs("div",{className:"flex justify-end gap-3 pt-2 border-t border-border",children:[t.jsx(h,{variant:"ghost",onClick:()=>p(!1),disabled:T,children:"Cancelar"}),t.jsx(h,{onClick:K,loading:T,disabled:!i.partida_id||!i.tipo_movimiento||!i.monto||!i.fecha,children:"Registrar movimiento"})]})]})}),t.jsx(ne,{open:V,onClose:()=>{v(!1),f(null)},onConfirm:H,title:"Eliminar movimiento",message:u?`¿Esta seguro de eliminar este movimiento por ${q(u.monto)}? Esta accion no se puede deshacer.`:"",confirmText:"Eliminar",loading:N.isPending})]})}export{Me as default};
