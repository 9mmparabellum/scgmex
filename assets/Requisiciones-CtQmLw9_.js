import{u as B,j as a}from"./index-CyKkzz21.js";import{b as s}from"./vendor-DEA9Ikep.js";import{a as T,b as J,c as V}from"./useCrud-bUfgzWCS.js";import{b as Q}from"./useAdquisiciones-BTnPTHe7.js";import{D as U}from"./DataTable-DfIEqyJf.js";import{M as X}from"./Modal-CR5BegYj.js";import{B as d}from"./Button-BA780zlq.js";import{I as u}from"./Input-CofDiIdZ.js";import{S as G}from"./Select-B7MIUx36.js";import{B as L}from"./Badge-BiItYtys.js";import{C as $}from"./ConfirmDialog-DPG7zYiO.js";import{e as H}from"./exportHelpers-CvXmrB4L.js";import"./supabase-DANKYb0E.js";import"./export-t5FFX7R_.js";const K=m=>new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(m||0),b={borrador:{label:"Borrador",variant:"default"},enviada:{label:"Enviada",variant:"info"},autorizada:{label:"Autorizada",variant:"success"},en_cotizacion:{label:"En Cotizacion",variant:"warning"},adjudicada:{label:"Adjudicada",variant:"primary"},rechazada:{label:"Rechazada",variant:"danger"},cancelada:{label:"Cancelada",variant:"danger"}},g=()=>new Date().toISOString().slice(0,10),k={numero:"",fecha:g(),area_solicitante:"",justificacion:"",monto_estimado:"",estado:"borrador"};function ue(){const{entePublico:m,ejercicioFiscal:q,user:_}=B(),[S,n]=s.useState(!1),[l,j]=s.useState(null),[i,x]=s.useState({...k}),[M,p]=s.useState(!1),[c,f]=s.useState(null),{data:h=[],isLoading:R}=Q(),v=T("requisicion"),y=J("requisicion"),C=V("requisicion"),A=s.useMemo(()=>Object.entries(b).map(([e,{label:t}])=>({value:e,label:t})),[]),o=(e,t)=>x(r=>({...r,[e]:t})),D=(e,t=40)=>e?e.length>t?e.slice(0,t)+"...":e:"",w=()=>{j(null),x({...k,fecha:g()}),n(!0)},N=e=>{j(e),x({numero:e.numero??"",fecha:e.fecha??g(),area_solicitante:e.area_solicitante??"",justificacion:e.justificacion??"",monto_estimado:e.monto_estimado??"",estado:e.estado??"borrador"}),n(!0)},z=async()=>{const e={...i,ente_id:m?.id,ejercicio_id:q?.id,solicitado_por:_?.id,monto_estimado:Number(i.monto_estimado)||0};l?await y.mutateAsync({id:l.id,...e}):await v.mutateAsync(e),n(!1)},O=e=>{f(e),p(!0)},F=async()=>{c&&await C.mutateAsync(c.id),p(!1),f(null)},I=()=>{H(h,[{key:"numero",label:"Numero"},{key:"fecha",label:"Fecha"},{key:"area_solicitante",label:"Area Solicitante"},{key:"justificacion",label:"Justificacion"},{key:"monto_estimado",label:"Monto Estimado",getValue:t=>Number(t.monto_estimado||0)},{key:"estado",label:"Estado",getValue:t=>b[t.estado]?.label||t.estado},{key:"solicitante",label:"Solicitante",getValue:t=>t.solicitante?.nombre||""}],"requisiciones")},P=s.useMemo(()=>[{key:"numero",label:"Numero",width:"100px"},{key:"fecha",label:"Fecha",width:"110px"},{key:"area_solicitante",label:"Area Solicitante",width:"180px"},{key:"justificacion",label:"Justificacion",render:e=>a.jsx("span",{title:e||"",children:D(e)})},{key:"monto_estimado",label:"Monto Estimado",width:"150px",render:e=>a.jsx("span",{className:"text-right block tabular-nums",children:K(e)})},{key:"estado",label:"Estado",width:"130px",render:e=>{const t=b[e]||{label:e,variant:"default"};return a.jsx(L,{variant:t.variant,children:t.label})}},{key:"solicitante",label:"Solicitante",width:"150px",render:e=>e?.nombre||""},{key:"id",label:"Acciones",width:"140px",sortable:!1,render:(e,t)=>a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("button",{onClick:r=>{r.stopPropagation(),N(t)},className:"text-xs text-primary hover:text-primary-light transition-colors cursor-pointer",children:"Editar"}),a.jsx("button",{onClick:r=>{r.stopPropagation(),O(t)},className:"text-xs text-danger hover:text-danger/80 transition-colors cursor-pointer",children:"Eliminar"})]})}],[]),E=v.isPending||y.isPending;return a.jsxs("div",{children:[a.jsxs("div",{className:"mb-6",children:[a.jsx("h1",{className:"text-xl font-bold text-text-primary",children:"Requisiciones"}),a.jsx("p",{className:"text-sm text-text-muted mt-1",children:"Solicitudes de compra y requisiciones del ejercicio fiscal"})]}),a.jsxs("div",{className:"flex items-center justify-between mb-4",children:[a.jsxs("h2",{className:"text-sm font-semibold text-text-secondary",children:["Requisiciones",a.jsxs("span",{className:"ml-2 text-text-muted font-normal",children:["(",h.length," registros)"]})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(d,{onClick:I,variant:"outline-primary",size:"sm",children:"Exportar Excel"}),a.jsx(d,{onClick:w,size:"sm",children:"+ Nueva Requisicion"})]})]}),R?a.jsx("div",{className:"flex items-center justify-center py-16 text-text-muted text-sm",children:"Cargando requisiciones..."}):a.jsx(U,{columns:P,data:h,onRowClick:N}),a.jsx(X,{open:S,onClose:()=>n(!1),title:l?"Editar Requisicion":"Nueva Requisicion",size:"lg",children:a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[a.jsx(u,{label:"Numero",value:i.numero,onChange:e=>o("numero",e.target.value),placeholder:"Ej. REQ-001",required:!0}),a.jsx(u,{label:"Fecha",type:"date",value:i.fecha,onChange:e=>o("fecha",e.target.value),required:!0})]}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[a.jsx(u,{label:"Area Solicitante",value:i.area_solicitante,onChange:e=>o("area_solicitante",e.target.value),placeholder:"Area que solicita la compra",required:!0}),a.jsx(G,{label:"Estado",value:i.estado,onChange:e=>o("estado",e.target.value),options:A,placeholder:"-- Seleccione estado --",required:!0})]}),a.jsx(u,{label:"Monto Estimado",type:"number",value:i.monto_estimado,onChange:e=>o("monto_estimado",e.target.value),placeholder:"0.00",required:!0}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Justificacion"}),a.jsx("textarea",{value:i.justificacion,onChange:e=>o("justificacion",e.target.value),placeholder:"Describa la justificacion de la requisicion",rows:3,className:"w-full h-auto rounded-md border border-border text-[0.9375rem] px-3 py-2 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda"})]}),a.jsxs("div",{className:"flex justify-end gap-3 pt-2 border-t border-border",children:[a.jsx(d,{variant:"ghost",onClick:()=>n(!1),disabled:E,children:"Cancelar"}),a.jsx(d,{onClick:z,loading:E,disabled:!i.numero.trim()||!i.area_solicitante.trim(),children:l?"Guardar cambios":"Crear requisicion"})]})]})}),a.jsx($,{open:M,onClose:()=>{p(!1),f(null)},onConfirm:F,title:"Eliminar requisicion",message:c?`Â¿Esta seguro de eliminar la requisicion "${c.numero}"? Esta accion no se puede deshacer.`:"",confirmText:"Eliminar",loading:C.isPending})]})}export{ue as default};
