import{s as o,u as b,o as l,p as f,q as u}from"./index-KskWbqO9.js";const d={sandboxUrl:"https://apisandbox.facturama.mx",productionUrl:"https://api.facturama.mx",getApiUrl:()=>"https://apisandbox.facturama.mx",getCredentials:()=>btoa("9mmparabellum:MadriZ11"),isSandbox:()=>"https://apisandbox.facturama.mx".includes("sandbox"),hasCredentials:()=>!0,isMultiemisor:()=>!1},O=[{key:"601",label:"General de Ley Personas Morales"},{key:"603",label:"Personas Morales con Fines no Lucrativos"},{key:"605",label:"Sueldos y Salarios"},{key:"606",label:"Arrendamiento"},{key:"608",label:"Demas Ingresos"},{key:"610",label:"Residentes en el Extranjero sin EP"},{key:"612",label:"Actividades Empresariales y Profesionales"},{key:"614",label:"Ingresos por Intereses"},{key:"616",label:"Sin Obligaciones Fiscales"},{key:"620",label:"Sociedades Cooperativas de Produccion"},{key:"621",label:"Incorporacion Fiscal"},{key:"622",label:"Actividades Agricolas, Ganaderas, Silvicolas y Pesqueras"},{key:"623",label:"Opcional para Grupos de Sociedades"},{key:"624",label:"Coordinados"},{key:"625",label:"Regimen de las Actividades Empresariales con ingresos a traves de Plataformas Tecnologicas"},{key:"626",label:"Regimen Simplificado de Confianza"}],$=[{key:"01",label:"Efectivo"},{key:"02",label:"Cheque nominativo"},{key:"03",label:"Transferencia electronica"},{key:"04",label:"Tarjeta de credito"},{key:"05",label:"Monedero electronico"},{key:"06",label:"Dinero electronico"},{key:"28",label:"Tarjeta de debito"},{key:"29",label:"Tarjeta de servicios"},{key:"99",label:"Por definir"}],U=[{key:"MXN",label:"Peso Mexicano"},{key:"USD",label:"Dolar Americano"},{key:"EUR",label:"Euro"}],K=[{key:"01",label:"Comprobante emitido con errores con relacion"},{key:"02",label:"Comprobante emitido con errores sin relacion"},{key:"03",label:"No se llevo a cabo la operacion"},{key:"04",label:"Operacion nominativa relacionada en factura global"}];async function c(e,i={}){const a=`${d.getApiUrl()}${e}`,t=d.getCredentials(),n=await fetch(a,{...i,headers:{"Content-Type":"application/json",Authorization:`Basic ${t}`,...i.headers}});if(!n.ok){const r=await n.json().catch(()=>({}));throw new Error(r.Message||r.message||`Facturama error: ${n.status}`)}return n}const y=()=>d.isMultiemisor();async function _(e){{const a=await(await c("/TaxEntity")).json();return{rfc:a.Rfc,hasCsd:!!a.Csd?.Certificate,serialNumber:a.Csd?.SerialNumber||"",expirationDate:a.Csd?.ExpirationDate||""}}}function C(e){return{ingreso:"I",egreso:"E",traslado:"T",nomina:"N",pago:"P"}[e]||"I"}function g(e){const i=[];return e.iva_tasa!==void 0&&i.push({Name:"IVA",Rate:Number(e.iva_tasa)||.16,Total:Number(e.iva_monto)||Number(e.precio_unitario)*Number(e.cantidad)*.16,Base:Number(e.precio_unitario)*Number(e.cantidad),IsRetention:!1}),i}function F(e){const i=Number(e.cantidad)*Number(e.precio_unitario),a=Number(e.iva_monto)||i*.16;return i+a}function p(e){return e?"02":"01"}function S(e){if(e.conceptos?.length)return e.conceptos.map(a=>{const t=g(a);return{ProductCode:a.clave_prod_serv||"01010101",UnitCode:a.clave_unidad||"ACT",Unit:a.unidad||"Actividad",Description:a.descripcion,IdentificationNumber:a.no_identificacion||"",Quantity:Number(a.cantidad)||1,UnitPrice:Number(a.precio_unitario)||0,Subtotal:Number(a.cantidad)*Number(a.precio_unitario),TaxObject:p(t.length>0),Taxes:t,Total:F(a)}});const i=Number(e.iva)>0;return[{ProductCode:"01010101",UnitCode:"ACT",Unit:"Actividad",Description:e.descripcion||"Servicio",Quantity:1,UnitPrice:Number(e.subtotal)||0,Subtotal:Number(e.subtotal)||0,TaxObject:p(i),Taxes:i?[{Name:"IVA",Rate:.16,Total:Number(e.iva)||0,Base:Number(e.subtotal)||0,IsRetention:!1}]:[],Total:Number(e.total)||0}]}function h(e,i){return{Folio:e.folio||"",Serie:e.serie||"A",Currency:e.moneda||"MXN",ExpeditionPlace:i.codigo_postal||"06300",PaymentConditions:e.condiciones_pago||"",CfdiType:C(e.tipo),PaymentForm:e.forma_pago||"99",PaymentMethod:e.metodo_pago==="PUE"?"PUE":"PPD",Receiver:{Rfc:e.receptor_rfc,Name:e.receptor_nombre,CfdiUse:e.uso_cfdi||"G03",FiscalRegime:e.receptor_regimen||"616",TaxZipCode:e.receptor_cp||"06300"},Items:S(e)}}async function I(e){return(await c("/3/cfdis",{method:"POST",body:JSON.stringify(e)})).json()}async function x(e,i,a=""){let n=`/cfdi/${e}?type=issued&motive=${i}`;return i==="01"&&a&&(n+=`&uuidReplacement=${a}`),(await c(n,{method:"DELETE"})).json()}async function w(e){return(await c(`/cfdi/xml/issued/${e}`)).text()}async function E(e){return(await c(`/cfdi/pdf/issued/${e}`)).text()}async function T(e,i,a,t){return(await c(`/api/Cfdi/Validation/${e}/${i}/${a}/${t}`)).json()}async function N(){try{const i=await(await c("/TaxEntity")).json(),a=!!i.Csd?.Certificate;return{connected:!0,sandbox:d.isSandbox(),multiemisor:y(),rfc:i.Rfc,razonSocial:i.TaxName,regimen:i.FiscalRegime,hasCsd:a,profile:i}}catch(e){return{connected:!1,sandbox:d.isSandbox(),error:e.message}}}async function q(e,i){const{data:a,error:t}=await o.from("cfdi_emitido").select("*").eq("ente_id",e).eq("ejercicio_id",i).order("fecha_emision",{ascending:!1});if(t)throw t;return a}async function v(e,i){const{data:a,error:t}=await o.from("cfdi_recibido").select("*").eq("ente_id",e).eq("ejercicio_id",i).order("fecha_recepcion",{ascending:!1});if(t)throw t;return a}async function k(e,i){const[a,t]=await Promise.all([o.from("cfdi_emitido").select("id, subtotal, total, estado").eq("ente_id",e).eq("ejercicio_id",i),o.from("cfdi_recibido").select("id, subtotal, total, estado").eq("ente_id",e).eq("ejercicio_id",i)]),n=a.data||[],r=t.data||[];return{totalEmitidos:n.length,montoEmitidos:n.filter(s=>s.estado!=="cancelado").reduce((s,m)=>s+Number(m.total||0),0),totalRecibidos:r.length,montoRecibidos:r.filter(s=>s.estado!=="cancelado").reduce((s,m)=>s+Number(m.total||0),0),timbrados:n.filter(s=>s.estado==="timbrado").length}}async function P(e,i,a){const t=h(i,a),n=await I(t),{error:r}=await o.from("cfdi_emitido").update({uuid:n.Complement?.TaxStamp?.Uuid||n.Id,estado:"timbrado",pac_id:n.Id,sello_sat:n.Complement?.TaxStamp?.SatSign||"",sello_emisor:n.Complement?.TaxStamp?.CfdiSign||"",certificado_sat:n.Complement?.TaxStamp?.SatCertNumber||"",fecha_timbrado:n.Complement?.TaxStamp?.Date||new Date().toISOString(),cadena_original:n.OriginalString||""}).eq("id",e);if(r)throw r;return n}async function A(e,i,a){const{data:t}=await o.from("cfdi_emitido").select("pac_id").eq("id",e).single();if(!t?.pac_id)throw new Error("Este CFDI no ha sido timbrado con el PAC.");const n=await x(t.pac_id,i,a);return await o.from("cfdi_emitido").update({estado:"cancelado",motivo_cancelacion:i,fecha_cancelacion:new Date().toISOString()}).eq("id",e),n}async function R(e){const{data:i}=await o.from("cfdi_emitido").select("pac_id").eq("id",e).single();if(!i?.pac_id)throw new Error("Este CFDI no ha sido timbrado.");return w(i.pac_id)}async function D(e){const{data:i}=await o.from("cfdi_emitido").select("pac_id").eq("id",e).single();if(!i?.pac_id)throw new Error("Este CFDI no ha sido timbrado.");return E(i.pac_id)}async function M(e){const{data:i}=await o.from("cfdi_recibido").select("*").eq("id",e).single();if(!i)throw new Error("CFDI no encontrado.");const a=await T(i.emisor_rfc,i.receptor_rfc||"",String(i.total),i.uuid);return await o.from("cfdi_recibido").update({validado_sat:!0,estado_sat:a.Estado||a.status,fecha_validacion:new Date().toISOString()}).eq("id",e),a}function Q(){const{entePublico:e,ejercicioFiscal:i}=b();return l({queryKey:["cfdi_emitidos",e?.id,i?.id],queryFn:()=>q(e.id,i.id),enabled:!!e?.id&&!!i?.id})}function L(){const{entePublico:e,ejercicioFiscal:i}=b();return l({queryKey:["cfdi_recibidos",e?.id,i?.id],queryFn:()=>v(e.id,i.id),enabled:!!e?.id&&!!i?.id})}function G(){const{entePublico:e,ejercicioFiscal:i}=b();return l({queryKey:["resumen_cfdi",e?.id,i?.id],queryFn:()=>k(e.id,i.id),enabled:!!e?.id&&!!i?.id})}function V(){const e=f();return u({mutationFn:({cfdiId:i,formData:a,emisor:t})=>P(i,a,t),onSuccess:()=>{e.invalidateQueries({queryKey:["cfdi_emitidos"]}),e.invalidateQueries({queryKey:["resumen_cfdi"]})}})}function X(){const e=f();return u({mutationFn:({cfdiId:i,motivo:a,uuidSustitucion:t})=>A(i,a,t),onSuccess:()=>{e.invalidateQueries({queryKey:["cfdi_emitidos"]}),e.invalidateQueries({queryKey:["resumen_cfdi"]})}})}function z(){return u({mutationFn:e=>R(e)})}function B(){return u({mutationFn:e=>D(e)})}function Z(){const e=f();return u({mutationFn:i=>M(i),onSuccess:()=>{e.invalidateQueries({queryKey:["cfdi_recibidos"]})}})}function J(){return l({queryKey:["pac_status"],queryFn:N,staleTime:6e4,retry:!1})}function H(e){return l({queryKey:["csd_ente",e],queryFn:()=>_(),enabled:!!e,staleTime:12e4,retry:!1})}export{d as F,U as M,O as R,J as a,H as b,Q as c,V as d,X as e,z as f,B as g,$ as h,K as i,L as j,Z as k,G as u};
