import{j as e,u as be,b as ge,c as fe,d as je,e as ve,f as Ne,g as ye,h as Ce,i as we,R as v}from"./index-CHHoMz4Q.js";import{b as s,g as _e,c as Se}from"./vendor-DEA9Ikep.js";import{u as se,B as h}from"./Button-BlJJN9v_.js";import{T as ke,E as ze}from"./constants-B9IYjURH.js";import{f as te}from"./polizaHelpers-DSRoDnth.js";import{S as ae}from"./Select-Dfn36s6t.js";import{B as D}from"./Badge-B5Ahs-LU.js";import{C as Pe}from"./ConfirmDialog-C6dy2a8k.js";import{b as Me,T as Ae}from"./TreeView-DOKu2HLh.js";import{M as Oe}from"./Modal-CrKTJ4AZ.js";import"./export-t5FFX7R_.js";import"./supabase-DANKYb0E.js";function Fe(r){const n=r.reduce((l,f)=>l+(parseFloat(f.debe)||0),0),o=r.reduce((l,f)=>l+(parseFloat(f.haber)||0),0),b=Math.abs(n-o);return{valido:b<.01,totalDebe:n,totalHaber:o,diferencia:b,mensaje:b<.01?null:`La poliza no cuadra. Debe: ${n.toFixed(2)}, Haber: ${o.toFixed(2)}, Diferencia: ${b.toFixed(2)}`}}function De({open:r,onClose:n,onSelect:o,enteId:b}){const[l,f]=s.useState(null),{data:x=[]}=se("plan_de_cuentas",{filter:{ente_id:b},order:{column:"codigo",ascending:!0}}),S=s.useMemo(()=>Me(x),[x]),i=d=>{d.es_detalle===!0&&f(d)},I=()=>{l&&(o(l),f(null),n())},N=()=>{f(null),n()},y=d=>e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsx("span",{className:"font-mono text-xs text-text-muted flex-shrink-0",children:d.codigo}),e.jsx("span",{className:`truncate text-sm ${d.es_detalle?"font-medium text-text-primary":"text-text-secondary"}`,children:d.nombre}),d.tipo_cuenta&&e.jsx(D,{variant:"info",className:"flex-shrink-0",children:d.tipo_cuenta}),d.naturaleza&&e.jsx(D,{variant:"default",className:"flex-shrink-0",children:d.naturaleza}),d.es_detalle&&e.jsx(D,{variant:"success",className:"flex-shrink-0",children:"Detalle"})]});return e.jsxs(Oe,{open:r,onClose:N,title:"Seleccionar Cuenta Contable",size:"lg",children:[e.jsx("p",{className:"text-sm text-text-muted mb-3",children:"Seleccione una cuenta de detalle para el movimiento contable."}),e.jsx("div",{className:"max-h-[400px] overflow-y-auto border border-border rounded-lg p-2",children:e.jsx(Ae,{data:S,renderNode:y,onSelect:i,selectedId:l?.id,searchable:!0})}),l&&e.jsxs("div",{className:"mt-3 p-3 bg-bg-hover rounded-lg",children:[e.jsxs("p",{className:"text-sm font-medium text-text-primary",children:[l.codigo," — ",l.nombre]}),e.jsxs("p",{className:"text-xs text-text-muted mt-1",children:["Tipo: ",l.tipo_cuenta," | Naturaleza:"," ",l.naturaleza]})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-3 border-t border-border mt-4",children:[e.jsx(h,{variant:"ghost",onClick:N,children:"Cancelar"}),e.jsx(h,{onClick:I,disabled:!l,children:"Seleccionar"})]})]})}const Ie={borrador:"default",pendiente:"warning",aprobada:"success",cancelada:"danger"},$={cuenta_id:"",cuenta_codigo:"",cuenta_nombre:"",concepto:"",debe:"",haber:""},_=r=>new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(r);function Je(){const{id:r}=_e(),n=!r,o=Se(),{entePublico:b,ejercicioFiscal:l,periodoContable:f,user:x,rol:S}=be(),{data:i,isLoading:I}=ge(r),{data:N=[]}=se("periodo_contable",{filter:{ejercicio_id:l?.id},order:{column:"numero",ascending:!0}}),y=fe(),d=je(),L=ve(),E=Ne(),k=ye(),T=Ce(),[j,V]=s.useState("diario"),[z,U]=s.useState(new Date().toISOString().split("T")[0]),[P,X]=s.useState(f?.id||""),[R,G]=s.useState(""),{data:M}=we(n?j:null),[m,C]=s.useState([{...$},{...$}]),[ne,B]=s.useState(!1),[Le,W]=s.useState(null),[q,J]=s.useState(""),[re,A]=s.useState(!1),[K,Ee]=s.useState("");s.useEffect(()=>{i&&!n&&(V(i.tipo),U(i.fecha),X(i.periodo_id||""),G(i.descripcion||""),i.movimientos?.length>0&&C(i.movimientos.map(t=>({cuenta_id:t.cuenta_id||"",cuenta_codigo:t.plan_de_cuentas?.codigo||"",cuenta_nombre:t.plan_de_cuentas?.nombre||"",concepto:t.concepto||"",debe:t.debe>0?String(t.debe):"",haber:t.haber>0?String(t.haber):""}))))},[i,n]);const O=m.reduce((t,a)=>t+(parseFloat(a.debe)||0),0),F=m.reduce((t,a)=>t+(parseFloat(a.haber)||0),0),Q=Math.abs(O-F),Y=Q<.01,g=i?.estado||"borrador",p=g==="aprobada"||g==="cancelada"||g==="pendiente",oe=s.useMemo(()=>N.map(t=>({value:t.id,label:`${t.numero} — ${t.nombre||t.mes}`})),[N]),le=s.useMemo(()=>Object.entries(ke).map(([t,a])=>({value:t,label:a})),[]),Z=s.useCallback((t,a,u)=>{C(c=>{const w=[...c];return w[t]={...w[t],[a]:u},a==="debe"&&u&&(w[t].haber=""),a==="haber"&&u&&(w[t].debe=""),w})},[]),ie=s.useCallback(()=>C(t=>[...t,{...$}]),[]),ce=s.useCallback(t=>{m.length<=2||C(a=>a.filter((u,c)=>c!==t))},[m.length]),de=s.useCallback(t=>{W(t),B(!0)},[]),ue=s.useCallback(t=>{t!=null&&(W(a=>(a!=null&&C(u=>{const c=[...u];return c[a]={...c[a],cuenta_id:t.id,cuenta_codigo:t.codigo,cuenta_nombre:t.nombre},c}),a)),B(!1))},[]),ee=j&&z&&P&&m.length>=2&&m.every(t=>t.cuenta_id&&(parseFloat(t.debe)>0||parseFloat(t.haber)>0))&&Y,H=s.useCallback(async()=>{J("");const t=Fe(m);if(!t.valido){J(t.mensaje);return}const a={ente_id:b?.id,ejercicio_id:l?.id,periodo_id:P,tipo:j,numero_poliza:n?M:i?.numero_poliza,fecha:z,descripcion:R.trim(),estado:"borrador",total_debe:O,total_haber:F,creado_por:x?.id||x?.email},u=m.map(c=>({cuenta_id:c.cuenta_id,concepto:c.concepto||"",debe:parseFloat(c.debe)||0,haber:parseFloat(c.haber)||0}));try{if(n){const c=await y.mutateAsync({header:a,movimientos:u});o(v.POLIZAS+"/"+c.id,{replace:!0})}else await d.mutateAsync({id:r,changes:a,movimientos:u})}catch(c){console.error("Error saving poliza:",c)}},[b,l,P,j,n,M,i,z,R,O,F,x,m,r,y,d,o]),xe=s.useCallback(async()=>{n&&await H(),await L.mutateAsync(r||i?.id),o(v.POLIZAS)},[n,H,L,r,i,o]),me=s.useCallback(async()=>{await E.mutateAsync({polizaId:r,aprobadoPor:x?.id||x?.email}),o(v.POLIZAS)},[E,r,x,o]),pe=s.useCallback(async()=>{await T.mutateAsync(r)},[T,r]),he=s.useCallback(async()=>{await k.mutateAsync({polizaId:r,canceladoPor:x?.id||x?.email,motivo:K}),A(!1),o(v.POLIZAS)},[k,r,x,K,o]);return!n&&I?e.jsx("div",{className:"flex items-center justify-center py-24",children:e.jsxs("svg",{className:"animate-spin h-8 w-8 text-guinda",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]})}):e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-4 mb-6",children:[e.jsx("button",{onClick:()=>o(v.POLIZAS),className:"text-text-muted hover:text-text-heading transition-colors cursor-pointer",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z",clipRule:"evenodd"})})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h1",{className:"text-xl font-bold text-text-primary",children:n?"Nueva Poliza":`Poliza ${te(j,i?.numero_poliza||M||0)}`}),!n&&e.jsx(D,{variant:Ie[g]||"default",children:ze[g]?.label||g})]}),e.jsx("p",{className:"text-sm text-text-muted mt-1",children:n?"Registre una nueva poliza contable con partida doble":"Detalle y movimientos de la poliza"})]})]}),e.jsxs("div",{className:"bg-white rounded-lg card-shadow p-5 mb-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx(ae,{label:"Tipo *",options:le,value:j,onChange:t=>V(t.target.value),disabled:!n||p}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-text-heading mb-1.5",children:"Numero"}),e.jsx("div",{className:"h-[40px] rounded-md border border-border bg-bg-hover text-text-muted text-[0.9375rem] px-3.5 flex items-center font-mono",children:te(j,n?M||"...":i?.numero_poliza)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-text-heading mb-1.5",children:"Fecha *"}),e.jsx("input",{type:"date",value:z,onChange:t=>U(t.target.value),disabled:p,className:"block w-full h-[40px] rounded-md border border-border bg-white text-text-heading text-[0.9375rem] px-3.5 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda transition-all duration-150"})]}),e.jsx(ae,{label:"Periodo *",options:oe,value:P,onChange:t=>X(t.target.value),placeholder:"Seleccionar...",disabled:p})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"block text-sm font-medium text-text-heading mb-1.5",children:"Descripcion"}),e.jsx("textarea",{rows:2,value:R,onChange:t=>G(t.target.value),disabled:p,placeholder:"Descripcion de la poliza...",className:"block w-full rounded-md border border-border bg-white text-text-heading text-[0.9375rem] px-3.5 py-2.5 placeholder:text-text-muted focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda transition-all duration-150 resize-none"})]})]}),e.jsxs("div",{className:"bg-white rounded-lg card-shadow p-5 mb-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-sm font-semibold text-text-secondary",children:"Movimientos contables"}),!p&&e.jsx(h,{size:"sm",variant:"outline-primary",onClick:ie,children:"+ Agregar linea"})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-[#f9fafb]",children:[e.jsx("th",{className:"text-left text-xs font-semibold text-text-secondary uppercase tracking-wider px-3 py-2.5 w-10",children:"#"}),e.jsx("th",{className:"text-left text-xs font-semibold text-text-secondary uppercase tracking-wider px-3 py-2.5",children:"Cuenta"}),e.jsx("th",{className:"text-left text-xs font-semibold text-text-secondary uppercase tracking-wider px-3 py-2.5",children:"Concepto"}),e.jsx("th",{className:"text-right text-xs font-semibold text-text-secondary uppercase tracking-wider px-3 py-2.5 w-40",children:"Debe"}),e.jsx("th",{className:"text-right text-xs font-semibold text-text-secondary uppercase tracking-wider px-3 py-2.5 w-40",children:"Haber"}),!p&&e.jsx("th",{className:"w-10"})]})}),e.jsx("tbody",{children:m.map((t,a)=>e.jsxs("tr",{className:"border-b border-[#f0f0f0]",children:[e.jsx("td",{className:"px-3 py-2 text-xs text-text-muted",children:a+1}),e.jsx("td",{className:"px-3 py-2",children:p?e.jsxs("span",{className:"text-sm",children:[t.cuenta_codigo," — ",t.cuenta_nombre]}):e.jsx("button",{onClick:()=>de(a),className:"text-left w-full text-sm hover:text-primary transition-colors cursor-pointer",children:t.cuenta_id?e.jsxs("span",{className:"font-mono",children:[t.cuenta_codigo," ",e.jsxs("span",{className:"text-text-muted",children:["— ",t.cuenta_nombre]})]}):e.jsx("span",{className:"text-text-muted italic",children:"Seleccionar cuenta..."})})}),e.jsx("td",{className:"px-3 py-2",children:p?e.jsx("span",{className:"text-sm",children:t.concepto||"—"}):e.jsx("input",{type:"text",value:t.concepto,onChange:u=>Z(a,"concepto",u.target.value),placeholder:"Concepto...",className:"w-full text-sm border border-border rounded-md px-2.5 py-1.5 focus:outline-none focus:ring-1 focus:ring-guinda/25 focus:border-guinda"})}),e.jsx("td",{className:"px-3 py-2",children:p?e.jsx("span",{className:"font-mono text-sm text-right block",children:parseFloat(t.debe)>0?_(t.debe):""}):e.jsx("input",{type:"number",value:t.debe,onChange:u=>Z(a,"debe",u.target.value),placeholder:"0.00",min:"0",step:"0.01",className:"w-full text-sm text-right font-mono border border-border rounded-md px-2.5 py-1.5 focus:outline-none focus:ring-1 focus:ring-guinda/25 focus:border-guinda"})}),e.jsx("td",{className:"px-3 py-2",children:p?e.jsx("span",{className:"font-mono text-sm text-right block",children:parseFloat(t.haber)>0?_(t.haber):""}):e.jsx("input",{type:"number",value:t.haber,onChange:u=>Z(a,"haber",u.target.value),placeholder:"0.00",min:"0",step:"0.01",className:"w-full text-sm text-right font-mono border border-border rounded-md px-2.5 py-1.5 focus:outline-none focus:ring-1 focus:ring-guinda/25 focus:border-guinda"})}),!p&&e.jsx("td",{className:"px-3 py-2",children:m.length>2&&e.jsx("button",{onClick:()=>ce(a),className:"text-danger hover:text-danger/80 transition-colors cursor-pointer",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z",clipRule:"evenodd"})})})})]},a))})]})})]}),e.jsxs("div",{className:"sticky bottom-0 bg-white rounded-lg card-shadow p-4 mb-4 border-t-2 border-guinda/20",children:[q&&e.jsx("div",{className:"mb-3 p-3 bg-danger/10 border border-danger/20 rounded-md text-danger text-sm",children:q}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-6",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-xs text-text-muted uppercase",children:"Total Debe"}),e.jsx("p",{className:"font-mono text-lg font-semibold text-text-primary",children:_(O)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-xs text-text-muted uppercase",children:"Total Haber"}),e.jsx("p",{className:"font-mono text-lg font-semibold text-text-primary",children:_(F)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-xs text-text-muted uppercase",children:"Diferencia"}),e.jsx("p",{className:`font-mono text-lg font-semibold ${Y?"text-success":"text-danger"}`,children:_(Q)})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[(g==="borrador"||n)&&e.jsxs(e.Fragment,{children:[e.jsx(h,{variant:"ghost",onClick:()=>o(v.POLIZAS),children:"Cancelar"}),e.jsx(h,{variant:"outline-primary",onClick:H,disabled:!ee,loading:y.isPending||d.isPending,children:"Guardar Borrador"}),!n&&e.jsx(h,{onClick:xe,disabled:!ee,loading:L.isPending,children:"Enviar a Aprobacion"})]}),g==="pendiente"&&e.jsxs(e.Fragment,{children:[e.jsx(h,{variant:"ghost",onClick:()=>A(!0),children:"Cancelar Poliza"}),e.jsx(h,{variant:"outline-primary",onClick:pe,loading:T.isPending,children:"Regresar a Borrador"}),(S==="super_admin"||S==="contador_general")&&e.jsx(h,{variant:"success",onClick:me,loading:E.isPending,children:"Aprobar"})]}),g==="aprobada"&&e.jsx(h,{variant:"danger",onClick:()=>A(!0),loading:k.isPending,children:"Cancelar Poliza"}),g==="cancelada"&&e.jsx(h,{variant:"ghost",onClick:()=>o(v.POLIZAS),children:"Volver"})]})]})]}),e.jsx(De,{open:ne,onClose:()=>B(!1),onSelect:ue,enteId:b?.id}),e.jsx(Pe,{open:re,onClose:()=>A(!1),onConfirm:he,title:"Cancelar Poliza",message:"Esta seguro de cancelar esta poliza? Esta accion no se puede deshacer.",confirmText:"Cancelar Poliza",variant:"danger",loading:k.isPending})]})}export{Je as default};
