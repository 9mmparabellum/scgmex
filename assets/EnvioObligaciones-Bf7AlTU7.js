import{s as J,u as O,o as $,A as ne,j as t}from"./index-CyKkzz21.js";import{b as l}from"./vendor-DEA9Ikep.js";import{a as re,b as le,c as de}from"./useCrud-bUfgzWCS.js";import{H as G,J as F}from"./constants-B48pdecp.js";import{D as ce}from"./DataTable-DfIEqyJf.js";import{M as me}from"./Modal-CR5BegYj.js";import{B as N}from"./Button-BA780zlq.js";import{I as y}from"./Input-CofDiIdZ.js";import{S as V}from"./Select-B7MIUx36.js";import{B as I}from"./Badge-BiItYtys.js";import{C as ue}from"./ConfirmDialog-DPG7zYiO.js";import{e as xe}from"./exportHelpers-CvXmrB4L.js";import"./supabase-DANKYb0E.js";import"./export-t5FFX7R_.js";async function pe(i,a){const{data:p,error:r}=await J.from("envio_obligacion").select("*").eq("ente_id",i).eq("ejercicio_id",a).order("fecha_limite",{ascending:!0});if(r)throw r;return p}async function he(i,a){const{data:p,error:r}=await J.from("envio_obligacion").select("id, tipo, estado, fecha_limite, fecha_envio").eq("ente_id",i).eq("ejercicio_id",a);if(r)throw r;const u=p||[],x=new Date;return{total:u.length,pendientes:u.filter(o=>o.estado==="pendiente").length,enviados:u.filter(o=>["enviado","confirmado"].includes(o.estado)).length,vencidos:u.filter(o=>o.estado==="pendiente"&&new Date(o.fecha_limite)<x).length,rechazados:u.filter(o=>o.estado==="rechazado").length}}function ge(){const{entePublico:i,ejercicioFiscal:a}=O();return $({queryKey:["envios_obligacion",i?.id,a?.id],queryFn:()=>pe(i.id,a.id),enabled:!!i?.id&&!!a?.id})}function be(){const{entePublico:i,ejercicioFiscal:a}=O();return $({queryKey:["resumen_envios",i?.id,a?.id],queryFn:()=>he(i.id,a.id),enabled:!!i?.id&&!!a?.id})}const T=i=>i?new Date(i+"T00:00:00").toLocaleDateString("es-MX",{day:"2-digit",month:"short",year:"numeric"}):"—",w=i=>G[i]||i,S=i=>F[i]?.label||i,Q=i=>F[i]?.variant||"default",fe=[{key:"Q1",label:"T1 (Ene–Mar)",months:[1,2,3]},{key:"Q2",label:"T2 (Abr–Jun)",months:[4,5,6]},{key:"Q3",label:"T3 (Jul–Sep)",months:[7,8,9]},{key:"Q4",label:"T4 (Oct–Dic)",months:[10,11,12]}],B={tipo:"conac_trimestral",periodo:"",descripcion:"",fecha_limite:"",fecha_envio:"",estado:"pendiente",acuse:"",notas:""};function Pe(){const{entePublico:i,ejercicioFiscal:a,rol:p}=O(),r=ne(p,"obligaciones"),[u,x]=l.useState(!1),[o,P]=l.useState(null),[n,_]=l.useState({...B}),[K,E]=l.useState(!1),[h,k]=l.useState(null),[b,U]=l.useState(""),[f,H]=l.useState(""),{data:v=[],isLoading:X}=ge(),{data:g={}}=be(),M=re("envio_obligacion"),A=le("envio_obligacion"),q=de("envio_obligacion"),z=l.useMemo(()=>Object.entries(G).map(([e,s])=>({value:e,label:s})),[]),L=l.useMemo(()=>Object.entries(F).map(([e,s])=>({value:e,label:s.label})),[]),C=l.useMemo(()=>{let e=v;return b&&(e=e.filter(s=>s.estado===b)),f&&(e=e.filter(s=>s.tipo===f)),e},[v,b,f]),W=l.useMemo(()=>{const e=new Date;return fe.map(s=>{const d=v.filter(c=>{if(!c.fecha_limite)return!1;const j=new Date(c.fecha_limite+"T00:00:00").getMonth()+1;return s.months.includes(j)});return{...s,items:d.map(c=>{const j=c.estado==="pendiente"&&new Date(c.fecha_limite)<e,ae=c.estado==="pendiente"&&!j&&new Date(c.fecha_limite)-e<360*60*60*1e3,oe=["enviado","confirmado"].includes(c.estado);return{...c,isVencido:j,isProximo:ae,isEnviado:oe}})}})},[v]),m=(e,s)=>_(d=>({...d,[e]:s})),Y=()=>{P(null),_({...B}),x(!0)},D=e=>{r&&(P(e),_({tipo:e.tipo??"conac_trimestral",periodo:e.periodo??"",descripcion:e.descripcion??"",fecha_limite:e.fecha_limite??"",fecha_envio:e.fecha_envio??"",estado:e.estado??"pendiente",acuse:e.acuse??"",notas:e.notas??""}),x(!0))},Z=async()=>{const e={...n,ente_id:i?.id,ejercicio_id:a?.id,fecha_envio:n.fecha_envio||null};o?await A.mutateAsync({id:o.id,...e}):await M.mutateAsync(e),x(!1)},ee=e=>{k(e),E(!0)},te=async()=>{h&&await q.mutateAsync(h.id),E(!1),k(null)},se=()=>{xe(C,[{key:"tipo",label:"Tipo",getValue:s=>w(s.tipo)},{key:"periodo",label:"Periodo"},{key:"descripcion",label:"Descripcion"},{key:"fecha_limite",label:"Fecha Limite"},{key:"fecha_envio",label:"Fecha Envio"},{key:"estado",label:"Estado",getValue:s=>S(s.estado)},{key:"acuse",label:"Acuse"},{key:"notas",label:"Notas"}],"envio_obligaciones")},ie=[{key:"tipo",label:"Tipo",width:"180px",render:e=>t.jsx("span",{className:"text-[0.8125rem] font-medium",children:w(e)})},{key:"periodo",label:"Periodo",width:"100px"},{key:"fecha_limite",label:"Fecha Limite",width:"130px",render:e=>{const s=new Date,d=e&&new Date(e)<s;return t.jsx("span",{className:d?"text-danger font-medium":"",children:T(e)})}},{key:"fecha_envio",label:"Fecha Envio",width:"130px",render:e=>T(e)},{key:"estado",label:"Estado",width:"120px",render:e=>t.jsx(I,{variant:Q(e),children:S(e)})},{key:"id",label:"Acciones",width:"140px",sortable:!1,render:(e,s)=>r?t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{onClick:d=>{d.stopPropagation(),D(s)},className:"text-xs text-primary hover:text-primary-light transition-colors cursor-pointer",children:"Editar"}),t.jsx("button",{onClick:d=>{d.stopPropagation(),ee(s)},className:"text-xs text-danger hover:text-danger/80 transition-colors cursor-pointer",children:"Eliminar"})]}):t.jsx("span",{className:"text-xs text-text-muted",children:"Solo lectura"})}],R=M.isPending||A.isPending;return t.jsxs("div",{children:[t.jsxs("div",{className:"mb-6",children:[t.jsx("h1",{className:"text-xl font-bold text-text-primary",children:"Envio de Obligaciones"}),t.jsx("p",{className:"text-sm text-text-muted mt-1",children:"Control y seguimiento de envios de informacion a organos fiscalizadores"})]}),t.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-4 mb-6",children:[t.jsxs("div",{className:"bg-white rounded-lg card-shadow p-4",children:[t.jsx("p",{className:"text-xs text-text-muted uppercase tracking-wide mb-1",children:"Total Obligaciones"}),t.jsx("p",{className:"text-lg font-bold text-text-primary",children:g.total??0})]}),t.jsxs("div",{className:"bg-white rounded-lg card-shadow p-4",children:[t.jsx("p",{className:"text-xs text-text-muted uppercase tracking-wide mb-1",children:"Pendientes"}),t.jsx("p",{className:"text-lg font-bold text-amber-600",children:g.pendientes??0})]}),t.jsxs("div",{className:"bg-white rounded-lg card-shadow p-4",children:[t.jsx("p",{className:"text-xs text-text-muted uppercase tracking-wide mb-1",children:"Enviados"}),t.jsx("p",{className:"text-lg font-bold text-emerald-600",children:g.enviados??0})]}),t.jsxs("div",{className:"bg-white rounded-lg card-shadow p-4 border border-red-100",children:[t.jsx("p",{className:"text-xs text-text-muted uppercase tracking-wide mb-1",children:"Vencidos"}),t.jsx("p",{className:"text-lg font-bold text-danger",children:g.vencidos??0})]}),t.jsxs("div",{className:"bg-white rounded-lg card-shadow p-4",children:[t.jsx("p",{className:"text-xs text-text-muted uppercase tracking-wide mb-1",children:"Rechazados"}),t.jsx("p",{className:"text-lg font-bold text-danger",children:g.rechazados??0})]})]}),t.jsxs("div",{className:"mb-6",children:[t.jsx("h2",{className:"text-sm font-semibold text-text-secondary mb-3",children:"Calendario de Obligaciones"}),t.jsx("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:W.map(e=>t.jsxs("div",{className:"bg-white rounded-lg card-shadow p-4",children:[t.jsx("h3",{className:"text-xs font-semibold text-text-secondary uppercase tracking-wide mb-3",children:e.label}),e.items.length===0?t.jsx("p",{className:"text-xs text-text-muted italic",children:"Sin obligaciones"}):t.jsx("div",{className:"space-y-2",children:e.items.map(s=>t.jsxs("div",{className:["rounded-md px-3 py-2 text-xs cursor-pointer transition-colors",s.isVencido?"bg-red-50 border border-red-200 hover:bg-red-100":s.isProximo?"bg-amber-50 border border-amber-200 hover:bg-amber-100":s.isEnviado?"bg-emerald-50 border border-emerald-200 hover:bg-emerald-100":"bg-gray-50 border border-gray-200 hover:bg-gray-100"].join(" "),onClick:()=>r&&D(s),children:[t.jsxs("div",{className:"flex items-center justify-between mb-1",children:[t.jsx("span",{className:"font-medium text-text-primary truncate",children:w(s.tipo)}),t.jsx(I,{variant:Q(s.estado),children:S(s.estado)})]}),t.jsxs("p",{className:"text-text-muted",children:[T(s.fecha_limite),s.periodo?` · ${s.periodo}`:""]})]},s.id))})]},e.key))})]}),t.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 mb-4",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs("h2",{className:"text-sm font-semibold text-text-secondary",children:["Detalle",t.jsxs("span",{className:"ml-2 text-text-muted font-normal",children:["(",C.length," registros)"]})]}),t.jsxs("select",{value:f,onChange:e=>H(e.target.value),className:"h-[32px] rounded-md border border-border bg-white text-[0.8125rem] text-text-heading px-2 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda",children:[t.jsx("option",{value:"",children:"Todos los tipos"}),z.map(e=>t.jsx("option",{value:e.value,children:e.label},e.value))]}),t.jsxs("select",{value:b,onChange:e=>U(e.target.value),className:"h-[32px] rounded-md border border-border bg-white text-[0.8125rem] text-text-heading px-2 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda",children:[t.jsx("option",{value:"",children:"Todos los estados"}),L.map(e=>t.jsx("option",{value:e.value,children:e.label},e.value))]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(N,{onClick:se,variant:"outline-primary",size:"sm",children:"Exportar Excel"}),r&&t.jsx(N,{onClick:Y,size:"sm",children:"+ Nuevo Envio"})]})]}),X?t.jsx("div",{className:"flex items-center justify-center py-16 text-text-muted text-sm",children:"Cargando obligaciones..."}):t.jsx(ce,{columns:ie,data:C,onRowClick:r?D:void 0}),t.jsx(me,{open:u,onClose:()=>x(!1),title:o?"Editar Envio":"Nuevo Envio",size:"lg",children:t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsx(V,{label:"Tipo de Obligacion",value:n.tipo,onChange:e=>m("tipo",e.target.value),options:z,placeholder:"\\u2014 Seleccione tipo \\u2014",required:!0}),t.jsx(y,{label:"Periodo",value:n.periodo,onChange:e=>m("periodo",e.target.value),placeholder:"Ej. 2024-T1",required:!0})]}),t.jsxs("div",{className:"w-full",children:[t.jsx("label",{className:"block text-sm font-medium text-text-heading mb-1.5",children:"Descripcion"}),t.jsx("textarea",{value:n.descripcion,onChange:e=>m("descripcion",e.target.value),placeholder:"Descripcion de la obligacion",rows:2,className:"w-full min-h-[60px] rounded-md border border-border px-3 py-2 text-[0.9375rem] text-text-heading placeholder:text-text-muted focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda transition-all duration-150"})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsx(y,{label:"Fecha Limite",type:"date",value:n.fecha_limite,onChange:e=>m("fecha_limite",e.target.value),required:!0}),t.jsx(y,{label:"Fecha Envio",type:"date",value:n.fecha_envio,onChange:e=>m("fecha_envio",e.target.value)})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsx(V,{label:"Estado",value:n.estado,onChange:e=>m("estado",e.target.value),options:L,placeholder:"\\u2014 Seleccione estado \\u2014",required:!0}),t.jsx(y,{label:"Acuse",value:n.acuse,onChange:e=>m("acuse",e.target.value),placeholder:"Numero de acuse o referencia"})]}),t.jsxs("div",{className:"w-full",children:[t.jsx("label",{className:"block text-sm font-medium text-text-heading mb-1.5",children:"Notas"}),t.jsx("textarea",{value:n.notas,onChange:e=>m("notas",e.target.value),placeholder:"Notas adicionales",rows:3,className:"w-full min-h-[80px] rounded-md border border-border px-3 py-2 text-[0.9375rem] text-text-heading placeholder:text-text-muted focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda transition-all duration-150"})]}),t.jsxs("div",{className:"flex justify-end gap-3 pt-2 border-t border-border",children:[t.jsx(N,{variant:"ghost",onClick:()=>x(!1),disabled:R,children:"Cancelar"}),t.jsx(N,{onClick:Z,loading:R,disabled:!n.tipo||!n.periodo.trim()||!n.fecha_limite,children:o?"Guardar cambios":"Crear envio"})]})]})}),t.jsx(ue,{open:K,onClose:()=>{E(!1),k(null)},onConfirm:te,title:"Eliminar envio",message:h?`¿Esta seguro de eliminar el envio "${w(h.tipo)} — ${h.periodo||""}"? Esta accion no se puede deshacer.`:"",confirmText:"Eliminar",loading:q.isPending})]})}export{Pe as default};
