import{u as Re,A as $e,j as t}from"./index-KskWbqO9.js";import{b as o}from"./vendor-DEA9Ikep.js";import{useCreate as Le,useUpdate as qe,useRemove as Ve}from"./useCrud-C19KmPO4.js";import{c as Be,d as Xe,e as ze,f as Ge,g as Qe,h as He,M as Je,R as Ke,i as We}from"./useCFDI-BCypyy2r.js";import{O as T,P,U as ne,Q as ce}from"./constants-CX_We7cr.js";import{D as Ye}from"./DataTable-DWljaDCm.js";import{M as Q}from"./Modal-DfjuYvxB.js";import{B as x}from"./Button-DGu3eAys.js";import{I as n}from"./Input-CHoXOb6x.js";import{S as g}from"./Select-k3R1vLiz.js";import{B as Ze}from"./Badge-B4UqNpVe.js";import{C as we}from"./ConfirmDialog-D5TWhe0q.js";import{e as et}from"./exportHelpers-CvXmrB4L.js";import"./supabase-DANKYb0E.js";import"./export-t5FFX7R_.js";const A=d=>new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(d||0),H=()=>new Date().toISOString().slice(0,10),de={serie:"",folio:"",uuid:"",fecha_emision:H(),receptor_rfc:"",receptor_nombre:"",receptor_regimen:"616",receptor_cp:"",uso_cfdi:"G03",tipo:"ingreso",metodo_pago:"PUE",forma_pago:"99",moneda:"MXN",descripcion:"",subtotal:"",iva:"",total:"",estado:"borrador",notas:""};function ue(d,k,U){try{const u=d.replace(/^data:[^;]+;base64,/,"").replace(/"/g,""),b=atob(u),l=new Array(b.length);for(let C=0;C<b.length;C++)l[C]=b.charCodeAt(C);const v=new Uint8Array(l),D=new Blob([v],{type:U}),s=URL.createObjectURL(D),m=document.createElement("a");m.href=s,m.download=k,document.body.appendChild(m),m.click(),document.body.removeChild(m),URL.revokeObjectURL(s)}catch{const u=new Blob([d],{type:"text/plain"}),b=URL.createObjectURL(u),l=document.createElement("a");l.href=b,l.download=k,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(b)}}function gt(){const{entePublico:d,ejercicioFiscal:k,rol:U}=Re(),u=$e(U,"cfdi"),[b,l]=o.useState(!1),[v,D]=o.useState(null),[s,m]=o.useState({...de}),[C,R]=o.useState(!1),[f,$]=o.useState(null),[E,me]=o.useState(""),[F,pe]=o.useState(""),[be,S]=o.useState(!1),[c,I]=o.useState(null),[J,y]=o.useState(""),[xe,M]=o.useState(!1),[h,O]=o.useState(null),[_,K]=o.useState("02"),[L,W]=o.useState(""),[Y,N]=o.useState(""),{data:Z=[],isLoading:ge}=Be(),w=Le("cfdi_emitido"),ee=qe("cfdi_emitido"),te=Ve("cfdi_emitido"),q=Xe(),V=ze(),B=Ge(),X=Qe(),fe=o.useMemo(()=>Object.entries(T).map(([e,a])=>({value:e,label:a})),[]),he=o.useMemo(()=>Object.entries(P).map(([e,{label:a}])=>({value:e,label:a})),[]),ve=o.useMemo(()=>Object.entries(ne).map(([e,a])=>({value:e,label:`${e} - ${a}`})),[]),Ce=o.useMemo(()=>Object.entries(ce).map(([e,a])=>({value:e,label:`${e} - ${a}`})),[]),je=o.useMemo(()=>He.map(e=>({value:e.key,label:`${e.key} - ${e.label}`})),[]),ye=o.useMemo(()=>Je.map(e=>({value:e.key,label:`${e.key} - ${e.label}`})),[]),_e=o.useMemo(()=>Ke.map(e=>({value:e.key,label:`${e.key} - ${e.label}`})),[]),Ne=o.useMemo(()=>We.map(e=>({value:e.key,label:`${e.key} - ${e.label}`})),[]),ke=o.useMemo(()=>[{value:"",label:"Todos los tipos"},...Object.entries(T).map(([e,a])=>({value:e,label:a}))],[]),De=o.useMemo(()=>[{value:"",label:"Todos los estados"},...Object.entries(P).map(([e,{label:a}])=>({value:e,label:a}))],[]),z=o.useMemo(()=>{let e=Z;return E&&(e=e.filter(a=>a.tipo===E)),F&&(e=e.filter(a=>a.estado===F)),e},[Z,E,F]),r=(e,a)=>m(p=>{const j={...p,[e]:a};if(e==="subtotal"||e==="iva"){const G=Number(e==="subtotal"?a:j.subtotal)||0,i=Number(e==="iva"?a:j.iva)||0;j.total=(G+i).toFixed(2)}return j}),Ee=e=>e?e.length>12?e.slice(0,8)+"...":e:"",Fe=()=>{D(null),m({...de,fecha_emision:H()}),l(!0)},ae=e=>{D(e),m({serie:e.serie??"",folio:e.folio??"",uuid:e.uuid??"",fecha_emision:e.fecha_emision??H(),receptor_rfc:e.receptor_rfc??"",receptor_nombre:e.receptor_nombre??"",receptor_regimen:e.receptor_regimen??"616",receptor_cp:e.receptor_cp??"",uso_cfdi:e.uso_cfdi??"G03",tipo:e.tipo??"ingreso",metodo_pago:e.metodo_pago??"PUE",forma_pago:e.forma_pago??"99",moneda:e.moneda??"MXN",descripcion:e.descripcion??"",subtotal:e.subtotal??"",iva:e.iva??"",total:e.total??"",estado:e.estado??"borrador",notas:e.notas??""}),l(!0)},Se=async()=>{const e={...s,ente_id:d?.id,ejercicio_id:k?.id,subtotal:Number(s.subtotal)||0,iva:Number(s.iva)||0,total:Number(s.total)||0};v?await ee.mutateAsync({id:v.id,...e}):await w.mutateAsync(e),l(!1)},Ie=e=>{$(e),R(!0)},Me=async()=>{f&&await te.mutateAsync(f.id),R(!1),$(null)},oe=o.useCallback(e=>{I(e),y(""),S(!0)},[]),Oe=async()=>{if(c){y("");try{const e={rfc:d?.rfc||"",nombre:d?.nombre||"",codigo_postal:d?.codigo_postal||"06600"};await q.mutateAsync({cfdiId:c.id,formData:c,emisor:e}),S(!1),I(null)}catch(e){y(e.message||"Error al timbrar el CFDI.")}}},se=o.useCallback(e=>{O(e),K("02"),W(""),N(""),M(!0)},[]),Te=async()=>{if(h){N("");try{await V.mutateAsync({cfdiId:h.id,motivo:_,uuidSustitucion:_==="01"?L:""}),M(!1),O(null)}catch(e){N(e.message||"Error al cancelar el CFDI.")}}},re=o.useCallback(async e=>{try{const a=await B.mutateAsync(e.id),p=`CFDI_${e.serie||""}${e.folio||""}_${e.uuid?.slice(0,8)||"sin-uuid"}.xml`;ue(a,p,"application/xml")}catch{}},[B]),le=o.useCallback(async e=>{try{const a=await X.mutateAsync(e.id),p=`CFDI_${e.serie||""}${e.folio||""}_${e.uuid?.slice(0,8)||"sin-uuid"}.pdf`;ue(a,p,"application/pdf")}catch{}},[X]),Pe=()=>{et(z,[{key:"serie",label:"Serie"},{key:"folio",label:"Folio"},{key:"uuid",label:"UUID"},{key:"fecha_emision",label:"Fecha Emision"},{key:"receptor_rfc",label:"Receptor RFC"},{key:"receptor_nombre",label:"Receptor Nombre"},{key:"uso_cfdi",label:"Uso CFDI",getValue:a=>ne[a.uso_cfdi]||a.uso_cfdi},{key:"tipo",label:"Tipo",getValue:a=>T[a.tipo]||a.tipo},{key:"metodo_pago",label:"Metodo Pago",getValue:a=>ce[a.metodo_pago]||a.metodo_pago},{key:"forma_pago",label:"Forma Pago"},{key:"moneda",label:"Moneda"},{key:"subtotal",label:"Subtotal",getValue:a=>Number(a.subtotal||0)},{key:"iva",label:"IVA",getValue:a=>Number(a.iva||0)},{key:"total",label:"Total",getValue:a=>Number(a.total||0)},{key:"estado",label:"Estado",getValue:a=>P[a.estado]?.label||a.estado},{key:"notas",label:"Notas"}],"cfdi_emitidos")},Ae=e=>{const a=P[e]||{label:e,variant:"default"};return t.jsx(Ze,{variant:a.variant,children:a.label})},Ue=o.useMemo(()=>[{key:"serie",label:"Serie-Folio",width:"120px",render:(e,a)=>`${e||""}${e&&a.folio?"-":""}${a.folio||""}`},{key:"uuid",label:"UUID",width:"120px",render:e=>t.jsx("span",{title:e||"",children:Ee(e)})},{key:"fecha_emision",label:"Fecha",width:"110px"},{key:"receptor_rfc",label:"Receptor RFC",width:"140px"},{key:"receptor_nombre",label:"Receptor Nombre"},{key:"tipo",label:"Tipo",width:"100px",render:e=>T[e]||e},{key:"subtotal",label:"Subtotal",width:"130px",render:e=>t.jsx("span",{className:"text-right block tabular-nums",children:A(e)})},{key:"iva",label:"IVA",width:"110px",render:e=>t.jsx("span",{className:"text-right block tabular-nums",children:A(e)})},{key:"total",label:"Total",width:"140px",render:e=>t.jsx("span",{className:"text-right block tabular-nums font-bold",children:A(e)})},{key:"estado",label:"Estado",width:"120px",render:e=>Ae(e)},{key:"id",label:"Acciones",width:"260px",sortable:!1,render:(e,a)=>{const p=a.estado==="timbrado",j=a.estado==="cancelado",G=!p&&!j;return t.jsxs("div",{className:"flex items-center gap-1.5 flex-wrap",children:[t.jsx("button",{onClick:i=>{i.stopPropagation(),ae(a)},className:"text-xs text-primary hover:text-primary-light transition-colors cursor-pointer",children:"Editar"}),u&&G&&t.jsx("button",{onClick:i=>{i.stopPropagation(),oe(a)},className:"text-xs text-[#56ca00] hover:text-[#56ca00]/80 transition-colors cursor-pointer font-medium",children:"Timbrar"}),u&&p&&t.jsxs(t.Fragment,{children:[t.jsx("button",{onClick:i=>{i.stopPropagation(),se(a)},className:"text-xs text-danger hover:text-danger/80 transition-colors cursor-pointer",children:"Cancelar"}),t.jsx("button",{onClick:i=>{i.stopPropagation(),re(a)},className:"text-xs text-[#03a9ce] hover:text-[#03a9ce]/80 transition-colors cursor-pointer",disabled:B.isPending,children:"XML"}),t.jsx("button",{onClick:i=>{i.stopPropagation(),le(a)},className:"text-xs text-[#9D2449] hover:text-[#9D2449]/80 transition-colors cursor-pointer",disabled:X.isPending,children:"PDF"})]}),u&&!p&&t.jsx("button",{onClick:i=>{i.stopPropagation(),Ie(a)},className:"text-xs text-danger hover:text-danger/80 transition-colors cursor-pointer",children:"Eliminar"})]})}}],[u,oe,se,re,le]),ie=w.isPending||ee.isPending;return t.jsxs("div",{children:[t.jsxs("div",{className:"mb-6",children:[t.jsx("h1",{className:"text-xl font-bold text-text-primary",children:"CFDI Emitidos"}),t.jsx("p",{className:"text-sm text-text-muted mt-1",children:"Comprobantes fiscales digitales emitidos por el ente publico"})]}),t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsxs("div",{className:"flex items-center gap-4",children:[t.jsxs("h2",{className:"text-sm font-semibold text-text-secondary",children:["Emitidos",t.jsxs("span",{className:"ml-2 text-text-muted font-normal",children:["(",z.length," registros)"]})]}),t.jsx("select",{value:E,onChange:e=>me(e.target.value),className:"h-[38px] rounded-md border border-border text-[0.9375rem] px-3 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda",children:ke.map(e=>t.jsx("option",{value:e.value,children:e.label},e.value))}),t.jsx("select",{value:F,onChange:e=>pe(e.target.value),className:"h-[38px] rounded-md border border-border text-[0.9375rem] px-3 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda",children:De.map(e=>t.jsx("option",{value:e.value,children:e.label},e.value))})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(x,{onClick:Pe,variant:"outline-primary",size:"sm",children:"Exportar Excel"}),u&&t.jsx(x,{onClick:Fe,size:"sm",children:"+ Nuevo CFDI"})]})]}),ge?t.jsx("div",{className:"flex items-center justify-center py-16 text-text-muted text-sm",children:"Cargando CFDI emitidos..."}):t.jsx(Ye,{columns:Ue,data:z,onRowClick:ae}),t.jsx(Q,{open:b,onClose:()=>l(!1),title:v?"Editar CFDI Emitido":"Nuevo CFDI Emitido",size:"lg",children:t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[t.jsx(n,{label:"Serie",value:s.serie,onChange:e=>r("serie",e.target.value),placeholder:"Ej. A"}),t.jsx(n,{label:"Folio",value:s.folio,onChange:e=>r("folio",e.target.value),placeholder:"Ej. 001",required:!0}),t.jsx(n,{label:"UUID",value:s.uuid,onChange:e=>r("uuid",e.target.value),placeholder:"Se asigna al timbrar",disabled:!0})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsx(n,{label:"Fecha de Emision",type:"date",value:s.fecha_emision,onChange:e=>r("fecha_emision",e.target.value),required:!0}),t.jsx(g,{label:"Tipo",value:s.tipo,onChange:e=>r("tipo",e.target.value),options:fe,placeholder:"-- Seleccione tipo --",required:!0})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsx(n,{label:"Receptor RFC",value:s.receptor_rfc,onChange:e=>r("receptor_rfc",e.target.value),placeholder:"RFC del receptor",required:!0}),t.jsx(n,{label:"Receptor Nombre",value:s.receptor_nombre,onChange:e=>r("receptor_nombre",e.target.value),placeholder:"Nombre o razon social del receptor",required:!0})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsx(g,{label:"Regimen Fiscal Receptor",value:s.receptor_regimen,onChange:e=>r("receptor_regimen",e.target.value),options:_e,placeholder:"-- Seleccione regimen --"}),t.jsx(n,{label:"Codigo Postal Receptor",value:s.receptor_cp,onChange:e=>r("receptor_cp",e.target.value),placeholder:"Ej. 06600"})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsx(g,{label:"Uso CFDI",value:s.uso_cfdi,onChange:e=>r("uso_cfdi",e.target.value),options:ve,placeholder:"-- Seleccione uso CFDI --",required:!0}),t.jsx(g,{label:"Metodo de Pago",value:s.metodo_pago,onChange:e=>r("metodo_pago",e.target.value),options:Ce,placeholder:"-- Seleccione metodo de pago --",required:!0})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsx(g,{label:"Forma de Pago",value:s.forma_pago,onChange:e=>r("forma_pago",e.target.value),options:je,placeholder:"-- Seleccione forma de pago --"}),t.jsx(g,{label:"Moneda",value:s.moneda,onChange:e=>r("moneda",e.target.value),options:ye,placeholder:"-- Seleccione moneda --"})]}),t.jsx(n,{label:"Descripcion del concepto",value:s.descripcion,onChange:e=>r("descripcion",e.target.value),placeholder:"Descripcion general del servicio o producto"}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[t.jsx(n,{label:"Subtotal",type:"number",value:s.subtotal,onChange:e=>r("subtotal",e.target.value),placeholder:"0.00",required:!0}),t.jsx(n,{label:"IVA",type:"number",value:s.iva,onChange:e=>r("iva",e.target.value),placeholder:"0.00"}),t.jsx(n,{label:"Total",type:"number",value:s.total,onChange:e=>r("total",e.target.value),placeholder:"0.00",disabled:!0})]}),t.jsx(g,{label:"Estado",value:s.estado,onChange:e=>r("estado",e.target.value),options:he,placeholder:"-- Seleccione estado --",required:!0}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Notas"}),t.jsx("textarea",{value:s.notas,onChange:e=>r("notas",e.target.value),placeholder:"Observaciones o notas adicionales",rows:3,className:"w-full h-auto rounded-md border border-border text-[0.9375rem] px-3 py-2 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda"})]}),t.jsxs("div",{className:"flex justify-end gap-3 pt-2 border-t border-border",children:[t.jsx(x,{variant:"ghost",onClick:()=>l(!1),disabled:ie,children:"Cancelar"}),t.jsx(x,{onClick:Se,loading:ie,disabled:!s.folio.toString().trim()||!s.receptor_rfc.trim()||!s.receptor_nombre.trim(),children:v?"Guardar cambios":"Crear CFDI"})]})]})}),t.jsx(we,{open:C,onClose:()=>{R(!1),$(null)},onConfirm:Me,title:"Eliminar CFDI emitido",message:f?`Â¿Esta seguro de eliminar el CFDI emitido "${f.serie||""}${f.serie&&f.folio?"-":""}${f.folio||""}"? Esta accion no se puede deshacer.`:"",confirmText:"Eliminar",loading:te.isPending}),t.jsx(Q,{open:be,onClose:()=>{S(!1),I(null),y("")},title:"Timbrar CFDI ante el SAT",size:"md",children:t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"bg-[#03c3ec]/10 border border-[#03c3ec]/30 rounded-md p-3",children:[t.jsxs("p",{className:"text-sm text-text-primary",children:["Esta a punto de enviar el CFDI"," ",t.jsxs("strong",{children:[c?.serie||"",c?.serie&&c?.folio?"-":"",c?.folio||""]})," ","al PAC Facturama para su timbrado ante el SAT."]}),t.jsxs("p",{className:"text-xs text-text-muted mt-2",children:["Receptor: ",t.jsx("strong",{children:c?.receptor_nombre})," (",c?.receptor_rfc,")",t.jsx("br",{}),"Total: ",t.jsx("strong",{children:A(c?.total)})]})]}),J&&t.jsxs("div",{className:"bg-[#ff3e1d]/10 border border-[#ff3e1d]/30 rounded-md p-3",children:[t.jsx("p",{className:"text-sm text-[#e0360a] font-medium",children:"Error al timbrar"}),t.jsx("p",{className:"text-xs text-[#e0360a] mt-1",children:J})]}),t.jsxs("div",{className:"flex justify-end gap-3 pt-2 border-t border-border",children:[t.jsx(x,{variant:"ghost",onClick:()=>{S(!1),I(null),y("")},disabled:q.isPending,children:"Cancelar"}),t.jsx(x,{variant:"success",onClick:Oe,loading:q.isPending,children:"Confirmar Timbrado"})]})]})}),t.jsx(Q,{open:xe,onClose:()=>{M(!1),O(null),N("")},title:"Cancelar CFDI ante el SAT",size:"md",children:t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"bg-[#ff3e1d]/10 border border-[#ff3e1d]/30 rounded-md p-3",children:[t.jsxs("p",{className:"text-sm text-text-primary",children:["Esta a punto de cancelar el CFDI"," ",t.jsxs("strong",{children:[h?.serie||"",h?.serie&&h?.folio?"-":"",h?.folio||""]})," ","ante el SAT. Esta accion puede ser irreversible."]}),t.jsxs("p",{className:"text-xs text-text-muted mt-2",children:["UUID: ",t.jsx("strong",{children:h?.uuid||"N/A"})]})]}),t.jsx(g,{label:"Motivo de Cancelacion",value:_,onChange:e=>K(e.target.value),options:Ne,required:!0}),_==="01"&&t.jsx(n,{label:"UUID de Sustitucion",value:L,onChange:e=>W(e.target.value),placeholder:"UUID del CFDI que sustituye",required:!0}),Y&&t.jsxs("div",{className:"bg-[#ff3e1d]/10 border border-[#ff3e1d]/30 rounded-md p-3",children:[t.jsx("p",{className:"text-sm text-[#e0360a] font-medium",children:"Error al cancelar"}),t.jsx("p",{className:"text-xs text-[#e0360a] mt-1",children:Y})]}),t.jsxs("div",{className:"flex justify-end gap-3 pt-2 border-t border-border",children:[t.jsx(x,{variant:"ghost",onClick:()=>{M(!1),O(null),N("")},disabled:V.isPending,children:"Volver"}),t.jsx(x,{variant:"danger",onClick:Te,loading:V.isPending,disabled:_==="01"&&!L.trim(),children:"Confirmar Cancelacion"})]})]})})]})}export{gt as default};
