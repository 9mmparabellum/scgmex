import{u as Y,j as t}from"./index-C7O7P87m.js";import{b as a}from"./vendor-DEA9Ikep.js";import{u as g,a as Z,c as ee,B as x}from"./Button-DSFUuRiE.js";import{M as j,a as D}from"./constants-B9IYjURH.js";import{e as te}from"./exportHelpers-CvXmrB4L.js";import{D as oe}from"./DataTable-wHfPkz6g.js";import{M as ie}from"./Modal-DLp9MTwE.js";import{I as y}from"./Input-B5i4Vmf0.js";import{S as l}from"./Select-Bs0hNJCZ.js";import{B as ae}from"./Badge-DFM6rO93.js";import{C as se}from"./ConfirmDialog-CJrDnoxI.js";import"./export-t5FFX7R_.js";import"./supabase-DANKYb0E.js";const F=h=>new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(h||0),R=()=>new Date().toISOString().slice(0,10),I={partida_id:"",periodo_id:"",tipo_movimiento:"",monto:"",descripcion:"",fecha:R()};function ge(){const{entePublico:h,ejercicioFiscal:_}=Y(),[r,q]=a.useState(j[0].key),[c,A]=a.useState(""),[d,$]=a.useState(""),[B,m]=a.useState(!1),[i,M]=a.useState({...I}),[L,v]=a.useState(!1),[p,f]=a.useState(null),V=a.useMemo(()=>{const e={momento:r};return c&&(e.partida_id=c),d&&(e.periodo_id=d),e},[r,c,d]),{data:b=[],isLoading:z}=g("movimiento_presupuestal_egreso",{filter:V}),{data:u=[]}=g("partida_egreso",{filter:{ente_id:h?.id,ejercicio_id:_?.id}}),{data:k=[]}=g("periodo_contable",{filter:{ejercicio_id:_?.id}}),C=Z("movimiento_presupuestal_egreso"),N=ee("movimiento_presupuestal_egreso"),S=a.useMemo(()=>{const e={};return u.forEach(o=>{e[o.id]=o}),e},[u]),P=a.useMemo(()=>u.map(e=>({value:e.id,label:`${e.clave} — ${e.descripcion}`})),[u]),E=a.useMemo(()=>k.map(e=>({value:e.id,label:e.nombre||e.clave})),[k]),G=a.useMemo(()=>D.map(e=>({value:e.key,label:e.label})),[]),U=e=>({original:"info",adicion:"success",reduccion:"danger"})[e]||"default",w=e=>{const o=D.find(s=>s.key===e);return o?o.label:e},O=j.find(e=>e.key===r)?.label??r,X=()=>{M({...I,fecha:R()}),m(!0)},n=(e,o)=>{M(s=>({...s,[e]:o}))},H=async()=>{const e={partida_id:i.partida_id,periodo_id:i.periodo_id||null,momento:r,tipo_movimiento:i.tipo_movimiento,monto:Number(i.monto)||0,descripcion:i.descripcion,fecha:i.fecha};await C.mutateAsync(e),m(!1)},J=e=>{f(e),v(!0)},K=async()=>{p&&await N.mutateAsync(p.id),v(!1),f(null)},Q=()=>{te(b,[{key:"fecha",label:"Fecha",getValue:o=>o.fecha},{key:"partida",label:"Partida",getValue:o=>{const s=S[o.partida_id];return s?`${s.clave} — ${s.descripcion}`:o.partida_id}},{key:"tipo_movimiento",label:"Tipo Movimiento",getValue:o=>w(o.tipo_movimiento)},{key:"monto",label:"Monto",getValue:o=>Number(o.monto||0)},{key:"descripcion",label:"Descripcion"}],`momentos_gasto_${r}`)},W=[{key:"fecha",label:"Fecha",width:"120px"},{key:"partida_id",label:"Partida",render:e=>{const o=S[e];return o?o.clave:"—"}},{key:"tipo_movimiento",label:"Tipo Mov.",width:"120px",render:e=>t.jsx(ae,{variant:U(e),children:w(e)})},{key:"monto",label:"Monto",width:"130px",render:e=>t.jsx("span",{className:"text-right block tabular-nums",children:F(e)})},{key:"descripcion",label:"Descripcion"},{key:"id",label:"Acciones",width:"100px",sortable:!1,render:(e,o)=>t.jsx("button",{onClick:s=>{s.stopPropagation(),J(o)},className:"text-xs text-danger hover:text-danger/80 transition-colors cursor-pointer",children:"Eliminar"})}],T=C.isPending;return t.jsxs("div",{children:[t.jsxs("div",{className:"mb-6",children:[t.jsx("h1",{className:"text-xl font-bold text-text-primary",children:"Momentos del Gasto"}),t.jsx("p",{className:"text-sm text-text-muted mt-1",children:"Registro de movimientos presupuestarios de egreso"})]}),t.jsx("div",{className:"flex flex-wrap items-center gap-2 mb-6",children:j.map(e=>t.jsx("button",{onClick:()=>q(e.key),className:["px-4 py-2 text-sm font-medium rounded-lg transition-colors cursor-pointer",r===e.key?"bg-primary text-white":"bg-white card-shadow text-text-secondary hover:bg-bg-hover"].join(" "),children:e.label},e.key))}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 max-w-2xl",children:[t.jsx(l,{label:"Partida",value:c,onChange:e=>A(e.target.value),options:P,placeholder:"— Todas las partidas —"}),t.jsx(l,{label:"Periodo",value:d,onChange:e=>$(e.target.value),options:E,placeholder:"— Todos los periodos —"})]}),t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsxs("h2",{className:"text-sm font-semibold text-text-secondary",children:[O,t.jsxs("span",{className:"ml-2 text-text-muted font-normal",children:["(",b.length," movimientos)"]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(x,{onClick:Q,variant:"outline-primary",size:"sm",children:"Exportar Excel"}),t.jsx(x,{onClick:X,size:"sm",children:"+ Registrar Movimiento"})]})]}),z?t.jsx("div",{className:"flex items-center justify-center py-16 text-text-muted text-sm",children:"Cargando movimientos..."}):t.jsx(oe,{columns:W,data:b}),t.jsx(ie,{open:B,onClose:()=>m(!1),title:"Registrar Movimiento",size:"md",children:t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"w-full",children:[t.jsx("label",{className:"block text-sm font-medium text-text-heading mb-1.5",children:"Momento contable"}),t.jsx("div",{className:"block w-full h-[40px] rounded-md border border-border bg-bg-hover text-text-muted text-[0.9375rem] px-3.5 py-2.5",children:O})]}),t.jsx(l,{label:"Partida",value:i.partida_id,onChange:e=>n("partida_id",e.target.value),options:P,placeholder:"— Seleccione una partida —",required:!0}),t.jsx(l,{label:"Periodo contable",value:i.periodo_id,onChange:e=>n("periodo_id",e.target.value),options:E,placeholder:"— Seleccione un periodo —",required:!0}),t.jsx(l,{label:"Tipo de movimiento",value:i.tipo_movimiento,onChange:e=>n("tipo_movimiento",e.target.value),options:G,placeholder:"— Seleccione tipo —",required:!0}),t.jsx(y,{label:"Monto",type:"number",value:i.monto,onChange:e=>n("monto",e.target.value),placeholder:"0.00",min:0,required:!0}),t.jsx(y,{label:"Descripcion (opcional)",value:i.descripcion,onChange:e=>n("descripcion",e.target.value),placeholder:"Descripcion del movimiento"}),t.jsx(y,{label:"Fecha",type:"date",value:i.fecha,onChange:e=>n("fecha",e.target.value),required:!0}),t.jsxs("div",{className:"flex justify-end gap-3 pt-2 border-t border-border",children:[t.jsx(x,{variant:"ghost",onClick:()=>m(!1),disabled:T,children:"Cancelar"}),t.jsx(x,{onClick:H,loading:T,disabled:!i.partida_id||!i.tipo_movimiento||!i.monto||!i.fecha,children:"Registrar movimiento"})]})]})}),t.jsx(se,{open:L,onClose:()=>{v(!1),f(null)},onConfirm:K,title:"Eliminar movimiento",message:p?`¿Esta seguro de eliminar este movimiento por ${F(p.monto)}? Esta accion no se puede deshacer.`:"",confirmText:"Eliminar",loading:N.isPending})]})}export{ge as default};
