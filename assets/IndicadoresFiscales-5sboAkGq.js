import{s as N,u as M,o as L,p as E,q as A,j as e}from"./index-xuYioy8Y.js";import{b as v}from"./vendor-DEA9Ikep.js";import{I as B,C as b}from"./constants-B0qHiDNt.js";import{c as S,e as V}from"./presupuestoService-Dbov0cd6.js";import{u as F}from"./useCrud-BZqSYSww.js";import{e as O}from"./exportHelpers-CvXmrB4L.js";import{B as w}from"./Button-CQM7GO5t.js";import{S as P}from"./Select-CHQpqBAE.js";import{B as k}from"./Badge-DX5pclE5.js";import"./supabase-DANKYb0E.js";import"./export-t5FFX7R_.js";async function q(a,i,r){const{data:n,error:d}=await N.from("indicador_postura_fiscal").select("*").eq("ente_id",a).eq("ejercicio_id",i).eq("periodo_id",r).order("clave");if(d)throw d;return n}async function R(a,i,r){const n=await S(a,i),m=(await V(a,i)).recaudado||0,o=n.pagado||0,{data:j}=await N.from("instrumento_deuda").select("saldo_vigente").eq("ente_id",a).eq("ejercicio_id",i).eq("estado","vigente"),h=(j||[]).reduce((c,s)=>c+Number(s.saldo_vigente||0),0),f=B.map(c=>{let s=0;switch(c.clave){case"ING_TOTAL":s=m;break;case"GAS_TOTAL":s=o;break;case"BAL_PRES":s=m-o;break;case"AHORRO":s=m-o;break;case"BAL_PRIM":s=m-o+h;break;case"END_NETO":s=h;break;case"INV_PUB":s=n.ejercido||0;break}return{ente_id:a,ejercicio_id:i,periodo_id:r,clave:c.clave,nombre:c.nombre,categoria:c.categoria,valor:s,valor_anterior:0,variacion:0}}),{data:g,error:p}=await N.from("indicador_postura_fiscal").upsert(f,{onConflict:"ente_id,ejercicio_id,periodo_id,clave"}).select();if(p)throw p;return g}function T(a){const{entePublico:i,ejercicioFiscal:r}=M();return L({queryKey:["indicadores_fiscales",i?.id,r?.id,a],queryFn:()=>q(i.id,r.id,a),enabled:!!i?.id&&!!r?.id&&!!a})}function z(){const a=E();return A({mutationFn:({enteId:i,ejercicioId:r,periodoId:n})=>R(i,r,n),onSuccess:()=>{a.invalidateQueries({queryKey:["indicadores_fiscales"]})}})}const _=a=>new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(a||0),D=a=>`${Math.abs(Number(a||0)).toFixed(2)}%`;function se(){const{entePublico:a,ejercicioFiscal:i}=M(),[r,n]=v.useState(""),{data:d=[]}=F("periodo_contable",{filter:{ejercicio_id:i?.id},order:{column:"numero",ascending:!0}}),m=v.useMemo(()=>d.map(s=>({value:s.id,label:s.nombre||`Periodo ${s.numero}`})),[d]),{data:o=[],isLoading:j,isError:h}=T(r),f=z(),g=v.useMemo(()=>{const s={};return Object.keys(b).forEach(t=>{s[t]=[]}),o.forEach(t=>{const l=t.categoria||"financiero";s[l]||(s[l]=[]),s[l].push(t)}),s},[o]),p=async()=>{if(r)try{await f.mutateAsync({enteId:a?.id,ejercicioId:i?.id,periodoId:r})}catch{}},c=()=>{O(o,[{key:"nombre",label:"Indicador"},{key:"categoria",label:"Categoria",getValue:t=>b[t.categoria]?.label||t.categoria},{key:"valor",label:"Valor",getValue:t=>Number(t.valor||0)},{key:"variacion",label:"Variacion %",getValue:t=>Number(t.variacion||0)},{key:"valor_anterior",label:"Valor Anterior",getValue:t=>Number(t.valor_anterior||0)}],"indicadores_fiscales")};return e.jsxs("div",{children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h1",{className:"text-xl font-bold text-text-primary",children:"Indicadores de Postura Fiscal"}),e.jsx("p",{className:"text-sm text-text-muted mt-1",children:"Indicadores financieros del ente publico (Art. 46 LGCG)"})]}),e.jsx("div",{className:"bg-white rounded-lg card-shadow p-4 mb-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 items-end",children:[e.jsx(P,{label:"Periodo",placeholder:"Seleccionar periodo...",options:m,value:r,onChange:s=>n(s.target.value)}),e.jsx("div",{className:"flex items-end gap-2",children:e.jsxs(w,{onClick:p,loading:f.isPending,disabled:!r,children:[e.jsx("svg",{className:"w-4 h-4 mr-1.5 inline-block",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"})}),"Calcular Indicadores"]})}),e.jsx("div",{className:"flex justify-end",children:e.jsxs(w,{variant:"outline-primary",onClick:c,disabled:o.length===0,size:"sm",children:[e.jsx("svg",{className:"w-4 h-4 mr-1.5 inline-block",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),"Exportar Excel"]})})]})}),j?e.jsx("div",{className:"bg-white rounded-lg card-shadow p-5",children:e.jsx("div",{className:"flex items-center justify-center py-16",children:e.jsxs("svg",{className:"animate-spin h-8 w-8 text-guinda",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]})})}):h?e.jsx("div",{className:"bg-white rounded-lg card-shadow p-5",children:e.jsxs("div",{className:"text-center py-16",children:[e.jsx("div",{className:"flex justify-center mb-4",children:e.jsx("div",{className:"w-16 h-16 rounded-full bg-[#ff3e1d]/10 flex items-center justify-center text-[#ff3e1d]",children:e.jsxs("svg",{className:"w-7 h-7",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("line",{x1:"12",y1:"8",x2:"12",y2:"12"}),e.jsx("line",{x1:"12",y1:"16",x2:"12.01",y2:"16"})]})})}),e.jsx("h3",{className:"text-[0.9375rem] font-semibold text-text-heading mb-1",children:"Error al cargar indicadores"}),e.jsx("p",{className:"text-sm text-text-muted max-w-sm mx-auto",children:"Ocurrio un error al obtener los indicadores. Intente nuevamente."})]})}):r?o.length===0?e.jsx("div",{className:"bg-white rounded-lg card-shadow p-5",children:e.jsxs("div",{className:"text-center py-16",children:[e.jsx("div",{className:"flex justify-center mb-4",children:e.jsx("div",{className:"w-16 h-16 rounded-full bg-[#f5f5f9] flex items-center justify-center text-text-muted",children:e.jsx("svg",{className:"w-7 h-7",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("path",{d:"M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"})})})}),e.jsx("h3",{className:"text-[0.9375rem] font-semibold text-text-heading mb-1",children:"Sin indicadores calculados"}),e.jsx("p",{className:"text-sm text-text-muted max-w-sm mx-auto",children:'No hay indicadores para este periodo. Presione "Calcular Indicadores" para generarlos.'})]})}):e.jsx("div",{className:"space-y-6",children:Object.entries(g).map(([s,t])=>{if(t.length===0)return null;const l=b[s]||{label:s,variant:"default"};return e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(k,{variant:l.variant,children:l.label}),e.jsxs("span",{className:"text-xs text-text-muted",children:["(",t.length," indicador",t.length!==1?"es":"",")"]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4",children:t.map(u=>{const y=Number(u.valor||0),x=Number(u.variacion||0),C=Number(u.valor_anterior||0),I=s==="balance"?y>=0?"text-[#71dd37]":"text-[#ff3e1d]":"text-text-heading";return e.jsxs("div",{className:"bg-white rounded-lg card-shadow p-5 flex flex-col",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsx("h3",{className:"text-[0.9375rem] font-semibold text-text-heading leading-snug pr-2",children:u.nombre}),e.jsx(k,{variant:l.variant,children:l.label})]}),e.jsx("p",{className:`text-[22px] font-bold tracking-tight leading-tight mb-2 ${I}`,children:_(y)}),e.jsxs("div",{className:"flex items-center justify-between mt-auto pt-3 border-t border-border/50",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[x!==0&&e.jsx("svg",{className:`w-4 h-4 ${x>0?"text-[#71dd37]":"text-[#ff3e1d]"}`,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:x>0?e.jsx("polyline",{points:"18 15 12 9 6 15"}):e.jsx("polyline",{points:"6 9 12 15 18 9"})}),e.jsx("span",{className:`text-sm font-semibold ${x>0?"text-[#71dd37]":x<0?"text-[#ff3e1d]":"text-text-muted"}`,children:D(x)})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-[11px] text-text-muted uppercase tracking-wide",children:"Anterior"}),e.jsx("p",{className:"text-sm font-mono text-text-secondary",children:_(C)})]})]})]},u.id)})})]},s)})}):e.jsx("div",{className:"bg-white rounded-lg card-shadow p-5",children:e.jsxs("div",{className:"text-center py-16",children:[e.jsx("div",{className:"flex justify-center mb-4",children:e.jsx("div",{className:"w-16 h-16 rounded-full bg-[#f5f5f9] flex items-center justify-center text-text-muted",children:e.jsx("svg",{className:"w-7 h-7",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("path",{d:"M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"})})})}),e.jsx("h3",{className:"text-[0.9375rem] font-semibold text-text-heading mb-1",children:"Seleccione un periodo"}),e.jsx("p",{className:"text-sm text-text-muted max-w-sm mx-auto",children:"Seleccione un periodo contable para ver los indicadores fiscales"})]})})]})}export{se as default};
