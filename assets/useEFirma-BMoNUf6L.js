import{s as m,u as g,o as D,p as A,q as C}from"./index-KskWbqO9.js";const O=2,j=6,B=12,M=19,P=20,G=22,$=23,K=24,N=30;function x(e,t){if(t>=e.length)throw new Error(`DER parse error: offset ${t} out of bounds (len=${e.length})`);const n=e[t];let r=t+1;const i=(n&32)!==0,o=n>>6&3,a=n&31;if(r>=e.length)throw new Error("DER parse error: unexpected end reading length");let c=e[r++];if(c&128){const d=c&127;if(d===0)throw new Error("DER parse error: indefinite length not supported");c=0;for(let l=0;l<d;l++){if(r>=e.length)throw new Error("DER parse error: unexpected end in long length");c=c*256+e[r++]}}if(r+c>e.length)throw new Error(`DER parse error: content length ${c} exceeds buffer at offset ${r}`);const s=e.slice(r,r+c),u=r+c,f={tag:n,tagClass:o,tagNumber:a,constructed:i,length:c,value:s,offset:t,end:u};return i&&(f.children=Q(s)),f}function Q(e){const t=[];let n=0;for(;n<e.length;){const r=x(e,n);t.push(r),n=r.end}return t}function v(e){let t=0;return e.length>1&&e[0]===0&&(t=1),Array.from(e.slice(t)).map(n=>n.toString(16).padStart(2,"0")).join("")}function Z(e){if(e.length===0)return"";const t=[];t.push(Math.floor(e[0]/40)),t.push(e[0]%40);let n=0;for(let r=1;r<e.length;r++)n=n*128+(e[r]&127),(e[r]&128)===0&&(t.push(n),n=0);return t.join(".")}function H(e,t){if(e===N){let n="";for(let r=0;r<t.length;r+=2)n+=String.fromCharCode(t[r]<<8|t[r+1]);return n}return new TextDecoder("utf-8").decode(t)}function I(e,t){const n=new TextDecoder("ascii").decode(t);if(e===$){const r=parseInt(n.slice(0,2),10),i=r>=50?1900+r:2e3+r,o=parseInt(n.slice(2,4),10)-1,a=parseInt(n.slice(4,6),10),c=parseInt(n.slice(6,8),10),s=parseInt(n.slice(8,10),10),u=parseInt(n.slice(10,12),10);return new Date(Date.UTC(i,o,a,c,s,u))}if(e===K){const r=parseInt(n.slice(0,4),10),i=parseInt(n.slice(4,6),10)-1,o=parseInt(n.slice(6,8),10),a=parseInt(n.slice(8,10),10),c=parseInt(n.slice(10,12),10),s=parseInt(n.slice(12,14),10);return new Date(Date.UTC(r,i,o,a,c,s))}return new Date(n)}function L(e){return[B,M,G,P,N].includes(e)}function V(e){if(!e.children||e.children.length<2)return"";let t=0;e.children[0].tagClass===2&&e.children[0].tagNumber===0&&(t=1);const n=e.children[t];return!n||n.tag!==O?"":v(n.value)}function w(e,t){let n=0;return e.children&&e.children[0]&&e.children[0].tagClass===2&&e.children[0].tagNumber===0&&(n=1),e.children[t+n]||null}function S(e){if(!e||!e.children)return[];const t=[];for(const n of e.children)if(n.children)for(const r of n.children){if(!r.children||r.children.length<2)continue;const i=r.children[0],o=r.children[1];if(i.tag!==j)continue;const a=Z(i.value),c=L(o.tag)?H(o.tag,o.value):v(o.value);t.push({oid:a,value:c})}return t}function k(e){if(!e||!e.children||e.children.length<2)return{notBefore:new Date(0),notAfter:new Date(0)};const t=e.children[0],n=e.children[1];return{notBefore:I(t.tag,t.value),notAfter:I(n.tag,n.value)}}const T="2.5.4.3",z="2.5.4.5",X="2.5.4.10",W="0.9.2342.19200300.100.1.1",J="2.5.4.45",Y="2.5.4.44";function h(e,t){const n=e.find(r=>r.oid===t);return n?n.value:""}function ee(e){let t=h(e,J);if(t)return p(t);if(t=h(e,z),t){const i=t.match(/[A-Z&]{3,4}\d{6}[A-Z0-9]{3}/i);return i?i[0].toUpperCase():p(t)}if(t=h(e,W),t||(t=h(e,Y),t))return p(t);const r=h(e,T).match(/[A-Z&]{3,4}\d{6}[A-Z0-9]{3}/i);return r?r[0].toUpperCase():""}function p(e){if(!e)return"";const t=e.replace(/^\/\s*/,"").trim(),n=t.match(/[A-Z&]{3,4}\d{6}[A-Z0-9]{3}/i);return n?n[0].toUpperCase():t.toUpperCase()}function E(e){return h(e,T)||h(e,X)||""}function te(e){const t=new Uint8Array(e);let n=t;new TextDecoder("ascii").decode(t.slice(0,11)).startsWith("-----BEGIN")&&(n=ne(t));const i=x(n,0);if(!i.constructed||!i.children||i.children.length<1)throw new Error("Formato de certificado invalido: no es una estructura X.509 valida");const o=i.children[0];if(!o.constructed||!o.children)throw new Error("Formato de certificado invalido: TBSCertificate no encontrado");const a=V(o),c=w(o,2),s=S(c),u=w(o,3),f=k(u),d=w(o,4),l=S(d),R=ee(l),U=E(l),q=E(s),_=new Date;return{numeroSerie:a,titular:U,rfc:R,emisor:q,emisorCompleto:s.map(y=>`${y.oid}=${y.value}`).join(", "),sujetoDN:l,emisorDN:s,fechaInicio:f.notBefore,fechaFin:f.notAfter,vigente:_>=f.notBefore&&_<=f.notAfter,raw:n,pem:re(n,"CERTIFICATE")}}function ne(e){const n=new TextDecoder("ascii").decode(e).replace(/-----BEGIN [^-]+-----/,"").replace(/-----END [^-]+-----/,"").replace(/\s/g,""),r=atob(n),i=new Uint8Array(r.length);for(let o=0;o<r.length;o++)i[o]=r.charCodeAt(o);return i}function re(e,t){const n=e instanceof Uint8Array?e:new Uint8Array(e);let r="";const i=8192;for(let a=0;a<n.length;a+=i){const c=n.slice(a,a+i);r+=btoa(String.fromCharCode.apply(null,c))}const o=r.match(/.{1,64}/g)||[];return`-----BEGIN ${t}-----
${o.join(`
`)}
-----END ${t}-----`}function de(e){const t=(e.emisor||"").toLowerCase(),n=(e.emisorCompleto||"").toLowerCase(),r=t+" "+n;return r.includes("sat")||r.includes("servicio de administracion tributaria")||r.includes("autoridad certificadora")||r.includes("servicio de administraciÃ³n tributaria")}function he(e){const t=new Date,n=e.fechaFin.getTime()-t.getTime();return Math.ceil(n/(1e3*60*60*24))}async function b(e){let t;typeof e=="string"?t=new TextEncoder().encode(e):e instanceof Uint8Array?t=e:t=new Uint8Array(e);const n=await crypto.subtle.digest("SHA-256",t);return ie(n)}async function F(e){let t;typeof e=="string"?t=new TextEncoder().encode(e):e instanceof Uint8Array?t=e:t=new Uint8Array(e);const n=await crypto.subtle.digest("SHA-256",t),r=new Uint8Array(n);let i="";for(let o=0;o<r.length;o++)i+=String.fromCharCode(r[o]);return btoa(i)}function ie(e){return Array.from(new Uint8Array(e)).map(t=>t.toString(16).padStart(2,"0")).join("")}function oe(e){return`||${e.filter(n=>n!=null&&n!=="").map(n=>String(n).trim()).join("|")}||`}async function me(e){const t=await e.arrayBuffer(),[n,r]=await Promise.all([b(t),F(t)]);return{hex:n,base64:r,size:e.size,name:e.name}}async function ce(e){const{data:t,error:n}=await m.from("certificado_efirma").select("*").eq("ente_id",e).order("fecha_vigencia_fin",{ascending:!1});if(n)throw n;return t}async function ae(e,t){const{data:n,error:r}=await m.from("documento_firmado").select("*, certificado:certificado_efirma!certificado_id(numero_serie, titular)").eq("ente_id",e).eq("ejercicio_id",t).order("fecha_firma",{ascending:!1});if(r)throw r;return n}async function se(e){const[t,n]=await Promise.all([m.from("certificado_efirma").select("id, tipo, estado, fecha_vigencia_fin").eq("ente_id",e),m.from("documento_firmado").select("id, estado").eq("ente_id",e)]),r=t.data||[],i=n.data||[],o=new Date,a=720*60*60*1e3;return{totalCertificados:r.length,vigentes:r.filter(c=>c.estado==="vigente").length,porVencer:r.filter(c=>c.estado==="vigente"&&new Date(c.fecha_vigencia_fin)<new Date(o.getTime()+a)).length,totalDocumentos:i.length,firmados:i.filter(c=>c.estado==="firmado").length,pendientes:i.filter(c=>c.estado==="pendiente").length}}async function fe(e,t,n="fiel"){const r=await e.arrayBuffer(),i=te(r);let o="vigente";i.vigente||(o=new Date>i.fechaFin?"vencido":"vigente");const a=Math.ceil((i.fechaFin.getTime()-Date.now())/(1e3*60*60*24));o==="vigente"&&a<=30&&(o="por_vencer");const{data:c,error:s}=await m.from("certificado_efirma").insert({ente_id:t,numero_serie:i.numeroSerie,titular:i.titular,rfc:i.rfc,tipo:n,fecha_vigencia_inicio:i.fechaInicio.toISOString(),fecha_vigencia_fin:i.fechaFin.toISOString(),estado:o,emisor:i.emisor,certificado_pem:i.pem}).select().single();if(s)throw s;return{certificado:c,info:i}}async function ue(e,t,n,r,i){const o=await b(t),a=await F(t),c=oe([e,o,n,new Date().toISOString()]);let s=a;try{const{data:d,error:l}=await m.functions.invoke("firma-digital",{body:{documentHash:a,certificadoId:n}});!l&&d?.success&&(s=d.selloDigital||a)}catch{console.warn("Edge Function firma-digital no disponible, usando hash como sello")}const{data:u,error:f}=await m.from("documento_firmado").update({cadena_original:c,sello_digital:s,hash_documento:o,estado:"firmado",fecha_firma:new Date().toISOString()}).eq("id",e).select().single();if(f)throw f;return u}function ge(){const{entePublico:e}=g();return D({queryKey:["certificado_efirma",e?.id],queryFn:()=>ce(e.id),enabled:!!e?.id})}function pe(){const{entePublico:e,ejercicioFiscal:t}=g();return D({queryKey:["documento_firmado",e?.id,t?.id],queryFn:()=>ae(e.id,t.id),enabled:!!e?.id&&!!t?.id})}function we(){const{entePublico:e}=g();return D({queryKey:["resumen_efirma",e?.id],queryFn:()=>se(e.id),enabled:!!e?.id})}function De(){const e=A(),{entePublico:t}=g();return C({mutationFn:({file:n,tipo:r})=>fe(n,t?.id,r),onSuccess:()=>{e.invalidateQueries({queryKey:["certificado_efirma"]}),e.invalidateQueries({queryKey:["resumen_efirma"]})}})}function _e(){const e=A(),{entePublico:t,ejercicioFiscal:n}=g();return C({mutationFn:({documentoId:r,contenido:i,certificadoId:o})=>ue(r,i,o,t?.id,n?.id),onSuccess:()=>{e.invalidateQueries({queryKey:["documento_firmado"]}),e.invalidateQueries({queryKey:["resumen_efirma"]})}})}export{we as a,De as b,pe as c,he as d,de as e,_e as f,me as g,b as h,te as p,ge as u};
