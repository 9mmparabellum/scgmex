import{s as r,o as i,p as l,q as u,r as o}from"./index-CPaKNtDw.js";async function c(e,a){const{data:n,error:s}=await r.from("anomalia_detectada").select("*, regla:regla_anomalia!regla_id(nombre, tipo)").eq("ente_id",e).eq("ejercicio_id",a).order("fecha_deteccion",{ascending:!1});if(s)throw s;return n}async function m(e){const{data:a,error:n}=await r.from("regla_anomalia").select("*").eq("ente_id",e).order("nombre");if(n)throw n;return a}async function d(e,a){const{data:n}=await r.from("anomalia_detectada").select("id, tipo, nivel_riesgo, estado").eq("ente_id",e).eq("ejercicio_id",a),s=n||[];return{total:s.length,detectadas:s.filter(t=>t.estado==="detectada").length,enRevision:s.filter(t=>t.estado==="en_revision").length,confirmadas:s.filter(t=>t.estado==="confirmada").length,resueltas:s.filter(t=>t.estado==="resuelta").length,descartadas:s.filter(t=>t.estado==="descartada").length,criticas:s.filter(t=>t.nivel_riesgo==="critico").length,altas:s.filter(t=>t.nivel_riesgo==="alto").length,medias:s.filter(t=>t.nivel_riesgo==="medio").length,bajas:s.filter(t=>t.nivel_riesgo==="bajo").length}}async function f(e,a){try{const{data:n,error:s}=await r.rpc("ejecutar_analisis_anomalias",{p_ente_id:e,p_ejercicio_id:a});if(s)throw s;return n}catch(n){return console.warn("ejecutar_analisis_anomalias RPC not available, simulating:",n.message),{nuevas:0,mensaje:"Analisis simulado completado"}}}function _(e,a){return i({queryKey:["anomalias",e,a],queryFn:()=>c(e,a),enabled:!!e&&!!a})}function y(e){return i({queryKey:["reglas_anomalia",e],queryFn:()=>m(e),enabled:!!e})}function h(e,a){return i({queryKey:["resumen_anomalias",e,a],queryFn:()=>d(e,a),enabled:!!e&&!!a})}function q(){const e=l();return u({mutationFn:({enteId:a,ejercicioId:n})=>f(a,n),onSuccess:a=>{e.invalidateQueries({queryKey:["anomalias"]}),e.invalidateQueries({queryKey:["resumen_anomalias"]}),o.getState().addToast({type:"success",title:"Analisis completado",message:a?.mensaje||"El analisis de anomalias se ejecuto correctamente"})},onError:a=>{o.getState().addToast({type:"error",title:"Error en analisis",message:a.message||"Ocurrio un error al ejecutar el analisis"})}})}export{h as a,q as b,y as c,_ as u};
