import{j as e}from"./index-CyKkzz21.js";import{g as T,c as V,b as l}from"./vendor-DEA9Ikep.js";import{a as W}from"./useMIR-M2jrfV9T.js";import{a as $,c as U}from"./useCrud-bUfgzWCS.js";import{N as b,F as M,D as X,n as G}from"./constants-B48pdecp.js";import{M as q}from"./Modal-CR5BegYj.js";import{B as m}from"./Button-BA780zlq.js";import{I as h}from"./Input-CofDiIdZ.js";import{S as g}from"./Select-B7MIUx36.js";import{B as k}from"./Badge-BiItYtys.js";import{C as H}from"./ConfirmDialog-DPG7zYiO.js";import"./supabase-DANKYb0E.js";import"./export-t5FFX7R_.js";const J={fin:"primary",proposito:"success",componente:"info",actividad:"warning"},K=b.map(i=>({value:i.key,label:i.label})),Q=Object.entries(G).map(([i,o])=>({value:i,label:o})),Y=Object.entries(M).map(([i,o])=>({value:i,label:o})),Z=Object.entries(X).map(([i,o])=>({value:i,label:o})),I={nivel:"",resumen_narrativo:"",nombre_indicador:"",metodo_calculo:"",frecuencia_medicion:"",tipo_indicador:"",dimension:"",meta_programada:"",unidad_medida:"",medios_verificacion:"",supuestos:""};function ue(){const{programaId:i}=T(),o=V(),[S,x]=l.useState(!1),[s,y]=l.useState({...I}),[E,f]=l.useState(!1),[u,v]=l.useState(null),{data:c,isLoading:A}=W(i),N=$("indicador_mir"),_=U("indicador_mir"),D=l.useMemo(()=>{if(!c?.indicadores)return{};const t={};return b.forEach(r=>{t[r.key]=[]}),c.indicadores.forEach(r=>{const a=r.nivel||"actividad";t[a]||(t[a]=[]),t[a].push(r)}),t},[c]),w=c?.indicadores?.length||0,z=()=>{y({...I}),x(!0)},n=(t,r)=>{y(a=>({...a,[t]:r}))},O=async()=>{const t={...s,programa_id:i,meta_programada:s.meta_programada?Number(s.meta_programada):0};await N.mutateAsync(t),x(!1)},R=t=>{v(t),f(!0)},L=async()=>{u&&await _.mutateAsync(u.id),f(!1),v(null)},P=t=>{const r=Number(t.meta_programada||0);if(r===0)return 0;const d=(t.avances||[]).reduce((p,j)=>p+Number(j.valor_alcanzado||0),0);return Math.min(d/r*100,999.99)},B=t=>(t.avances||[]).reduce((a,d)=>a+Number(d.valor_alcanzado||0),0),F=t=>t>=100?"success":t>=50?"warning":"danger",C=N.isPending;return A?e.jsxs("div",{className:"flex items-center justify-center py-16 text-text-muted text-sm",children:[e.jsxs("svg",{className:"animate-spin h-5 w-5 mr-3 text-primary",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4",fill:"none"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}),"Cargando Matriz de Indicadores..."]}):c?e.jsxs("div",{children:[e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("button",{onClick:()=>o("/mir/programas"),className:"text-text-muted hover:text-text-primary transition-colors cursor-pointer",children:e.jsx("svg",{className:"w-5 h-5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"15 18 9 12 15 6"})})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-bold text-text-primary",children:"Matriz de Indicadores para Resultados"}),e.jsxs("p",{className:"text-sm text-text-muted mt-0.5",children:[c.clave," — ",c.nombre]})]})]})}),e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h2",{className:"text-sm font-semibold text-text-secondary",children:["Indicadores",e.jsxs("span",{className:"ml-2 text-text-muted font-normal",children:["(",w," registros)"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(m,{variant:"outline-primary",size:"sm",onClick:()=>o("/mir/avances"),children:"Registrar Avances"}),e.jsx(m,{onClick:z,size:"sm",children:"+ Agregar Indicador"})]})]}),e.jsx("div",{className:"bg-white rounded-lg card-shadow overflow-hidden",children:w===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-16 text-text-muted",children:[e.jsxs("svg",{className:"w-10 h-10 text-text-muted/50 mb-2",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("line",{x1:"3",y1:"9",x2:"21",y2:"9"}),e.jsx("line",{x1:"9",y1:"21",x2:"9",y2:"9"})]}),e.jsx("p",{className:"text-[0.9375rem]",children:"No hay indicadores registrados en esta MIR."}),e.jsx("p",{className:"text-xs text-text-muted mt-1",children:"Agregue indicadores para los niveles Fin, Proposito, Componente y Actividad."})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-[#f9fafb]",children:[e.jsx("th",{className:"text-left text-xs font-semibold text-text-secondary uppercase tracking-wider px-5 py-3.5",style:{width:"120px"},children:"Nivel"}),e.jsx("th",{className:"text-left text-xs font-semibold text-text-secondary uppercase tracking-wider px-5 py-3.5",children:"Resumen Narrativo"}),e.jsx("th",{className:"text-left text-xs font-semibold text-text-secondary uppercase tracking-wider px-5 py-3.5",style:{width:"180px"},children:"Indicador"}),e.jsx("th",{className:"text-right text-xs font-semibold text-text-secondary uppercase tracking-wider px-5 py-3.5",style:{width:"120px"},children:"Meta"}),e.jsx("th",{className:"text-right text-xs font-semibold text-text-secondary uppercase tracking-wider px-5 py-3.5",style:{width:"120px"},children:"Alcanzado"}),e.jsx("th",{className:"text-center text-xs font-semibold text-text-secondary uppercase tracking-wider px-5 py-3.5",style:{width:"110px"},children:"% Avance"}),e.jsx("th",{className:"text-left text-xs font-semibold text-text-secondary uppercase tracking-wider px-5 py-3.5",style:{width:"180px"},children:"Medios de Verificacion"}),e.jsx("th",{className:"text-left text-xs font-semibold text-text-secondary uppercase tracking-wider px-5 py-3.5",style:{width:"180px"},children:"Supuestos"}),e.jsx("th",{className:"text-center text-xs font-semibold text-text-secondary uppercase tracking-wider px-5 py-3.5",style:{width:"80px"},children:"Acciones"})]})}),e.jsx("tbody",{children:b.map(t=>{const r=D[t.key]||[];return r.length===0?null:r.map((a,d)=>{const p=P(a),j=B(a);return e.jsxs("tr",{className:"border-b border-[#f0f0f0] last:border-0 hover:bg-[#f9fafb] transition-colors",children:[e.jsx("td",{className:"px-5 py-3.5",children:e.jsx(k,{variant:J[t.key]||"default",children:t.label})}),e.jsx("td",{className:"px-5 py-3.5 text-[0.9375rem] text-text-primary",children:a.resumen_narrativo||"—"}),e.jsx("td",{className:"px-5 py-3.5 text-[0.9375rem] text-text-primary",children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:a.nombre_indicador||"—"}),a.frecuencia_medicion&&e.jsx("p",{className:"text-xs text-text-muted mt-0.5",children:M[a.frecuencia_medicion]||a.frecuencia_medicion})]})}),e.jsxs("td",{className:"px-5 py-3.5 text-[0.9375rem] text-text-primary text-right tabular-nums",children:[Number(a.meta_programada||0).toLocaleString("es-MX"),a.unidad_medida&&e.jsx("span",{className:"text-xs text-text-muted ml-1",children:a.unidad_medida})]}),e.jsx("td",{className:"px-5 py-3.5 text-[0.9375rem] text-text-primary text-right tabular-nums",children:j.toLocaleString("es-MX")}),e.jsx("td",{className:"px-5 py-3.5 text-center",children:e.jsxs(k,{variant:F(p),children:[p.toFixed(1),"%"]})}),e.jsx("td",{className:"px-5 py-3.5 text-[0.8125rem] text-text-secondary",children:a.medios_verificacion||"—"}),e.jsx("td",{className:"px-5 py-3.5 text-[0.8125rem] text-text-secondary",children:a.supuestos||"—"}),e.jsx("td",{className:"px-5 py-3.5 text-center",children:e.jsx("button",{onClick:()=>R(a),className:"text-xs text-danger hover:text-danger/80 transition-colors cursor-pointer",children:"Eliminar"})})]},a.id??`${t.key}-${d}`)})})})]})})}),e.jsx(q,{open:S,onClose:()=>x(!1),title:"Nuevo Indicador",size:"lg",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(g,{label:"Nivel MIR",value:s.nivel,onChange:t=>n("nivel",t.target.value),placeholder:"-- Seleccione nivel --",options:K}),e.jsx(g,{label:"Dimension",value:s.dimension,onChange:t=>n("dimension",t.target.value),placeholder:"-- Seleccione dimension --",options:Z})]}),e.jsxs("div",{className:"w-full",children:[e.jsxs("label",{className:"block text-sm font-medium text-text-heading mb-1.5",children:["Resumen Narrativo ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx("textarea",{value:s.resumen_narrativo,onChange:t=>n("resumen_narrativo",t.target.value),placeholder:"Describa el resumen narrativo del indicador",rows:3,className:"block w-full rounded-md border border-border bg-white text-text-heading text-[0.9375rem] px-3.5 py-2.5 transition-all duration-150 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda resize-none"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(h,{label:"Nombre del Indicador",value:s.nombre_indicador,onChange:t=>n("nombre_indicador",t.target.value),placeholder:"Ej. Tasa de cobertura"}),e.jsx(h,{label:"Metodo de Calculo",value:s.metodo_calculo,onChange:t=>n("metodo_calculo",t.target.value),placeholder:"Ej. (Numerador / Denominador) * 100"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(g,{label:"Tipo de Indicador",value:s.tipo_indicador,onChange:t=>n("tipo_indicador",t.target.value),placeholder:"-- Seleccione tipo --",options:Q}),e.jsx(g,{label:"Frecuencia de Medicion",value:s.frecuencia_medicion,onChange:t=>n("frecuencia_medicion",t.target.value),placeholder:"-- Seleccione frecuencia --",options:Y})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(h,{label:"Meta Programada",value:s.meta_programada,onChange:t=>n("meta_programada",t.target.value),placeholder:"0",type:"number"}),e.jsx(h,{label:"Unidad de Medida",value:s.unidad_medida,onChange:t=>n("unidad_medida",t.target.value),placeholder:"Ej. Porcentaje, Personas, Acciones"})]}),e.jsxs("div",{className:"w-full",children:[e.jsx("label",{className:"block text-sm font-medium text-text-heading mb-1.5",children:"Medios de Verificacion"}),e.jsx("textarea",{value:s.medios_verificacion,onChange:t=>n("medios_verificacion",t.target.value),placeholder:"Describa los medios de verificacion del indicador",rows:2,className:"block w-full rounded-md border border-border bg-white text-text-heading text-[0.9375rem] px-3.5 py-2.5 transition-all duration-150 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda resize-none"})]}),e.jsxs("div",{className:"w-full",children:[e.jsx("label",{className:"block text-sm font-medium text-text-heading mb-1.5",children:"Supuestos"}),e.jsx("textarea",{value:s.supuestos,onChange:t=>n("supuestos",t.target.value),placeholder:"Describa los supuestos del indicador",rows:2,className:"block w-full rounded-md border border-border bg-white text-text-heading text-[0.9375rem] px-3.5 py-2.5 transition-all duration-150 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda resize-none"})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-2 border-t border-border",children:[e.jsx(m,{variant:"ghost",onClick:()=>x(!1),disabled:C,children:"Cancelar"}),e.jsx(m,{onClick:O,loading:C,disabled:!s.nivel||!s.resumen_narrativo.trim()||!s.nombre_indicador.trim(),children:"Crear indicador"})]})]})}),e.jsx(H,{open:E,onClose:()=>{f(!1),v(null)},onConfirm:L,title:"Eliminar indicador",message:u?`¿Esta seguro de eliminar el indicador "${u.nombre_indicador}"? Se eliminaran tambien los avances asociados. Esta accion no se puede deshacer.`:"",confirmText:"Eliminar",loading:_.isPending})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center py-16 text-text-muted",children:[e.jsxs("svg",{className:"w-10 h-10 text-text-muted/50 mb-2",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("line",{x1:"12",y1:"8",x2:"12",y2:"12"}),e.jsx("line",{x1:"12",y1:"16",x2:"12.01",y2:"16"})]}),e.jsx("p",{className:"text-[0.9375rem] mb-4",children:"No se encontro el programa solicitado."}),e.jsx(m,{variant:"outline-primary",size:"sm",onClick:()=>o("/mir/programas"),children:"Volver a programas"})]})}export{ue as default};
