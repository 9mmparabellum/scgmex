import{u as Te,A as Re,j as e}from"./index-FiQ-o0as.js";import{b as s}from"./vendor-DEA9Ikep.js";import{useCreate as Ie,useUpdate as ze,useRemove as Be}from"./useCrud--Epse75Z.js";import{c as Le,u as Pe,f as Ve,h as $e,g as qe}from"./useEFirma-Z7THRUTS.js";import{W as x,X as C}from"./constants-CX_We7cr.js";import{D as We}from"./DataTable-BIXgbPbQ.js";import{M as _}from"./Modal-nDz351DY.js";import{B as l}from"./Button-CjklDnap.js";import{I as R}from"./Input-C95Jlo8c.js";import{S}from"./Select-DaQh9AUa.js";import{B as Ue}from"./Badge-7Bgbyuqr.js";import{C as Ke}from"./ConfirmDialog-Bpgd99YJ.js";import{e as Ge}from"./exportHelpers-CvXmrB4L.js";import"./supabase-DANKYb0E.js";import"./export-t5FFX7R_.js";const I=()=>new Date().toISOString().slice(0,10),Y={folio:"",tipo_documento:"poliza",descripcion:"",certificado_id:"",firmante:"",fecha_firma:I(),cadena_original:"",sello_digital:"",estado:"pendiente",notas:""};function dt(){const{entePublico:Z,ejercicioFiscal:ee,rol:te}=Te(),f=Re(te,"seguridad"),[ae,u]=s.useState(!1),[h,z]=s.useState(null),[i,k]=s.useState({...Y}),[se,D]=s.useState(!1),[p,F]=s.useState(null),[g,oe]=s.useState(""),[b,ie]=s.useState(""),[re,j]=s.useState(!1),[n,ne]=s.useState(null),[v,B]=s.useState(""),[L,P]=s.useState(""),[O]=s.useState(()=>({current:null})),le=s.useRef(null),[ce,E]=s.useState(!1),[m,de]=s.useState(null),[c,A]=s.useState(null),[me,V]=s.useState(!1),ue=s.useRef(null),[xe,M]=s.useState(!1),[d,H]=s.useState(null),[fe,$]=s.useState(!1),he=s.useRef(null),{data:q=[],isLoading:pe}=Le(),{data:y=[]}=Pe(),W=Ie("documento_firmado"),U=ze("documento_firmado"),K=Be("documento_firmado"),N=Ve(),ge=s.useMemo(()=>Object.entries(x).map(([t,a])=>({value:t,label:a})),[]),be=s.useMemo(()=>Object.entries(C).map(([t,{label:a}])=>({value:t,label:a})),[]),G=s.useMemo(()=>y.filter(t=>t.estado==="vigente").map(t=>({value:t.id,label:`${t.numero_serie} - ${t.titular}`})),[y]),je=s.useMemo(()=>y.map(t=>({value:t.id,label:`${t.numero_serie} - ${t.titular}`})),[y]),ve=s.useMemo(()=>[{value:"",label:"Todos los tipos"},...Object.entries(x).map(([t,a])=>({value:t,label:a}))],[]),ye=s.useMemo(()=>[{value:"",label:"Todos los estados"},...Object.entries(C).map(([t,{label:a}])=>({value:t,label:a}))],[]),w=s.useMemo(()=>{let t=q;return g&&(t=t.filter(a=>a.tipo_documento===g)),b&&(t=t.filter(a=>a.estado===b)),t},[q,g,b]),r=(t,a)=>k(o=>({...o,[t]:a})),T=(t,a=40)=>t?t.length>a?t.slice(0,a)+"...":t:"",Ne=()=>{z(null),k({...Y,fecha_firma:I()}),u(!0)},X=t=>{z(t),k({folio:t.folio??"",tipo_documento:t.tipo_documento??"poliza",descripcion:t.descripcion??"",certificado_id:t.certificado_id??"",firmante:t.firmante??"",fecha_firma:t.fecha_firma??I(),cadena_original:t.cadena_original??"",sello_digital:t.sello_digital??"",estado:t.estado??"pendiente",notas:t.notas??""}),u(!0)},Ce=async()=>{const t={...i,ente_id:Z?.id,ejercicio_id:ee?.id,certificado_id:i.certificado_id||null};h?await U.mutateAsync({id:h.id,...t}):await W.mutateAsync(t),u(!1)},_e=t=>{F(t),D(!0)},Se=async()=>{p&&await K.mutateAsync(p.id),D(!1),F(null)},ke=t=>{ne(t),B(t.certificado_id||""),P(""),j(!0)},De=async t=>{const a=t.target.files?.[0];if(!a)return;const o=await a.arrayBuffer();O.current=o,P(`[Archivo: ${a.name} - ${(a.size/1024).toFixed(1)} KB]`)},Fe=async()=>{if(!n||!v)return;const t=O.current||n.descripcion||n.folio||"";await N.mutateAsync({documentoId:n.id,contenido:t,certificadoId:v}),j(!1),O.current=null},Oe=t=>{de(t),A(null),E(!0)},Ee=async t=>{const a=t.target.files?.[0];if(!(!a||!m?.hash_documento)){V(!0);try{const o=await a.arrayBuffer(),Q=await $e(o);A({valido:Q===m.hash_documento,hashActual:Q,hashOriginal:m.hash_documento})}catch(o){A({valido:!1,error:o.message})}V(!1)}},Ae=()=>{H(null),M(!0)},Me=async t=>{const a=t.target.files?.[0];if(a){$(!0);try{const o=await qe(a);H(o)}catch(o){H({error:o.message})}$(!1)}},He=()=>{Ge(w,[{key:"folio",label:"Folio"},{key:"tipo_documento",label:"Tipo Documento",getValue:a=>x[a.tipo_documento]||a.tipo_documento},{key:"descripcion",label:"Descripcion"},{key:"certificado_id",label:"Certificado",getValue:a=>a.certificado?.numero_serie||""},{key:"firmante",label:"Firmante"},{key:"fecha_firma",label:"Fecha Firma"},{key:"hash_documento",label:"Hash SHA-256"},{key:"cadena_original",label:"Cadena Original"},{key:"sello_digital",label:"Sello Digital"},{key:"estado",label:"Estado",getValue:a=>C[a.estado]?.label||a.estado},{key:"notas",label:"Notas"}],"documentos_firmados")},we=s.useMemo(()=>[{key:"folio",label:"Folio",width:"100px"},{key:"tipo_documento",label:"Tipo",width:"130px",render:t=>x[t]||t},{key:"descripcion",label:"Descripcion",render:t=>e.jsx("span",{title:t||"",children:T(t)})},{key:"certificado",label:"Certificado",width:"150px",render:t=>t?.numero_serie||"-"},{key:"firmante",label:"Firmante",width:"130px"},{key:"fecha_firma",label:"Fecha",width:"100px"},{key:"hash_documento",label:"Hash SHA-256",width:"140px",render:t=>t?e.jsxs("span",{title:t,className:"font-mono text-[10px] text-text-secondary",children:[t.slice(0,16),"..."]}):e.jsx("span",{className:"text-text-muted text-xs",children:"-"})},{key:"estado",label:"Estado",width:"110px",render:t=>{const a=C[t]||{label:t,variant:"default"};return e.jsx(Ue,{variant:a.variant,children:a.label})}},{key:"id",label:"Acciones",width:"180px",sortable:!1,render:(t,a)=>e.jsxs("div",{className:"flex items-center gap-2",children:[a.estado==="pendiente"&&f&&e.jsx("button",{onClick:o=>{o.stopPropagation(),ke(a)},className:"text-xs text-[#56ca00] hover:text-[#56ca00]/80 transition-colors cursor-pointer font-medium",children:"Firmar"}),a.estado==="firmado"&&a.hash_documento&&e.jsx("button",{onClick:o=>{o.stopPropagation(),Oe(a)},className:"text-xs text-[#03a9ce] hover:text-[#03a9ce]/80 transition-colors cursor-pointer",children:"Verificar"}),e.jsx("button",{onClick:o=>{o.stopPropagation(),X(a)},className:"text-xs text-primary hover:text-primary-light transition-colors cursor-pointer",children:"Editar"}),f&&e.jsx("button",{onClick:o=>{o.stopPropagation(),_e(a)},className:"text-xs text-danger hover:text-danger/80 transition-colors cursor-pointer",children:"Eliminar"})]})}],[f]),J=W.isPending||U.isPending;return e.jsxs("div",{children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h1",{className:"text-xl font-bold text-text-primary",children:"Documentos Firmados"}),e.jsx("p",{className:"text-sm text-text-muted mt-1",children:"Control de documentos firmados electronicamente con e.firma"})]}),e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("h2",{className:"text-sm font-semibold text-text-secondary",children:["Documentos",e.jsxs("span",{className:"ml-2 text-text-muted font-normal",children:["(",w.length," registros)"]})]}),e.jsx("select",{value:g,onChange:t=>oe(t.target.value),className:"h-[38px] rounded-md border border-border text-[0.9375rem] px-3 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda",children:ve.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))}),e.jsx("select",{value:b,onChange:t=>ie(t.target.value),className:"h-[38px] rounded-md border border-border text-[0.9375rem] px-3 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda",children:ye.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(l,{onClick:Ae,variant:"outline-secondary",size:"sm",children:"Calcular Hash"}),e.jsx(l,{onClick:He,variant:"outline-primary",size:"sm",children:"Exportar Excel"}),f&&e.jsx(l,{onClick:Ne,size:"sm",children:"+ Nuevo Documento"})]})]}),pe?e.jsx("div",{className:"flex items-center justify-center py-16 text-text-muted text-sm",children:"Cargando documentos firmados..."}):e.jsx(We,{columns:we,data:w,onRowClick:X}),e.jsx(_,{open:ae,onClose:()=>u(!1),title:h?"Editar Documento Firmado":"Nuevo Documento Firmado",size:"lg",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(R,{label:"Folio",value:i.folio,onChange:t=>r("folio",t.target.value),placeholder:"Ej. DOC-001",required:!0}),e.jsx(S,{label:"Tipo de Documento",value:i.tipo_documento,onChange:t=>r("tipo_documento",t.target.value),options:ge,placeholder:"-- Seleccione tipo --",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Descripcion"}),e.jsx("textarea",{value:i.descripcion,onChange:t=>r("descripcion",t.target.value),placeholder:"Descripcion del documento a firmar",rows:2,className:"w-full h-auto rounded-md border border-border text-[0.9375rem] px-3 py-2 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(S,{label:"Certificado",value:i.certificado_id,onChange:t=>r("certificado_id",t.target.value),options:je,placeholder:"-- Seleccione certificado --"}),e.jsx(R,{label:"Firmante",value:i.firmante,onChange:t=>r("firmante",t.target.value),placeholder:"Nombre del firmante",required:!0})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(R,{label:"Fecha de Firma",type:"date",value:i.fecha_firma,onChange:t=>r("fecha_firma",t.target.value),required:!0}),e.jsx(S,{label:"Estado",value:i.estado,onChange:t=>r("estado",t.target.value),options:be,placeholder:"-- Seleccione estado --",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Cadena Original"}),e.jsx("textarea",{value:i.cadena_original,onChange:t=>r("cadena_original",t.target.value),placeholder:"Se genera automaticamente al firmar",rows:3,readOnly:i.estado==="firmado",className:`w-full h-auto rounded-md border border-border text-[0.9375rem] font-mono text-xs px-3 py-2 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda ${i.estado==="firmado"?"bg-[#f8f8f8]":""}`})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Sello Digital"}),e.jsx("textarea",{value:i.sello_digital,onChange:t=>r("sello_digital",t.target.value),placeholder:"Se genera automaticamente al firmar",rows:3,readOnly:i.estado==="firmado",className:`w-full h-auto rounded-md border border-border text-[0.9375rem] font-mono text-xs px-3 py-2 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda ${i.estado==="firmado"?"bg-[#f8f8f8]":""}`})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Notas"}),e.jsx("textarea",{value:i.notas,onChange:t=>r("notas",t.target.value),placeholder:"Observaciones o notas adicionales",rows:2,className:"w-full h-auto rounded-md border border-border text-[0.9375rem] px-3 py-2 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda"})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-2 border-t border-border",children:[e.jsx(l,{variant:"ghost",onClick:()=>u(!1),disabled:J,children:"Cancelar"}),e.jsx(l,{onClick:Ce,loading:J,disabled:!i.folio.trim()||!i.firmante.trim(),children:h?"Guardar cambios":"Crear Documento"})]})]})}),e.jsx(_,{open:re,onClose:()=>j(!1),title:"Firmar Documento",size:"md",children:n&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-[#f8f8f8] rounded-lg p-4",children:e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-text-muted",children:"Folio:"}),e.jsx("span",{className:"ml-2 font-semibold text-text-primary",children:n.folio})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-text-muted",children:"Tipo:"}),e.jsx("span",{className:"ml-2 text-text-primary",children:x[n.tipo_documento]||n.tipo_documento})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("span",{className:"text-text-muted",children:"Descripcion:"}),e.jsx("span",{className:"ml-2 text-text-primary",children:n.descripcion||"-"})]})]})}),e.jsx(S,{label:"Certificado para firmar",value:v,onChange:t=>B(t.target.value),options:G,placeholder:"-- Seleccione certificado vigente --",required:!0}),G.length===0&&e.jsx("p",{className:"text-xs text-danger",children:"No hay certificados vigentes. Cargue un certificado .cer en la seccion de e.firma."}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Archivo a firmar (opcional)"}),e.jsx("p",{className:"text-xs text-text-muted mb-2",children:"Si selecciona un archivo, se generara el hash SHA-256 de su contenido. Si no, se usara la descripcion del documento."}),e.jsx("input",{ref:le,type:"file",onChange:De,className:"block w-full text-sm text-text-secondary file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-guinda/10 file:text-guinda hover:file:bg-guinda/20 file:cursor-pointer"}),L&&e.jsx("p",{className:"mt-1 text-xs text-[#56ca00]",children:L})]}),N.isError&&e.jsxs("p",{className:"text-xs text-danger",children:["Error: ",N.error?.message||"No se pudo firmar el documento"]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-2 border-t border-border",children:[e.jsx(l,{variant:"ghost",onClick:()=>j(!1),children:"Cancelar"}),e.jsx(l,{variant:"success",onClick:Fe,loading:N.isPending,disabled:!v,children:"Firmar Documento"})]})]})}),e.jsx(_,{open:ce,onClose:()=>E(!1),title:"Verificar Integridad del Documento",size:"md",children:m&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-[#f8f8f8] rounded-lg p-4 space-y-2",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"text-text-muted",children:"Folio:"}),e.jsx("span",{className:"ml-2 font-semibold text-text-primary",children:m.folio})]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"text-text-muted",children:"Hash original (SHA-256):"}),e.jsx("p",{className:"mt-1 font-mono text-[11px] text-text-primary bg-white rounded p-2 border border-border break-all",children:m.hash_documento})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Seleccione el archivo original para verificar"}),e.jsx("p",{className:"text-xs text-text-muted mb-2",children:"Se calculara el hash SHA-256 del archivo y se comparara con el hash registrado al firmar."}),e.jsx("input",{ref:ue,type:"file",onChange:Ee,className:"block w-full text-sm text-text-secondary file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-guinda/10 file:text-guinda hover:file:bg-guinda/20 file:cursor-pointer"})]}),me&&e.jsx("div",{className:"text-sm text-text-muted text-center py-3",children:"Calculando hash..."}),c&&!c.error&&e.jsxs("div",{className:`rounded-lg p-4 ${c.valido?"bg-[#56ca00]/10":"bg-danger/10"}`,children:[e.jsx("div",{className:"flex items-center gap-2 mb-2",children:c.valido?e.jsxs(e.Fragment,{children:[e.jsx("svg",{className:"w-5 h-5 text-[#56ca00]",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})}),e.jsx("span",{className:"text-sm font-semibold text-[#56ca00]",children:"Documento integro - Los hashes coinciden"})]}):e.jsxs(e.Fragment,{children:[e.jsx("svg",{className:"w-5 h-5 text-danger",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"})}),e.jsx("span",{className:"text-sm font-semibold text-danger",children:"Documento alterado - Los hashes NO coinciden"})]})}),e.jsxs("div",{className:"text-xs space-y-1",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-text-muted",children:"Hash original:"}),e.jsx("span",{className:"ml-1 font-mono",children:T(c.hashOriginal,32)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-text-muted",children:"Hash actual:"}),e.jsx("span",{className:"ml-1 font-mono",children:T(c.hashActual,32)})]})]})]}),c?.error&&e.jsxs("p",{className:"text-xs text-danger",children:["Error: ",c.error]}),e.jsx("div",{className:"flex justify-end pt-2 border-t border-border",children:e.jsx(l,{variant:"ghost",onClick:()=>E(!1),children:"Cerrar"})})]})}),e.jsx(_,{open:xe,onClose:()=>M(!1),title:"Calcular Hash SHA-256",size:"md",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-text-secondary",children:"Seleccione un archivo para calcular su hash SHA-256 usando la Web Crypto API del navegador. Este hash es identico al que se genera al firmar un documento."}),e.jsx("input",{ref:he,type:"file",onChange:Me,className:"block w-full text-sm text-text-secondary file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-guinda/10 file:text-guinda hover:file:bg-guinda/20 file:cursor-pointer"}),fe&&e.jsx("div",{className:"text-sm text-text-muted text-center py-3",children:"Calculando hash SHA-256..."}),d&&!d.error&&e.jsxs("div",{className:"bg-[#f8f8f8] rounded-lg p-4 space-y-3",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"text-text-muted",children:"Archivo:"}),e.jsx("span",{className:"ml-2 text-text-primary",children:d.name}),e.jsxs("span",{className:"ml-2 text-text-muted",children:["(",(d.size/1024).toFixed(1)," KB)"]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-text-muted mb-1",children:"Hash SHA-256 (Hex)"}),e.jsx("div",{className:"font-mono text-[11px] text-text-primary bg-white rounded p-2 border border-border break-all select-all",children:d.hex})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-text-muted mb-1",children:"Hash SHA-256 (Base64)"}),e.jsx("div",{className:"font-mono text-[11px] text-text-primary bg-white rounded p-2 border border-border break-all select-all",children:d.base64})]})]}),d?.error&&e.jsxs("p",{className:"text-xs text-danger",children:["Error: ",d.error]}),e.jsx("div",{className:"flex justify-end pt-2 border-t border-border",children:e.jsx(l,{variant:"ghost",onClick:()=>M(!1),children:"Cerrar"})})]})}),e.jsx(Ke,{open:se,onClose:()=>{D(!1),F(null)},onConfirm:Se,title:"Eliminar documento firmado",message:p?`Â¿Esta seguro de eliminar el documento firmado "${p.folio||""}"? Esta accion no se puede deshacer.`:"",confirmText:"Eliminar",loading:K.isPending})]})}export{dt as default};
