import{u as Y,j as o}from"./index-C8w7C__S.js";import{b as n}from"./vendor-DEA9Ikep.js";import{u as b,a as Z,c as ee,B as x}from"./Button-DuXcW5xX.js";import{b as j,a as I}from"./constants-B9IYjURH.js";import{e as oe}from"./exportHelpers-CvXmrB4L.js";import{D as te}from"./DataTable-jgOn3qee.js";import{M as ie}from"./Modal-DP5Epx02.js";import{I as y}from"./Input-BuLY86I-.js";import{S as l}from"./Select-D5ASwMqy.js";import{B as ne}from"./Badge-R2GXFUbi.js";import{C as se}from"./ConfirmDialog-u86aQ__Z.js";import"./supabase-DANKYb0E.js";import"./export-t5FFX7R_.js";const P=h=>new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(h||0),R=()=>new Date().toISOString().slice(0,10),F={concepto_id:"",periodo_id:"",tipo_movimiento:"",monto:"",descripcion:"",fecha:R()};function be(){const{entePublico:h,ejercicioFiscal:_}=Y(),[a,q]=n.useState(j[0].key),[c,$]=n.useState(""),[d,A]=n.useState(""),[B,m]=n.useState(!1),[i,C]=n.useState({...F}),[L,v]=n.useState(!1),[p,f]=n.useState(null),V=n.useMemo(()=>{const e={momento:a};return c&&(e.concepto_id=c),d&&(e.periodo_id=d),e},[a,c,d]),{data:g=[],isLoading:z}=b("movimiento_presupuestal_ingreso",{filter:V}),{data:u=[]}=b("concepto_ingreso",{filter:{ente_id:h?.id,ejercicio_id:_?.id}}),{data:M=[]}=b("periodo_contable",{filter:{ejercicio_id:_?.id}}),k=Z("movimiento_presupuestal_ingreso"),N=ee("movimiento_presupuestal_ingreso"),S=n.useMemo(()=>{const e={};return u.forEach(t=>{e[t.id]=t}),e},[u]),E=n.useMemo(()=>u.map(e=>({value:e.id,label:`${e.clave} — ${e.descripcion}`})),[u]),w=n.useMemo(()=>M.map(e=>({value:e.id,label:e.nombre||e.clave})),[M]),U=n.useMemo(()=>I.map(e=>({value:e.key,label:e.label})),[]),X=e=>({original:"info",adicion:"success",reduccion:"danger"})[e]||"default",O=e=>{const t=I.find(s=>s.key===e);return t?t.label:e},T=j.find(e=>e.key===a)?.label??a,G=()=>{C({...F,fecha:R()}),m(!0)},r=(e,t)=>{C(s=>({...s,[e]:t}))},H=async()=>{const e={concepto_id:i.concepto_id,periodo_id:i.periodo_id||null,momento:a,tipo_movimiento:i.tipo_movimiento,monto:Number(i.monto)||0,descripcion:i.descripcion,fecha:i.fecha};await k.mutateAsync(e),m(!1)},J=e=>{f(e),v(!0)},K=async()=>{p&&await N.mutateAsync(p.id),v(!1),f(null)},Q=()=>{oe(g,[{key:"fecha",label:"Fecha",getValue:t=>t.fecha},{key:"concepto",label:"Concepto",getValue:t=>{const s=S[t.concepto_id];return s?`${s.clave} — ${s.descripcion}`:t.concepto_id}},{key:"tipo_movimiento",label:"Tipo Movimiento",getValue:t=>O(t.tipo_movimiento)},{key:"monto",label:"Monto",getValue:t=>Number(t.monto||0)},{key:"descripcion",label:"Descripcion"}],`momentos_ingreso_${a}`)},W=[{key:"fecha",label:"Fecha",width:"120px"},{key:"concepto_id",label:"Concepto",render:e=>{const t=S[e];return t?t.clave:"—"}},{key:"tipo_movimiento",label:"Tipo Mov.",width:"120px",render:e=>o.jsx(ne,{variant:X(e),children:O(e)})},{key:"monto",label:"Monto",width:"130px",render:e=>o.jsx("span",{className:"text-right block tabular-nums",children:P(e)})},{key:"descripcion",label:"Descripcion"},{key:"id",label:"Acciones",width:"100px",sortable:!1,render:(e,t)=>o.jsx("button",{onClick:s=>{s.stopPropagation(),J(t)},className:"text-xs text-danger hover:text-danger/80 transition-colors cursor-pointer",children:"Eliminar"})}],D=k.isPending;return o.jsxs("div",{children:[o.jsxs("div",{className:"mb-6",children:[o.jsx("h1",{className:"text-xl font-bold text-text-primary",children:"Momentos del Ingreso"}),o.jsx("p",{className:"text-sm text-text-muted mt-1",children:"Registro de movimientos presupuestarios de ingreso"})]}),o.jsx("div",{className:"flex flex-wrap items-center gap-2 mb-6",children:j.map(e=>o.jsx("button",{onClick:()=>q(e.key),className:["px-4 py-2 text-sm font-medium rounded-lg transition-colors cursor-pointer",a===e.key?"bg-primary text-white":"bg-white card-shadow text-text-secondary hover:bg-bg-hover"].join(" "),children:e.label},e.key))}),o.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 max-w-2xl",children:[o.jsx(l,{label:"Concepto",value:c,onChange:e=>$(e.target.value),options:E,placeholder:"— Todos los conceptos —"}),o.jsx(l,{label:"Periodo",value:d,onChange:e=>A(e.target.value),options:w,placeholder:"— Todos los periodos —"})]}),o.jsxs("div",{className:"flex items-center justify-between mb-4",children:[o.jsxs("h2",{className:"text-sm font-semibold text-text-secondary",children:[T,o.jsxs("span",{className:"ml-2 text-text-muted font-normal",children:["(",g.length," movimientos)"]})]}),o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx(x,{onClick:Q,variant:"outline-primary",size:"sm",children:"Exportar Excel"}),o.jsx(x,{onClick:G,size:"sm",children:"+ Registrar Movimiento"})]})]}),z?o.jsx("div",{className:"flex items-center justify-center py-16 text-text-muted text-sm",children:"Cargando movimientos..."}):o.jsx(te,{columns:W,data:g}),o.jsx(ie,{open:B,onClose:()=>m(!1),title:"Registrar Movimiento",size:"md",children:o.jsxs("div",{className:"space-y-4",children:[o.jsxs("div",{className:"w-full",children:[o.jsx("label",{className:"block text-sm font-medium text-text-heading mb-1.5",children:"Momento contable"}),o.jsx("div",{className:"block w-full h-[40px] rounded-md border border-border bg-bg-hover text-text-muted text-[0.9375rem] px-3.5 py-2.5",children:T})]}),o.jsx(l,{label:"Concepto",value:i.concepto_id,onChange:e=>r("concepto_id",e.target.value),options:E,placeholder:"— Seleccione un concepto —",required:!0}),o.jsx(l,{label:"Periodo contable",value:i.periodo_id,onChange:e=>r("periodo_id",e.target.value),options:w,placeholder:"— Seleccione un periodo —",required:!0}),o.jsx(l,{label:"Tipo de movimiento",value:i.tipo_movimiento,onChange:e=>r("tipo_movimiento",e.target.value),options:U,placeholder:"— Seleccione tipo —",required:!0}),o.jsx(y,{label:"Monto",type:"number",value:i.monto,onChange:e=>r("monto",e.target.value),placeholder:"0.00",min:0,required:!0}),o.jsx(y,{label:"Descripcion (opcional)",value:i.descripcion,onChange:e=>r("descripcion",e.target.value),placeholder:"Descripcion del movimiento"}),o.jsx(y,{label:"Fecha",type:"date",value:i.fecha,onChange:e=>r("fecha",e.target.value),required:!0}),o.jsxs("div",{className:"flex justify-end gap-3 pt-2 border-t border-border",children:[o.jsx(x,{variant:"ghost",onClick:()=>m(!1),disabled:D,children:"Cancelar"}),o.jsx(x,{onClick:H,loading:D,disabled:!i.concepto_id||!i.tipo_movimiento||!i.monto||!i.fecha,children:"Registrar movimiento"})]})]})}),o.jsx(se,{open:L,onClose:()=>{v(!1),f(null)},onConfirm:K,title:"Eliminar movimiento",message:p?`¿Esta seguro de eliminar este movimiento por ${P(p.monto)}? Esta accion no se puede deshacer.`:"",confirmText:"Eliminar",loading:N.isPending})]})}export{be as default};
