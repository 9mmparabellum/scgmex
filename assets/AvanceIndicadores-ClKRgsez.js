import{u as W,j as e}from"./index-KskWbqO9.js";import{b as i}from"./vendor-DEA9Ikep.js";import{u as D,b as J}from"./useMIR-C2IqXHdm.js";import{useList as q,useCreate as G}from"./useCrud-C19KmPO4.js";import{N as H}from"./constants-CX_We7cr.js";import{M as K}from"./Modal-DfjuYvxB.js";import{B as h}from"./Button-DGu3eAys.js";import{I as Q}from"./Input-CHoXOb6x.js";import{S as w}from"./Select-k3R1vLiz.js";import{B as M}from"./Badge-B4UqNpVe.js";import"./supabase-DANKYb0E.js";import"./export-t5FFX7R_.js";const T={fin:"primary",proposito:"success",componente:"info",actividad:"warning"},k={};H.forEach(l=>{k[l.key]=l.label});function de(){const{ejercicioFiscal:l,entePublico:z}=W(),[m,C]=i.useState(""),[S,x]=i.useState(!1),[n,u]=i.useState(null),[s,f]=i.useState({periodo_id:"",valor_alcanzado:"",justificacion:""}),[A,g]=i.useState(null),{data:v=[],isLoading:b}=D(),{data:N=[],isLoading:I}=J(m||void 0),{data:p=[]}=q("periodo_contable",{filter:{ejercicio_id:l?.id},order:{column:"numero",ascending:!0}}),y=G("avance_indicador"),L=i.useMemo(()=>v.map(a=>({value:a.id,label:`${a.clave} — ${a.nombre}`})),[v]),P=i.useMemo(()=>p.map(a=>({value:a.id,label:a.nombre||`Periodo ${a.numero}`})),[p]),E=a=>{u(a),f({periodo_id:"",valor_alcanzado:"",justificacion:""}),x(!0)},j=(a,t)=>{f(o=>({...o,[a]:t}))},B=async()=>{const a={indicador_id:n.id,periodo_id:s.periodo_id,valor_alcanzado:s.valor_alcanzado?Number(s.valor_alcanzado):0,justificacion:s.justificacion};await y.mutateAsync(a),x(!1),u(null)},R=a=>{g(t=>t===a?null:a)},V=a=>{const t=Number(a.meta_programada||0);if(t===0)return 0;const c=(a.avances||[]).reduce((d,r)=>d+Number(r.valor_alcanzado||0),0);return Math.min(c/t*100,999.99)},$=a=>(a.avances||[]).reduce((o,c)=>o+Number(c.valor_alcanzado||0),0),F=a=>a>=100?"success":a>=50?"warning":"danger",O=i.useMemo(()=>{const a={};return p.forEach(t=>{a[t.id]=t.nombre||`Periodo ${t.numero}`}),a},[p]),_=y.isPending;return!z?.id||!l?.id?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("p",{className:"text-text-muted text-sm",children:"Seleccione un ente publico y ejercicio fiscal para capturar avances de indicadores."})}):e.jsxs("div",{children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h1",{className:"text-xl font-bold text-text-primary",children:"Avance de Indicadores"}),e.jsx("p",{className:"text-sm text-text-muted mt-1",children:"Captura de avances por periodo"})]}),e.jsx("div",{className:"mb-6 max-w-md",children:e.jsx(w,{label:"Programa presupuestario",value:m,onChange:a=>{C(a.target.value),g(null)},options:L,placeholder:"-- Seleccione un programa --"})}),b&&e.jsxs("div",{className:"flex items-center justify-center py-16 text-text-muted text-sm",children:[e.jsxs("svg",{className:"animate-spin h-5 w-5 mr-3 text-primary",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4",fill:"none"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}),"Cargando programas..."]}),!m&&!b&&e.jsx("div",{className:"bg-white rounded-lg card-shadow p-5",children:e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-text-muted",children:[e.jsxs("svg",{className:"w-10 h-10 text-text-muted/50 mb-2",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"}),e.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),e.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"})]}),e.jsx("p",{className:"text-[0.9375rem]",children:"Seleccione un programa para ver sus indicadores"})]})}),m&&e.jsx(e.Fragment,{children:I?e.jsxs("div",{className:"flex items-center justify-center py-16 text-text-muted text-sm",children:[e.jsxs("svg",{className:"animate-spin h-5 w-5 mr-3 text-primary",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4",fill:"none"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}),"Cargando indicadores..."]}):N.length===0?e.jsx("div",{className:"bg-white rounded-lg card-shadow p-5",children:e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-text-muted",children:[e.jsxs("svg",{className:"w-10 h-10 text-text-muted/50 mb-2",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("line",{x1:"3",y1:"9",x2:"21",y2:"9"}),e.jsx("line",{x1:"9",y1:"21",x2:"9",y2:"9"})]}),e.jsx("p",{className:"text-[0.9375rem]",children:"Este programa no tiene indicadores registrados."}),e.jsx("p",{className:"text-xs text-text-muted mt-1",children:"Agregue indicadores desde la vista de detalle MIR del programa."})]})}):e.jsx("div",{className:"space-y-3",children:N.map(a=>{const t=V(a),o=$(a),c=A===a.id,d=a.avances||[];return e.jsxs("div",{className:"bg-white rounded-lg card-shadow",children:[e.jsxs("div",{className:"p-5",children:[e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(M,{variant:T[a.nivel]||"default",children:k[a.nivel]||a.nivel}),e.jsx("span",{className:"text-[0.9375rem] font-medium text-text-primary truncate",children:a.nombre_indicador})]}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-text-muted mt-1",children:[e.jsxs("span",{children:["Meta: ",e.jsx("span",{className:"font-semibold text-text-primary",children:Number(a.meta_programada||0).toLocaleString("es-MX")}),a.unidad_medida&&e.jsx("span",{className:"ml-1",children:a.unidad_medida})]}),e.jsxs("span",{children:["Alcanzado: ",e.jsx("span",{className:"font-semibold text-text-primary",children:o.toLocaleString("es-MX")})]}),e.jsxs(M,{variant:F(t),children:[t.toFixed(1),"%"]}),a.frecuencia_medicion&&e.jsxs("span",{className:"text-xs",children:["Frecuencia: ",a.frecuencia_medicion]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0",children:[d.length>0&&e.jsx(h,{variant:"ghost",size:"sm",onClick:()=>R(a.id),children:c?"Ocultar avances":`Ver avances (${d.length})`}),e.jsx(h,{variant:"outline-primary",size:"sm",onClick:()=>E(a),children:"Registrar Avance"})]})]}),e.jsx("div",{className:"mt-3",children:e.jsx("div",{className:"w-full bg-[#f0f0f0] rounded-full h-2",children:e.jsx("div",{className:`h-2 rounded-full transition-all duration-300 ${t>=100?"bg-success":t>=50?"bg-warning":"bg-danger"}`,style:{width:`${Math.min(t,100)}%`}})})})]}),c&&d.length>0&&e.jsx("div",{className:"border-t border-border px-5 pb-5",children:e.jsxs("table",{className:"w-full mt-3",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-[#f9fafb]",children:[e.jsx("th",{className:"text-left text-xs font-semibold text-text-secondary uppercase tracking-wider px-4 py-2.5",children:"Periodo"}),e.jsx("th",{className:"text-right text-xs font-semibold text-text-secondary uppercase tracking-wider px-4 py-2.5",style:{width:"140px"},children:"Valor Alcanzado"}),e.jsx("th",{className:"text-left text-xs font-semibold text-text-secondary uppercase tracking-wider px-4 py-2.5",children:"Justificacion"}),e.jsx("th",{className:"text-left text-xs font-semibold text-text-secondary uppercase tracking-wider px-4 py-2.5",style:{width:"160px"},children:"Fecha Registro"})]})}),e.jsx("tbody",{children:d.map((r,X)=>e.jsxs("tr",{className:"border-b border-[#f0f0f0] last:border-0",children:[e.jsx("td",{className:"px-4 py-2.5 text-[0.9375rem] text-text-primary",children:O[r.periodo_id]||r.periodo_id||"—"}),e.jsx("td",{className:"px-4 py-2.5 text-[0.9375rem] text-text-primary text-right tabular-nums",children:Number(r.valor_alcanzado||0).toLocaleString("es-MX")}),e.jsx("td",{className:"px-4 py-2.5 text-[0.8125rem] text-text-secondary",children:r.justificacion||"—"}),e.jsx("td",{className:"px-4 py-2.5 text-[0.8125rem] text-text-muted",children:r.created_at?new Date(r.created_at).toLocaleDateString("es-MX"):"—"})]},r.id??X))})]})})]},a.id)})})}),e.jsx(K,{open:S,onClose:()=>{x(!1),u(null)},title:"Registrar Avance",size:"md",children:e.jsxs("div",{className:"space-y-4",children:[n&&e.jsxs("div",{className:"p-3 rounded-lg border border-info/30 bg-info/5 text-sm",children:[e.jsx("p",{className:"font-medium text-text-primary",children:n.nombre_indicador}),e.jsxs("p",{className:"text-text-muted mt-0.5",children:["Meta programada: ",Number(n.meta_programada||0).toLocaleString("es-MX"),n.unidad_medida&&` ${n.unidad_medida}`]})]}),e.jsx(w,{label:"Periodo",value:s.periodo_id,onChange:a=>j("periodo_id",a.target.value),placeholder:"-- Seleccione periodo --",options:P}),e.jsx(Q,{label:"Valor Alcanzado",value:s.valor_alcanzado,onChange:a=>j("valor_alcanzado",a.target.value),placeholder:"0",type:"number"}),e.jsxs("div",{className:"w-full",children:[e.jsx("label",{className:"block text-sm font-medium text-text-heading mb-1.5",children:"Justificacion"}),e.jsx("textarea",{value:s.justificacion,onChange:a=>j("justificacion",a.target.value),placeholder:"Justifique el avance reportado (opcional)",rows:3,className:"block w-full rounded-md border border-border bg-white text-text-heading text-[0.9375rem] px-3.5 py-2.5 transition-all duration-150 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda resize-none"})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-2 border-t border-border",children:[e.jsx(h,{variant:"ghost",onClick:()=>{x(!1),u(null)},disabled:_,children:"Cancelar"}),e.jsx(h,{onClick:B,loading:_,disabled:!s.periodo_id||!s.valor_alcanzado,children:"Registrar avance"})]})]})})]})}export{de as default};
