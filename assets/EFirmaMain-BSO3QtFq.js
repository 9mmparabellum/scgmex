import{u as H,y as J,j as t}from"./index-xuYioy8Y.js";import{b as r}from"./vendor-DEA9Ikep.js";import{a as K,b as Q,c as Y}from"./useCrud-BZqSYSww.js";import{u as Z,a as ee}from"./useEFirma--Ic7l-uu.js";import{W as b,X as _}from"./constants-B0qHiDNt.js";import{D as te}from"./DataTable-CoGr0iSJ.js";import{M as ae}from"./Modal-BawsBw69.js";import{B as u}from"./Button-CQM7GO5t.js";import{I as l}from"./Input-C6_ozmNh.js";import{S as F}from"./Select-CHQpqBAE.js";import{B as ie}from"./Badge-DX5pclE5.js";import{C as se}from"./ConfirmDialog-BrOOKlKS.js";import{e as oe}from"./exportHelpers-CvXmrB4L.js";import"./supabase-DANKYb0E.js";import"./export-t5FFX7R_.js";const j=()=>new Date().toISOString().slice(0,10),T={numero_serie:"",titular:"",rfc:"",tipo:"fiel",fecha_vigencia_inicio:j(),fecha_vigencia_fin:"",estado:"vigente",emisor:"",notas:""};function je(){const{entePublico:D,rol:O}=H(),f=J(O,"seguridad"),[I,c]=r.useState(!1),[d,C]=r.useState(null),[i,x]=r.useState({...T}),[M,p]=r.useState(!1),[m,g]=r.useState(null),{data:h=[],isLoading:R}=Z(),{data:n={},isLoading:A}=ee(),y=K("certificado_efirma"),N=Q("certificado_efirma"),E=Y("certificado_efirma"),P=r.useMemo(()=>Object.entries(b).map(([e,a])=>({value:e,label:a})),[]),w=r.useMemo(()=>Object.entries(_).map(([e,{label:a}])=>({value:e,label:a})),[]),V=r.useMemo(()=>{const e=n.totalCertificados||0,a=n.vigentes||0,o=n.porVencer||0,v=n.totalDocumentos||0,W=n.firmados||0,X=n.pendientes||0;return[{label:"Total Certificados",value:e,color:"text-text-primary"},{label:"Vigentes",value:a,color:"text-[#56ca00]"},{label:"Por Vencer",value:o,color:"text-[#e09600]"},{label:"Total Documentos",value:v,color:"text-text-primary"},{label:"Firmados",value:W,color:"text-[#56ca00]"},{label:"Pendientes",value:X,color:"text-[#e09600]"}]},[n]),s=(e,a)=>x(o=>({...o,[e]:a})),q=e=>{if(e.estado!=="vigente"||!e.fecha_vigencia_fin)return!1;const a=new Date,o=new Date(e.fecha_vigencia_fin),v=720*60*60*1e3;return o.getTime()-a.getTime()<v},B=()=>{C(null),x({...T,fecha_vigencia_inicio:j()}),c(!0)},k=e=>{C(e),x({numero_serie:e.numero_serie??"",titular:e.titular??"",rfc:e.rfc??"",tipo:e.tipo??"fiel",fecha_vigencia_inicio:e.fecha_vigencia_inicio??j(),fecha_vigencia_fin:e.fecha_vigencia_fin??"",estado:e.estado??"vigente",emisor:e.emisor??"",notas:e.notas??""}),c(!0)},z=async()=>{const e={...i,ente_id:D?.id};d?await N.mutateAsync({id:d.id,...e}):await y.mutateAsync(e),c(!1)},L=e=>{g(e),p(!0)},G=async()=>{m&&await E.mutateAsync(m.id),p(!1),g(null)},$=()=>{oe(h,[{key:"numero_serie",label:"Numero de Serie"},{key:"titular",label:"Titular"},{key:"rfc",label:"RFC"},{key:"tipo",label:"Tipo",getValue:a=>b[a.tipo]||a.tipo},{key:"fecha_vigencia_inicio",label:"Fecha Inicio"},{key:"fecha_vigencia_fin",label:"Fecha Fin"},{key:"estado",label:"Estado",getValue:a=>_[a.estado]?.label||a.estado},{key:"emisor",label:"Emisor"},{key:"notas",label:"Notas"}],"certificados_efirma")},U=r.useMemo(()=>[{key:"numero_serie",label:"Numero de Serie",width:"160px"},{key:"titular",label:"Titular"},{key:"rfc",label:"RFC",width:"140px"},{key:"tipo",label:"Tipo",width:"160px",render:e=>b[e]||e},{key:"fecha_vigencia_inicio",label:"Fecha Inicio",width:"120px"},{key:"fecha_vigencia_fin",label:"Fecha Fin",width:"120px"},{key:"estado",label:"Estado",width:"120px",render:e=>{const a=_[e]||{label:e,variant:"default"};return t.jsx(ie,{variant:a.variant,children:a.label})}},{key:"id",label:"Acciones",width:"140px",sortable:!1,render:(e,a)=>t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{onClick:o=>{o.stopPropagation(),k(a)},className:"text-xs text-primary hover:text-primary-light transition-colors cursor-pointer",children:"Editar"}),f&&t.jsx("button",{onClick:o=>{o.stopPropagation(),L(a)},className:"text-xs text-danger hover:text-danger/80 transition-colors cursor-pointer",children:"Eliminar"})]})}],[f]),S=y.isPending||N.isPending;return t.jsxs("div",{children:[t.jsxs("div",{className:"mb-6",children:[t.jsx("h1",{className:"text-xl font-bold text-text-primary",children:"e.firma / FIEL"}),t.jsx("p",{className:"text-sm text-text-muted mt-1",children:"Gestion de certificados de firma electronica y documentos firmados"})]}),A?t.jsx("div",{className:"flex items-center justify-center py-16 text-text-muted text-sm",children:"Cargando resumen de e.firma..."}):t.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6",children:V.map(e=>t.jsxs("div",{className:"bg-white rounded-lg card-shadow p-4",children:[t.jsx("p",{className:"text-xs text-text-muted uppercase tracking-wide mb-1",children:e.label}),t.jsx("p",{className:`text-lg font-bold ${e.color}`,children:e.value})]},e.label))}),t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsxs("h2",{className:"text-sm font-semibold text-text-secondary",children:["Certificados",t.jsxs("span",{className:"ml-2 text-text-muted font-normal",children:["(",h.length," registros)"]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(u,{onClick:$,variant:"outline-primary",size:"sm",children:"Exportar Excel"}),f&&t.jsx(u,{onClick:B,size:"sm",children:"+ Nuevo Certificado"})]})]}),R?t.jsx("div",{className:"flex items-center justify-center py-16 text-text-muted text-sm",children:"Cargando certificados..."}):t.jsx(te,{columns:U,data:h,onRowClick:k,rowClassName:e=>q(e)?"bg-amber-50":""}),t.jsx(ae,{open:I,onClose:()=>c(!1),title:d?"Editar Certificado":"Nuevo Certificado",size:"lg",children:t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsx(l,{label:"Numero de Serie",value:i.numero_serie,onChange:e=>s("numero_serie",e.target.value),placeholder:"Ej. 30001000000400002434",required:!0}),t.jsx(l,{label:"RFC",value:i.rfc,onChange:e=>s("rfc",e.target.value),placeholder:"RFC del titular",required:!0})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsx(l,{label:"Titular",value:i.titular,onChange:e=>s("titular",e.target.value),placeholder:"Nombre del titular del certificado",required:!0}),t.jsx(F,{label:"Tipo",value:i.tipo,onChange:e=>s("tipo",e.target.value),options:P,placeholder:"-- Seleccione tipo --",required:!0})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsx(l,{label:"Fecha de Vigencia Inicio",type:"date",value:i.fecha_vigencia_inicio,onChange:e=>s("fecha_vigencia_inicio",e.target.value),required:!0}),t.jsx(l,{label:"Fecha de Vigencia Fin",type:"date",value:i.fecha_vigencia_fin,onChange:e=>s("fecha_vigencia_fin",e.target.value),required:!0})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsx(F,{label:"Estado",value:i.estado,onChange:e=>s("estado",e.target.value),options:w,placeholder:"-- Seleccione estado --",required:!0}),t.jsx(l,{label:"Emisor",value:i.emisor,onChange:e=>s("emisor",e.target.value),placeholder:"Ej. SAT, Autoridad Certificadora"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Notas"}),t.jsx("textarea",{value:i.notas,onChange:e=>s("notas",e.target.value),placeholder:"Observaciones o notas adicionales",rows:3,className:"w-full h-auto rounded-md border border-border text-[0.9375rem] px-3 py-2 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda"})]}),t.jsxs("div",{className:"flex justify-end gap-3 pt-2 border-t border-border",children:[t.jsx(u,{variant:"ghost",onClick:()=>c(!1),disabled:S,children:"Cancelar"}),t.jsx(u,{onClick:z,loading:S,disabled:!i.numero_serie.trim()||!i.titular.trim()||!i.rfc.trim()||!i.fecha_vigencia_fin,children:d?"Guardar cambios":"Crear Certificado"})]})]})}),t.jsx(se,{open:M,onClose:()=>{p(!1),g(null)},onConfirm:G,title:"Eliminar certificado",message:m?`Â¿Esta seguro de eliminar el certificado con numero de serie "${m.numero_serie||""}"? Esta accion no se puede deshacer.`:"",confirmText:"Eliminar",loading:E.isPending})]})}export{je as default};
