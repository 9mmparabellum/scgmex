import{u as se,y as ie,j as t}from"./index-xuYioy8Y.js";import{b as s}from"./vendor-DEA9Ikep.js";import{a as le,b as re,c as ne}from"./useCrud-BZqSYSww.js";import{b as ce}from"./useCFDI-XVMNfgm4.js";import{O as b,P as g,U,Q as T}from"./constants-B0qHiDNt.js";import{D as de}from"./DataTable-CoGr0iSJ.js";import{M as ue}from"./Modal-BawsBw69.js";import{B as x}from"./Button-CQM7GO5t.js";import{I as l}from"./Input-C6_ozmNh.js";import{S as f}from"./Select-CHQpqBAE.js";import{B as me}from"./Badge-DX5pclE5.js";import{C as pe}from"./ConfirmDialog-BrOOKlKS.js";import{e as be}from"./exportHelpers-CvXmrB4L.js";import"./supabase-DANKYb0E.js";import"./export-t5FFX7R_.js";const N=h=>new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(h||0),D=()=>new Date().toISOString().slice(0,10),R={uuid:"",fecha_recepcion:D(),emisor_rfc:"",emisor_nombre:"",uso_cfdi:"G03",tipo:"ingreso",metodo_pago:"PUE",subtotal:"",iva:"",total:"",estado:"vigente",fecha_pago:"",notas:""};function Se(){const{entePublico:h,ejercicioFiscal:P,rol:A}=se(),v=ie(A,"cfdi"),[V,r]=s.useState(!1),[c,F]=s.useState(null),[a,j]=s.useState({...R}),[q,_]=s.useState(!1),[d,C]=s.useState(null),[u,$]=s.useState(""),[m,z]=s.useState(""),{data:E=[],isLoading:B}=ce(),k=le("cfdi_recibido"),I=re("cfdi_recibido"),S=ne("cfdi_recibido"),G=s.useMemo(()=>Object.entries(b).map(([e,o])=>({value:e,label:o})),[]),X=s.useMemo(()=>Object.entries(g).map(([e,{label:o}])=>({value:e,label:o})),[]),L=s.useMemo(()=>Object.entries(U).map(([e,o])=>({value:e,label:`${e} - ${o}`})),[]),Q=s.useMemo(()=>Object.entries(T).map(([e,o])=>({value:e,label:`${e} - ${o}`})),[]),w=s.useMemo(()=>[{value:"",label:"Todos los tipos"},...Object.entries(b).map(([e,o])=>({value:e,label:o}))],[]),H=s.useMemo(()=>[{value:"",label:"Todos los estados"},...Object.entries(g).map(([e,{label:o}])=>({value:e,label:o}))],[]),y=s.useMemo(()=>{let e=E;return u&&(e=e.filter(o=>o.tipo===u)),m&&(e=e.filter(o=>o.estado===m)),e},[E,u,m]),i=(e,o)=>j(n=>{const p={...n,[e]:o};if(e==="subtotal"||e==="iva"){const oe=Number(e==="subtotal"?o:p.subtotal)||0,ae=Number(e==="iva"?o:p.iva)||0;p.total=(oe+ae).toFixed(2)}return p}),J=e=>e?e.length>12?e.slice(0,8)+"...":e:"",K=()=>{F(null),j({...R,fecha_recepcion:D()}),r(!0)},O=e=>{F(e),j({uuid:e.uuid??"",fecha_recepcion:e.fecha_recepcion??D(),emisor_rfc:e.emisor_rfc??"",emisor_nombre:e.emisor_nombre??"",uso_cfdi:e.uso_cfdi??"G03",tipo:e.tipo??"ingreso",metodo_pago:e.metodo_pago??"PUE",subtotal:e.subtotal??"",iva:e.iva??"",total:e.total??"",estado:e.estado??"vigente",fecha_pago:e.fecha_pago??"",notas:e.notas??""}),r(!0)},W=async()=>{const e={...a,ente_id:h?.id,ejercicio_id:P?.id,subtotal:Number(a.subtotal)||0,iva:Number(a.iva)||0,total:Number(a.total)||0,fecha_pago:a.fecha_pago||null};c?await I.mutateAsync({id:c.id,...e}):await k.mutateAsync(e),r(!1)},Y=e=>{C(e),_(!0)},Z=async()=>{d&&await S.mutateAsync(d.id),_(!1),C(null)},ee=()=>{be(y,[{key:"uuid",label:"UUID"},{key:"fecha_recepcion",label:"Fecha Recepcion"},{key:"emisor_rfc",label:"Emisor RFC"},{key:"emisor_nombre",label:"Emisor Nombre"},{key:"uso_cfdi",label:"Uso CFDI",getValue:o=>U[o.uso_cfdi]||o.uso_cfdi},{key:"tipo",label:"Tipo",getValue:o=>b[o.tipo]||o.tipo},{key:"metodo_pago",label:"Metodo Pago",getValue:o=>T[o.metodo_pago]||o.metodo_pago},{key:"subtotal",label:"Subtotal",getValue:o=>Number(o.subtotal||0)},{key:"iva",label:"IVA",getValue:o=>Number(o.iva||0)},{key:"total",label:"Total",getValue:o=>Number(o.total||0)},{key:"estado",label:"Estado",getValue:o=>g[o.estado]?.label||o.estado},{key:"fecha_pago",label:"Fecha Pago"},{key:"notas",label:"Notas"}],"cfdi_recibidos")},te=s.useMemo(()=>[{key:"uuid",label:"UUID",width:"120px",render:e=>t.jsx("span",{title:e||"",children:J(e)})},{key:"fecha_recepcion",label:"Fecha Recepcion",width:"140px"},{key:"emisor_rfc",label:"Emisor RFC",width:"140px"},{key:"emisor_nombre",label:"Emisor Nombre"},{key:"tipo",label:"Tipo",width:"100px",render:e=>b[e]||e},{key:"subtotal",label:"Subtotal",width:"130px",render:e=>t.jsx("span",{className:"text-right block tabular-nums",children:N(e)})},{key:"iva",label:"IVA",width:"110px",render:e=>t.jsx("span",{className:"text-right block tabular-nums",children:N(e)})},{key:"total",label:"Total",width:"140px",render:e=>t.jsx("span",{className:"text-right block tabular-nums font-bold",children:N(e)})},{key:"estado",label:"Estado",width:"120px",render:e=>{const o=g[e]||{label:e,variant:"default"};return t.jsx(me,{variant:o.variant,children:o.label})}},{key:"id",label:"Acciones",width:"140px",sortable:!1,render:(e,o)=>t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{onClick:n=>{n.stopPropagation(),O(o)},className:"text-xs text-primary hover:text-primary-light transition-colors cursor-pointer",children:"Editar"}),v&&t.jsx("button",{onClick:n=>{n.stopPropagation(),Y(o)},className:"text-xs text-danger hover:text-danger/80 transition-colors cursor-pointer",children:"Eliminar"})]})}],[v]),M=k.isPending||I.isPending;return t.jsxs("div",{children:[t.jsxs("div",{className:"mb-6",children:[t.jsx("h1",{className:"text-xl font-bold text-text-primary",children:"CFDI Recibidos"}),t.jsx("p",{className:"text-sm text-text-muted mt-1",children:"Comprobantes fiscales digitales recibidos de proveedores y terceros"})]}),t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsxs("div",{className:"flex items-center gap-4",children:[t.jsxs("h2",{className:"text-sm font-semibold text-text-secondary",children:["Recibidos",t.jsxs("span",{className:"ml-2 text-text-muted font-normal",children:["(",y.length," registros)"]})]}),t.jsx("select",{value:u,onChange:e=>$(e.target.value),className:"h-[38px] rounded-md border border-border text-[0.9375rem] px-3 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda",children:w.map(e=>t.jsx("option",{value:e.value,children:e.label},e.value))}),t.jsx("select",{value:m,onChange:e=>z(e.target.value),className:"h-[38px] rounded-md border border-border text-[0.9375rem] px-3 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda",children:H.map(e=>t.jsx("option",{value:e.value,children:e.label},e.value))})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(x,{onClick:ee,variant:"outline-primary",size:"sm",children:"Exportar Excel"}),v&&t.jsx(x,{onClick:K,size:"sm",children:"+ Nuevo CFDI"})]})]}),B?t.jsx("div",{className:"flex items-center justify-center py-16 text-text-muted text-sm",children:"Cargando CFDI recibidos..."}):t.jsx(de,{columns:te,data:y,onRowClick:O}),t.jsx(ue,{open:V,onClose:()=>r(!1),title:c?"Editar CFDI Recibido":"Nuevo CFDI Recibido",size:"lg",children:t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsx(l,{label:"UUID",value:a.uuid,onChange:e=>i("uuid",e.target.value),placeholder:"UUID del comprobante",required:!0}),t.jsx(l,{label:"Fecha de Recepcion",type:"date",value:a.fecha_recepcion,onChange:e=>i("fecha_recepcion",e.target.value),required:!0})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsx(l,{label:"Emisor RFC",value:a.emisor_rfc,onChange:e=>i("emisor_rfc",e.target.value),placeholder:"RFC del emisor",required:!0}),t.jsx(l,{label:"Emisor Nombre",value:a.emisor_nombre,onChange:e=>i("emisor_nombre",e.target.value),placeholder:"Nombre o razon social del emisor",required:!0})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsx(f,{label:"Tipo",value:a.tipo,onChange:e=>i("tipo",e.target.value),options:G,placeholder:"-- Seleccione tipo --",required:!0}),t.jsx(f,{label:"Uso CFDI",value:a.uso_cfdi,onChange:e=>i("uso_cfdi",e.target.value),options:L,placeholder:"-- Seleccione uso CFDI --",required:!0})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsx(f,{label:"Metodo de Pago",value:a.metodo_pago,onChange:e=>i("metodo_pago",e.target.value),options:Q,placeholder:"-- Seleccione metodo de pago --",required:!0}),t.jsx(f,{label:"Estado",value:a.estado,onChange:e=>i("estado",e.target.value),options:X,placeholder:"-- Seleccione estado --",required:!0})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[t.jsx(l,{label:"Subtotal",type:"number",value:a.subtotal,onChange:e=>i("subtotal",e.target.value),placeholder:"0.00",required:!0}),t.jsx(l,{label:"IVA",type:"number",value:a.iva,onChange:e=>i("iva",e.target.value),placeholder:"0.00"}),t.jsx(l,{label:"Total",type:"number",value:a.total,onChange:e=>i("total",e.target.value),placeholder:"0.00",disabled:!0})]}),t.jsx(l,{label:"Fecha de Pago (opcional)",type:"date",value:a.fecha_pago,onChange:e=>i("fecha_pago",e.target.value)}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Notas"}),t.jsx("textarea",{value:a.notas,onChange:e=>i("notas",e.target.value),placeholder:"Observaciones o notas adicionales",rows:3,className:"w-full h-auto rounded-md border border-border text-[0.9375rem] px-3 py-2 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda"})]}),t.jsxs("div",{className:"flex justify-end gap-3 pt-2 border-t border-border",children:[t.jsx(x,{variant:"ghost",onClick:()=>r(!1),disabled:M,children:"Cancelar"}),t.jsx(x,{onClick:W,loading:M,disabled:!a.uuid.trim()||!a.emisor_rfc.trim()||!a.emisor_nombre.trim(),children:c?"Guardar cambios":"Crear CFDI"})]})]})}),t.jsx(pe,{open:q,onClose:()=>{_(!1),C(null)},onConfirm:Z,title:"Eliminar CFDI recibido",message:d?`Â¿Esta seguro de eliminar el CFDI recibido con UUID "${d.uuid?.slice(0,8)||""}..."? Esta accion no se puede deshacer.`:"",confirmText:"Eliminar",loading:S.isPending})]})}export{Se as default};
