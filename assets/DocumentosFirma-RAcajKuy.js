import{u as W,y as X,j as o}from"./index-xuYioy8Y.js";import{b as i}from"./vendor-DEA9Ikep.js";import{a as ee,b as oe,c as te}from"./useCrud-BZqSYSww.js";import{b as ae,u as ie}from"./useEFirma--Ic7l-uu.js";import{Y as u,Z as f}from"./constants-B0qHiDNt.js";import{D as se}from"./DataTable-CoGr0iSJ.js";import{M as re}from"./Modal-BawsBw69.js";import{B as p}from"./Button-CQM7GO5t.js";import{I as v}from"./Input-C6_ozmNh.js";import{S as _}from"./Select-CHQpqBAE.js";import{B as ne}from"./Badge-DX5pclE5.js";import{C as le}from"./ConfirmDialog-BrOOKlKS.js";import{e as de}from"./exportHelpers-CvXmrB4L.js";import"./supabase-DANKYb0E.js";import"./export-t5FFX7R_.js";const y=()=>new Date().toISOString().slice(0,10),T={folio:"",tipo_documento:"poliza",descripcion:"",certificado_id:"",firmante:"",fecha_firma:y(),cadena_original:"",sello_digital:"",estado:"pendiente",notas:""};function ke(){const{entePublico:w,ejercicioFiscal:A,rol:P}=W(),x=X(P,"seguridad"),[I,r]=i.useState(!1),[l,C]=i.useState(null),[a,g]=i.useState({...T}),[q,h]=i.useState(!1),[d,b]=i.useState(null),[c,z]=i.useState(""),[m,B]=i.useState(""),{data:N=[],isLoading:R}=ae(),{data:k=[]}=ie(),D=ee("documento_firmado"),E=oe("documento_firmado"),F=te("documento_firmado"),V=i.useMemo(()=>Object.entries(u).map(([e,t])=>({value:e,label:t})),[]),$=i.useMemo(()=>Object.entries(f).map(([e,{label:t}])=>({value:e,label:t})),[]),U=i.useMemo(()=>k.map(e=>({value:e.id,label:`${e.numero_serie} - ${e.titular}`})),[k]),G=i.useMemo(()=>[{value:"",label:"Todos los tipos"},...Object.entries(u).map(([e,t])=>({value:e,label:t}))],[]),L=i.useMemo(()=>[{value:"",label:"Todos los estados"},...Object.entries(f).map(([e,{label:t}])=>({value:e,label:t}))],[]),j=i.useMemo(()=>{let e=N;return c&&(e=e.filter(t=>t.tipo_documento===c)),m&&(e=e.filter(t=>t.estado===m)),e},[N,c,m]),s=(e,t)=>g(n=>({...n,[e]:t})),O=(e,t=40)=>e?e.length>t?e.slice(0,t)+"...":e:"",Y=()=>{C(null),g({...T,fecha_firma:y()}),r(!0)},S=e=>{C(e),g({folio:e.folio??"",tipo_documento:e.tipo_documento??"poliza",descripcion:e.descripcion??"",certificado_id:e.certificado_id??"",firmante:e.firmante??"",fecha_firma:e.fecha_firma??y(),cadena_original:e.cadena_original??"",sello_digital:e.sello_digital??"",estado:e.estado??"pendiente",notas:e.notas??""}),r(!0)},Z=async()=>{const e={...a,ente_id:w?.id,ejercicio_id:A?.id,certificado_id:a.certificado_id||null};l?await E.mutateAsync({id:l.id,...e}):await D.mutateAsync(e),r(!1)},H=e=>{b(e),h(!0)},J=async()=>{d&&await F.mutateAsync(d.id),h(!1),b(null)},K=()=>{de(j,[{key:"folio",label:"Folio"},{key:"tipo_documento",label:"Tipo Documento",getValue:t=>u[t.tipo_documento]||t.tipo_documento},{key:"descripcion",label:"Descripcion"},{key:"certificado_id",label:"Certificado",getValue:t=>t.certificado?.numero_serie||""},{key:"firmante",label:"Firmante"},{key:"fecha_firma",label:"Fecha Firma"},{key:"cadena_original",label:"Cadena Original"},{key:"sello_digital",label:"Sello Digital"},{key:"estado",label:"Estado",getValue:t=>f[t.estado]?.label||t.estado},{key:"notas",label:"Notas"}],"documentos_firmados")},Q=i.useMemo(()=>[{key:"folio",label:"Folio",width:"100px"},{key:"tipo_documento",label:"Tipo Documento",width:"150px",render:e=>u[e]||e},{key:"descripcion",label:"Descripcion",render:e=>o.jsx("span",{title:e||"",children:O(e)})},{key:"certificado",label:"Certificado",width:"160px",render:e=>e?.numero_serie||"-"},{key:"firmante",label:"Firmante",width:"150px"},{key:"fecha_firma",label:"Fecha Firma",width:"120px"},{key:"cadena_original",label:"Cadena Original",width:"160px",render:e=>o.jsx("span",{title:e||"",className:"font-mono text-xs",children:O(e,24)})},{key:"estado",label:"Estado",width:"120px",render:e=>{const t=f[e]||{label:e,variant:"default"};return o.jsx(ne,{variant:t.variant,children:t.label})}},{key:"id",label:"Acciones",width:"140px",sortable:!1,render:(e,t)=>o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx("button",{onClick:n=>{n.stopPropagation(),S(t)},className:"text-xs text-primary hover:text-primary-light transition-colors cursor-pointer",children:"Editar"}),x&&o.jsx("button",{onClick:n=>{n.stopPropagation(),H(t)},className:"text-xs text-danger hover:text-danger/80 transition-colors cursor-pointer",children:"Eliminar"})]})}],[x]),M=D.isPending||E.isPending;return o.jsxs("div",{children:[o.jsxs("div",{className:"mb-6",children:[o.jsx("h1",{className:"text-xl font-bold text-text-primary",children:"Documentos Firmados"}),o.jsx("p",{className:"text-sm text-text-muted mt-1",children:"Control de documentos firmados electronicamente"})]}),o.jsxs("div",{className:"flex items-center justify-between mb-4",children:[o.jsxs("div",{className:"flex items-center gap-4",children:[o.jsxs("h2",{className:"text-sm font-semibold text-text-secondary",children:["Documentos",o.jsxs("span",{className:"ml-2 text-text-muted font-normal",children:["(",j.length," registros)"]})]}),o.jsx("select",{value:c,onChange:e=>z(e.target.value),className:"h-[38px] rounded-md border border-border text-[0.9375rem] px-3 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda",children:G.map(e=>o.jsx("option",{value:e.value,children:e.label},e.value))}),o.jsx("select",{value:m,onChange:e=>B(e.target.value),className:"h-[38px] rounded-md border border-border text-[0.9375rem] px-3 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda",children:L.map(e=>o.jsx("option",{value:e.value,children:e.label},e.value))})]}),o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx(p,{onClick:K,variant:"outline-primary",size:"sm",children:"Exportar Excel"}),x&&o.jsx(p,{onClick:Y,size:"sm",children:"+ Nuevo Documento"})]})]}),R?o.jsx("div",{className:"flex items-center justify-center py-16 text-text-muted text-sm",children:"Cargando documentos firmados..."}):o.jsx(se,{columns:Q,data:j,onRowClick:S}),o.jsx(re,{open:I,onClose:()=>r(!1),title:l?"Editar Documento Firmado":"Nuevo Documento Firmado",size:"lg",children:o.jsxs("div",{className:"space-y-4",children:[o.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[o.jsx(v,{label:"Folio",value:a.folio,onChange:e=>s("folio",e.target.value),placeholder:"Ej. DOC-001",required:!0}),o.jsx(_,{label:"Tipo de Documento",value:a.tipo_documento,onChange:e=>s("tipo_documento",e.target.value),options:V,placeholder:"-- Seleccione tipo --",required:!0})]}),o.jsxs("div",{children:[o.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Descripcion"}),o.jsx("textarea",{value:a.descripcion,onChange:e=>s("descripcion",e.target.value),placeholder:"Descripcion del documento a firmar",rows:2,className:"w-full h-auto rounded-md border border-border text-[0.9375rem] px-3 py-2 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda"})]}),o.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[o.jsx(_,{label:"Certificado",value:a.certificado_id,onChange:e=>s("certificado_id",e.target.value),options:U,placeholder:"-- Seleccione certificado --"}),o.jsx(v,{label:"Firmante",value:a.firmante,onChange:e=>s("firmante",e.target.value),placeholder:"Nombre del firmante",required:!0})]}),o.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[o.jsx(v,{label:"Fecha de Firma",type:"date",value:a.fecha_firma,onChange:e=>s("fecha_firma",e.target.value),required:!0}),o.jsx(_,{label:"Estado",value:a.estado,onChange:e=>s("estado",e.target.value),options:$,placeholder:"-- Seleccione estado --",required:!0})]}),o.jsxs("div",{children:[o.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Cadena Original"}),o.jsx("textarea",{value:a.cadena_original,onChange:e=>s("cadena_original",e.target.value),placeholder:"||version|uuid|fecha|...",rows:3,className:"w-full h-auto rounded-md border border-border text-[0.9375rem] font-mono text-xs px-3 py-2 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda"})]}),o.jsxs("div",{children:[o.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Sello Digital"}),o.jsx("textarea",{value:a.sello_digital,onChange:e=>s("sello_digital",e.target.value),placeholder:"Base64 del sello digital",rows:3,className:"w-full h-auto rounded-md border border-border text-[0.9375rem] font-mono text-xs px-3 py-2 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda"})]}),o.jsxs("div",{children:[o.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Notas"}),o.jsx("textarea",{value:a.notas,onChange:e=>s("notas",e.target.value),placeholder:"Observaciones o notas adicionales",rows:2,className:"w-full h-auto rounded-md border border-border text-[0.9375rem] px-3 py-2 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda"})]}),o.jsxs("div",{className:"flex justify-end gap-3 pt-2 border-t border-border",children:[o.jsx(p,{variant:"ghost",onClick:()=>r(!1),disabled:M,children:"Cancelar"}),o.jsx(p,{onClick:Z,loading:M,disabled:!a.folio.trim()||!a.firmante.trim(),children:l?"Guardar cambios":"Crear Documento"})]})]})}),o.jsx(le,{open:q,onClose:()=>{h(!1),b(null)},onConfirm:J,title:"Eliminar documento firmado",message:d?`Â¿Esta seguro de eliminar el documento firmado "${d.folio||""}"? Esta accion no se puede deshacer.`:"",confirmText:"Eliminar",loading:F.isPending})]})}export{ke as default};
