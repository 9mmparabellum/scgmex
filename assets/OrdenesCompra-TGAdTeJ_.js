import{u as X,j as a}from"./index-xuYioy8Y.js";import{b as s}from"./vendor-DEA9Ikep.js";import{a as L,b as U,c as H}from"./useCrud-BZqSYSww.js";import{c as J,a as K}from"./useAdquisiciones-BXXWibzH.js";import{D as Q}from"./DataTable-CoGr0iSJ.js";import{M as W}from"./Modal-BawsBw69.js";import{B as m}from"./Button-CQM7GO5t.js";import{I as n}from"./Input-C6_ozmNh.js";import{S}from"./Select-CHQpqBAE.js";import{B as Y}from"./Badge-DX5pclE5.js";import{C as Z}from"./ConfirmDialog-BrOOKlKS.js";import{e as ee}from"./exportHelpers-CvXmrB4L.js";import"./supabase-DANKYb0E.js";import"./export-t5FFX7R_.js";const h=u=>new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(u||0),v={borrador:{label:"Borrador",variant:"default"},enviada:{label:"Enviada",variant:"info"},recibida:{label:"Recibida",variant:"warning"},parcial:{label:"Parcial",variant:"warning"},completa:{label:"Completa",variant:"success"},cancelada:{label:"Cancelada",variant:"danger"}},f=()=>new Date().toISOString().slice(0,10),P={numero:"",fecha:f(),proveedor_id:"",subtotal:"",iva:"",total:"",estado:"borrador",condiciones_pago:"",fecha_entrega:""};function ge(){const{entePublico:u,ejercicioFiscal:M}=X(),[A,i]=s.useState(!1),[d,j]=s.useState(null),[o,p]=s.useState({...P}),[D,b]=s.useState(!1),[c,g]=s.useState(null),{data:x=[],isLoading:F}=J(),{data:y=[]}=K(),C=L("orden_compra"),N=U("orden_compra"),_=H("orden_compra"),T=s.useMemo(()=>y.filter(e=>e.activo!==!1).map(e=>({value:e.id,label:`${e.razon_social} (${e.rfc})`})),[y]),V=s.useMemo(()=>Object.entries(v).map(([e,{label:t}])=>({value:e,label:t})),[]),r=(e,t)=>{p(l=>{const O={...l,[e]:t};if(e==="subtotal"||e==="iva"){const $=Number(e==="subtotal"?t:l.subtotal)||0,G=Number(e==="iva"?t:l.iva)||0;O.total=($+G).toFixed(2)}return O})},I=()=>{j(null),p({...P,fecha:f()}),i(!0)},E=e=>{j(e),p({numero:e.numero??"",fecha:e.fecha??f(),proveedor_id:e.proveedor_id??"",subtotal:e.subtotal??"",iva:e.iva??"",total:e.total??"",estado:e.estado??"borrador",condiciones_pago:e.condiciones_pago??"",fecha_entrega:e.fecha_entrega??""}),i(!0)},q=async()=>{const e={...o,ente_id:u?.id,ejercicio_id:M?.id,subtotal:Number(o.subtotal)||0,iva:Number(o.iva)||0,total:Number(o.total)||0,fecha_entrega:o.fecha_entrega||null};d?await N.mutateAsync({id:d.id,...e}):await C.mutateAsync(e),i(!1)},w=e=>{g(e),b(!0)},z=async()=>{c&&await _.mutateAsync(c.id),b(!1),g(null)},R=()=>{ee(x,[{key:"numero",label:"Numero"},{key:"fecha",label:"Fecha"},{key:"proveedor",label:"Proveedor",getValue:t=>t.proveedor?.razon_social||""},{key:"subtotal",label:"Subtotal",getValue:t=>Number(t.subtotal||0)},{key:"iva",label:"IVA",getValue:t=>Number(t.iva||0)},{key:"total",label:"Total",getValue:t=>Number(t.total||0)},{key:"estado",label:"Estado",getValue:t=>v[t.estado]?.label||t.estado},{key:"condiciones_pago",label:"Condiciones de Pago"},{key:"fecha_entrega",label:"Fecha Entrega"}],"ordenes_compra")},B=s.useMemo(()=>[{key:"numero",label:"Numero",width:"100px"},{key:"fecha",label:"Fecha",width:"110px"},{key:"proveedor",label:"Proveedor",render:e=>e?.razon_social||""},{key:"subtotal",label:"Subtotal",width:"130px",render:e=>a.jsx("span",{className:"text-right block tabular-nums",children:h(e)})},{key:"iva",label:"IVA",width:"120px",render:e=>a.jsx("span",{className:"text-right block tabular-nums",children:h(e)})},{key:"total",label:"Total",width:"140px",render:e=>a.jsx("span",{className:"text-right block tabular-nums font-semibold",children:h(e)})},{key:"estado",label:"Estado",width:"120px",render:e=>{const t=v[e]||{label:e,variant:"default"};return a.jsx(Y,{variant:t.variant,children:t.label})}},{key:"fecha_entrega",label:"Entrega",width:"110px"},{key:"id",label:"Acciones",width:"140px",sortable:!1,render:(e,t)=>a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("button",{onClick:l=>{l.stopPropagation(),E(t)},className:"text-xs text-primary hover:text-primary-light transition-colors cursor-pointer",children:"Editar"}),a.jsx("button",{onClick:l=>{l.stopPropagation(),w(t)},className:"text-xs text-danger hover:text-danger/80 transition-colors cursor-pointer",children:"Eliminar"})]})}],[]),k=C.isPending||N.isPending;return a.jsxs("div",{children:[a.jsxs("div",{className:"mb-6",children:[a.jsx("h1",{className:"text-xl font-bold text-text-primary",children:"Ordenes de Compra"}),a.jsx("p",{className:"text-sm text-text-muted mt-1",children:"Generacion y seguimiento de ordenes de compra del ejercicio fiscal"})]}),a.jsxs("div",{className:"flex items-center justify-between mb-4",children:[a.jsxs("h2",{className:"text-sm font-semibold text-text-secondary",children:["Ordenes de Compra",a.jsxs("span",{className:"ml-2 text-text-muted font-normal",children:["(",x.length," registros)"]})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(m,{onClick:R,variant:"outline-primary",size:"sm",children:"Exportar Excel"}),a.jsx(m,{onClick:I,size:"sm",children:"+ Nueva Orden"})]})]}),F?a.jsx("div",{className:"flex items-center justify-center py-16 text-text-muted text-sm",children:"Cargando ordenes de compra..."}):a.jsx(Q,{columns:B,data:x,onRowClick:E}),a.jsx(W,{open:A,onClose:()=>i(!1),title:d?"Editar Orden de Compra":"Nueva Orden de Compra",size:"lg",children:a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[a.jsx(n,{label:"Numero",value:o.numero,onChange:e=>r("numero",e.target.value),placeholder:"Ej. OC-001",required:!0}),a.jsx(n,{label:"Fecha",type:"date",value:o.fecha,onChange:e=>r("fecha",e.target.value),required:!0})]}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[a.jsx(S,{label:"Proveedor",value:o.proveedor_id,onChange:e=>r("proveedor_id",e.target.value),options:T,placeholder:"-- Seleccione proveedor --",required:!0}),a.jsx(S,{label:"Estado",value:o.estado,onChange:e=>r("estado",e.target.value),options:V,placeholder:"-- Seleccione estado --",required:!0})]}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[a.jsx(n,{label:"Subtotal",type:"number",value:o.subtotal,onChange:e=>r("subtotal",e.target.value),placeholder:"0.00",required:!0}),a.jsx(n,{label:"IVA",type:"number",value:o.iva,onChange:e=>r("iva",e.target.value),placeholder:"0.00",required:!0}),a.jsx(n,{label:"Total",type:"number",value:o.total,onChange:e=>r("total",e.target.value),placeholder:"0.00",disabled:!0})]}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[a.jsx(n,{label:"Condiciones de Pago",value:o.condiciones_pago,onChange:e=>r("condiciones_pago",e.target.value),placeholder:"Ej. 30 dias, contado, etc."}),a.jsx(n,{label:"Fecha de Entrega",type:"date",value:o.fecha_entrega,onChange:e=>r("fecha_entrega",e.target.value)})]}),a.jsxs("div",{className:"flex justify-end gap-3 pt-2 border-t border-border",children:[a.jsx(m,{variant:"ghost",onClick:()=>i(!1),disabled:k,children:"Cancelar"}),a.jsx(m,{onClick:q,loading:k,disabled:!o.numero.trim()||!o.proveedor_id,children:d?"Guardar cambios":"Crear orden"})]})]})}),a.jsx(Z,{open:D,onClose:()=>{b(!1),g(null)},onConfirm:z,title:"Eliminar orden de compra",message:c?`Â¿Esta seguro de eliminar la orden "${c.numero}"? Esta accion no se puede deshacer.`:"",confirmText:"Eliminar",loading:_.isPending})]})}export{ge as default};
