import{u as J,A as K,j as o}from"./index-w8y8owqO.js";import{b as r}from"./vendor-DEA9Ikep.js";import{c as Q,a as W}from"./useRecaudacion-B-QHPcQN.js";import{useCreate as Y,useUpdate as Z,useRemove as ee}from"./useCrud-BtFPgtI3.js";import{B as j,G as u}from"./constants-CX_We7cr.js";import{D as oe}from"./DataTable-BSU7FwdU.js";import{M as te}from"./Modal-BIIwL78L.js";import{B as b}from"./Button-BNgFL-Nv.js";import{I as i}from"./Input-pbRyI1ph.js";import{S as C}from"./Select-BDMENQev.js";import{B as ae}from"./Badge-CBnEW2x0.js";import{C as re}from"./ConfirmDialog-CEB8zrmM.js";import{e as se}from"./exportHelpers-CvXmrB4L.js";import"./supabase-DANKYb0E.js";import"./export-t5FFX7R_.js";const ne=p=>new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(p||0),N=()=>new Date().toISOString().slice(0,10),P={contribuyente_id:"",concepto:"",monto:"",forma_pago:"efectivo",referencia:"",fecha:N(),folio_recibo:"",estado:"pendiente",notas:""};function Ce(){const{entePublico:p,ejercicioFiscal:R,rol:A}=J(),f=K(A,"recaudacion"),[D,n]=r.useState(!1),[c,_]=r.useState(null),[a,x]=r.useState({...P}),[q,g]=r.useState(!1),[d,h]=r.useState(null),[m,B]=r.useState(""),{data:y=[],isLoading:T}=Q(),{data:k=[]}=W(),E=Y("cobro"),M=Z("cobro"),S=ee("cobro"),V=r.useMemo(()=>k.map(e=>({value:e.id,label:`${e.nombre} (${e.rfc})`})),[k]),w=r.useMemo(()=>Object.entries(j).map(([e,t])=>({value:e,label:t})),[]),I=r.useMemo(()=>Object.entries(u).map(([e,{label:t}])=>({value:e,label:t})),[]),z=r.useMemo(()=>[{value:"",label:"Todos los estados"},...Object.entries(u).map(([e,{label:t}])=>({value:e,label:t}))],[]),v=r.useMemo(()=>m?y.filter(e=>e.estado===m):y,[y,m]),s=(e,t)=>x(l=>({...l,[e]:t})),G=()=>{_(null),x({...P,fecha:N()}),n(!0)},O=e=>{_(e),x({contribuyente_id:e.contribuyente_id??"",concepto:e.concepto??"",monto:e.monto??"",forma_pago:e.forma_pago??"efectivo",referencia:e.referencia??"",fecha:e.fecha??N(),folio_recibo:e.folio_recibo??"",estado:e.estado??"pendiente",notas:e.notas??""}),n(!0)},$=async()=>{const e={...a,ente_id:p?.id,ejercicio_id:R?.id,monto:Number(a.monto)||0};c?await M.mutateAsync({id:c.id,...e}):await E.mutateAsync(e),n(!1)},X=e=>{h(e),g(!0)},L=async()=>{d&&await S.mutateAsync(d.id),g(!1),h(null)},U=()=>{se(v,[{key:"folio_recibo",label:"Folio"},{key:"fecha",label:"Fecha"},{key:"contribuyente",label:"Contribuyente",getValue:t=>t.contribuyente?.nombre||""},{key:"contribuyente_rfc",label:"RFC",getValue:t=>t.contribuyente?.rfc||""},{key:"concepto",label:"Concepto"},{key:"monto",label:"Monto",getValue:t=>Number(t.monto||0)},{key:"forma_pago",label:"Forma de Pago",getValue:t=>j[t.forma_pago]||t.forma_pago},{key:"referencia",label:"Referencia"},{key:"estado",label:"Estado",getValue:t=>u[t.estado]?.label||t.estado},{key:"notas",label:"Notas"}],"cobros")},H=r.useMemo(()=>[{key:"folio_recibo",label:"Folio",width:"110px"},{key:"fecha",label:"Fecha",width:"110px"},{key:"contribuyente",label:"Contribuyente",render:e=>e?.nombre||""},{key:"concepto",label:"Concepto",width:"180px"},{key:"monto",label:"Monto",width:"140px",render:e=>o.jsx("span",{className:"text-right block tabular-nums font-semibold",children:ne(e)})},{key:"forma_pago",label:"Forma Pago",width:"130px",render:e=>j[e]||e},{key:"estado",label:"Estado",width:"120px",render:e=>{const t=u[e]||{label:e,variant:"default"};return o.jsx(ae,{variant:t.variant,children:t.label})}},{key:"id",label:"Acciones",width:"140px",sortable:!1,render:(e,t)=>o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx("button",{onClick:l=>{l.stopPropagation(),O(t)},className:"text-xs text-primary hover:text-primary-light transition-colors cursor-pointer",children:"Editar"}),f&&o.jsx("button",{onClick:l=>{l.stopPropagation(),X(t)},className:"text-xs text-danger hover:text-danger/80 transition-colors cursor-pointer",children:"Eliminar"})]})}],[f]),F=E.isPending||M.isPending;return o.jsxs("div",{children:[o.jsxs("div",{className:"mb-6",children:[o.jsx("h1",{className:"text-xl font-bold text-text-primary",children:"Cobros"}),o.jsx("p",{className:"text-sm text-text-muted mt-1",children:"Control de cobros y recaudacion del ejercicio fiscal"})]}),o.jsxs("div",{className:"flex items-center justify-between mb-4",children:[o.jsxs("div",{className:"flex items-center gap-4",children:[o.jsxs("h2",{className:"text-sm font-semibold text-text-secondary",children:["Cobros",o.jsxs("span",{className:"ml-2 text-text-muted font-normal",children:["(",v.length," registros)"]})]}),o.jsx("select",{value:m,onChange:e=>B(e.target.value),className:"h-[38px] rounded-md border border-border text-[0.9375rem] px-3 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda",children:z.map(e=>o.jsx("option",{value:e.value,children:e.label},e.value))})]}),o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx(b,{onClick:U,variant:"outline-primary",size:"sm",children:"Exportar Excel"}),f&&o.jsx(b,{onClick:G,size:"sm",children:"+ Nuevo Cobro"})]})]}),T?o.jsx("div",{className:"flex items-center justify-center py-16 text-text-muted text-sm",children:"Cargando cobros..."}):o.jsx(oe,{columns:H,data:v,onRowClick:O}),o.jsx(te,{open:D,onClose:()=>n(!1),title:c?"Editar Cobro":"Nuevo Cobro",size:"lg",children:o.jsxs("div",{className:"space-y-4",children:[o.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[o.jsx(C,{label:"Contribuyente",value:a.contribuyente_id,onChange:e=>s("contribuyente_id",e.target.value),options:V,placeholder:"-- Seleccione contribuyente --",required:!0}),o.jsx(i,{label:"Fecha",type:"date",value:a.fecha,onChange:e=>s("fecha",e.target.value),required:!0})]}),o.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[o.jsx(i,{label:"Folio de Recibo",value:a.folio_recibo,onChange:e=>s("folio_recibo",e.target.value),placeholder:"Ej. REC-001",required:!0}),o.jsx(i,{label:"Concepto",value:a.concepto,onChange:e=>s("concepto",e.target.value),placeholder:"Concepto del cobro",required:!0})]}),o.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[o.jsx(i,{label:"Monto",type:"number",value:a.monto,onChange:e=>s("monto",e.target.value),placeholder:"0.00",required:!0}),o.jsx(C,{label:"Forma de Pago",value:a.forma_pago,onChange:e=>s("forma_pago",e.target.value),options:w,placeholder:"-- Seleccione forma de pago --",required:!0}),o.jsx(C,{label:"Estado",value:a.estado,onChange:e=>s("estado",e.target.value),options:I,placeholder:"-- Seleccione estado --",required:!0})]}),o.jsx(i,{label:"Referencia",value:a.referencia,onChange:e=>s("referencia",e.target.value),placeholder:"Numero de referencia, cheque, transferencia, etc."}),o.jsxs("div",{children:[o.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Notas"}),o.jsx("textarea",{value:a.notas,onChange:e=>s("notas",e.target.value),placeholder:"Observaciones o notas adicionales",rows:3,className:"w-full h-auto rounded-md border border-border text-[0.9375rem] px-3 py-2 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda"})]}),o.jsxs("div",{className:"flex justify-end gap-3 pt-2 border-t border-border",children:[o.jsx(b,{variant:"ghost",onClick:()=>n(!1),disabled:F,children:"Cancelar"}),o.jsx(b,{onClick:$,loading:F,disabled:!a.contribuyente_id||!a.concepto.trim()||!a.folio_recibo.trim(),children:c?"Guardar cambios":"Crear cobro"})]})]})}),o.jsx(re,{open:q,onClose:()=>{g(!1),h(null)},onConfirm:L,title:"Eliminar cobro",message:d?`Â¿Esta seguro de eliminar el cobro con folio "${d.folio_recibo}"? Esta accion no se puede deshacer.`:"",confirmText:"Eliminar",loading:S.isPending})]})}export{Ce as default};
