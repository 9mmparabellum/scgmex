import{s as o,u as b,o as u,p as f,q as d}from"./index-FiQ-o0as.js";const l={sandboxUrl:"https://apisandbox.facturama.mx",productionUrl:"https://api.facturama.mx",getApiUrl:()=>"https://apisandbox.facturama.mx",getCredentials:()=>btoa("9mmparabellum:MadriZ11"),isSandbox:()=>"https://apisandbox.facturama.mx".includes("sandbox"),hasCredentials:()=>!0},j=[{key:"601",label:"General de Ley Personas Morales"},{key:"603",label:"Personas Morales con Fines no Lucrativos"},{key:"605",label:"Sueldos y Salarios"},{key:"606",label:"Arrendamiento"},{key:"608",label:"Demas Ingresos"},{key:"610",label:"Residentes en el Extranjero sin EP"},{key:"612",label:"Actividades Empresariales y Profesionales"},{key:"614",label:"Ingresos por Intereses"},{key:"616",label:"Sin Obligaciones Fiscales"},{key:"620",label:"Sociedades Cooperativas de Produccion"},{key:"621",label:"Incorporacion Fiscal"},{key:"622",label:"Actividades Agricolas, Ganaderas, Silvicolas y Pesqueras"},{key:"623",label:"Opcional para Grupos de Sociedades"},{key:"624",label:"Coordinados"},{key:"625",label:"Regimen de las Actividades Empresariales con ingresos a traves de Plataformas Tecnologicas"},{key:"626",label:"Regimen Simplificado de Confianza"}],M=[{key:"01",label:"Efectivo"},{key:"02",label:"Cheque nominativo"},{key:"03",label:"Transferencia electronica"},{key:"04",label:"Tarjeta de credito"},{key:"05",label:"Monedero electronico"},{key:"06",label:"Dinero electronico"},{key:"28",label:"Tarjeta de debito"},{key:"29",label:"Tarjeta de servicios"},{key:"99",label:"Por definir"}],O=[{key:"MXN",label:"Peso Mexicano"},{key:"USD",label:"Dolar Americano"},{key:"EUR",label:"Euro"}],U=[{key:"01",label:"Comprobante emitido con errores con relacion"},{key:"02",label:"Comprobante emitido con errores sin relacion"},{key:"03",label:"No se llevo a cabo la operacion"},{key:"04",label:"Operacion nominativa relacionada en factura global"}];async function c(e,i={}){const a=`${l.getApiUrl()}${e}`,t=l.getCredentials(),n=await fetch(a,{...i,headers:{"Content-Type":"application/json",Authorization:`Basic ${t}`,...i.headers}});if(!n.ok){const s=await n.json().catch(()=>({}));throw new Error(s.Message||s.message||`Facturama error: ${n.status}`)}return n}function y(e){return{ingreso:"I",egreso:"E",traslado:"T",nomina:"N",pago:"P"}[e]||"I"}function _(e){const i=[];return e.iva_tasa!==void 0&&i.push({Name:"IVA",Rate:Number(e.iva_tasa)||.16,Total:Number(e.iva_monto)||Number(e.precio_unitario)*Number(e.cantidad)*.16,Base:Number(e.precio_unitario)*Number(e.cantidad),IsRetention:!1}),i}function C(e){const i=Number(e.cantidad)*Number(e.precio_unitario),a=Number(e.iva_monto)||i*.16;return i+a}function p(e){return e?"02":"01"}function g(e){if(e.conceptos?.length)return e.conceptos.map(a=>{const t=_(a);return{ProductCode:a.clave_prod_serv||"01010101",UnitCode:a.clave_unidad||"ACT",Unit:a.unidad||"Actividad",Description:a.descripcion,IdentificationNumber:a.no_identificacion||"",Quantity:Number(a.cantidad)||1,UnitPrice:Number(a.precio_unitario)||0,Subtotal:Number(a.cantidad)*Number(a.precio_unitario),TaxObject:p(t.length>0),Taxes:t,Total:C(a)}});const i=Number(e.iva)>0;return[{ProductCode:"01010101",UnitCode:"ACT",Unit:"Actividad",Description:e.descripcion||"Servicio",Quantity:1,UnitPrice:Number(e.subtotal)||0,Subtotal:Number(e.subtotal)||0,TaxObject:p(i),Taxes:i?[{Name:"IVA",Rate:.16,Total:Number(e.iva)||0,Base:Number(e.subtotal)||0,IsRetention:!1}]:[],Total:Number(e.total)||0}]}function F(e,i){return{Folio:e.folio||"",Serie:e.serie||"A",Currency:e.moneda||"MXN",ExpeditionPlace:i.codigo_postal||"06600",PaymentConditions:e.condiciones_pago||"",CfdiType:y(e.tipo),PaymentForm:e.forma_pago||"99",PaymentMethod:e.metodo_pago==="PUE"?"PUE":"PPD",Receiver:{Rfc:e.receptor_rfc,Name:e.receptor_nombre,CfdiUse:e.uso_cfdi||"G03",FiscalRegime:e.receptor_regimen||"616",TaxZipCode:e.receptor_cp||"06600"},Items:g(e)}}async function S(e){return(await c("/3/cfdis",{method:"POST",body:JSON.stringify(e)})).json()}async function h(e,i,a=""){let t=`/cfdi/${e}?type=issued&motive=${i}`;return i==="01"&&a&&(t+=`&uuidReplacement=${a}`),(await c(t,{method:"DELETE"})).json()}async function x(e){return await(await c(`/cfdi/xml/issued/${e}`)).text()}async function I(e){return await(await c(`/cfdi/pdf/issued/${e}`)).text()}async function w(e,i,a,t){return(await c(`/api/Cfdi/Validation/${e}/${i}/${a}/${t}`)).json()}async function T(){try{const i=await(await c("/TaxEntity")).json(),a=!!i.Csd?.Certificate;return{connected:!0,sandbox:l.isSandbox(),rfc:i.Rfc,razonSocial:i.TaxName,regimen:i.FiscalRegime,hasCsd:a,profile:i}}catch(e){return{connected:!1,sandbox:l.isSandbox(),error:e.message}}}async function N(e,i){const{data:a,error:t}=await o.from("cfdi_emitido").select("*").eq("ente_id",e).eq("ejercicio_id",i).order("fecha_emision",{ascending:!1});if(t)throw t;return a}async function q(e,i){const{data:a,error:t}=await o.from("cfdi_recibido").select("*").eq("ente_id",e).eq("ejercicio_id",i).order("fecha_recepcion",{ascending:!1});if(t)throw t;return a}async function v(e,i){const[a,t]=await Promise.all([o.from("cfdi_emitido").select("id, subtotal, total, estado").eq("ente_id",e).eq("ejercicio_id",i),o.from("cfdi_recibido").select("id, subtotal, total, estado").eq("ente_id",e).eq("ejercicio_id",i)]),n=a.data||[],s=t.data||[];return{totalEmitidos:n.length,montoEmitidos:n.filter(r=>r.estado!=="cancelado").reduce((r,m)=>r+Number(m.total||0),0),totalRecibidos:s.length,montoRecibidos:s.filter(r=>r.estado!=="cancelado").reduce((r,m)=>r+Number(m.total||0),0),timbrados:n.filter(r=>r.estado==="timbrado").length}}async function E(e,i,a){const t=F(i,a),n=await S(t),{error:s}=await o.from("cfdi_emitido").update({uuid:n.Complement?.TaxStamp?.Uuid||n.Id,estado:"timbrado",pac_id:n.Id,sello_sat:n.Complement?.TaxStamp?.SatSign||"",sello_emisor:n.Complement?.TaxStamp?.CfdiSign||"",certificado_sat:n.Complement?.TaxStamp?.SatCertNumber||"",fecha_timbrado:n.Complement?.TaxStamp?.Date||new Date().toISOString(),cadena_original:n.OriginalString||""}).eq("id",e);if(s)throw s;return n}async function P(e,i,a){const{data:t}=await o.from("cfdi_emitido").select("pac_id").eq("id",e).single();if(!t?.pac_id)throw new Error("Este CFDI no ha sido timbrado con el PAC.");const n=await h(t.pac_id,i,a);return await o.from("cfdi_emitido").update({estado:"cancelado",motivo_cancelacion:i,fecha_cancelacion:new Date().toISOString()}).eq("id",e),n}async function k(e){const{data:i}=await o.from("cfdi_emitido").select("pac_id").eq("id",e).single();if(!i?.pac_id)throw new Error("Este CFDI no ha sido timbrado.");return x(i.pac_id)}async function A(e){const{data:i}=await o.from("cfdi_emitido").select("pac_id").eq("id",e).single();if(!i?.pac_id)throw new Error("Este CFDI no ha sido timbrado.");return I(i.pac_id)}async function R(e){const{data:i}=await o.from("cfdi_recibido").select("*").eq("id",e).single();if(!i)throw new Error("CFDI no encontrado.");const a=await w(i.emisor_rfc,i.receptor_rfc||"",String(i.total),i.uuid);return await o.from("cfdi_recibido").update({validado_sat:!0,estado_sat:a.Estado||a.status,fecha_validacion:new Date().toISOString()}).eq("id",e),a}function $(){const{entePublico:e,ejercicioFiscal:i}=b();return u({queryKey:["cfdi_emitidos",e?.id,i?.id],queryFn:()=>N(e.id,i.id),enabled:!!e?.id&&!!i?.id})}function K(){const{entePublico:e,ejercicioFiscal:i}=b();return u({queryKey:["cfdi_recibidos",e?.id,i?.id],queryFn:()=>q(e.id,i.id),enabled:!!e?.id&&!!i?.id})}function Q(){const{entePublico:e,ejercicioFiscal:i}=b();return u({queryKey:["resumen_cfdi",e?.id,i?.id],queryFn:()=>v(e.id,i.id),enabled:!!e?.id&&!!i?.id})}function L(){const e=f();return d({mutationFn:({cfdiId:i,formData:a,emisor:t})=>E(i,a,t),onSuccess:()=>{e.invalidateQueries({queryKey:["cfdi_emitidos"]}),e.invalidateQueries({queryKey:["resumen_cfdi"]})}})}function G(){const e=f();return d({mutationFn:({cfdiId:i,motivo:a,uuidSustitucion:t})=>P(i,a,t),onSuccess:()=>{e.invalidateQueries({queryKey:["cfdi_emitidos"]}),e.invalidateQueries({queryKey:["resumen_cfdi"]})}})}function V(){return d({mutationFn:e=>k(e)})}function X(){return d({mutationFn:e=>A(e)})}function z(){const e=f();return d({mutationFn:i=>R(i),onSuccess:()=>{e.invalidateQueries({queryKey:["cfdi_recibidos"]})}})}function B(){return u({queryKey:["pac_status"],queryFn:T,staleTime:6e4,retry:!1})}export{l as F,O as M,j as R,B as a,$ as b,L as c,G as d,V as e,X as f,M as g,U as h,K as i,z as j,Q as u};
