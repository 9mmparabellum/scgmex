import{s as i,o as _,p as f,q as b}from"./index-CPaKNtDw.js";async function h(e){const{data:n,error:a}=await i.from("estado_cuenta_bancario").select("*, periodo:periodo_contable(nombre, numero)").eq("cuenta_bancaria_id",e).order("created_at",{ascending:!1});if(a)throw a;return n}async function y(e){const{data:n,error:a}=await i.from("movimiento_estado_cuenta").select("*, movimiento_bancario:movimiento_bancario(referencia, concepto, monto)").eq("estado_cuenta_id",e).order("fecha");if(a)throw a;return n}async function q(e,n,a,r,u,s,t){const{data:o,error:c}=await i.from("estado_cuenta_bancario").insert({cuenta_bancaria_id:e,periodo_id:n,fecha_corte:a,saldo_inicial_banco:r,saldo_final_banco:u,archivo_nombre:s,estado:"importado"}).select().single();if(c)throw c;if(t.length){const l=t.map(m=>({estado_cuenta_id:o.id,fecha:m.fecha,referencia:m.referencia||null,concepto:m.concepto||null,cargo:Number(m.cargo||0),abono:Number(m.abono||0),saldo:m.saldo!=null?Number(m.saldo):null,conciliado:!1})),{error:d}=await i.from("movimiento_estado_cuenta").insert(l);if(d)throw d}return o}async function v(e,n){const{data:a,error:r}=await i.from("movimiento_estado_cuenta").select("*").eq("estado_cuenta_id",e).eq("conciliado",!1);if(r)throw r;const{data:u,error:s}=await i.from("movimiento_bancario").select("*").eq("cuenta_bancaria_id",n).eq("conciliado",!1);if(s)throw s;let t=0;for(const o of a){const c=Math.abs(Number(o.cargo||0)-Number(o.abono||0)),l=u.find(d=>!d._matched&&d.referencia===o.referencia&&Math.abs(Number(d.monto))===c&&d.fecha===o.fecha);l&&(l._matched=!0,await i.from("movimiento_estado_cuenta").update({conciliado:!0,movimiento_bancario_id:l.id}).eq("id",o.id),await i.from("movimiento_bancario").update({conciliado:!0}).eq("id",l.id),t++)}return t>0&&await i.from("estado_cuenta_bancario").update({estado:"en_conciliacion"}).eq("id",e),{matched:t,total:a.length}}async function w(e){const{data:n,error:a}=await i.from("estado_cuenta_bancario").select("*").eq("id",e).single();if(a)throw a;const{data:r,error:u}=await i.from("movimiento_estado_cuenta").select("conciliado, cargo, abono").eq("estado_cuenta_id",e);if(u)throw u;const s=r.filter(o=>o.conciliado),t=r.filter(o=>!o.conciliado);return{...n,total_movimientos:r.length,conciliados:s.length,no_conciliados:t.length,monto_conciliado:s.reduce((o,c)=>o+Math.abs(Number(c.cargo||0)-Number(c.abono||0)),0),monto_no_conciliado:t.reduce((o,c)=>o+Math.abs(Number(c.cargo||0)-Number(c.abono||0)),0)}}function g(e){return _({queryKey:["estados_cuenta",e],queryFn:()=>h(e),enabled:!!e})}function E(e){return _({queryKey:["movimientos_estado_cuenta",e],queryFn:()=>y(e),enabled:!!e})}function N(){const e=f();return b({mutationFn:({cuentaBancariaId:n,periodoId:a,fechaCorte:r,saldoInicial:u,saldoFinal:s,archivoNombre:t,movimientos:o})=>q(n,a,r,u,s,t,o),onSuccess:()=>{e.invalidateQueries({queryKey:["estados_cuenta"]})}})}function C(){const e=f();return b({mutationFn:({estadoCuentaId:n,cuentaBancariaId:a})=>v(n,a),onSuccess:()=>{e.invalidateQueries({queryKey:["estados_cuenta"]}),e.invalidateQueries({queryKey:["movimientos_estado_cuenta"]}),e.invalidateQueries({queryKey:["movimientos_bancarios"]})}})}function M(e){return _({queryKey:["resumen_conciliacion",e],queryFn:()=>w(e),enabled:!!e})}export{N as a,M as b,E as c,C as d,g as u};
