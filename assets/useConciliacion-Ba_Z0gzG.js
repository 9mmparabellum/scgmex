import{s as c,u as K,o as v,p as E,q as D}from"./index-xuYioy8Y.js";async function Q(e,i){const{data:t,error:n}=await c.from("conciliacion_contable_presupuestal").select("*, periodo:periodo_contable(nombre, numero), elaborador:usuarios!elaborado_por(nombre), aprobador:usuarios!aprobado_por(nombre)").eq("ente_id",e).eq("ejercicio_id",i).order("created_at",{ascending:!1});if(n)throw n;return t}async function S(e){const{data:i,error:t}=await c.from("conciliacion_contable_presupuestal").select("*, periodo:periodo_contable(nombre, numero)").eq("id",e).single();if(t)throw t;const{data:n,error:l}=await c.from("conciliacion_detalle").select("*, cuenta:plan_de_cuentas(codigo, nombre), partida:partida_egreso(clave, descripcion), concepto:concepto_ingreso(clave, descripcion)").eq("conciliacion_id",e).order("tipo").order("created_at");if(l)throw l;return{...i,detalle:n}}async function j(e,i,t,n){const{data:l,error:b}=await c.from("saldo_cuenta").select("cuenta_id, total_debe, total_haber, cuenta:plan_de_cuentas(codigo, nombre, tipo_cuenta)").eq("ente_id",e).eq("ejercicio_id",i).eq("periodo_id",t);if(b)throw b;const{data:d,error:g}=await c.from("partida_egreso").select("id, clave, descripcion").eq("ente_id",e).eq("ejercicio_id",i);if(g)throw g;let u=[];if(d.length){const o=d.map(s=>s.id),{data:r,error:a}=await c.from("movimiento_presupuestal_egreso").select("partida_id, momento, monto").in("partida_id",o).eq("periodo_id",t);if(a)throw a;u=r}const{data:p,error:q}=await c.from("concepto_ingreso").select("id, clave, descripcion").eq("ente_id",e).eq("ejercicio_id",i);if(q)throw q;let _=[];if(p.length){const o=p.map(s=>s.id),{data:r,error:a}=await c.from("movimiento_presupuestal_ingreso").select("concepto_id, momento, monto").in("concepto_id",o).eq("periodo_id",t);if(a)throw a;_=r}const m=l.reduce((o,r)=>o+Number(r.total_debe||0)+Number(r.total_haber||0),0),w=u.reduce((o,r)=>o+Number(r.monto||0),0),y=_.reduce((o,r)=>o+Number(r.monto||0),0),{data:f,error:h}=await c.from("conciliacion_contable_presupuestal").insert({ente_id:e,ejercicio_id:i,periodo_id:t,fecha_elaboracion:new Date().toISOString().slice(0,10),total_contable:m,total_presupuestal_egreso:w,total_presupuestal_ingreso:y,diferencia_egreso:m-w,diferencia_ingreso:m-y,estado:"borrador",elaborado_por:n}).select().single();if(h)throw h;const N=d.map(o=>{const r=u.filter(a=>a.partida_id===o.id).reduce((a,s)=>a+Number(s.monto||0),0);return{conciliacion_id:f.id,tipo:"egreso",partida_egreso_id:o.id,monto_contable:0,monto_presupuestal:r,diferencia:-r,conciliado:!1}}).filter(o=>o.monto_presupuestal!==0),F=p.map(o=>{const r=_.filter(a=>a.concepto_id===o.id).reduce((a,s)=>a+Number(s.monto||0),0);return{conciliacion_id:f.id,tipo:"ingreso",concepto_ingreso_id:o.id,monto_contable:0,monto_presupuestal:r,diferencia:-r,conciliado:!1}}).filter(o=>o.monto_presupuestal!==0),C=[...N,...F];if(C.length){const{error:o}=await c.from("conciliacion_detalle").insert(C);if(o)throw o}return f}async function P(e,i){const{data:t,error:n}=await c.from("conciliacion_contable_presupuestal").update({estado:"aprobado",aprobado_por:i}).eq("id",e).select().single();if(n)throw n;return t}function T(){const{entePublico:e,ejercicioFiscal:i}=K();return v({queryKey:["conciliaciones",e?.id,i?.id],queryFn:()=>Q(e.id,i.id),enabled:!!e?.id&&!!i?.id})}function x(e){return v({queryKey:["conciliacion_detalle",e],queryFn:()=>S(e),enabled:!!e})}function G(){const e=E();return D({mutationFn:({enteId:i,ejercicioId:t,periodoId:n,elaboradoPor:l})=>j(i,t,n,l),onSuccess:()=>{e.invalidateQueries({queryKey:["conciliaciones"]})}})}function M(){const e=E();return D({mutationFn:({conciliacionId:i,aprobadoPor:t})=>P(i,t),onSuccess:()=>{e.invalidateQueries({queryKey:["conciliaciones"]}),e.invalidateQueries({queryKey:["conciliacion_detalle"]})}})}export{G as a,x as b,M as c,T as u};
