import{u as W,A as H,j as e}from"./index-CPaKNtDw.js";import{g as J,c as K,b as i}from"./vendor-DEA9Ikep.js";import{b as Q,c as Z}from"./useObraPublica-mhUE7uf2.js";import{useCreate as ee,useUpdate as te,useRemove as se}from"./useCrud-BktvsPeN.js";import{z as v,y as ae,w as oe,x as ie}from"./constants-CX_We7cr.js";import{D as ne}from"./DataTable-HS7RLNYY.js";import{M as re}from"./Modal-BiK_8Ur7.js";import{B as h}from"./Button-BnoK6vsi.js";import{I as y}from"./Input-DL7Lvbg0.js";import{S as ce}from"./Select-C_7OhVDc.js";import{B as O}from"./Badge-CGz_j3CN.js";import{C as le}from"./ConfirmDialog-DLbWcXIK.js";import{e as de}from"./exportHelpers-CvXmrB4L.js";import"./supabase-DANKYb0E.js";import"./export-t5FFX7R_.js";const b=n=>new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(n||0),N=()=>new Date().toISOString().slice(0,10),D={numero:"",concepto:"",monto:"",fecha:N(),estado:"pendiente"};function we(){const{id:n}=J(),P=K(),{entePublico:A,ejercicioFiscal:T,rol:F}=W(),m=H(F,"obra_publica"),{data:s,isLoading:I}=Q(n),{data:r=[],isLoading:R}=Z(n),[B,c]=i.useState(!1),[x,C]=i.useState(null),[o,g]=i.useState({...D}),[L,j]=i.useState(!1),[p,f]=i.useState(null),E=ee("estimacion_obra"),k=te("estimacion_obra"),w=se("estimacion_obra"),q=i.useMemo(()=>Object.entries(v).map(([t,{label:a}])=>({value:t,label:a})),[]),l=(t,a)=>g(d=>({...d,[t]:a})),z=i.useMemo(()=>r.reduce((t,a)=>t+Number(a.monto||0),0),[r]),$=()=>{C(null),g({...D,fecha:N()}),c(!0)},_=t=>{C(t),g({numero:t.numero??"",concepto:t.concepto??"",monto:t.monto??"",fecha:t.fecha??N(),estado:t.estado??"pendiente"}),c(!0)},V=async()=>{const t={...o,proyecto_id:n,ente_id:A?.id,ejercicio_id:T?.id,monto:Number(o.monto)||0};x?await k.mutateAsync({id:x.id,...t}):await E.mutateAsync(t),c(!1)},X=t=>{f(t),j(!0)},Y=async()=>{p&&await w.mutateAsync(p.id),j(!1),f(null)},G=()=>{de(r,[{key:"numero",label:"Numero"},{key:"concepto",label:"Concepto"},{key:"monto",label:"Monto",getValue:a=>Number(a.monto||0)},{key:"fecha",label:"Fecha"},{key:"estado",label:"Estado",getValue:a=>v[a.estado]?.label||a.estado}],`estimaciones_${s?.clave||n}`)},U=i.useMemo(()=>[{key:"numero",label:"Numero",width:"100px"},{key:"concepto",label:"Concepto"},{key:"monto",label:"Monto",width:"160px",render:t=>e.jsx("span",{className:"text-right block tabular-nums",children:b(t)})},{key:"fecha",label:"Fecha",width:"110px"},{key:"estado",label:"Estado",width:"120px",render:t=>{const a=v[t]||{label:t,variant:"default"};return e.jsx(O,{variant:a.variant,children:a.label})}},{key:"id",label:"Acciones",width:"140px",sortable:!1,render:(t,a)=>e.jsx("div",{className:"flex items-center gap-2",children:m&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:d=>{d.stopPropagation(),_(a)},className:"text-xs text-primary hover:text-primary-light transition-colors cursor-pointer",children:"Editar"}),e.jsx("button",{onClick:d=>{d.stopPropagation(),X(a)},className:"text-xs text-danger hover:text-danger/80 transition-colors cursor-pointer",children:"Eliminar"})]})})}],[m]),M=E.isPending||k.isPending;if(I)return e.jsx("div",{className:"flex items-center justify-center py-16 text-text-muted text-sm",children:"Cargando proyecto..."});if(!s)return e.jsx("div",{className:"flex items-center justify-center py-16 text-text-muted text-sm",children:"Proyecto no encontrado."});const S=ae[s.estado]||{label:s.estado,variant:"default"},u=Number(s.avance_fisico||0);return e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>P("/obra-publica/proyectos"),className:"inline-flex items-center justify-center w-9 h-9 rounded-md text-text-secondary hover:bg-bg-hover hover:text-text-heading transition-colors cursor-pointer","aria-label":"Regresar",children:e.jsx("svg",{className:"w-5 h-5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"15 18 9 12 15 6"})})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-bold text-text-primary",children:s.nombre}),e.jsxs("p",{className:"text-sm text-text-muted mt-1",children:[s.clave,e.jsx("span",{className:"ml-3 inline-block",children:e.jsx(O,{variant:S.variant,children:S.label})})]})]})]}),e.jsx(h,{onClick:G,variant:"outline-primary",size:"sm",children:"Exportar Excel"})]}),e.jsxs("div",{className:"bg-white rounded-lg card-shadow p-5 mb-6",children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-text-muted uppercase tracking-wide mb-1",children:"Tipo"}),e.jsx("p",{className:"text-sm font-semibold text-text-primary",children:oe[s.tipo]||s.tipo||"—"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-text-muted uppercase tracking-wide mb-1",children:"Modalidad"}),e.jsx("p",{className:"text-sm font-semibold text-text-primary",children:ie[s.modalidad_contratacion]||s.modalidad_contratacion||"—"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-text-muted uppercase tracking-wide mb-1",children:"Contratista"}),e.jsx("p",{className:"text-sm font-semibold text-text-primary",children:s.contratista||"—"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-text-muted uppercase tracking-wide mb-1",children:"Fechas"}),e.jsxs("p",{className:"text-sm font-semibold text-text-primary",children:[s.fecha_inicio||"—"," a ",s.fecha_fin_programada||"—"]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-text-muted uppercase tracking-wide mb-1",children:"Monto Contratado"}),e.jsx("p",{className:"text-lg font-bold text-text-primary",children:b(s.monto_contratado)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-text-muted uppercase tracking-wide mb-1",children:"Monto Ejercido"}),e.jsx("p",{className:"text-lg font-bold text-text-primary",children:b(s.monto_ejercido)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-text-muted uppercase tracking-wide mb-1",children:"Total Estimado"}),e.jsx("p",{className:"text-lg font-bold text-text-primary",children:b(z)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-text-muted uppercase tracking-wide mb-1",children:"Avance Fisico"}),e.jsx("div",{className:"mt-1",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex-1 h-2.5 bg-gray-200 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full rounded-full transition-all duration-300",style:{width:`${Math.min(u,100)}%`,backgroundColor:u>=80?"#56ca00":u>=40?"#e09600":"#9D2449"}})}),e.jsxs("span",{className:"text-sm font-bold text-text-primary",children:[u.toFixed(0),"%"]})]})})]})]}),s.descripcion&&e.jsxs("div",{className:"border-t border-border pt-3",children:[e.jsx("p",{className:"text-xs text-text-muted uppercase tracking-wide mb-1",children:"Descripcion"}),e.jsx("p",{className:"text-sm text-text-secondary leading-relaxed",children:s.descripcion})]})]}),e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h2",{className:"text-sm font-semibold text-text-secondary",children:["Estimaciones",e.jsxs("span",{className:"ml-2 text-text-muted font-normal",children:["(",r.length," registros)"]})]}),m&&e.jsx(h,{onClick:$,size:"sm",children:"+ Nueva Estimacion"})]}),R?e.jsx("div",{className:"flex items-center justify-center py-16 text-text-muted text-sm",children:"Cargando estimaciones..."}):e.jsx(ne,{columns:U,data:r,onRowClick:m?_:void 0}),e.jsx(re,{open:B,onClose:()=>c(!1),title:x?"Editar Estimacion":"Nueva Estimacion",size:"md",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(y,{label:"Numero",value:o.numero,onChange:t=>l("numero",t.target.value),placeholder:"Ej. EST-001",required:!0}),e.jsx(y,{label:"Fecha",type:"date",value:o.fecha,onChange:t=>l("fecha",t.target.value),required:!0})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(y,{label:"Monto",type:"number",value:o.monto,onChange:t=>l("monto",t.target.value),placeholder:"0.00",required:!0}),e.jsx(ce,{label:"Estado",value:o.estado,onChange:t=>l("estado",t.target.value),options:q,placeholder:"-- Seleccione estado --",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Concepto"}),e.jsx("textarea",{value:o.concepto,onChange:t=>l("concepto",t.target.value),placeholder:"Describa el concepto de la estimacion",rows:3,className:"w-full h-auto rounded-md border border-border text-[0.9375rem] px-3 py-2 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda"})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-2 border-t border-border",children:[e.jsx(h,{variant:"ghost",onClick:()=>c(!1),disabled:M,children:"Cancelar"}),e.jsx(h,{onClick:V,loading:M,disabled:!o.numero.trim()||!o.monto,children:x?"Guardar cambios":"Crear estimacion"})]})]})}),e.jsx(le,{open:L,onClose:()=>{j(!1),f(null)},onConfirm:Y,title:"Eliminar estimacion",message:p?`¿Esta seguro de eliminar la estimacion "${p.numero}"? Esta accion no se puede deshacer.`:"",confirmText:"Eliminar",loading:w.isPending})]})}export{we as default};
