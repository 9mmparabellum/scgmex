import{u as ue,A as me,j as a}from"./index-CPaKNtDw.js";import{b as s}from"./vendor-DEA9Ikep.js";import{useCreate as pe,useUpdate as be,useRemove as xe}from"./useCrud-BktvsPeN.js";import{h as ge,i as he}from"./useCFDI-IKL5CtJq.js";import{O as x,P as g,U as $,Q as z}from"./constants-CX_We7cr.js";import{D as fe}from"./DataTable-HS7RLNYY.js";import{M as ve}from"./Modal-BiK_8Ur7.js";import{B as h}from"./Button-BnoK6vsi.js";import{I as r}from"./Input-DL7Lvbg0.js";import{S as f}from"./Select-C_7OhVDc.js";import{B as k}from"./Badge-CGz_j3CN.js";import{C as je}from"./ConfirmDialog-DLbWcXIK.js";import{e as _e}from"./exportHelpers-CvXmrB4L.js";import"./supabase-DANKYb0E.js";import"./export-t5FFX7R_.js";const D=v=>new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(v||0),F=()=>new Date().toISOString().slice(0,10),B={uuid:"",fecha_recepcion:F(),emisor_rfc:"",emisor_nombre:"",uso_cfdi:"G03",tipo:"ingreso",metodo_pago:"PUE",subtotal:"",iva:"",total:"",estado:"vigente",fecha_pago:"",notas:""};function Ue(){const{entePublico:v,ejercicioFiscal:G,rol:X}=ue(),j=me(X,"cfdi"),[L,n]=s.useState(!1),[c,I]=s.useState(null),[o,_]=s.useState({...B}),[Q,C]=s.useState(!1),[u,y]=s.useState(null),[m,H]=s.useState(""),[p,J]=s.useState(""),[T,N]=s.useState(""),[O,S]=s.useState(""),{data:M=[],isLoading:K}=ge(),P=pe("cfdi_recibido"),V=be("cfdi_recibido"),A=xe("cfdi_recibido"),d=he(),W=s.useMemo(()=>Object.entries(x).map(([e,t])=>({value:e,label:t})),[]),Y=s.useMemo(()=>Object.entries(g).map(([e,{label:t}])=>({value:e,label:t})),[]),Z=s.useMemo(()=>Object.entries($).map(([e,t])=>({value:e,label:`${e} - ${t}`})),[]),w=s.useMemo(()=>Object.entries(z).map(([e,t])=>({value:e,label:`${e} - ${t}`})),[]),ee=s.useMemo(()=>[{value:"",label:"Todos los tipos"},...Object.entries(x).map(([e,t])=>({value:e,label:t}))],[]),ae=s.useMemo(()=>[{value:"",label:"Todos los estados"},...Object.entries(g).map(([e,{label:t}])=>({value:e,label:t}))],[]),E=s.useMemo(()=>{let e=M;return m&&(e=e.filter(t=>t.tipo===m)),p&&(e=e.filter(t=>t.estado===p)),e},[M,m,p]),i=(e,t)=>_(l=>{const b={...l,[e]:t};if(e==="subtotal"||e==="iva"){const de=Number(e==="subtotal"?t:b.subtotal)||0,ce=Number(e==="iva"?t:b.iva)||0;b.total=(de+ce).toFixed(2)}return b}),te=e=>e?e.length>12?e.slice(0,8)+"...":e:"",oe=()=>{I(null),_({...B,fecha_recepcion:F()}),n(!0)},U=e=>{I(e),_({uuid:e.uuid??"",fecha_recepcion:e.fecha_recepcion??F(),emisor_rfc:e.emisor_rfc??"",emisor_nombre:e.emisor_nombre??"",uso_cfdi:e.uso_cfdi??"G03",tipo:e.tipo??"ingreso",metodo_pago:e.metodo_pago??"PUE",subtotal:e.subtotal??"",iva:e.iva??"",total:e.total??"",estado:e.estado??"vigente",fecha_pago:e.fecha_pago??"",notas:e.notas??""}),n(!0)},se=async()=>{const e={...o,ente_id:v?.id,ejercicio_id:G?.id,subtotal:Number(o.subtotal)||0,iva:Number(o.iva)||0,total:Number(o.total)||0,fecha_pago:o.fecha_pago||null};c?await V.mutateAsync({id:c.id,...e}):await P.mutateAsync(e),n(!1)},ie=e=>{y(e),C(!0)},le=async()=>{u&&await A.mutateAsync(u.id),C(!1),y(null)},R=s.useCallback(async e=>{N(""),S("");try{const t=await d.mutateAsync(e.id),l=t?.Estado||t?.status||"Consultado";S(`CFDI ${e.uuid?.slice(0,8)||""}... validado ante SAT. Estado: ${l}`),setTimeout(()=>S(""),5e3)}catch(t){N(t.message||"Error al validar el CFDI ante el SAT."),setTimeout(()=>N(""),5e3)}},[d]),re=()=>{_e(E,[{key:"uuid",label:"UUID"},{key:"fecha_recepcion",label:"Fecha Recepcion"},{key:"emisor_rfc",label:"Emisor RFC"},{key:"emisor_nombre",label:"Emisor Nombre"},{key:"uso_cfdi",label:"Uso CFDI",getValue:t=>$[t.uso_cfdi]||t.uso_cfdi},{key:"tipo",label:"Tipo",getValue:t=>x[t.tipo]||t.tipo},{key:"metodo_pago",label:"Metodo Pago",getValue:t=>z[t.metodo_pago]||t.metodo_pago},{key:"subtotal",label:"Subtotal",getValue:t=>Number(t.subtotal||0)},{key:"iva",label:"IVA",getValue:t=>Number(t.iva||0)},{key:"total",label:"Total",getValue:t=>Number(t.total||0)},{key:"estado",label:"Estado",getValue:t=>g[t.estado]?.label||t.estado},{key:"validado_sat",label:"Validado SAT",getValue:t=>t.validado_sat?"Si":"No"},{key:"estado_sat",label:"Estado SAT"},{key:"fecha_validacion",label:"Fecha Validacion"},{key:"fecha_pago",label:"Fecha Pago"},{key:"notas",label:"Notas"}],"cfdi_recibidos")},ne=s.useMemo(()=>[{key:"uuid",label:"UUID",width:"120px",render:e=>a.jsx("span",{title:e||"",children:te(e)})},{key:"fecha_recepcion",label:"Fecha Recepcion",width:"140px"},{key:"emisor_rfc",label:"Emisor RFC",width:"140px"},{key:"emisor_nombre",label:"Emisor Nombre"},{key:"tipo",label:"Tipo",width:"100px",render:e=>x[e]||e},{key:"subtotal",label:"Subtotal",width:"130px",render:e=>a.jsx("span",{className:"text-right block tabular-nums",children:D(e)})},{key:"iva",label:"IVA",width:"110px",render:e=>a.jsx("span",{className:"text-right block tabular-nums",children:D(e)})},{key:"total",label:"Total",width:"140px",render:e=>a.jsx("span",{className:"text-right block tabular-nums font-bold",children:D(e)})},{key:"estado",label:"Estado",width:"120px",render:e=>{const t=g[e]||{label:e,variant:"default"};return a.jsx(k,{variant:t.variant,children:t.label})}},{key:"validado_sat",label:"SAT",width:"100px",render:(e,t)=>e?a.jsxs("div",{className:"flex flex-col items-start gap-0.5",children:[a.jsx(k,{variant:"success",children:"Validado"}),t.estado_sat&&a.jsx("span",{className:"text-[10px] text-text-muted",children:t.estado_sat})]}):a.jsx(k,{variant:"default",children:"Pendiente"})},{key:"id",label:"Acciones",width:"180px",sortable:!1,render:(e,t)=>a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("button",{onClick:l=>{l.stopPropagation(),U(t)},className:"text-xs text-primary hover:text-primary-light transition-colors cursor-pointer",children:"Editar"}),t.uuid&&!t.validado_sat&&a.jsx("button",{onClick:l=>{l.stopPropagation(),R(t)},className:"text-xs text-[#56ca00] hover:text-[#56ca00]/80 transition-colors cursor-pointer font-medium",disabled:d.isPending,children:d.isPending?"Validando...":"Validar SAT"}),t.validado_sat&&t.fecha_validacion&&a.jsx("span",{className:"text-[10px] text-text-muted",title:`Validado el ${t.fecha_validacion}`,children:t.fecha_validacion?.slice(0,10)}),j&&a.jsx("button",{onClick:l=>{l.stopPropagation(),ie(t)},className:"text-xs text-danger hover:text-danger/80 transition-colors cursor-pointer",children:"Eliminar"})]})}],[j,R,d.isPending]),q=P.isPending||V.isPending;return a.jsxs("div",{children:[a.jsxs("div",{className:"mb-6",children:[a.jsx("h1",{className:"text-xl font-bold text-text-primary",children:"CFDI Recibidos"}),a.jsx("p",{className:"text-sm text-text-muted mt-1",children:"Comprobantes fiscales digitales recibidos de proveedores y terceros"})]}),O&&a.jsx("div",{className:"bg-[#71dd37]/10 border border-[#71dd37]/30 rounded-lg p-3 mb-4",children:a.jsx("p",{className:"text-sm text-[#56ca00] font-medium",children:O})}),T&&a.jsx("div",{className:"bg-[#ff3e1d]/10 border border-[#ff3e1d]/30 rounded-lg p-3 mb-4",children:a.jsx("p",{className:"text-sm text-[#e0360a] font-medium",children:T})}),a.jsxs("div",{className:"flex items-center justify-between mb-4",children:[a.jsxs("div",{className:"flex items-center gap-4",children:[a.jsxs("h2",{className:"text-sm font-semibold text-text-secondary",children:["Recibidos",a.jsxs("span",{className:"ml-2 text-text-muted font-normal",children:["(",E.length," registros)"]})]}),a.jsx("select",{value:m,onChange:e=>H(e.target.value),className:"h-[38px] rounded-md border border-border text-[0.9375rem] px-3 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda",children:ee.map(e=>a.jsx("option",{value:e.value,children:e.label},e.value))}),a.jsx("select",{value:p,onChange:e=>J(e.target.value),className:"h-[38px] rounded-md border border-border text-[0.9375rem] px-3 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda",children:ae.map(e=>a.jsx("option",{value:e.value,children:e.label},e.value))})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(h,{onClick:re,variant:"outline-primary",size:"sm",children:"Exportar Excel"}),j&&a.jsx(h,{onClick:oe,size:"sm",children:"+ Nuevo CFDI"})]})]}),K?a.jsx("div",{className:"flex items-center justify-center py-16 text-text-muted text-sm",children:"Cargando CFDI recibidos..."}):a.jsx(fe,{columns:ne,data:E,onRowClick:U}),a.jsx(ve,{open:L,onClose:()=>n(!1),title:c?"Editar CFDI Recibido":"Nuevo CFDI Recibido",size:"lg",children:a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[a.jsx(r,{label:"UUID",value:o.uuid,onChange:e=>i("uuid",e.target.value),placeholder:"UUID del comprobante",required:!0}),a.jsx(r,{label:"Fecha de Recepcion",type:"date",value:o.fecha_recepcion,onChange:e=>i("fecha_recepcion",e.target.value),required:!0})]}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[a.jsx(r,{label:"Emisor RFC",value:o.emisor_rfc,onChange:e=>i("emisor_rfc",e.target.value),placeholder:"RFC del emisor",required:!0}),a.jsx(r,{label:"Emisor Nombre",value:o.emisor_nombre,onChange:e=>i("emisor_nombre",e.target.value),placeholder:"Nombre o razon social del emisor",required:!0})]}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[a.jsx(f,{label:"Tipo",value:o.tipo,onChange:e=>i("tipo",e.target.value),options:W,placeholder:"-- Seleccione tipo --",required:!0}),a.jsx(f,{label:"Uso CFDI",value:o.uso_cfdi,onChange:e=>i("uso_cfdi",e.target.value),options:Z,placeholder:"-- Seleccione uso CFDI --",required:!0})]}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[a.jsx(f,{label:"Metodo de Pago",value:o.metodo_pago,onChange:e=>i("metodo_pago",e.target.value),options:w,placeholder:"-- Seleccione metodo de pago --",required:!0}),a.jsx(f,{label:"Estado",value:o.estado,onChange:e=>i("estado",e.target.value),options:Y,placeholder:"-- Seleccione estado --",required:!0})]}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[a.jsx(r,{label:"Subtotal",type:"number",value:o.subtotal,onChange:e=>i("subtotal",e.target.value),placeholder:"0.00",required:!0}),a.jsx(r,{label:"IVA",type:"number",value:o.iva,onChange:e=>i("iva",e.target.value),placeholder:"0.00"}),a.jsx(r,{label:"Total",type:"number",value:o.total,onChange:e=>i("total",e.target.value),placeholder:"0.00",disabled:!0})]}),a.jsx(r,{label:"Fecha de Pago (opcional)",type:"date",value:o.fecha_pago,onChange:e=>i("fecha_pago",e.target.value)}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Notas"}),a.jsx("textarea",{value:o.notas,onChange:e=>i("notas",e.target.value),placeholder:"Observaciones o notas adicionales",rows:3,className:"w-full h-auto rounded-md border border-border text-[0.9375rem] px-3 py-2 focus:outline-none focus:ring-2 focus:ring-guinda/25 focus:border-guinda"})]}),a.jsxs("div",{className:"flex justify-end gap-3 pt-2 border-t border-border",children:[a.jsx(h,{variant:"ghost",onClick:()=>n(!1),disabled:q,children:"Cancelar"}),a.jsx(h,{onClick:se,loading:q,disabled:!o.uuid.trim()||!o.emisor_rfc.trim()||!o.emisor_nombre.trim(),children:c?"Guardar cambios":"Crear CFDI"})]})]})}),a.jsx(je,{open:Q,onClose:()=>{C(!1),y(null)},onConfirm:le,title:"Eliminar CFDI recibido",message:u?`Â¿Esta seguro de eliminar el CFDI recibido con UUID "${u.uuid?.slice(0,8)||""}..."? Esta accion no se puede deshacer.`:"",confirmText:"Eliminar",loading:A.isPending})]})}export{Ue as default};
