import{s as g,y as T,z as L,o as V,p as ee,q as ae,r as B,u as te,j as e}from"./index-w8y8owqO.js";import{b as z}from"./vendor-DEA9Ikep.js";import{useList as be}from"./useCrud-BtFPgtI3.js";import{r as fe}from"./constants-CX_We7cr.js";import{D as J}from"./DataTable-BSU7FwdU.js";import{M as je}from"./Modal-BIIwL78L.js";import{B as $}from"./Button-BNgFL-Nv.js";import{S as W}from"./Select-BDMENQev.js";import{B as H}from"./Badge-CBnEW2x0.js";import{C as U}from"./ConfirmDialog-CEB8zrmM.js";import"./supabase-DANKYb0E.js";import"./export-t5FFX7R_.js";async function q(a,r,s){const{data:i,error:c}=await g.from("plan_de_cuentas").select("id, codigo, nombre, naturaleza, tipo_cuenta").eq("ente_id",a).eq("ejercicio_id",r).eq("es_detalle",!0).like("codigo",`${s}.%`).order("codigo");if(c)throw c;if(!i?.length)return[];const p=i.map(u=>u.id),{data:h}=await g.from("periodo_contable").select("id").eq("ejercicio_id",r).order("numero",{ascending:!1}).limit(1);if(!h?.length)return[];const j=h[0].id,{data:x,error:b}=await g.from("saldo_cuenta").select("cuenta_id, saldo_final").eq("ente_id",a).eq("ejercicio_id",r).eq("periodo_id",j).in("cuenta_id",p);if(b)throw b;const w={};for(const u of x||[])w[u.cuenta_id]=Number(u.saldo_final)||0;return i.map(u=>({...u,saldo_final:w[u.id]||0})).filter(u=>u.saldo_final!==0)}async function re(a,r){const{data:s,error:i}=await g.from("plan_de_cuentas").select("id, codigo, nombre, naturaleza").eq("ente_id",a).eq("ejercicio_id",r).eq("es_detalle",!0).like("codigo","3.2%").order("codigo").limit(1);if(i)throw i;if(!s?.length)throw new Error("No se encontro la cuenta de Resultado del Ejercicio (3.2.x.x).");return s[0]}async function se(a,r){const{data:s,error:i}=await g.from("plan_de_cuentas").select("id, codigo, nombre, naturaleza").eq("ente_id",a).eq("ejercicio_id",r).eq("es_detalle",!0).like("codigo","3.1%").order("codigo").limit(1);if(i)throw i;if(!s?.length)throw new Error("No se encontro la cuenta de Hacienda Publica (3.1.x.x).");return s[0]}async function oe(a,r){const s=[],i={ejercicioAbierto:!1,periodossCerrados:!1,sinPolizasPendientes:!1,balanzaCuadrada:!1},{data:c}=await g.from("ejercicio_fiscal").select("id, anio, estado").eq("id",r).eq("ente_id",a).single();if(!c)return s.push("El ejercicio fiscal no existe."),{canClose:!1,errors:s,checks:i};if(c.estado==="cerrado")return s.push("El ejercicio ya se encuentra cerrado."),{canClose:!1,errors:s,checks:i};i.ejercicioAbierto=c.estado==="abierto",i.ejercicioAbierto||s.push(`El ejercicio se encuentra en estado "${c.estado}". Debe estar "abierto" para cerrarlo.`);const{data:p}=await g.from("periodo_contable").select("id, numero, nombre, estado").eq("ejercicio_id",r).order("numero");if(!p?.length)s.push("No se encontraron periodos contables en el ejercicio.");else{const m=p.filter(_=>_.estado!=="cerrado");if(m.length>0){const _=m.map(N=>N.nombre||`Periodo ${N.numero}`).join(", ");s.push(`Existen periodos sin cerrar: ${_}`)}else i.periodossCerrados=!0}const{data:h,error:j}=await g.from("poliza").select("id, tipo, numero_poliza, estado").eq("ente_id",a).eq("ejercicio_id",r).in("estado",["borrador","pendiente"]);if(j)throw j;h?.length>0?s.push(`Existen ${h.length} poliza(s) en estado borrador o pendiente.`):i.sinPolizasPendientes=!0;const{data:x,error:b}=await g.from("movimiento_contable").select("debe, haber, poliza!inner(ente_id, ejercicio_id, estado)").eq("poliza.ente_id",a).eq("poliza.ejercicio_id",r).eq("poliza.estado","aprobada");if(b)throw b;let w=0,u=0;for(const m of x||[])w+=Number(m.debe)||0,u+=Number(m.haber)||0;const E=Math.abs(w-u);return E<=.01?i.balanzaCuadrada=!0:s.push(`La balanza no esta cuadrada. Diferencia: $${E.toFixed(2)} (Debe: $${w.toFixed(2)}, Haber: $${u.toFixed(2)})`),{canClose:s.length===0,errors:s,checks:i}}async function ge(a,r){const s=await q(a,r,"4"),i=await q(a,r,"5"),c=await re(a,r),p=await se(a,r),h=s.reduce((n,m)=>n+Math.abs(m.saldo_final),0),j=i.reduce((n,m)=>n+Math.abs(m.saldo_final),0),x=h-j,b={descripcion:"Cierre de cuentas de ingresos (4.x.x.x) contra Resultado del Ejercicio",movimientos:[...s.map(n=>({cuenta_codigo:n.codigo,cuenta_nombre:n.nombre,concepto:`Cierre cuenta de ingreso ${n.codigo}`,debe:Math.abs(n.saldo_final),haber:0})),{cuenta_codigo:c.codigo,cuenta_nombre:c.nombre,concepto:"Cierre de ingresos al Resultado del Ejercicio",debe:0,haber:h}],totalDebe:h,totalHaber:h},w={descripcion:"Cierre de cuentas de gastos (5.x.x.x) contra Resultado del Ejercicio",movimientos:[{cuenta_codigo:c.codigo,cuenta_nombre:c.nombre,concepto:"Cierre de gastos al Resultado del Ejercicio",debe:j,haber:0},...i.map(n=>({cuenta_codigo:n.codigo,cuenta_nombre:n.nombre,concepto:`Cierre cuenta de gasto ${n.codigo}`,debe:0,haber:Math.abs(n.saldo_final)}))],totalDebe:j,totalHaber:j},u={descripcion:"Traspaso del Resultado del Ejercicio a Hacienda Publica",movimientos:x>=0?[{cuenta_codigo:c.codigo,cuenta_nombre:c.nombre,concepto:"Traspaso resultado a Hacienda Publica",debe:Math.abs(x),haber:0},{cuenta_codigo:p.codigo,cuenta_nombre:p.nombre,concepto:"Traspaso resultado a Hacienda Publica",debe:0,haber:Math.abs(x)}]:[{cuenta_codigo:p.codigo,cuenta_nombre:p.nombre,concepto:"Traspaso resultado negativo a Hacienda Publica",debe:Math.abs(x),haber:0},{cuenta_codigo:c.codigo,cuenta_nombre:c.nombre,concepto:"Traspaso resultado negativo a Hacienda Publica",debe:0,haber:Math.abs(x)}],totalDebe:Math.abs(x),totalHaber:Math.abs(x)},E={totalIngresos:Math.round(h*100)/100,totalGastos:Math.round(j*100)/100,resultado:Math.round(x*100)/100,tipo:x>=0?"superavit":"deficit",cuentasIngreso:s.length,cuentasGasto:i.length,cuentaResultado:`${c.codigo} ${c.nombre}`,cuentaHacienda:`${p.codigo} ${p.nombre}`};return{polizaIngresos:b,polizaGastos:w,polizaResultado:u,resumen:E}}async function _e(a,r,s){const{canClose:i,errors:c}=await oe(a,r);if(!i)throw new Error(`No se puede cerrar el ejercicio:
${c.join(`
`)}`);await g.from("ejercicio_fiscal").update({estado:"en_cierre"}).eq("id",r);try{const{data:p}=await g.from("periodo_contable").select("id").eq("ejercicio_id",r).order("numero",{ascending:!1}).limit(1);if(!p?.length)throw new Error("No se encontraron periodos contables.");const h=p[0].id,j=await q(a,r,"4"),x=await q(a,r,"5"),b=await re(a,r),w=await se(a,r),u=j.reduce((y,C)=>y+Math.abs(C.saldo_final),0),E=x.reduce((y,C)=>y+Math.abs(C.saldo_final),0),n=u-E,m=new Date().toISOString().slice(0,10);let _=null;if(j.length>0){const y=await T(a,r,"cierre"),C={ente_id:a,ejercicio_id:r,periodo_id:h,tipo:"cierre",numero_poliza:y,fecha:m,descripcion:"Cierre de cuentas de ingresos - Art. 49 LGCG",estado:"aprobada",creado_por:s,aprobado_por:s,aprobado_en:new Date().toISOString()},o=[...j.map(d=>({cuenta_id:d.id,concepto:`Cierre cuenta de ingreso ${d.codigo} ${d.nombre}`,debe:Math.abs(d.saldo_final),haber:0})),{cuenta_id:b.id,concepto:"Cierre de ingresos al Resultado del Ejercicio",debe:0,haber:u}];_=await L(C,o)}let N=null;if(x.length>0){const y=await T(a,r,"cierre"),C={ente_id:a,ejercicio_id:r,periodo_id:h,tipo:"cierre",numero_poliza:y,fecha:m,descripcion:"Cierre de cuentas de gastos - Art. 49 LGCG",estado:"aprobada",creado_por:s,aprobado_por:s,aprobado_en:new Date().toISOString()},o=[{cuenta_id:b.id,concepto:"Cierre de gastos al Resultado del Ejercicio",debe:E,haber:0},...x.map(d=>({cuenta_id:d.id,concepto:`Cierre cuenta de gasto ${d.codigo} ${d.nombre}`,debe:0,haber:Math.abs(d.saldo_final)}))];N=await L(C,o)}let k=null;if(Math.abs(n)>.01){const y=await T(a,r,"cierre"),C={ente_id:a,ejercicio_id:r,periodo_id:h,tipo:"cierre",numero_poliza:y,fecha:m,descripcion:`Traspaso de Resultado del Ejercicio a Hacienda Publica (${n>=0?"Superavit":"Deficit"}) - Art. 49 LGCG`,estado:"aprobada",creado_por:s,aprobado_por:s,aprobado_en:new Date().toISOString()},o=n>=0?[{cuenta_id:b.id,concepto:"Traspaso de resultado a Hacienda Publica",debe:Math.abs(n),haber:0},{cuenta_id:w.id,concepto:"Traspaso de resultado a Hacienda Publica",debe:0,haber:Math.abs(n)}]:[{cuenta_id:w.id,concepto:"Traspaso de resultado negativo a Hacienda Publica",debe:Math.abs(n),haber:0},{cuenta_id:b.id,concepto:"Traspaso de resultado negativo a Hacienda Publica",debe:0,haber:Math.abs(n)}];k=await L(C,o)}const{error:P}=await g.from("ejercicio_fiscal").update({estado:"cerrado",fecha_cierre:m,cerrado_por:s}).eq("id",r);if(P)throw P;return{polizaIngresos:_,polizaGastos:N,polizaResultado:k,resumen:{totalIngresos:Math.round(u*100)/100,totalGastos:Math.round(E*100)/100,resultado:Math.round(n*100)/100,tipo:n>=0?"superavit":"deficit",cuentasIngresoCerradas:j.length,cuentasGastoCerradas:x.length,polizasGeneradas:[_,N,k].filter(Boolean).length}}}catch(p){throw await g.from("ejercicio_fiscal").update({estado:"abierto"}).eq("id",r),p}}async function ve(a,r,s,i){const{data:c}=await g.from("ejercicio_fiscal").select("id, anio, estado").eq("id",r).eq("ente_id",a).single();if(!c)throw new Error("Ejercicio origen no encontrado.");if(c.estado!=="cerrado")throw new Error("El ejercicio origen debe estar cerrado.");const{data:p}=await g.from("ejercicio_fiscal").select("id, anio, estado").eq("id",s).eq("ente_id",a).single();if(!p)throw new Error("Ejercicio destino no encontrado.");if(p.estado==="cerrado")throw new Error("El ejercicio destino ya esta cerrado.");const h=await q(a,r,"1"),j=await q(a,r,"2"),x=await q(a,r,"3"),b=[...h,...j,...x].filter(o=>Math.abs(o.saldo_final)>.01);if(!b.length)throw new Error("No se encontraron saldos de cuentas de balance para transferir.");const{data:w}=await g.from("periodo_contable").select("id").eq("ejercicio_id",s).order("numero",{ascending:!0}).limit(1);if(!w?.length)throw new Error("No se encontraron periodos contables en el ejercicio destino.");const u=w[0].id,{data:E,error:n}=await g.from("plan_de_cuentas").select("id, codigo, nombre, naturaleza").eq("ente_id",a).eq("ejercicio_id",s).eq("es_detalle",!0).in("codigo",b.map(o=>o.codigo));if(n)throw n;const m={};for(const o of E||[])m[o.codigo]=o;const _=b.filter(o=>m[o.codigo]);if(!_.length)throw new Error("No se encontraron cuentas equivalentes en el ejercicio destino.");new Date().toISOString().slice(0,10);const N=await T(a,s,"diario"),k={ente_id:a,ejercicio_id:s,periodo_id:u,tipo:"diario",numero_poliza:N,fecha:`${p.anio}-01-01`,descripcion:`Poliza de Apertura - Saldos iniciales del ejercicio ${p.anio} (desde ${c.anio})`,estado:"aprobada",creado_por:i,aprobado_por:i,aprobado_en:new Date().toISOString()},P=[];for(const o of _){const d=m[o.codigo],G=o.saldo_final;G>0?P.push({cuenta_id:d.id,concepto:`Saldo inicial ${o.codigo} ${o.nombre}`,debe:G,haber:0}):P.push({cuenta_id:d.id,concepto:`Saldo inicial ${o.codigo} ${o.nombre}`,debe:0,haber:Math.abs(G)})}const y=await L(k,P),C=_.map(o=>{const d=m[o.codigo];return{ente_id:a,ejercicio_id:s,periodo_id:u,cuenta_id:d.id,saldo_inicial:o.saldo_final,total_debe:o.saldo_final>0?o.saldo_final:0,total_haber:o.saldo_final<0?Math.abs(o.saldo_final):0,saldo_final:o.saldo_final}});if(C.length){const{error:o}=await g.from("saldo_cuenta").insert(C);if(o)throw o}return{polizaApertura:y,cuentasTransferidas:_.length,totalDeudor:_.filter(o=>o.saldo_final>0).reduce((o,d)=>o+d.saldo_final,0),totalAcreedor:_.filter(o=>o.saldo_final<0).reduce((o,d)=>o+Math.abs(d.saldo_final),0)}}function we(a,r){return V({queryKey:["validar_cierre",a,r],queryFn:()=>oe(a,r),enabled:!!a&&!!r,staleTime:3e4})}function Ne(a,r){return V({queryKey:["previsualizar_cierre",a,r],queryFn:()=>ge(a,r),enabled:!!a&&!!r,staleTime:6e4})}function ye(){const a=ee();return ae({mutationFn:({enteId:r,ejercicioId:s,userId:i})=>_e(r,s,i),onSuccess:(r,s)=>{a.invalidateQueries({queryKey:["validar_cierre"]}),a.invalidateQueries({queryKey:["previsualizar_cierre"]}),a.invalidateQueries({queryKey:["ejercicio_fiscal"]}),a.invalidateQueries({queryKey:["poliza"]}),a.invalidateQueries({queryKey:["saldos_cuenta"]}),a.invalidateQueries({queryKey:["aperturas"]}),B.getState().addToast({type:"success",title:"Cierre ejecutado",message:"El cierre del ejercicio se realizo correctamente."})},onError:r=>{B.getState().addToast({type:"error",title:"Error en cierre",message:r.message||"Ocurrio un error al ejecutar el cierre.",duration:8e3})}})}function Ce(){const a=ee();return ae({mutationFn:({enteId:r,ejercicioOrigenId:s,ejercicioDestinoId:i,userId:c})=>ve(r,s,i,c),onSuccess:()=>{a.invalidateQueries({queryKey:["aperturas"]}),a.invalidateQueries({queryKey:["saldos_cuenta"]}),a.invalidateQueries({queryKey:["poliza"]}),a.invalidateQueries({queryKey:["ejercicio_fiscal"]}),B.getState().addToast({type:"success",title:"Apertura generada",message:"La poliza de apertura del nuevo ejercicio se genero correctamente."})},onError:r=>{B.getState().addToast({type:"error",title:"Error en apertura",message:r.message||"Ocurrio un error al generar la poliza de apertura.",duration:8e3})}})}async function ze(a){const{data:r,error:s}=await g.from("apertura_ejercicio").select("*, ejercicio_origen:ejercicio_fiscal!ejercicio_origen_id(anio, estado), ejercicio_destino:ejercicio_fiscal!ejercicio_destino_id(anio, estado), ejecutador:usuarios!ejecutado_por(nombre)").eq("ente_id",a).order("created_at",{ascending:!1});if(s)throw s;return r}function Ee(){const{entePublico:a}=te();return V({queryKey:["aperturas",a?.id],queryFn:()=>ze(a.id),enabled:!!a?.id})}const v=a=>new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(a||0),Y={abierto:{label:"Abierto",variant:"primary"},en_cierre:{label:"En Cierre",variant:"warning"},cerrado:{label:"Cerrado",variant:"success"}};function ke({className:a="w-3.5 h-3.5"}){return e.jsx("svg",{className:a,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"20 6 9 17 4 12"})})}function ie({className:a="w-3.5 h-3.5"}){return e.jsxs("svg",{className:a,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})}function O({className:a="h-8 w-8"}){return e.jsxs("svg",{className:`animate-spin ${a} text-guinda`,xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]})}function Z({className:a="h-4 w-4"}){return e.jsx("svg",{className:a,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"})})}function Se({className:a="h-4 w-4"}){return e.jsx("svg",{className:a,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 10V3L4 14h7v7l9-11h-7z"})})}function Pe({className:a="h-4 w-4"}){return e.jsxs("svg",{className:a,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"})]})}function I({className:a="h-4 w-4"}){return e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:a,viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z",clipRule:"evenodd"})})}function Me({className:a="w-7 h-7"}){return e.jsxs("svg",{className:a,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M3 3v18h18"}),e.jsx("path",{d:"M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"})]})}function D({label:a,passed:r,loading:s=!1}){return e.jsxs("div",{className:"flex items-center gap-2.5 py-1.5",children:[s?e.jsx("div",{className:"w-5 h-5 flex items-center justify-center flex-shrink-0",children:e.jsx(O,{className:"h-4 w-4"})}):r?e.jsx("div",{className:"w-5 h-5 rounded-full bg-[#71dd37]/15 flex items-center justify-center flex-shrink-0",children:e.jsx(ke,{className:"w-3.5 h-3.5 text-[#71dd37]"})}):e.jsx("div",{className:"w-5 h-5 rounded-full bg-[#ff3e1d]/15 flex items-center justify-center flex-shrink-0",children:e.jsx(ie,{className:"w-3.5 h-3.5 text-[#ff3e1d]"})}),e.jsx("span",{className:`text-sm ${s?"text-text-muted":r?"text-text-primary":"text-[#ff3e1d] font-medium"}`,children:a})]})}function Ke(){const{entePublico:a,ejercicioFiscal:r,user:s}=te(),i=a?.id,[c,p]=z.useState("cierre"),[h,j]=z.useState(""),[x,b]=z.useState(!1),[w,u]=z.useState(!1),[E,n]=z.useState(!1),[m,_]=z.useState(""),[N,k]=z.useState(""),[P,y]=z.useState(!1),{data:C=[],isLoading:o}=Ee(),{data:d=[]}=be("ejercicio_fiscal",{filter:{ente_id:i},order:{column:"anio",ascending:!0}}),G=z.useMemo(()=>d.map(t=>({value:t.id,label:`${t.anio}`})),[d]),ne=z.useMemo(()=>d.filter(t=>t.estado==="cerrado").map(t=>({value:t.id,label:`${t.anio}`})),[d]),ce=z.useMemo(()=>d.filter(t=>t.estado!=="cerrado").map(t=>({value:t.id,label:`${t.anio}`})),[d]),M=h||r?.id,{data:S,isLoading:de,refetch:X}=we(i,M),{data:l,isLoading:F,refetch:le}=Ne(x?i:null,x?M:null),R=ye(),K=Ce(),A=z.useMemo(()=>d.find(t=>t.id===M),[d,M]),Q=A?.estado?Y[A.estado]||{label:A.estado,variant:"default"}:null,ue=()=>{b(!0),le()},me=async()=>{try{await R.mutateAsync({enteId:i,ejercicioId:M,userId:s?.id}),u(!1),b(!1),X()}catch{u(!1)}},xe=async()=>{try{await K.mutateAsync({enteId:i,ejercicioOrigenId:m,ejercicioDestinoId:N,userId:s?.id}),y(!1),n(!1),_(""),k("")}catch{y(!1)}},pe=z.useMemo(()=>[{key:"ejercicio_origen",label:"Ejercicio Origen",width:"140px",render:(t,f)=>f.ejercicio_origen?.anio||"—"},{key:"ejercicio_destino",label:"Ejercicio Destino",width:"140px",render:(t,f)=>f.ejercicio_destino?.anio||"—"},{key:"fecha_apertura",label:"Fecha",width:"130px",render:t=>t?new Date(t).toLocaleDateString("es-MX"):"—"},{key:"estado",label:"Estado",width:"130px",render:t=>{const f=fe[t];return e.jsx(H,{variant:f?.variant||"default",children:f?.label||t||"—"})}},{key:"total_cuentas_transferidas",label:"Cuentas",width:"100px",render:t=>e.jsx("span",{className:"font-mono text-sm",children:t??0})},{key:"total_saldo_deudor",label:"Saldo Deudor",width:"150px",render:t=>e.jsx("span",{className:"font-mono text-sm text-right block tabular-nums",children:v(t)})},{key:"total_saldo_acreedor",label:"Saldo Acreedor",width:"150px",render:t=>e.jsx("span",{className:"font-mono text-sm text-right block tabular-nums",children:v(t)})},{key:"ejecutado_por",label:"Ejecutado Por",width:"140px",render:(t,f)=>f.ejecutador?.nombre||f.ejecutado_por_nombre||"—"}],[]),he=z.useMemo(()=>[{key:"anio",label:"Ejercicio",width:"120px",render:t=>e.jsx("span",{className:"font-semibold",children:t})},{key:"estado",label:"Estado",width:"140px",render:t=>{const f=Y[t]||{label:t,variant:"default"};return e.jsx(H,{variant:f.variant,children:f.label})}},{key:"fecha_cierre",label:"Fecha Cierre",width:"140px",render:t=>t?new Date(t).toLocaleDateString("es-MX"):"—"}],[]);return e.jsxs("div",{children:[e.jsx("div",{className:"flex items-center justify-between mb-6",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-bold text-text-primary",children:"Cierre y Apertura de Ejercicio"}),e.jsx("p",{className:"text-sm text-text-muted mt-1",children:"Cierre contable del ejercicio fiscal y apertura del nuevo ejercicio (Art. 49 LGCG)"})]})}),e.jsxs("div",{className:"flex gap-1 mb-6 bg-[#f5f5f9] rounded-lg p-1 w-fit",children:[e.jsxs("button",{onClick:()=>p("cierre"),className:`px-5 py-2 text-sm font-medium rounded-md transition-all cursor-pointer ${c==="cierre"?"bg-white text-guinda card-shadow":"text-text-muted hover:text-text-primary"}`,children:[e.jsx(Z,{className:"h-4 w-4 mr-1.5 inline-block"}),"Cierre de Ejercicio"]}),e.jsxs("button",{onClick:()=>p("apertura"),className:`px-5 py-2 text-sm font-medium rounded-md transition-all cursor-pointer ${c==="apertura"?"bg-white text-guinda card-shadow":"text-text-muted hover:text-text-primary"}`,children:[e.jsx(I,{className:"h-4 w-4 mr-1.5 inline-block"}),"Apertura de Ejercicio"]})]}),c==="cierre"&&e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"bg-white rounded-lg card-shadow p-5",children:e.jsxs("div",{className:"flex items-end gap-4",children:[e.jsx("div",{className:"w-64",children:e.jsx(W,{label:"Ejercicio fiscal a cerrar",placeholder:"Seleccionar ejercicio...",options:G,value:h||r?.id||"",onChange:t=>{j(t.target.value),b(!1)}})}),A&&Q&&e.jsxs("div",{className:"flex items-center gap-3 pb-1",children:[e.jsx(H,{variant:Q.variant,children:Q.label}),e.jsxs("span",{className:"text-sm text-text-muted",children:["Ejercicio ",A.anio]})]})]})}),M&&e.jsxs("div",{className:"bg-white rounded-lg card-shadow p-5",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-[0.9375rem] font-semibold text-text-heading",children:"Validaciones Pre-Cierre"}),e.jsx($,{variant:"outline-primary",size:"sm",onClick:()=>X(),children:"Actualizar"})]}),de?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(O,{className:"h-6 w-6"})}):S?e.jsxs("div",{className:"space-y-1",children:[e.jsx(D,{label:"Ejercicio fiscal en estado abierto",passed:S.checks?.ejercicioAbierto}),e.jsx(D,{label:"Todos los periodos contables cerrados",passed:S.checks?.periodossCerrados}),e.jsx(D,{label:"Sin polizas pendientes (borrador/pendiente)",passed:S.checks?.sinPolizasPendientes}),e.jsx(D,{label:"Balanza de comprobacion cuadrada (Debe = Haber)",passed:S.checks?.balanzaCuadrada}),S.errors?.length>0&&e.jsxs("div",{className:"mt-4 bg-[#ff3e1d]/5 rounded-lg p-4 border border-[#ff3e1d]/20",children:[e.jsx("p",{className:"text-xs text-[#ff3e1d] font-semibold uppercase tracking-wide mb-2",children:"Errores encontrados"}),e.jsx("ul",{className:"space-y-1",children:S.errors.map((t,f)=>e.jsxs("li",{className:"text-sm text-[#ff3e1d] flex items-start gap-2",children:[e.jsx("span",{className:"flex-shrink-0 mt-0.5",children:e.jsx(ie,{className:"w-3 h-3 text-[#ff3e1d]"})}),t]},f))})]}),S.canClose&&e.jsx("div",{className:"mt-4 bg-[#71dd37]/5 rounded-lg p-4 border border-[#71dd37]/20",children:e.jsx("p",{className:"text-sm text-[#56ca00] font-medium",children:"Todas las validaciones pasaron correctamente. Puede proceder con el cierre."})})]}):e.jsx("p",{className:"text-sm text-text-muted py-4",children:"Seleccione un ejercicio fiscal para ver las validaciones."})]}),M&&e.jsxs("div",{className:"bg-white rounded-lg card-shadow p-5",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-[0.9375rem] font-semibold text-text-heading",children:"Previsualizacion del Cierre"}),e.jsxs($,{variant:"outline-primary",size:"sm",onClick:ue,loading:F,children:[e.jsx(Pe,{className:"w-4 h-4 mr-1.5 inline-block"}),"Previsualizar Cierre"]})]}),x&&F&&e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(O,{className:"h-6 w-6"})}),x&&l&&!F&&e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"bg-[#71dd37]/5 rounded-lg p-4 border border-[#71dd37]/20",children:[e.jsx("p",{className:"text-xs text-text-muted uppercase tracking-wide mb-1",children:"Total Ingresos"}),e.jsx("p",{className:"text-lg font-bold text-[#56ca00] tabular-nums",children:v(l.resumen?.totalIngresos)}),e.jsxs("p",{className:"text-xs text-text-muted mt-1",children:[l.resumen?.cuentasIngreso," cuentas"]})]}),e.jsxs("div",{className:"bg-[#ff3e1d]/5 rounded-lg p-4 border border-[#ff3e1d]/20",children:[e.jsx("p",{className:"text-xs text-text-muted uppercase tracking-wide mb-1",children:"Total Gastos"}),e.jsx("p",{className:"text-lg font-bold text-[#e0360a] tabular-nums",children:v(l.resumen?.totalGastos)}),e.jsxs("p",{className:"text-xs text-text-muted mt-1",children:[l.resumen?.cuentasGasto," cuentas"]})]}),e.jsxs("div",{className:`rounded-lg p-4 border ${l.resumen?.resultado>=0?"bg-[#03c3ec]/5 border-[#03c3ec]/20":"bg-[#ffab00]/5 border-[#ffab00]/20"}`,children:[e.jsx("p",{className:"text-xs text-text-muted uppercase tracking-wide mb-1",children:"Resultado del Ejercicio"}),e.jsx("p",{className:`text-lg font-bold tabular-nums ${l.resumen?.resultado>=0?"text-[#03a9ce]":"text-[#e09600]"}`,children:v(l.resumen?.resultado)}),e.jsx("p",{className:"text-xs text-text-muted mt-1",children:e.jsx(H,{variant:l.resumen?.tipo==="superavit"?"success":"warning",children:l.resumen?.tipo==="superavit"?"Superavit":"Deficit"})})]})]}),e.jsxs("div",{className:"space-y-4",children:[l.polizaIngresos&&e.jsxs("details",{className:"border border-border rounded-lg",children:[e.jsxs("summary",{className:"px-4 py-3 cursor-pointer text-sm font-medium text-text-heading hover:bg-[#f5f5f9] rounded-lg",children:["Poliza de Cierre de Ingresos (",l.polizaIngresos.movimientos?.length||0," movimientos)"]}),e.jsxs("div",{className:"px-4 pb-3",children:[e.jsx("p",{className:"text-xs text-text-muted mb-2",children:l.polizaIngresos.descripcion}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-border",children:[e.jsx("th",{className:"text-left py-2 pr-4 text-xs text-text-muted font-medium",children:"Cuenta"}),e.jsx("th",{className:"text-left py-2 pr-4 text-xs text-text-muted font-medium",children:"Concepto"}),e.jsx("th",{className:"text-right py-2 pr-4 text-xs text-text-muted font-medium",children:"Debe"}),e.jsx("th",{className:"text-right py-2 text-xs text-text-muted font-medium",children:"Haber"})]})}),e.jsx("tbody",{children:l.polizaIngresos.movimientos?.map((t,f)=>e.jsxs("tr",{className:"border-b border-border/50",children:[e.jsx("td",{className:"py-1.5 pr-4 font-mono text-xs",children:t.cuenta_codigo}),e.jsx("td",{className:"py-1.5 pr-4 text-xs",children:t.concepto}),e.jsx("td",{className:"py-1.5 pr-4 text-right font-mono text-xs tabular-nums",children:t.debe>0?v(t.debe):""}),e.jsx("td",{className:"py-1.5 text-right font-mono text-xs tabular-nums",children:t.haber>0?v(t.haber):""})]},f))}),e.jsx("tfoot",{children:e.jsxs("tr",{className:"font-semibold border-t-2 border-border",children:[e.jsx("td",{colSpan:"2",className:"py-2 text-xs",children:"Totales"}),e.jsx("td",{className:"py-2 text-right font-mono text-xs tabular-nums",children:v(l.polizaIngresos.totalDebe)}),e.jsx("td",{className:"py-2 text-right font-mono text-xs tabular-nums",children:v(l.polizaIngresos.totalHaber)})]})})]})})]})]}),l.polizaGastos&&e.jsxs("details",{className:"border border-border rounded-lg",children:[e.jsxs("summary",{className:"px-4 py-3 cursor-pointer text-sm font-medium text-text-heading hover:bg-[#f5f5f9] rounded-lg",children:["Poliza de Cierre de Gastos (",l.polizaGastos.movimientos?.length||0," movimientos)"]}),e.jsxs("div",{className:"px-4 pb-3",children:[e.jsx("p",{className:"text-xs text-text-muted mb-2",children:l.polizaGastos.descripcion}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-border",children:[e.jsx("th",{className:"text-left py-2 pr-4 text-xs text-text-muted font-medium",children:"Cuenta"}),e.jsx("th",{className:"text-left py-2 pr-4 text-xs text-text-muted font-medium",children:"Concepto"}),e.jsx("th",{className:"text-right py-2 pr-4 text-xs text-text-muted font-medium",children:"Debe"}),e.jsx("th",{className:"text-right py-2 text-xs text-text-muted font-medium",children:"Haber"})]})}),e.jsx("tbody",{children:l.polizaGastos.movimientos?.map((t,f)=>e.jsxs("tr",{className:"border-b border-border/50",children:[e.jsx("td",{className:"py-1.5 pr-4 font-mono text-xs",children:t.cuenta_codigo}),e.jsx("td",{className:"py-1.5 pr-4 text-xs",children:t.concepto}),e.jsx("td",{className:"py-1.5 pr-4 text-right font-mono text-xs tabular-nums",children:t.debe>0?v(t.debe):""}),e.jsx("td",{className:"py-1.5 text-right font-mono text-xs tabular-nums",children:t.haber>0?v(t.haber):""})]},f))}),e.jsx("tfoot",{children:e.jsxs("tr",{className:"font-semibold border-t-2 border-border",children:[e.jsx("td",{colSpan:"2",className:"py-2 text-xs",children:"Totales"}),e.jsx("td",{className:"py-2 text-right font-mono text-xs tabular-nums",children:v(l.polizaGastos.totalDebe)}),e.jsx("td",{className:"py-2 text-right font-mono text-xs tabular-nums",children:v(l.polizaGastos.totalHaber)})]})})]})})]})]}),l.polizaResultado&&e.jsxs("details",{className:"border border-border rounded-lg",children:[e.jsxs("summary",{className:"px-4 py-3 cursor-pointer text-sm font-medium text-text-heading hover:bg-[#f5f5f9] rounded-lg",children:["Poliza de Traspaso a Hacienda Publica (",l.polizaResultado.movimientos?.length||0," movimientos)"]}),e.jsxs("div",{className:"px-4 pb-3",children:[e.jsx("p",{className:"text-xs text-text-muted mb-2",children:l.polizaResultado.descripcion}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-border",children:[e.jsx("th",{className:"text-left py-2 pr-4 text-xs text-text-muted font-medium",children:"Cuenta"}),e.jsx("th",{className:"text-left py-2 pr-4 text-xs text-text-muted font-medium",children:"Concepto"}),e.jsx("th",{className:"text-right py-2 pr-4 text-xs text-text-muted font-medium",children:"Debe"}),e.jsx("th",{className:"text-right py-2 text-xs text-text-muted font-medium",children:"Haber"})]})}),e.jsx("tbody",{children:l.polizaResultado.movimientos?.map((t,f)=>e.jsxs("tr",{className:"border-b border-border/50",children:[e.jsx("td",{className:"py-1.5 pr-4 font-mono text-xs",children:t.cuenta_codigo}),e.jsx("td",{className:"py-1.5 pr-4 text-xs",children:t.concepto}),e.jsx("td",{className:"py-1.5 pr-4 text-right font-mono text-xs tabular-nums",children:t.debe>0?v(t.debe):""}),e.jsx("td",{className:"py-1.5 text-right font-mono text-xs tabular-nums",children:t.haber>0?v(t.haber):""})]},f))}),e.jsx("tfoot",{children:e.jsxs("tr",{className:"font-semibold border-t-2 border-border",children:[e.jsx("td",{colSpan:"2",className:"py-2 text-xs",children:"Totales"}),e.jsx("td",{className:"py-2 text-right font-mono text-xs tabular-nums",children:v(l.polizaResultado.totalDebe)}),e.jsx("td",{className:"py-2 text-right font-mono text-xs tabular-nums",children:v(l.polizaResultado.totalHaber)})]})})]})})]})]}),l.resumen&&e.jsxs("div",{className:"bg-[#f5f5f9] rounded-lg p-4 text-xs text-text-muted space-y-1",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium text-text-secondary",children:"Cuenta Resultado del Ejercicio:"})," ",l.resumen.cuentaResultado]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium text-text-secondary",children:"Cuenta Hacienda Publica:"})," ",l.resumen.cuentaHacienda]})]})]})]}),!x&&e.jsx("p",{className:"text-sm text-text-muted py-4",children:'Presione "Previsualizar Cierre" para ver las polizas que se generaran.'})]}),M&&e.jsx("div",{className:"bg-white rounded-lg card-shadow p-5",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-[0.9375rem] font-semibold text-text-heading mb-1",children:"Ejecutar Cierre"}),e.jsx("p",{className:"text-xs text-text-muted",children:"Esta operacion generara las polizas de cierre y marcara el ejercicio como cerrado. Esta accion no se puede deshacer."})]}),e.jsxs($,{variant:"danger",onClick:()=>u(!0),disabled:!S?.canClose||R.isPending,loading:R.isPending,children:[e.jsx(Z,{className:"w-4 h-4 mr-1.5 inline-block"}),"Ejecutar Cierre"]})]})}),e.jsxs("div",{className:"bg-white rounded-lg card-shadow p-5",children:[e.jsx("h2",{className:"text-[0.9375rem] font-semibold text-text-heading mb-4",children:"Estado de Ejercicios Fiscales"}),d.length===0?e.jsx("p",{className:"text-sm text-text-muted py-4",children:"No se encontraron ejercicios fiscales."}):e.jsx(J,{columns:he,data:d})]})]}),c==="apertura"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{}),e.jsxs($,{onClick:()=>{_(""),k(""),n(!0)},children:[e.jsx(I,{className:"h-4 w-4 mr-1.5 inline-block"}),"Nueva Apertura"]})]}),e.jsxs("div",{className:"bg-white rounded-lg card-shadow p-5",children:[e.jsx("h2",{className:"text-[0.9375rem] font-semibold text-text-heading mb-4",children:"Historial de Aperturas"}),o?e.jsx("div",{className:"flex items-center justify-center py-16",children:e.jsx(O,{})}):C.length===0?e.jsxs("div",{className:"text-center py-16",children:[e.jsx("div",{className:"flex justify-center mb-4",children:e.jsx("div",{className:"w-16 h-16 rounded-full bg-[#f5f5f9] flex items-center justify-center text-text-muted",children:e.jsx(Me,{})})}),e.jsx("h3",{className:"text-[0.9375rem] font-semibold text-text-heading mb-1",children:"Sin aperturas registradas"}),e.jsx("p",{className:"text-sm text-text-muted max-w-sm mx-auto",children:'No se han realizado aperturas de ejercicio. Presione "Nueva Apertura" para iniciar el proceso.'})]}):e.jsx(J,{columns:pe,data:C})]})]}),e.jsx(je,{open:E,onClose:()=>n(!1),title:"Generar Poliza de Apertura",size:"md",children:e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"text-sm font-semibold text-text-secondary mb-3 flex items-center gap-2",children:[e.jsx("span",{className:"w-5 h-5 rounded-full bg-guinda text-white text-xs flex items-center justify-center font-bold",children:"1"}),"Seleccionar ejercicios"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(W,{label:"Ejercicio Origen (cerrado)",placeholder:"Seleccionar...",options:ne,value:m,onChange:t=>_(t.target.value)}),e.jsx(W,{label:"Ejercicio Destino (abierto)",placeholder:"Seleccionar...",options:ce,value:N,onChange:t=>k(t.target.value)})]}),m&&N&&m===N&&e.jsx("p",{className:"text-xs text-[#ff3e1d] mt-2",children:"El ejercicio origen y destino deben ser diferentes."})]}),e.jsxs("div",{children:[e.jsxs("h3",{className:"text-sm font-semibold text-text-secondary mb-3 flex items-center gap-2",children:[e.jsx("span",{className:"w-5 h-5 rounded-full bg-guinda text-white text-xs flex items-center justify-center font-bold",children:"2"}),"Informacion"]}),e.jsxs("div",{className:"bg-[#f5f5f9] rounded-lg p-4 text-xs text-text-muted space-y-2",children:[e.jsx("p",{children:"La poliza de apertura transferira los saldos finales de las cuentas de balance (Activo 1.x, Pasivo 2.x, Hacienda Publica 3.x) del ejercicio origen como saldos iniciales del ejercicio destino."}),e.jsx("p",{children:"Se creara una poliza contable tipo diario en el primer periodo del ejercicio destino con todos los saldos de apertura."}),e.jsx("p",{className:"font-medium text-text-secondary",children:"Esta operacion no se puede deshacer."})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-2 border-t border-border",children:[e.jsx($,{variant:"ghost",onClick:()=>n(!1),children:"Cancelar"}),e.jsxs($,{variant:"success",onClick:()=>y(!0),disabled:!m||!N||m===N,loading:K.isPending,children:[e.jsx(Se,{className:"w-4 h-4 mr-1.5 inline-block"}),"Generar Poliza de Apertura"]})]})]})}),e.jsx(U,{open:w,onClose:()=>u(!1),onConfirm:me,title:"Confirmar cierre del ejercicio",message:`Se generaran las polizas de cierre para el ejercicio ${A?.anio||""} y se marcara como cerrado. Las cuentas de ingresos y gastos se cerraran contra Resultado del Ejercicio, y el resultado se trasladara a Hacienda Publica. Esta operacion no se puede deshacer. ¿Desea continuar?`,confirmText:"Ejecutar Cierre",loading:R.isPending}),e.jsx(U,{open:P,onClose:()=>y(!1),onConfirm:xe,title:"Confirmar generacion de apertura",message:`Se transferiran los saldos de balance del ejercicio ${d.find(t=>t.id===m)?.anio||""} al ejercicio ${d.find(t=>t.id===N)?.anio||""} mediante una poliza de apertura. Esta operacion no se puede deshacer. ¿Desea continuar?`,confirmText:"Generar Apertura",loading:K.isPending})]})}export{Ke as default};
